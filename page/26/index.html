


    




<!DOCTYPE HTML>

<html>
    <head>
        
            <title> - ジェダイさんのブログ</title>
        

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="generator" content="Hugo 0.16" />
        


        
        
            
                <meta name="description" content="技術ネタを書いていきます">
            
        

        
        <meta property="og:title" content="" />
<meta property="og:description" content="技術ネタを書いていきます" />
<meta property="og:type" content="website" />
<meta property="og:url" content="http://jedipunkz.github.io/" />


<meta property="og:updated_time" content="2013-02-10T00:00:00&#43;00:00"/>









        
<meta itemprop="name" content="">
<meta itemprop="description" content="技術ネタを書いていきます">


        

        

        
        
            
        

        
        
            <link rel="stylesheet" href="/css/google-font.css" />
            <link rel="stylesheet" href="/css/font-awesome.min.css" />
            <link rel="stylesheet" href="/css/main.css" />
            <link rel="stylesheet" href="/css/add-on.css" />
            <link rel="stylesheet" href="/css/monokai-sublime.css">
        

        

        
        
        
            
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-30563095-1', 'auto');
ga('send', 'pageview');
</script>

        
    </head>
    <body>

        
        <div id="wrapper">

    
<header id="header">
    
        <h2><a href="/">ジェダイさんのブログ</i></a></h2>
    

    <nav class="links">
        <ul>
            
                <li>
                    <a href="/post">
                        
                            <i class="fa fa-newspaper-o">&nbsp;</i>Blog
                    </a>
                </li>
            
                <li>
                    <a href="/categories">
                        Categories
                    </a>
                </li>
            
                <li>
                    <a href="/about">
                        About
                    </a>
                </li>
            
        </ul>
    </nav>
    <nav class="main">
        <ul>
            
            <li class="search">
                <a class="fa-search" href="#search">Search</a>
                <form id="search" method="get" action="//google.com/search">
                    <input type="text" name="q" placeholder="Search" />
                    <input type="hidden" name="q" value="site:http://jedipunkz.github.io/">
                </form>
            </li>
            <li class="menu">
                <a class="fa-bars" href="#menu">Menu</a>
            </li>
        </ul>
    </nav>
</header>


<section id="menu">

    
        <section>
            <form class="search" method="get" action="//google.com/search">
                <input type="text" name="q" placeholder="Search" />
                <input type="hidden" name="q" value="site:http://jedipunkz.github.io/">
            </form>
        </section>

    
        <section>
            <ul class="links">
                
                    <li>
                        <a href="/post">
                            <h3>
                                
                                    <i class="fa fa-newspaper-o">&nbsp;</i>
                                
                                Blog
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories">
                            <h3>
                                
                                Categories
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/about">
                            <h3>
                                
                                About
                            </h3>
                        </a>
                    </li>
                
            </ul>
        </section>

    
        <section>
            <ul class="links">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    <li>
                        <a href="http://jedipunkz.github.io/blog/2016/07/23/influxdb-go/"><p>Go言語とInfluxDBで監視のコード化</p></a>
                    </li>
                
                    <li>
                        <a href="http://jedipunkz.github.io/blog/2016/07/14/test-kitchen-with-ansible/"><p>Test-Kitchen, Docker で Ansible Role 開発サイクル高速化！</p></a>
                    </li>
                
                    <li>
                        <a href="http://jedipunkz.github.io/blog/2016/07/02/stackstorm/"><p>イベントドリブンな StackStorm で運用自動化</p></a>
                    </li>
                
                    <li>
                        <a href="http://jedipunkz.github.io/blog/2016/06/21/mesos-dcos-vagrant/"><p>Vagrant で Mesosphere DC/OS を構築</p></a>
                    </li>
                
            </ul>
        </section>

    
        
</section>

    
    <div id="main">
        
        
            
        

        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="http://jedipunkz.github.io/blog/2013/02/10/di-11hui-openstack-study11-openstack-chef-repo/">第11回OpenStack勉強会で話してきた</a></h2>
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2013-02-10'>
            February 10, 2013</time>
        <span class="author"></span>
        
            <p>4 minute read</p>
        
        
    </div>
</header>

    

    
    <p>2013年2月9日に行われた OpenStack 勉強会第11回で話してきました。</p>

<p>openstack-chef-repo と言う、Opscode Chef で OpenStack を構築する内容を話して
きました。その時に説明出来なかった詳細についてブログに書いておきます。</p>

<p><iframe src="http://www.slideshare.net/slideshow/embed_code/16434817"
width="427" height="356" frameborder="0" marginwidth="0" marginheight="0"
scrolling="no" style="border:1px solid #CCC;border-width:1px 1px
0;margin-bottom:5px" allowfullscreen webkitallowfullscreen mozallowfullscreen>
</iframe> <div style="margin-bottom:5px"> <strong> <a
href="http://www.slideshare.net/tomokazubobhirai/openstack-chefrepo"
title="Openstack chef-repo" target="_blank">Openstack chef-repo</a> </strong>
from <strong><a href="http://www.slideshare.net/tomokazubobhirai"
target="_blank">Tomokazu Hirai</a></strong> </div></p>

<p>説明で使ったスライドです。</p>

<h2 id="まえがき">まえがき</h2>

<p>Essex ベースで構築することしか今は出来ません。Folsom に関しては &lsquo;直ちに開発が
スタートする&rsquo; と記されていました。今回は Opscode と RackSpace のエンジニアが共
同で開発を進めているので期待しています。今まで個人で OpenStack の各コンポーネ
ントの cookbook を開発されていた方がいらっしゃるのだけど汎用性を持たせるという
意味で非常に難しく、またどの方の開発に追従していけばよいか判断困っていました。
よって今回こそ期待。</p>

<h2 id="前提の構成">前提の構成</h2>

<pre><code>+-------------+
| chef-server |
+-------------+ 10.0.0.10
|
+---------------+ 10.0.0.0/24
|               |
+-------------+ +-------------+
| workstation | |    node     |
+-------------+ +-------------+
10.0.0.11       10.0.0.12
</code></pre>

<ul>
<li>chef-server : chef API を持つ chef-server 。cookbook, role..などのデータを持つ</li>
<li>workstation : openstack-chef-repo を使うノード。knife が使える必要がある。</li>
<li>node        : OpenStack を構築するターゲットノード</li>
</ul>

<h2 id="目次">目次</h2>

<ul>
<li>chef-server の構築 (BootStrap 使う)</li>
<li>openstack-chef-repo を使用する準備</li>
<li>openstack-chef-repo 実行</li>
</ul>

<h2 id="chef-server-の構築">chef-server の構築</h2>

<p>Opscode の wiki に記されている通りなのですが、簡単に書いておきます。今回は
bootstrap 方式で用意します。</p>

<p>chef-server ノードに chef をインストールします。chef-solo を用いるからです。</p>

<pre><code>chef-server# gem install chef
</code></pre>

<p>chef-solo を使うための設定情報を /etc/chef/solo.rb に記します。</p>

<pre><code>chef-server# mkdir /etc/chef
chef-server# ${EDITOR} /etc/chef/solo.rb
file_cache_path &quot;/tmp/chef-solo&quot;
cookbook_path &quot;/tmp/chef-solo/cookbooks&quot;
</code></pre>

<p>chef-solo を実行する際に使う json ファイルを用意します。attribute を上書きする
ことが出来ます。今回は webui を有効にした状態にします。</p>

<pre><code>chef-server# ${EDITOR} ~/chef.json
{
  &quot;chef_server&quot;: {
    &quot;server_url&quot;: &quot;http://localhost:4000&quot;,
    &quot;init_style&quot;: &quot;runit&quot;
  },
  &quot;run_list&quot;: [ &quot;recipe[chef-server::rubygems-install]&quot; ]
}
</code></pre>

<p>bootstrap して chef-server を構築します。</p>

<pre><code>chef-server# chef-solo -c /etc/chef/solo.rb -j ~/chef.json -r http://s3.amazonaws.com/chef-solo/bootstrap-latest.tar.gz
</code></pre>

<p>chef-server が完成したはずです。workstation で knife を使うために &lsquo;client&rsquo; を
作ります。chef 10.x では user ではなく client が knife を実行します。</p>

<pre><code>chef-server% mkdir ~/.chef
chef-server% sudo cp /etc/chef/validation.pem ~/.chef/
chef-server% sudo cp /etc/chef/webui.pem ~/.chef/
chef-server% sudo chown &lt;my-username&gt;:&lt;my-group&gt; ~/.chef
</code></pre>

<p>knife を使うために下記の操作を行います。</p>

<pre><code>chef-server% cd ~
chef-server% knife configure -i
Where should I put the config file? [~/.chef/knife.rb]
Please enter the chef server URL: [http://10.0.0.1:4000]
Please enter a clientname for the new client: [jedipunkz]
Please enter the existing admin clientname: [chef-webui]
Please enter the location of the existing admin client's private key:[/etc/chef/webui.pem] /home/jedipunkz/.chef/webui.pem
Please enter the validation clientname: [chef-validator]
Please enter the location of the validation key:[/etc/chef/validation.pem] /home/jedipunkz/.chef/validation.pem
Please enter the path to a chef repository (or leave blank):
Creating initial API user...
Created client[jedipunkz]
Configuration file written to /home/jedipunkz/.chef/knife.rb
</code></pre>

<p>workstaion ノードで knife を操作するための &lsquo;worker&rsquo; client を作成します。</p>

<pre><code>chef-server% export EDITOR=vim
chef-server% knife client create worker -a -f worker.pem
chef-server% knife client list
  chef-validator
  chef-webui
  chefserver.example.com
  jedipunkz
  worker
</code></pre>

<h2 id="openstack-chef-repo-を使用する準備">openstack-chef-repo を使用する準備</h2>

<p>workstation で openstack-chef-repo を使うための準備をします。</p>

<p>まずは knife を使えるように下記のように knife.rb や pem の手元への転送を行います。</p>

<pre><code>workstation% gem install chef librarian spiceweasel
workstation% cd ~
workstation% git clone git://github.com/opscode/openstack-chef-repo.git
workstation% cd openstack-chef-repo
workstation% vim .chef/knife.rb
log_level                :info
log_location             STDOUT
node_name                'worker'
client_key               '/home/jedipunkz/openstack-chef-repo/.chef/worker.pem'
validation_client_name   'chef-validator'
validation_key           '/home/jedipunkz/openstack-chef-repo/.chef/validation.pem'
chef_server_url          'http://10.0.0.10:4000'
cache_type               'BasicFile'
cache_options( :path =&gt; '/home/jedipunkz/openstack-chef-repo/.chef/checksums' )
cookbook_path           '/home/jedipunkz/openstack-chef-repo/cookbooks'
workstation% scp 10.0.0.10:~/worker.pem .chef/
workstation% scp 10.0.0.10:~/.chef/validation.pem .chef/
</code></pre>

<p>librarian を使って OpenStack 構築に必要な cookbooks をダンロードします。Cheffile
というファイルに何をどこから取得するのか記されいてそれにしたがってダウンロードされます。</p>

<pre><code>workstation% libratrian-chef update
</code></pre>

<p>環境に合わせて production.yml を修正します。今回必要最低限の箇所のみ修正します。
&ldquo;osops_networks&rdquo; という箇所に nova-network に渡すネットワーク情報があるので今回の
環境 10.0.0.0/24 に修正します。全体はこのような内容になります。</p>

<pre><code>workstation% ${EDITOR} production.yml
name &quot;production&quot;
description &quot;Defines the network and database settings you're going to use with OpenStack. The networks will be used in the libraries provided by the osops-utils cookbook. This example is for FlatDHCP with 2 physical networks.&quot;

override_attributes(
  &quot;glance&quot; =&gt; {
    &quot;image_upload&quot; =&gt; true,
    &quot;images&quot; =&gt; [&quot;precise&quot;,&quot;cirros&quot;],
  },
  &quot;mysql&quot; =&gt; {
    &quot;allow_remote_root&quot; =&gt; true,
    &quot;root_network_acl&quot; =&gt; &quot;%&quot;
  },
  &quot;osops_networks&quot; =&gt; {
    &quot;public&quot; =&gt; &quot;10.0.0.0/24&quot;,
    &quot;management&quot; =&gt; &quot;10.0.0.0/24&quot;,
    &quot;nova&quot; =&gt; &quot;10.0.0.0/24&quot;
  },
  &quot;nova&quot; =&gt; {
    &quot;network&quot; =&gt; {
      &quot;fixed_range&quot; =&gt; &quot;192.168.100.0/24&quot;,
      &quot;public_interface&quot; =&gt; &quot;eth0&quot;
    },
    &quot;networks&quot; =&gt; [
      {
        &quot;label&quot; =&gt; &quot;public&quot;,
        &quot;ipv4_cidr&quot; =&gt; &quot;192.168.100.0/24&quot;,
        &quot;num_networks&quot; =&gt; &quot;1&quot;,
        &quot;network_size&quot; =&gt; &quot;255&quot;,
        &quot;bridge&quot; =&gt; &quot;br100&quot;,
        &quot;bridge_dev&quot; =&gt; &quot;eth0&quot;,
        &quot;dns1&quot; =&gt; &quot;8.8.8.8&quot;,
        &quot;dns2&quot; =&gt; &quot;8.8.4.4&quot;
      }
    ]
  }
  )  
</code></pre>

<p>infrastructure.yml という spiceweasel が参照するファイルの修正を行います。
cookbooks, roles, environments, data bags, node とパラメータがあり node
のみ記されていないので今回用意したターゲットノードの情報を追記します。</p>

<p>node には予め SSH 公開鍵を設置する必要があります。また下記は root ユーザでログ
インしていますが、sudo してもらっても構わないです。role で指定した &lsquo;allinone&rsquo;
は OpenStack の全てのコンポーネントを一台のノードにインストールするためのもの
です。これを他の role 例えば &lsquo;keystone&rsquo; 等を指定して複数のノードに OpenStack
を展開することも可能なはずです。試していませんが。</p>

<pre><code>workstation% vim infrastructure.yml
... 省略
nodes:
- 10.0.0.12:
  run_list: role[allinone]
  options: -i ~/.ssh/id_rsa -x root -E production
</code></pre>

<h2 id="openstack-chef-repo-実行">openstack-chef-repo 実行</h2>

<p>準備が整ったので spiceweasel を使って knife コマンドの出力チェックと実行をして
みます。先ほど追記した infrastructure.yml を使います。</p>

<pre><code>workstation% spiceweasel infrastructure.yml
knife cookbook upload apache2
knife cookbook upload apt
knife cookbook upload aws
knife cookbook upload build-essential
knife cookbook upload ntp
knife cookbook upload openssh
knife cookbook upload openssl
knife cookbook upload postgresql
knife cookbook upload selinux
knife cookbook upload xfs
knife cookbook upload yum
knife cookbook upload erlang
knife cookbook upload mysql
knife cookbook upload rabbitmq
knife cookbook upload database
knife cookbook upload omnibus_updater
knife cookbook upload lxc
knife cookbook upload sysctl
knife cookbook upload osops-utils
knife cookbook upload mysql-openstack
knife cookbook upload rabbitmq-openstack
knife cookbook upload keystone
knife cookbook upload glance
knife cookbook upload nova
knife cookbook upload horizon
knife environment from file production.rb
knife role from file base.rb
knife role from file lxc.rb
knife role from file mysql-master.rb
knife role from file rabbitmq-server.rb
knife role from file keystone.rb
knife role from file glance-api.rb
knife role from file glance-registry.rb
knife role from file glance.rb
knife role from file nova-setup.rb
knife role from file nova-scheduler.rb
knife role from file nova-api-ec2.rb
knife role from file nova-api-os-compute.rb
knife role from file nova-volume.rb
knife role from file nova-vncproxy.rb
knife role from file horizon-server.rb
knife role from file single-controller.rb
knife role from file single-compute.rb
knife role from file allinone.rb
knife bootstrap 10.0.0.12 -i ~/.ssh/id_rsa -x root -E production -r 'role[allinone]'  
</code></pre>

<p>この操作で spiceweasel は role ファイルの中身と yml ファイルを読み、依存関係を
チェックしてくれます。</p>

<p>ではいよいよ実行。</p>

<pre><code>workstaion% spiceweasel -e infrastructure.yml
</code></pre>

<p>数分で OpenStack 環境が構築出来ると思います。</p>

<h2 id="所感">所感</h2>

<p>現時点ではまだ essex ベースの OpenStack しか構築出来ない。folsom 以降について
は直ちに行われる。また先にも記したが Opscode と RackSpace のエンジニアが共同で
作業に入ったので今後に期待。複数の OpenStack cookboooks を見てきたが個人で開発
するのは厳しいと感じています。fedra, centos, ubuntu, debian &hellip; いろんなプラッ
トフォームを前提に開発するのは厳しい&hellip;。pull request する余力があればやってみ
たい。また合わせて各コンポーネントの cookbooks についても同様に参加していきた
い。</p>

<p>chef は繰り返し実行されるので継続的にデプロイが可能であり、chef Resources が我々
の操作を抽象化してくれる。尚且つ API で開発も容易になる。学習コストは若干高い
し、cookbooks の開発も正直しんどい。だけどインフラを chef でコントロールする意
味はとても大きい。その他のメリットとして属人的な操作に依存したシステムを無くす
という事もある。</p>

<p>OpenStack のドキュメントにはデプロイ方法として dodai-deploy と puppet が掲載さ
れている。chef は載っていない。これは cookbooks の開発が遅れている状況が理由に
あると思う。今回 Opscode の中の Matt Ray さんの下記の資料</p>

<p><a href="http://www.slideshare.net/mattray/chef-11-previewchef-for-openstack">http://www.slideshare.net/mattray/chef-11-previewchef-for-openstack</a></p>

<p>を見て、これからに期待したいと感じた。</p>

    <footer>
        <ul class="actions">
            <li><a href="http://jedipunkz.github.io/blog/2013/02/10/di-11hui-openstack-study11-openstack-chef-repo/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    

                    

                    
                        Categories
                    
                
            </li>
        
    

    
    
        <li><a href='/categoriesinfrastructure'>infrastructure</a></li>
    
        <li><a href='/categoriesreport'>report</a></li>
    
</ul>

    </footer>
</article>

        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="http://jedipunkz.github.io/blog/2013/02/01/spiceweasel-knife-bootstrap/">Spiceweasel で knife バッチ処理</a></h2>
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2013-02-01'>
            February 1, 2013</time>
        <span class="author"></span>
        
            <p>2 minute read</p>
        
        
    </div>
</header>

    

    
    <p>Spiceweasel <a href="https://github.com/mattray/spiceweasel#cookbooks">https://github.com/mattray/spiceweasel#cookbooks</a> を使ってみた。</p>

<p>Spiceweasel は Chef の cookbook のダウンロード, role/cookbook の chef server
へのアップロード, ブートストラップ等をバッチ処理的に行なってくれる(もしくはコ
マンドラインを出力してくれる)ツールで、自分的にイケてるなと感じたのでブログに
書いておきます。</p>

<p>クラウドフェデレーション的サービスというかフロントエンドサービスというか、複数
のクラウドを扱えるサービスは増えてきているけど、chef を扱えるエンジニアであれ
ば、この Spiceweasel で簡単・一括デプロイ出来るので良いのではないかと。</p>

<p>早速だけど chef-repo にこんな yamp ファイルを用意します。</p>

<pre><code>cookbooks:
- apt:
- nginx:

roles:
- base:

nodes:
- 172.24.17.3:
    run_list: role[base]
    options: -i ~/.ssh/testkey01 -x root -N webset01
- 172.24.17.4:
    run_list: role[base]
    options: -i ~/.ssh/testkey01 -x root -N webset02
</code></pre>

<p>上から説明すると&hellip;</p>

<ul>
<li>&lsquo;apt&rsquo;, &lsquo;nginx&rsquo; の cookbook を opscode レポジトリからダウンロード</li>
<li>&lsquo;apt&rsquo;, &lsquo;nginx&rsquo; の cookbook を chef-server へアップロード</li>
<li>roles/base.rb を chef-server へアップロード</li>
<li>2つのノードに対して bootstrap 仕掛ける</li>
</ul>

<p>ってことをやるためのファイルです。予め chef-repo と roles は用意してあげる必要
があります。この辺りは knife の操作のための準備と全く同じ。また Spiceweasel は、
この yaml フィアル内の各パラメータや指定した role の内容の依存関係をチェックし
てくれます。</p>

<p>では、このファイルに対して</p>

<pre><code>% spiceweasel &lt;yaml ファイル名&gt;
</code></pre>

<p>すると、結果として下記のようなバッチが取得出来る。</p>

<pre><code>knife cookbook site download apt  --file cookbooks/apt.tgz
tar -C cookbooks/ -xf cookbooks/apt.tgz
rm -f cookbooks/apt.tgz
knife cookbook upload apt
knife cookbook site download test  --file cookbooks/test.tgz
tar -C cookbooks/ -xf cookbooks/test.tgz
rm -f cookbooks/test.tgz
knife cookbook upload test
knife role from file base.rb
knife bootstrap 172.24.17.3 -i ~/.ssh/testkey01 -x root -N webset01 -r 'role[base]'
knife bootstrap 172.24.17.4 -i ~/.ssh/testkey01 -x root -N webset02 -r 'role[base]'
</code></pre>

<p>尚且つ -e オプションを指定すると、実際にこれらのバッチを実行出来る。cookbooks
ディレクトリに予めレシピが存在すればダウンロードのバッチは省略されるぽいし、-d
を指定すると逆にノード削除バッチ処理、-r でリビルドのためのバッチ処理が得られ
る。</p>

<p>削除系・リビルド系は現時点では不具合が見られました。実行すると他の環境にも影響
出るので注意が必要。</p>

<p>個人的にはプライベートレポジトリの cookbooks も取ってこれるようになると嬉しい。
まぁ、Berkshelf 使えばいいのだけど。<a href="http://berkshelf.com/">http://berkshelf.com/</a></p>

<p>開発者の Matt Ray さんの資料によれば Chef for OpenStack もこの Spiceweasel を
使う方向で修正が掛かったらしい。個人的には一番興味あるところ。ちなみに Chef
for OpenStack は folsom ベースが現在 &lsquo;active development&rsquo; 状態らしい。</p>

<p>Opscode のサイトで紹介されているサンプルは古いバージョンでの指定方法らしく、注
意が必要です。</p>

<p><a href="http://wiki.opscode.com/display/chef/Spiceweasel">http://wiki.opscode.com/display/chef/Spiceweasel</a></p>

<h4 id="所感">所感</h4>

<p>chef, knife 周りはいろんな関連技術があるので技術を選定する上で迷ってしまうこと
が多いのだけど、この Spiceweasel には可能性を感じました。って言うのは、Chef が
実装出来ていないインテグレーションやオーケストレーションっていう所まで踏み込め
る可能性があるから。ノード間の関連付けが出来るんです。Swift-Storage と
Swift-Proxy の関連付け、または Load-Balancer と HTTP-Server の関連付け等。継続
的デリバリなインテグレーションって Chef を使ってどう実現するんだ？って思ってい
た時があったのですが、こういったラッパーツールの登場で解決されそうな気がします。</p>

    <footer>
        <ul class="actions">
            <li><a href="http://jedipunkz.github.io/blog/2013/02/01/spiceweasel-knife-bootstrap/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    

                    

                    
                        Categories
                    
                
            </li>
        
    

    
    
        <li><a href='/categoriesinfrastructure'>infrastructure</a></li>
    
        <li><a href='/categoriestools'>tools</a></li>
    
</ul>

    </footer>
</article>

        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="http://jedipunkz.github.io/blog/2013/01/14/arch-linux-setup/">Arch Linux セットアップまとめ</a></h2>
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2013-01-14'>
            January 14, 2013</time>
        <span class="author"></span>
        
            <p>3 minute read</p>
        
        
    </div>
</header>

    

    
    <p>(2013/08/31 修正しました)</p>

<p>自宅のノート PC にいつも Debian Gnu/Linux unstable を入れて作業してたのだけど、
Arch Linux が試したくなって入れてみた。すごくイイ。ミニマル思考で常に最新。端
末に入れる OS としては最適かも!と思えてきた。Ubuntu はデスクトップ環境で扱う
にはチト大きすぎるし。FreeBSD のコンパイル待ち時間が最近耐えられないし&hellip;。</p>

<p>前リリースの Arch Linux には /arch/setup という簡易インストーラがあったのだけ
ど、それすら最近無くなった。環境作る方法を自分のためにもメモしておきます。</p>

<h4 id="os-イメージ-iso-取得とインストール用-usb-スティック作成">OS イメージ iso 取得とインストール用 USB スティック作成</h4>

<p>Linux, Windows, Mac で作り方が変わるようだけど、自分は Mac OSX を使ってインス
トール USB スティックを作成した。</p>

<p>diskutil で USB スティック装着前後の disk デバイス番号を覚える</p>

<pre><code>% diskutil list
</code></pre>

<p>(ここでは /dev/rdisk4 として進める。)</p>

<p>アンマウントする。</p>

<pre><code>% sudo diskutil unmountDisk /dev/rdisk4
</code></pre>

<p>ダウンロードした iso を USB スティックに書き込む。</p>

<pre><code>% sudo dd if=/path/to/downloaded/iso of=/dev/rdisk4 bs=8192
% sudo diskutil eject /dev/rdisk4
</code></pre>

<h4 id="usb-スティック装着しインストール開始">USB スティック装着しインストール開始</h4>

<p>起動するとメニューが表示されるので x86_64 を選んで起動。プロンプトが表示される。</p>

<p>まず disk のパーティション作成。</p>

<pre><code># fdisk /dev/sda # 環境に合わせてデバイス名変更
# fdisk -l /dev/sda
デバイス ブート      始点        終点     ブロック   Id  システム
/dev/sda1            2048     4196351     2097152   82  Linux スワップ / Solaris
/dev/sda2   *     4196352   156301487    76052568   83  Linux
</code></pre>

<p>上記のように切りました。fdisk の使い方は&hellip;ぐぐってください。また /boot にあたるパーティション
にブートフラグを必ず付けること。</p>

<p>ファイルシステムを作ってマウント。</p>

<pre><code># mkfs.ext4 /dev/sda2
# mount -t ext4 /dev/sda2 /mnt
</code></pre>

<p>コアシステムのインストール</p>

<pre><code># pacstrap /mnt base base-devel
</code></pre>

<p>fstab の配置。必要に応じて /dev/sda1 (上記で作った) をスワップとして加筆。</p>

<pre><code># genfstab -p /mnt &gt;&gt; /mnt/etc/fstab
</code></pre>

<h4 id="chroot-して-dev-sda2-内コアシステムで作業">chroot して /dev/sda2 内コアシステムで作業</h4>

<p>chroot する。</p>

<pre><code># arch-chroot /mnt
</code></pre>

<p>キーマップを us 配列で CTRL と Caps をスワップしたいので下記の作業を実施。</p>

<pre><code># cd /usr/share/kbd/keymaps/i386/qwerty
# cp us.map.gz usx.map.gz
# gunzip usx.map.gz
# vi usx.map
keycode  58 = Control # Caps_Lock を Control に置き換え
# gzip usx.map
# loadkeys usx # キーマップをロード
# vi /etc/vconsole.conf
KEYMAP=usx # 追記
</code></pre>

<p>ロケールの生成。</p>

<pre><code># vi /etc/locale.gen # ja_JP.UTF-8 のコメントアウトを削除
# locale-gen
</code></pre>

<p>タイムゾーンの設定。</p>

<pre><code># ln -s /usr/share/zoneinfo/Asia/Tokyo /etc/localtime
</code></pre>

<p>ホスト名修正。</p>

<pre><code># echo &quot;&lt;ホスト名&gt;&quot; &gt; /etc/hostname
# vi /etc/hosts # 適宜修正
</code></pre>

<p>ネットワークの設定。まずは有線。</p>

<pre><code># systemctl enable dhcpcd@eth0.service
</code></pre>

<p>ブートローダとして syslinux を使う。ディスクデバイス名だけ修正。syslinux のインストーラが
うまくデバイス名を拾ってくれない。</p>

<pre><code># pacman -S syslinux
# vi /boot/syslinux/syslinux.cfg
LABEL arch
    MENU LABEL Arch Linux
    LINUX ../vmlinuz-linux
    APPEND root=/dev/sda2 ro
    INITRD ../initramfs-linux.img
</code></pre>

<p>パスワード設定。</p>

<pre><code># passwd
</code></pre>

<h4 id="再起動し-システムをインストールした-dev-sda2-で起動する">再起動し システムをインストールした /dev/sda2 で起動する。</h4>

<p>再起動し USB スティックを抜く。起動したら root ユーザでログイン。</p>

<p>無線デバイスの設定。</p>

<pre><code># pacman -S dialog wpa_supplicant
# wifi-menu
</code></pre>

<p>検知されたアクセスポイント名が表示されるので希望のモノを選択しパスフレーズを入力。</p>

<p>一般ユーザの作成と sudo 設定。</p>

<pre><code># useradd -u &lt;UID) -d /home/&lt;UESRNAME&gt; -m &lt;USERNAME&gt;
# passwd &lt;USERNAME&gt;
# pacman -S sudo
# vigr # wheel グループに自分を追記
# visudo # wheel のところのコメントアウトを削除
%wheel ALL=(ALL) ALL
</code></pre>

<h4 id="x-周りの設定">X 周りの設定</h4>

<p>X とウィンドウマネージャのインストール。ウィンドウマネージャは好きなものを。私
は awesome を選びました。</p>

<pre><code># pacman -S xorg xorg-xinit xterm rxvt-unicode xf86-video-intel awesome
</code></pre>

<p>日本語フォントのインストールと日本語インプットメソッドの設定。ibus と mozc を選んだ。
結構賢い。とりあえずのフォントとして sazanami を。</p>

<pre><code># vi /etc/pacman.conf # 下記のレポジトリを追記
[pnsft-pur]
SigLevel = Optional TrustAll
Server = http://downloads.sourceforge.net/project/pnsft-aur/pur/$arch
# pacman -Syy
# pacman -S ttf-sazanami ibus-mozc mozc
</code></pre>

<p>一般ユーザの ~/.xinitrc に下記を追記。</p>

<pre><code>% vi ~/.xinitrc
xrdb -merge $HOME/.Xresources

export LANG=ja_JP.UTF-8
export LANGUAGE=ja_JP.UTF-8
export LC_ALL=ja_JP.UTF-8
export LC_CTYPE=ja_JP.UTF-8

export GTK_IM_MODULE=ibus
export QT_IM_MODULE=xim
export XMODIFIERS=@im=ibus
ibus-daemon --daemonize --xim &amp;

setxkbmap -layout us -option ctrl:nocaps
exec awesome
</code></pre>

<p>X を起動。</p>

<pre><code>% startx
</code></pre>

<p>私は awesome を選びましたが、たまに enlightenment も選択します。この時点で enlightenment の
メニューなど、日本語化されているはずだが、厳しければ</p>

<p><a href="https://wiki.archlinux.org/index.php/Input_Japanese_using_uim_(%E6%97%A5%E6%9C%AC%E8%AA%9E)">https://wiki.archlinux.org/index.php/Input_Japanese_using_uim_(%E6%97%A5%E6%9C%AC%E8%AA%9E)</a></p>

<p>にある IPA フォント、VL ゴシックなどを入れる。こちらのほうが数段綺麗。</p>

<p>IPA フォントの入れ方だけメモっておく。</p>

<pre><code>% wget https://aur.archlinux.org/packages/ot/otf-ipafont/otf-ipafont.tar.gz
% tar zxvf otf-ipafont.tar.gz
% cd otf-ipafont
% makepkg -s
% sudo pacman -U &lt;生成された pkg.tar.xz ファイル&gt;
</code></pre>

<p>Thinkpad の真ん中ボタンでスクロールする。</p>

<pre><code># vi /etc/X11/xorg.conf.d/10-thinkpad.conf # 新規生成
Section &quot;InputClass&quot;
  Identifier &quot;Trackpoint Wheel Emulation&quot;
  MatchProduct &quot;TPPS/2 IBM TrackPoint|DualPoint Stick|Synaptics Inc. Composite TouchPad / TrackPoint|ThinkPad USB Keyboard with TrackPoint|USB Trackpoint pointing device|Composite TouchPad / TrackPoint&quot;
  MatchDevicePath &quot;/dev/input/event*&quot;
  Option  &quot;EmulateWheel&quot;  &quot;true&quot;
  Option  &quot;EmulateWheelButton&quot; &quot;2&quot;
  Option  &quot;Emulate3Buttons&quot; &quot;false&quot;
  Option  &quot;XAxisMapping&quot;  &quot;6 7&quot;
  Option  &quot;YAxisMapping&quot;  &quot;4 5&quot;
EndSection
</code></pre>

<p>X の再起動をして終了。</p>

<h4 id="まとめ">まとめ</h4>

<p>今回はブログというより雑多なまとめになったけど、メモするだけでも意味があるので
残しておいた。Debian / Ubuntu より手間は掛かるけど、エンジニアが何をやっている
か掴めるのでいいカンジ。無駄なプロセスいないので起動もめちゃ速いし。何より最新
のソフトウェア (安定したもの) が簡単に使えるのは嬉しい。ここに書いた手順は時間
がすぎるに連れて意味がないものになっていくだろう。開発が活発でここ数年でも結構
劇的にシステムが変更になってるみたい。systemd .. とか。理解するのに苦労する所
はないので、エンジニアであれば誰でも扱えそうなところも魅力。</p>

<p>OS なんて何でもいい時代 (抽象化されつつあるから) だけど、手元の端末に入れる OS
だけは Arch Linux がいいなぁ。</p>

    <footer>
        <ul class="actions">
            <li><a href="http://jedipunkz.github.io/blog/2013/01/14/arch-linux-setup/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    

                    

                    
                        Category
                    
                
            </li>
        
    

    
    
        <li><a href='/categoriesinfrastructure'>infrastructure</a></li>
    
</ul>

    </footer>
</article>

        

        
<ul class="actions pagination">
    
        <li><a href="/page/25/"
                class="button big previous">Previous Page</a></li>
    

    
        <li><a href="/page/27/"
                class="button big next">Next Page</a></li>
    
</ul>

    </div>
    
<section id="sidebar">

    
        <section id="intro">
            
            
                
                    <img src="/pix/jedipunkz.jpg" class="intro-circle" width="250" alt="jedipunkz icon" />
                
            
            
                <header>
                    <h2></h2>
                    <p>ジェダイさんです。インフラエンジニアからインフラ寄りのソフトウェアエンジニアになるために勉強していきます。</p>
                </header>
            
            <ul class="icons">
                
                    <li><a href="http://jedipunkz.github.io/index.xml" type="application/rss+xml"
                        target="_blank" title="RSS" class="fa fa-rss"></a></li>
                
                
                    
<li><a href="//github.com/jedipunkz" target="_blank" title="GitHub" class="fa fa-github"></a></li>

















































<li><a href="//twitter.com/jedipunkz" target="_blank" title="Twitter" class="fa fa-twitter"></a></li>




                
            </ul>
        </section>

    
        <section id="recent-posts">
            <ul class="posts">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    
                

                
                    <li>
                        <article>
                            <header>
                                <h3><a href="http://jedipunkz.github.io/blog/2016/07/23/influxdb-go/">Go言語とInfluxDBで監視のコード化</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2016-07-23'>
                                    July 23, 2016</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="http://jedipunkz.github.io/blog/2016/07/14/test-kitchen-with-ansible/">Test-Kitchen, Docker で Ansible Role 開発サイクル高速化！</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2016-07-14'>
                                    July 14, 2016</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="http://jedipunkz.github.io/blog/2016/07/02/stackstorm/">イベントドリブンな StackStorm で運用自動化</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2016-07-02'>
                                    July 2, 2016</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="http://jedipunkz.github.io/blog/2016/06/21/mesos-dcos-vagrant/">Vagrant で Mesosphere DC/OS を構築</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2016-06-21'>
                                    June 21, 2016</time>
                            </header>
                        </article>
                    </li>
                

                
                    <li>
                        <ul class="actions">
                            <li><a href=
                            
                                /post/
                            
                            class="button">View more posts</a></li>
                        </ul>
                    </li>
                
            </ul>
        </section>

    
    
    
    
        <section id="categories">
            <ul class="posts">
                <header>
                    <h3><a href="/categories/">Categories</a></h3>
                </header>

                
                    
                

                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/infrastructure/">infrastructure</a>
                                <span style="float:right;">101</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/tools/">tools</a>
                                <span style="float:right;">11</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/report/">report</a>
                                <span style="float:right;">9</span>
                            </header>
                        </article>
                    </li>
                
            </ul>
        </section>
    

    
        
        <section class="blurb">
            <h2>About</h2>
            <p>ソフトウェア寄りのエンジニアになるため勉強をしています。勉強したことをメモしていければと思います。</p>

            <ul class="actions">
                <li><a href="/about/" class="button">Learn More</a></li>
            </ul>
        </section>
        

    
        <section id="footer">
            <ul class="icons">
                
                    <li><a href="http://jedipunkz.github.io/index.xml" type="application/rss+xml"
                        target="_blank" title="RSS" class="fa fa-rss"></a></li>
                
                
                    
<li><a href="//github.com/jedipunkz" target="_blank" title="GitHub" class="fa fa-github"></a></li>

















































<li><a href="//twitter.com/jedipunkz" target="_blank" title="Twitter" class="fa fa-twitter"></a></li>




                
            </ul>

            <p class="copyright">&copy; ジェダイさんのブログ. テーマデザインは <a href="//github.com/jpescador" target="_blank">Julio Pescador</a>さんによるものです。 </p>
        </section>

</section>

            </div>
        <a id="back-to-top" href="#" class="fa fa-arrow-up fa-border fa-2x"></a>
        

        
        
            
        

        
        
            <script src="/js/jquery.min.js"></script>
            <script src="/js/skel.min.js"></script>
            <script src="/js/util.js"></script>
            <script src="/js/main.js"></script>
            <script src="/js/backToTop.js"></script>
            <script src="/js/highlight.pack.js"></script>
        

        

            
            <script>hljs.initHighlightingOnLoad();</script>
            
    </body>
</html>

