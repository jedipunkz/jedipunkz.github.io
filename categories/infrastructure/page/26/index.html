


    
        
    




<!DOCTYPE HTML>

<html>
    <head>
        
            <title>infrastructure Posts - ジェダイさんのブログ</title>
        

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="generator" content="Hugo 0.18" />
        


        
        
            
                <meta name="description" content="技術ネタを書いていきます">
            
        

        
        <meta property="og:title" content="infrastructure" />
<meta property="og:description" content="技術ネタを書いていきます" />
<meta property="og:type" content="website" />
<meta property="og:url" content="http://jedipunkz.github.io/categories/infrastructure/" />


<meta property="og:updated_time" content="2013-03-17T00:00:00&#43;00:00"/>









        
<meta itemprop="name" content="infrastructure">
<meta itemprop="description" content="技術ネタを書いていきます">


        

        

        
        
            
        

        
        
            <link rel="stylesheet" href="/css/google-font.css" />
            <link rel="stylesheet" href="/css/font-awesome.min.css" />
            <link rel="stylesheet" href="/css/main.css" />
            <link rel="stylesheet" href="/css/add-on.css" />
            <link rel="stylesheet" href="/css/monokai-sublime.css">
        

        

        
        
        
            
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-30563095-1', 'auto');
ga('send', 'pageview');
</script>

        
    </head>
    <body>

        
        <div id="wrapper">

    
<header id="header">
    
        <h2><a href="/">ジェダイさんのブログ</i></a></h2>
    

    <nav class="links">
        <ul>
            
                <li>
                    <a href="/post">
                        
                            <i class="fa fa-newspaper-o">&nbsp;</i>Blog
                    </a>
                </li>
            
                <li>
                    <a href="/categories">
                        Categories
                    </a>
                </li>
            
                <li>
                    <a href="/about">
                        About
                    </a>
                </li>
            
        </ul>
    </nav>
    <nav class="main">
        <ul>
            
            <li class="search">
                <a class="fa-search" href="#search">Search</a>
                <form id="search" method="get" action="//google.com/search">
                    <input type="text" name="q" placeholder="Search" />
                    <input type="hidden" name="q" value="site:http://jedipunkz.github.io/">
                </form>
            </li>
            <li class="menu">
                <a class="fa-bars" href="#menu">Menu</a>
            </li>
        </ul>
    </nav>
</header>


<section id="menu">

    
        <section>
            <form class="search" method="get" action="//google.com/search">
                <input type="text" name="q" placeholder="Search" />
                <input type="hidden" name="q" value="site:http://jedipunkz.github.io/">
            </form>
        </section>

    
        <section>
            <ul class="links">
                
                    <li>
                        <a href="/post">
                            <h3>
                                
                                    <i class="fa fa-newspaper-o">&nbsp;</i>
                                
                                Blog
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories">
                            <h3>
                                
                                Categories
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/about">
                            <h3>
                                
                                About
                            </h3>
                        </a>
                    </li>
                
            </ul>
        </section>

    
        <section>
            <ul class="links">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    <li>
                        <a href="http://jedipunkz.github.io/blog/2016/12/29/fluentd-sidecar-gcp/"><p>fluentd-sidecar-gcp と Kubernetes Volumes で Cloud Logging ログ転送</p></a>
                    </li>
                
                    <li>
                        <a href="http://jedipunkz.github.io/blog/2016/12/29/cloud-cdn/"><p>Google Cloud CDN を使ってみた</p></a>
                    </li>
                
                    <li>
                        <a href="http://jedipunkz.github.io/blog/2016/11/27/etcd-operator/"><p>coreos の etcd operator を触ってみた</p></a>
                    </li>
                
                    <li>
                        <a href="http://jedipunkz.github.io/blog/2016/11/20/helm/"><p>Helm を使って Kubernetes を管理する</p></a>
                    </li>
                
            </ul>
        </section>

    
        
</section>

    
    <div id="main">
        <h1>infrastructure</h1>
        
        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="http://jedipunkz.github.io/blog/2013/03/17/berkshelf-chef-cookbook-manage/">Berkshelf で Chef Cookbook の管理</a></h2>
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2013-03-17'>
            March 17, 2013</time>
        <span class="author"></span>
        
            <p>1 minute read</p>
        
        
    </div>
</header>

    

    
    <p>こんにちは。<a href="https://twitter.com/jedipunkz">@jedipunkz</a> です。</p>

<p>今日は Chef Cookbook の管理をしてくれる Berkshelf について。</p>

<p>Berkshelf は Librarian-Chef と同じく Cookbook の管理をしてくれるツールです。依
存関係のクリアもしてくれます。Opscode の中の人 @someara さんにこんなこと言われ
て、</p>

<p><blockquote class="twitter-tweet" lang="ja"><p>@<a
href="https://twitter.com/jedipunkz">jedipunkz</a> berkshelf &gt;
librarian-chef</p>&mdash; somearaさん (@someara) <a
href="https://twitter.com/someara/status/298664663976120321">2013年2月5日
</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></p>

<p>Librarian-chef じゃなくて Berkshelf 使えってことだろうなぁと思ったので僕は
Bekshelf を使うようにしてます。先日ブログ記事にした openstack-chef-repo も以前
は Librarian-chef を使っていたのですが最近 Berkshelf に置き換わりました。
openstack-chef-repo は Opscode の中の人の @mattray さん達が管理しています。</p>

<p>では早速。</p>

<h2 id="インストール">インストール</h2>

<p>インストールは簡単。gem install するだけです。</p>

<pre><code>% gem install berkshelf
</code></pre>

<h2 id="使い方">使い方</h2>

<p>chef-repo 配下で Berksfile を下記のように書きます。</p>

<pre><code>site :opscode

cookbook 'chef-client'
cookbook 'nginx', '= 0.101.2'
</code></pre>

<p>berks コマンドを実行して Cookbooks をダウンロードします。</p>

<pre><code>% export BERKSHELF_PATH=/Users/jedipunkz/chef-repo
% berks install
</code></pre>

<p>それぞれ依存関係のある Cookbook 達もダウンロードされます。これでいちいち依存を
解決しつつダウンロードなんてこともしなくて済む。</p>

<p>ここで言えるのは chef-repo とこの Berksfile だけ git 等で管理すれば良いという
こと。Cookbooks 達はそれぞれ別のレポジトリに git で管理する形が良いと思う。
プロジェクトで chef を使っていて chef-repo ごと管理しがちだと思うけど、この方
が Cookbook を他のプロジェクトでも使いまわせるメリットがある。</p>

<h2 id="opscode-コミュニティ管理外の-cookbooks">opscode コミュニティ管理外の Cookbooks</h2>

<p>自分で管理している cookbook 等も Berkshelf で管理出来ます。下記のように書くと、</p>

<pre><code>site : opscode

cookbook 'chef-client'
cookbook 'nginx', '= 0.101.2'
cookbook &quot;pxe_install_server&quot;, git: 'https://github.com/jedipunkz/pxe_install_server'
</code></pre>

<p>github から直接 git clone をしてくれます。</p>

<h2 id="cookbooks-のアップデート">Cookbooks のアップデート</h2>

<p>Cookbook は独立した git レポジトリで管理すると良いと書きましたが、それぞれの
Cookbooks は自分が若しくは他人が開発が進むので berks を使って最新の Cookbooks
にアップデートすることも出来る。</p>

<pre><code>% berks update
</code></pre>

<h2 id="バージョン指定">バージョン指定</h2>

<p>Cookbook のバージョン指定ももちろん出来る。先の例では</p>

<pre><code>cookbook 'nginx', '= 0.101.2'
</code></pre>

<p>では 0.101.2 と言うバージョンを指定した。その他</p>

<ul>
<li>Equal to (=)</li>
<li>Greater than (&gt;)</li>
<li>Greater than equal to (&lt;)</li>
<li>Less than (&lt;)</li>
<li>Less than equal to (&lt;=)</li>
<li>Pessimistic (~&gt;)</li>
</ul>

<p>が指定出来るようだ。</p>

<h2 id="まとめ">まとめ</h2>

<p>Cookbooks の管理は今のところ Berkshelf だけで OK。紹介したもの以外にも幾つか機
能があるので公式のサイトで確認してみて欲しい。個人的には path: 指定が
Berksfile で出来ないのが不便。公式のサイトには一応記述あるのだが動かなかった。
そのうち改善されるだろう。また Chef サーバに Cookbooks をアップロードする機能
もあるが、まぁこれは knife でも出来るしいいか。一番欲しかったのは &lsquo;依存関係の
クリア&rsquo; だったので。また Berksfile, Berksfile.lock のファイルさえプロジェクト
で管理すれば良いと言うのが個人的には綺麗になるなぁという印象。</p>

<p>昔、Linux の rpm コマンドでパッケージを入れてて依存関係にあるパッケージをコマ
ンド打つたびにダウンロードして&hellip;と言う問題を yum が解決してくれて。それに似て
るなぁと見ていて思った。</p>

    <footer>
        <ul class="actions">
            <li><a href="http://jedipunkz.github.io/blog/2013/03/17/berkshelf-chef-cookbook-manage/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    

                    

                    
                        Category
                    
                
            </li>
        
    

    
    
        <li><a href='/categoriesinfrastructure'>infrastructure</a></li>
    
</ul>

    </footer>
</article>


        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="http://jedipunkz.github.io/blog/2013/03/15/chef-contenuously-deploy/">chef-client の継続的デリバリ</a></h2>
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2013-03-15'>
            March 15, 2013</time>
        <span class="author"></span>
        
            <p>3 minute read</p>
        
        
    </div>
</header>

    

    
    <p>こんにちは。<a href="https://twitter.com/jedipunkz">@jedipunkz</a> です。</p>

<p>久々に Chef の話題。</p>

<p>有名な方々が最近 Chef について記事書いたりで Chef が再び盛り上がってきましたね。
僕のブログにも chef-solo で検索してアクセスしてくる方が増えているようです。</p>

<p>ちょうど今、仕事で試験的なサービスを立ち上げてそこで Chef を使っているのですが Server,
Workstation, Target Node(s) の構成で使っていて、僕らは最初から chef-solo と
capistrano でってことは考えていませんでした。もちろん chef-solo + capistrano
の環境も調査しましたが、今の Server 構成が便利なのでもう戻れない。</p>

<p>今日は Chef サーバ構成の良さについての記事ではないですが、それについては次回、
時間見つけて書こうかと思ってます。</p>

<p>今日は &lsquo;chef-client をどうアップデートするか&rsquo; について。せっかく Chef
でサーバ構成を継続的にデプロイ出来ても Chef 自身をアップデート出来ないと悲しい
ですよね。chef-client が稼働しているインスタンスなんて起動して利用してすぐに破
棄だって時代ですが、なかなかそうもいなかい気がしています。</p>

<p>「ほら、だから chef-solo 使えばいいんだよ！」って思ってるあなた！違うんですよー。
そのデメリットを上回るメリットが Chef サーバ構成にあるんです。次回書きますｗ</p>

<p>Chef10 から Chef11 と試験してみるにはちょうど良い時期でした。今回の構成は&hellip;</p>

<h2 id="旧環境">旧環境</h2>

<pre><code>+------------------+
|   chef server    |
|  version 10.18   |
+------------------+
^
|
+--------------------+
|                    |
|                    |
+------------------+ +------------------+
| chef workstation | |   target node    |
|  version 10.24   | |  version 10.24   |
+------------------+ +------------------+
</code></pre>

<ul>
<li>chef server は apt.opscode.com レポジトリを利用した Chef 10.18 なもの</li>
<li>chef workstaion は version 10.24 (2013年3月15日現在 10.x 系最新)</li>
<li>target node は chef workstaion から knife bootstrap を行い構成</li>
</ul>

<p>knife bootstrap の際に下記のオプションを指定します。</p>

<pre><code>% knife bootstrap -N vmtest01 -r 'role[base]' \ -i -x root -d chef-full
</code></pre>

<p>distro は chef-full を選択。chef-full については下記にコードがあります。</p>

<p><a href="https://github.com/opscode/chef/blob/master/lib/chef/knife/bootstrap/chef-full.erb">https://github.com/opscode/chef/blob/master/lib/chef/knife/bootstrap/chef-full.erb</a></p>

<p>コードを抜粋すると、omnibus インストーラをダンロードして実行しているのがわかり
ます。つまり Chef11 環境で再度 knife bootstrap すれば新しい Chef がインストー
ルされるはず。</p>

<pre><code class="language-bash">install_sh=&quot;http://opscode.com/chef/install.sh&quot;
version_string=&quot;-v &lt;%= chef_version %&gt;&quot;

if ! exists /usr/bin/chef-client; then
  if exists wget; then
    bash &lt;(wget &lt;%= &quot;--proxy=on &quot; if knife_config[:bootstrap_proxy] %&gt; ${install_sh} -O -) ${version_string}
  elif exists curl; then
    bash &lt;(curl -L &lt;%= &quot;--proxy \&quot;#{knife_config[:bootstrap_proxy]}\&quot; &quot; if knife_config[:bootstrap_proxy] %&gt; ${install_sh}) ${version_string}
  else
    echo &quot;Neither wget nor curl found. Please install one and try again.&quot; &gt;&amp;2
    exit 1
  fi
fi
</code></pre>

<p>このように Chef10 で運用している状態を Chef11 に移行します。新しい環境は&hellip;</p>

<h2 id="新環境">新環境</h2>

<pre><code>+------------------+ +------------------+
|   chef server    | |   chef server    |
|  version 10.18   | |  version 11.0.6  |
+------------------+ +------------------+
                     ^
                     |
+--------------------+
|                    |
|                    |
+------------------+ +------------------+
| chef workstation | |   target node    |
|  version 11.4    | |  version 11.4    |
+------------------+ +------------------+
</code></pre>

<ul>
<li>chef server は omnibus インストールから構築</li>
<li>chef workstation は version 11.4 (2013年3月15日現在最新)</li>
</ul>

<h2 id="移行手順">移行手順</h2>

<h4 id="chef11-サーバを用意する">Chef11 サーバを用意する</h4>

<p>Omnibus インストーラでコマンド3つ打つだけで Chef サーバは構築出来ます。Chef11
からはこの方法が推奨されているようです。bootstrap を使った方法より簡単ですし。</p>

<pre><code>% wget https://opscode-omnitruck-release.s3.amazonaws.com/ubuntu/12.04/x86_64/chef-server_11.0.6-1.ubuntu.12.04_amd64.deb
% sudo dpkg -i chef-server_11.0.6-1.ubuntu.12.04_amd64.deb
% sudo chef-server-ctl reconfigure
</code></pre>

<h4 id="chef11-workstation-を用意する">Chef11 Workstation を用意する</h4>

<p>詳細は割愛します。chef10 と同じです。手順としては</p>

<ul>
<li>chef10 の chef-repo をコピー</li>
<li>pem ファイル群を chef11 server からコピー</li>
<li>knife configure -i にて knife.rb の生成</li>
<li>cookbooks, roles, data_bags, environments 等を chef11 にアップロード。若干修正が必要な場合がある。</li>
</ul>

<p>です。</p>

<h4 id="target-node-における旧-chef-client-の停止と削除">Target Node における旧 chef-client の停止と削除</h4>

<p>稼働している Chef10 の chef-client を停止し削除、そして pem ファイル達を退避し
てあげます。ここでは ssh で消す例を書きますが、これこそ Cookbook を書いて実行
すれば良いと思います。</p>

<pre><code>% ssh -i &lt;ssh_secret_key&gt; -l root &lt;ip_address&gt; \
'service chef-client stop; apt-get -y remove chef; mv /etc/chef /etc/chef.old'
</code></pre>

<h4 id="再-knife-bootstrap-実行">再 knife bootstrap 実行</h4>

<p>Chef11 の Workstation から knife bootstrap を実行します。これによって Target
Node に Chef11 の環境がインストールされ Chef11 Server と接続出来ます。</p>

<pre><code>% knife bootstrap &lt;ip_address&gt; -N vmtest01 -r 'role[base]' -i &lt;ssh_secret_key&gt; \
-x root -d chef-full
</code></pre>

<p>role[base] 中の run_list に&rsquo;chef-client::service&rsquo; を追加すると chef-client が
常時稼動してくれて定期的に Chef Server と接続、更新してくれます。</p>

<h2 id="まとめと考察">まとめと考察</h2>

<p>chef-client の更新は簡単に出来た！</p>

<p>今回はデフォルトの distro &lsquo;chef-full&rsquo; の例で書いたのだけど、distro には他にも
下記がある。</p>

<p><a href="https://github.com/opscode/chef/tree/master/lib/chef/knife/bootstrap">https://github.com/opscode/chef/tree/master/lib/chef/knife/bootstrap</a></p>

<p>Linux のディストリビューション名がついた distro は ruby をパッケージで, Chef
を gem でインストールしている。下記は distro &lsquo;ubuntu12.04-gems&rsquo; のコードの抜粋
です。</p>

<pre><code class="language-bash">if [ ! -f /usr/bin/chef-client ]; then
  aptitude update
  aptitude install -y ruby ruby1.8-dev build-essential wget libruby1.8 rubygems
fi
  
gem update --no-rdoc --no-ri
gem install ohai --no-rdoc --no-ri --verbose
gem install chef --no-rdoc --no-ri --verbose &lt;%= bootstrap_version_string %&gt;
</code></pre>

<p>ruby はディストリビューションが用意しているパッケージを。Chef は
bootstrap_version_string を指定し gem でインストールしている。</p>

<p>つまり &lsquo;ubuntu12.04-gems&rsquo; でも chef-client の更新は出来る。ちなみに試してみま
した。chef-client の停止・削除を下記の通り行うと、全く同じ knife bootstrap コ
マンドで chef-client のアップデートが行えた。</p>

<pre><code>% ssh -i &lt;ssh_secret_key&gt; -l root &lt;ip_address&gt; 'service chef-client stop; mv \
/usr/local/bin/chef-client /usr/local/bin/chef-client.old; mv /etc/chef /etc/chef.old'
</code></pre>

<p>以上です。</p>

<p>なんか簡単なこと書くのに長くなっちゃったけど&hellip;。運用を僕らはまだ出来ていない
のだけど、その時のことを考えると今回の試験はしてみたかったし、いい結果が出てよ
かった。Chef がメジャーバージョンアップされて Chef Server の構成が大きく代わっ
ても対応した cookbook, role, .. があればスムースに移行出来る。</p>

<p>Chef 無しにはインフラエンジニアやってられない時代が来たって感じｗ Chef 周りた
のしー！</p>

<p>追伸: 今回の方法より良いベストプラクティス的な方法があれば教えて下さい。</p>

    <footer>
        <ul class="actions">
            <li><a href="http://jedipunkz.github.io/blog/2013/03/15/chef-contenuously-deploy/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    

                    

                    
                        Category
                    
                
            </li>
        
    

    
    
        <li><a href='/categoriesinfrastructure'>infrastructure</a></li>
    
</ul>

    </footer>
</article>


        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="http://jedipunkz.github.io/blog/2013/02/10/di-11hui-openstack-study11-openstack-chef-repo/">第11回OpenStack勉強会で話してきた</a></h2>
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2013-02-10'>
            February 10, 2013</time>
        <span class="author"></span>
        
            <p>4 minute read</p>
        
        
    </div>
</header>

    

    
    <p>2013年2月9日に行われた OpenStack 勉強会第11回で話してきました。</p>

<p>openstack-chef-repo と言う、Opscode Chef で OpenStack を構築する内容を話して
きました。その時に説明出来なかった詳細についてブログに書いておきます。</p>

<p><iframe src="http://www.slideshare.net/slideshow/embed_code/16434817"
width="427" height="356" frameborder="0" marginwidth="0" marginheight="0"
scrolling="no" style="border:1px solid #CCC;border-width:1px 1px
0;margin-bottom:5px" allowfullscreen webkitallowfullscreen mozallowfullscreen>
</iframe> <div style="margin-bottom:5px"> <strong> <a
href="http://www.slideshare.net/tomokazubobhirai/openstack-chefrepo"
title="Openstack chef-repo" target="_blank">Openstack chef-repo</a> </strong>
from <strong><a href="http://www.slideshare.net/tomokazubobhirai"
target="_blank">Tomokazu Hirai</a></strong> </div></p>

<p>説明で使ったスライドです。</p>

<h2 id="まえがき">まえがき</h2>

<p>Essex ベースで構築することしか今は出来ません。Folsom に関しては &lsquo;直ちに開発が
スタートする&rsquo; と記されていました。今回は Opscode と RackSpace のエンジニアが共
同で開発を進めているので期待しています。今まで個人で OpenStack の各コンポーネ
ントの cookbook を開発されていた方がいらっしゃるのだけど汎用性を持たせるという
意味で非常に難しく、またどの方の開発に追従していけばよいか判断困っていました。
よって今回こそ期待。</p>

<h2 id="前提の構成">前提の構成</h2>

<pre><code>+-------------+
| chef-server |
+-------------+ 10.0.0.10
|
+---------------+ 10.0.0.0/24
|               |
+-------------+ +-------------+
| workstation | |    node     |
+-------------+ +-------------+
10.0.0.11       10.0.0.12
</code></pre>

<ul>
<li>chef-server : chef API を持つ chef-server 。cookbook, role..などのデータを持つ</li>
<li>workstation : openstack-chef-repo を使うノード。knife が使える必要がある。</li>
<li>node        : OpenStack を構築するターゲットノード</li>
</ul>

<h2 id="目次">目次</h2>

<ul>
<li>chef-server の構築 (BootStrap 使う)</li>
<li>openstack-chef-repo を使用する準備</li>
<li>openstack-chef-repo 実行</li>
</ul>

<h2 id="chef-server-の構築">chef-server の構築</h2>

<p>Opscode の wiki に記されている通りなのですが、簡単に書いておきます。今回は
bootstrap 方式で用意します。</p>

<p>chef-server ノードに chef をインストールします。chef-solo を用いるからです。</p>

<pre><code>chef-server# gem install chef
</code></pre>

<p>chef-solo を使うための設定情報を /etc/chef/solo.rb に記します。</p>

<pre><code>chef-server# mkdir /etc/chef
chef-server# ${EDITOR} /etc/chef/solo.rb
file_cache_path &quot;/tmp/chef-solo&quot;
cookbook_path &quot;/tmp/chef-solo/cookbooks&quot;
</code></pre>

<p>chef-solo を実行する際に使う json ファイルを用意します。attribute を上書きする
ことが出来ます。今回は webui を有効にした状態にします。</p>

<pre><code>chef-server# ${EDITOR} ~/chef.json
{
  &quot;chef_server&quot;: {
    &quot;server_url&quot;: &quot;http://localhost:4000&quot;,
    &quot;init_style&quot;: &quot;runit&quot;
  },
  &quot;run_list&quot;: [ &quot;recipe[chef-server::rubygems-install]&quot; ]
}
</code></pre>

<p>bootstrap して chef-server を構築します。</p>

<pre><code>chef-server# chef-solo -c /etc/chef/solo.rb -j ~/chef.json -r http://s3.amazonaws.com/chef-solo/bootstrap-latest.tar.gz
</code></pre>

<p>chef-server が完成したはずです。workstation で knife を使うために &lsquo;client&rsquo; を
作ります。chef 10.x では user ではなく client が knife を実行します。</p>

<pre><code>chef-server% mkdir ~/.chef
chef-server% sudo cp /etc/chef/validation.pem ~/.chef/
chef-server% sudo cp /etc/chef/webui.pem ~/.chef/
chef-server% sudo chown &lt;my-username&gt;:&lt;my-group&gt; ~/.chef
</code></pre>

<p>knife を使うために下記の操作を行います。</p>

<pre><code>chef-server% cd ~
chef-server% knife configure -i
Where should I put the config file? [~/.chef/knife.rb]
Please enter the chef server URL: [http://10.0.0.1:4000]
Please enter a clientname for the new client: [jedipunkz]
Please enter the existing admin clientname: [chef-webui]
Please enter the location of the existing admin client's private key:[/etc/chef/webui.pem] /home/jedipunkz/.chef/webui.pem
Please enter the validation clientname: [chef-validator]
Please enter the location of the validation key:[/etc/chef/validation.pem] /home/jedipunkz/.chef/validation.pem
Please enter the path to a chef repository (or leave blank):
Creating initial API user...
Created client[jedipunkz]
Configuration file written to /home/jedipunkz/.chef/knife.rb
</code></pre>

<p>workstaion ノードで knife を操作するための &lsquo;worker&rsquo; client を作成します。</p>

<pre><code>chef-server% export EDITOR=vim
chef-server% knife client create worker -a -f worker.pem
chef-server% knife client list
  chef-validator
  chef-webui
  chefserver.example.com
  jedipunkz
  worker
</code></pre>

<h2 id="openstack-chef-repo-を使用する準備">openstack-chef-repo を使用する準備</h2>

<p>workstation で openstack-chef-repo を使うための準備をします。</p>

<p>まずは knife を使えるように下記のように knife.rb や pem の手元への転送を行います。</p>

<pre><code>workstation% gem install chef librarian spiceweasel
workstation% cd ~
workstation% git clone git://github.com/opscode/openstack-chef-repo.git
workstation% cd openstack-chef-repo
workstation% vim .chef/knife.rb
log_level                :info
log_location             STDOUT
node_name                'worker'
client_key               '/home/jedipunkz/openstack-chef-repo/.chef/worker.pem'
validation_client_name   'chef-validator'
validation_key           '/home/jedipunkz/openstack-chef-repo/.chef/validation.pem'
chef_server_url          'http://10.0.0.10:4000'
cache_type               'BasicFile'
cache_options( :path =&gt; '/home/jedipunkz/openstack-chef-repo/.chef/checksums' )
cookbook_path           '/home/jedipunkz/openstack-chef-repo/cookbooks'
workstation% scp 10.0.0.10:~/worker.pem .chef/
workstation% scp 10.0.0.10:~/.chef/validation.pem .chef/
</code></pre>

<p>librarian を使って OpenStack 構築に必要な cookbooks をダンロードします。Cheffile
というファイルに何をどこから取得するのか記されいてそれにしたがってダウンロードされます。</p>

<pre><code>workstation% libratrian-chef update
</code></pre>

<p>環境に合わせて production.yml を修正します。今回必要最低限の箇所のみ修正します。
&ldquo;osops_networks&rdquo; という箇所に nova-network に渡すネットワーク情報があるので今回の
環境 10.0.0.0/24 に修正します。全体はこのような内容になります。</p>

<pre><code>workstation% ${EDITOR} production.yml
name &quot;production&quot;
description &quot;Defines the network and database settings you're going to use with OpenStack. The networks will be used in the libraries provided by the osops-utils cookbook. This example is for FlatDHCP with 2 physical networks.&quot;

override_attributes(
  &quot;glance&quot; =&gt; {
    &quot;image_upload&quot; =&gt; true,
    &quot;images&quot; =&gt; [&quot;precise&quot;,&quot;cirros&quot;],
  },
  &quot;mysql&quot; =&gt; {
    &quot;allow_remote_root&quot; =&gt; true,
    &quot;root_network_acl&quot; =&gt; &quot;%&quot;
  },
  &quot;osops_networks&quot; =&gt; {
    &quot;public&quot; =&gt; &quot;10.0.0.0/24&quot;,
    &quot;management&quot; =&gt; &quot;10.0.0.0/24&quot;,
    &quot;nova&quot; =&gt; &quot;10.0.0.0/24&quot;
  },
  &quot;nova&quot; =&gt; {
    &quot;network&quot; =&gt; {
      &quot;fixed_range&quot; =&gt; &quot;192.168.100.0/24&quot;,
      &quot;public_interface&quot; =&gt; &quot;eth0&quot;
    },
    &quot;networks&quot; =&gt; [
      {
        &quot;label&quot; =&gt; &quot;public&quot;,
        &quot;ipv4_cidr&quot; =&gt; &quot;192.168.100.0/24&quot;,
        &quot;num_networks&quot; =&gt; &quot;1&quot;,
        &quot;network_size&quot; =&gt; &quot;255&quot;,
        &quot;bridge&quot; =&gt; &quot;br100&quot;,
        &quot;bridge_dev&quot; =&gt; &quot;eth0&quot;,
        &quot;dns1&quot; =&gt; &quot;8.8.8.8&quot;,
        &quot;dns2&quot; =&gt; &quot;8.8.4.4&quot;
      }
    ]
  }
  )  
</code></pre>

<p>infrastructure.yml という spiceweasel が参照するファイルの修正を行います。
cookbooks, roles, environments, data bags, node とパラメータがあり node
のみ記されていないので今回用意したターゲットノードの情報を追記します。</p>

<p>node には予め SSH 公開鍵を設置する必要があります。また下記は root ユーザでログ
インしていますが、sudo してもらっても構わないです。role で指定した &lsquo;allinone&rsquo;
は OpenStack の全てのコンポーネントを一台のノードにインストールするためのもの
です。これを他の role 例えば &lsquo;keystone&rsquo; 等を指定して複数のノードに OpenStack
を展開することも可能なはずです。試していませんが。</p>

<pre><code>workstation% vim infrastructure.yml
... 省略
nodes:
- 10.0.0.12:
  run_list: role[allinone]
  options: -i ~/.ssh/id_rsa -x root -E production
</code></pre>

<h2 id="openstack-chef-repo-実行">openstack-chef-repo 実行</h2>

<p>準備が整ったので spiceweasel を使って knife コマンドの出力チェックと実行をして
みます。先ほど追記した infrastructure.yml を使います。</p>

<pre><code>workstation% spiceweasel infrastructure.yml
knife cookbook upload apache2
knife cookbook upload apt
knife cookbook upload aws
knife cookbook upload build-essential
knife cookbook upload ntp
knife cookbook upload openssh
knife cookbook upload openssl
knife cookbook upload postgresql
knife cookbook upload selinux
knife cookbook upload xfs
knife cookbook upload yum
knife cookbook upload erlang
knife cookbook upload mysql
knife cookbook upload rabbitmq
knife cookbook upload database
knife cookbook upload omnibus_updater
knife cookbook upload lxc
knife cookbook upload sysctl
knife cookbook upload osops-utils
knife cookbook upload mysql-openstack
knife cookbook upload rabbitmq-openstack
knife cookbook upload keystone
knife cookbook upload glance
knife cookbook upload nova
knife cookbook upload horizon
knife environment from file production.rb
knife role from file base.rb
knife role from file lxc.rb
knife role from file mysql-master.rb
knife role from file rabbitmq-server.rb
knife role from file keystone.rb
knife role from file glance-api.rb
knife role from file glance-registry.rb
knife role from file glance.rb
knife role from file nova-setup.rb
knife role from file nova-scheduler.rb
knife role from file nova-api-ec2.rb
knife role from file nova-api-os-compute.rb
knife role from file nova-volume.rb
knife role from file nova-vncproxy.rb
knife role from file horizon-server.rb
knife role from file single-controller.rb
knife role from file single-compute.rb
knife role from file allinone.rb
knife bootstrap 10.0.0.12 -i ~/.ssh/id_rsa -x root -E production -r 'role[allinone]'  
</code></pre>

<p>この操作で spiceweasel は role ファイルの中身と yml ファイルを読み、依存関係を
チェックしてくれます。</p>

<p>ではいよいよ実行。</p>

<pre><code>workstaion% spiceweasel -e infrastructure.yml
</code></pre>

<p>数分で OpenStack 環境が構築出来ると思います。</p>

<h2 id="所感">所感</h2>

<p>現時点ではまだ essex ベースの OpenStack しか構築出来ない。folsom 以降について
は直ちに行われる。また先にも記したが Opscode と RackSpace のエンジニアが共同で
作業に入ったので今後に期待。複数の OpenStack cookboooks を見てきたが個人で開発
するのは厳しいと感じています。fedra, centos, ubuntu, debian &hellip; いろんなプラッ
トフォームを前提に開発するのは厳しい&hellip;。pull request する余力があればやってみ
たい。また合わせて各コンポーネントの cookbooks についても同様に参加していきた
い。</p>

<p>chef は繰り返し実行されるので継続的にデプロイが可能であり、chef Resources が我々
の操作を抽象化してくれる。尚且つ API で開発も容易になる。学習コストは若干高い
し、cookbooks の開発も正直しんどい。だけどインフラを chef でコントロールする意
味はとても大きい。その他のメリットとして属人的な操作に依存したシステムを無くす
という事もある。</p>

<p>OpenStack のドキュメントにはデプロイ方法として dodai-deploy と puppet が掲載さ
れている。chef は載っていない。これは cookbooks の開発が遅れている状況が理由に
あると思う。今回 Opscode の中の Matt Ray さんの下記の資料</p>

<p><a href="http://www.slideshare.net/mattray/chef-11-previewchef-for-openstack">http://www.slideshare.net/mattray/chef-11-previewchef-for-openstack</a></p>

<p>を見て、これからに期待したいと感じた。</p>

    <footer>
        <ul class="actions">
            <li><a href="http://jedipunkz.github.io/blog/2013/02/10/di-11hui-openstack-study11-openstack-chef-repo/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    

                    

                    
                        Categories
                    
                
            </li>
        
    

    
    
        <li><a href='/categoriesinfrastructure'>infrastructure</a></li>
    
        <li><a href='/categoriesreport'>report</a></li>
    
</ul>

    </footer>
</article>


        

        
<ul class="actions pagination">
    
        <li><a href="/categories/infrastructure/page/25/"
                class="button big previous">Previous Page</a></li>
    

    
        <li><a href="/categories/infrastructure/page/27/"
                class="button big next">Next Page</a></li>
    
</ul>

    </div>
    
<section id="sidebar">

    
        <section id="intro">
            
            
                
                    <img src="/pix/jedipunkz.jpg" class="intro-circle" width="250" alt="jedipunkz icon" />
                
            
            
                <header>
                    <h2></h2>
                    <p>ジェダイさんです。インフラエンジニアからインフラ寄りのソフトウェアエンジニアになるために勉強していきます。</p>
                </header>
            
            <ul class="icons">
                
                    <li><a href="http://jedipunkz.github.io/categories/infrastructure/index.xml" type="application/rss+xml"
                        target="_blank" title="RSS" class="fa fa-rss"></a></li>
                
                
                    
<li><a href="//github.com/jedipunkz" target="_blank" title="GitHub" class="fa fa-github"></a></li>

















































<li><a href="//twitter.com/jedipunkz" target="_blank" title="Twitter" class="fa fa-twitter"></a></li>




                
            </ul>
        </section>

    
        <section id="recent-posts">
            <ul class="posts">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    
                

                
                    <li>
                        <article>
                            <header>
                                <h3><a href="http://jedipunkz.github.io/blog/2016/12/29/fluentd-sidecar-gcp/">fluentd-sidecar-gcp と Kubernetes Volumes で Cloud Logging ログ転送</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2016-12-29'>
                                    December 29, 2016</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="http://jedipunkz.github.io/blog/2016/12/29/cloud-cdn/">Google Cloud CDN を使ってみた</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2016-12-29'>
                                    December 29, 2016</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="http://jedipunkz.github.io/blog/2016/11/27/etcd-operator/">coreos の etcd operator を触ってみた</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2016-11-27'>
                                    November 27, 2016</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="http://jedipunkz.github.io/blog/2016/11/20/helm/">Helm を使って Kubernetes を管理する</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2016-11-20'>
                                    November 20, 2016</time>
                            </header>
                        </article>
                    </li>
                

                
                    <li>
                        <ul class="actions">
                            <li><a href=
                            
                                /post/
                            
                            class="button">View more posts</a></li>
                        </ul>
                    </li>
                
            </ul>
        </section>

    
    
    
    
        <section id="categories">
            <ul class="posts">
                <header>
                    <h3><a href="/categories/">Categories</a></h3>
                </header>

                
                    
                

                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/infrastructure/">infrastructure</a>
                                <span style="float:right;">105</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/tools/">tools</a>
                                <span style="float:right;">11</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/report/">report</a>
                                <span style="float:right;">9</span>
                            </header>
                        </article>
                    </li>
                
            </ul>
        </section>
    

    
        
        <section class="blurb">
            <h2>About</h2>
            <p>ソフトウェア寄りのエンジニアになるため勉強をしています。勉強したことをメモしていければと思います。</p>

            <ul class="actions">
                <li><a href="/about/" class="button">Learn More</a></li>
            </ul>
        </section>
        

    
        <section id="footer">
            <ul class="icons">
                
                    <li><a href="http://jedipunkz.github.io/categories/infrastructure/index.xml" type="application/rss+xml"
                        target="_blank" title="RSS" class="fa fa-rss"></a></li>
                
                
                    
<li><a href="//github.com/jedipunkz" target="_blank" title="GitHub" class="fa fa-github"></a></li>

















































<li><a href="//twitter.com/jedipunkz" target="_blank" title="Twitter" class="fa fa-twitter"></a></li>




                
            </ul>

            <p class="copyright">&copy; ジェダイさんのブログ. テーマデザインは <a href="//github.com/jpescador" target="_blank">Julio Pescador</a>さんによるものです。 </p>
        </section>

</section>

            </div>
        <a id="back-to-top" href="#" class="fa fa-arrow-up fa-border fa-2x"></a>
        

        
        
            
        

        
        
            <script src="/js/jquery.min.js"></script>
            <script src="/js/skel.min.js"></script>
            <script src="/js/util.js"></script>
            <script src="/js/main.js"></script>
            <script src="/js/backToTop.js"></script>
            <script src="/js/highlight.pack.js"></script>
        

        

            
            <script>hljs.initHighlightingOnLoad();</script>
            
    </body>
</html>

