


    
        
    




<!DOCTYPE HTML>

<html>
    <head>
        
            <title>Infrastructure Posts - ジェダイさんのブログ</title>
        

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="generator" content="Hugo 0.53" />
        


        
        
            
        

        <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Infrastructure"/>
<meta name="twitter:description" content=""/>

        <meta property="og:title" content="Infrastructure" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://jedipunkz.github.io/categories/infrastructure/" />
<meta property="og:updated_time" content="2012-11-04T00:00:00&#43;00:00"/>

        
<meta itemprop="name" content="Infrastructure">
<meta itemprop="description" content="">


        

        

        
        
            
        

        
        
            <link rel="stylesheet" href="/css/google-font.css" />
            <link rel="stylesheet" href="/css/font-awesome.min.css" />
            <link rel="stylesheet" href="/css/main.css" />
            <link rel="stylesheet" href="/css/add-on.css" />
            <link rel="stylesheet" href="/css/monokai-sublime.css">
        

        

        
        
        
            
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-30563095-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

        
    </head>
    <body>

        
        <div id="wrapper">

    
<header id="header">
    
        <h2><a href="/"></i></a></h2>
    

    <nav class="links">
        <ul>
            
                <li>
                    <a href="">
                        Blog
                    </a>
                </li>
            
                <li>
                    <a href="about/index.html">
                        About
                    </a>
                </li>
            
        </ul>
    </nav>
    <nav class="main">
        <ul>
            
            <li class="search">
                <a class="fa-search" href="#search">Search</a>
                <form id="search" method="get" action="//google.com/search">
                    <input type="text" name="q" placeholder="Search" />
                    <input type="hidden" name="q" value="site:https://jedipunkz.github.io">
                </form>
            </li>
            <li class="menu">
                <a class="fa-bars" href="#menu">Menu</a>
            </li>
        </ul>
    </nav>
</header>


<section id="menu">

    
        <section>
            <form class="search" method="get" action="//google.com/search">
                <input type="text" name="q" placeholder="Search" />
                <input type="hidden" name="q" value="site:https://jedipunkz.github.io">
            </form>
        </section>

    
        <section>
            <ul class="links">
                
                    <li>
                        <a href="">
                            <h3>
                                
                                Blog
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="about/index.html">
                            <h3>
                                
                                About
                            </h3>
                        </a>
                    </li>
                
            </ul>
        </section>

    
        <section>
            <ul class="links">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    <li>
                        <a href="https://jedipunkz.github.io/blog/2018/12/31/istio/"><p>Istio, Helm を使って Getting Started 的なアプリをデプロイ</p></a>
                    </li>
                
                    <li>
                        <a href="https://jedipunkz.github.io/blog/2017/07/02/test-kitchen-cluster/"><p>Docker,Test-Kitchen,Ansible でクラスタを構成する</p></a>
                    </li>
                
                    <li>
                        <a href="https://jedipunkz.github.io/blog/2017/04/13/gke-lb/"><p>GCP ロードバランサと GKE クラスタを Terraform を使って構築する</p></a>
                    </li>
                
                    <li>
                        <a href="https://jedipunkz.github.io/blog/2017/02/12/serverless-fission/"><p>Serverless on Kubernetes : Fission を使ってみた</p></a>
                    </li>
                
                    <li>
                        <a href="https://jedipunkz.github.io/blog/2017/01/13/kubernetes-deployments/"><p>Kubernetes Deployments を使ってみた！</p></a>
                    </li>
                
            </ul>
        </section>

    
        
</section>

    
    <div id="main">
        <h1>Infrastructure</h1>
        
        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="https://jedipunkz.github.io/blog/2012/11/04/swift-tempauth/">Swift で簡単に分散オブジェクトストレージ</a></h2>
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2012-11-04'>
            November 4, 2012</time>
        <span class="author"></span>
        
        
    </div>
</header>

    

    
    <p><p>最近、OpenStack にどっぷり浸かってる <a href="https://twitter.com/jedipunkz">@jedipunkz</a> です。</p>

<p>Folsom がリリースされて Quantum を理解するのにめちゃ苦労して楽しい真っ最中なのだけど、
今日は OpenStack の中でも最も枯れているコンポーネント Swift を使ったオブジェクトストレー
ジ構築について少し書こうかなぁと思ってます。</p>

<p>最近は OpenStack を構築・デプロイするのに皆、Swift 入れてないのね。仲間はずれ
感たっぷりだけど、一番安定して動くと思ってる。</p>

<p>これを読んで、自宅にオブジェクトストレージを置いちゃおぅ。</p>

<h2 id="構成は">構成は ?&hellip;</h2>

<pre><code>                        +--------+
                        | client |
                        +--------+
                             |
                      +-------------+
                      | swift-proxy |
                      +-------------+ 172.16.0.10
                             |
         +-------------------+-------------------+ 172.16.0.0/24
         |                   |                   |
+-----------------+ +-----------------+ +-----------------+
| swift-storage01 | | swift-storage02 | | swift-storage03 |
+-----------------+ +-----------------+ +-----------------+
172.16.0.11         172.16.0.12         172.16.0.13
</code></pre>

<p>となる。IP アドレスは&hellip;</p>

<ul>
<li>client : 172.16.0.0/24 のどこか</li>
<li>swift-proxy : 172.16.0.10</li>
<li>swift-storage01 : 172.16.0.11</li>
<li>swift-storage02 : 172.16.0.12</li>
<li>swift-storage03 : 172.16.0.13</li>
</ul>

<p>これはサンプル。自宅の環境に合わせて読み替えてください。</p>

<p>全て同じネットワークセグメントに。なので上の図は概念的な図です。通信の流れだけ
把握出来ればいいなぁと。向き書いてないけど..。四角で囲まれているのがノード (サー
バ) です。物理サーバでも仮想マシンでも大丈夫！</p>

<h2 id="マシンの準備">マシンの準備</h2>

<p>Ubuntu Server 12.04 もしくは 12.10 を用意。swift-storage のマシン3台だけは
/dev/sda6 など Disk デバイスを swift 用に用意してあげてください。普通にハード
ディスクのパーティションを切ってあげるだけでいいです。高価な Disk を使うまでも
ないので。それが分散ストレージの良いところ！ Disk ・ノードが壊れてもデータが失
われないんです！</p>

<h2 id="swift-proxy-の構築">swift-proxy の構築</h2>

<p>今回は簡易認証機能の tempauth を使います。Keystone を使った構成を説明しようか
迷ったのだけど、Keystone の構築だけで一つ記事が書けるくらいになるので..、諦め
ました。tempauth は Swift 本体に実装されていますよ。</p>

<p>構築は簡単、まず下記をコピペしてください。</p>

<pre><code>apt-get update
apt-get install swift python-swift
apt-get install python-keystoneclient python-keystone 
mkdir /etc/swift
chown -R swift:swift /etc/swift
export PROXY_LOCAL_NET_IP=10.200.4.133
export POUND_NET=10.200.4.138
apt-get install swift-proxy memcached
perl -pi -e &quot;s/-l 127.0.0.1/-l $PROXY_LOCAL_NET_IP/&quot; /etc/memcached.conf
service memcached restart
cat &gt;/etc/swift/proxy-server.conf &lt;&lt;EOF
[DEFAULT]
#cert_file = /etc/swift/cert.crt
#key_file = /etc/swift/cert.key
bind_port = 8080
workers = 8
user = swift

[pipeline:main]
pipeline = healthcheck cache tempauth proxy-server

[app:proxy-server]
use = egg:swift#proxy
allow_account_management = true
account_autocreate = true

[filter:tempauth]
use = egg:swift#tempauth
user_system_root = testpass .admin
https://$PROXY_LOCAL_NET_IP:8080/v1/AUTH_system

[filter:healthcheck]
use = egg:swift#healthcheck

[filter:cache]
use = egg:swift#memcache
memcache_servers = $PROXY_LOCAL_NET_IP01:11211
EOF
</code></pre>

<p>次に swift.conf とリング情報 (バランシングのための情報) を swift-proxy 上に用意します。これらは、
あとで各すべてのノードに配置するので重要です。これもコピペしてください。</p>

<pre><code>cat &gt; /etc/swift/swift.conf &lt;&lt; EOF
[swift-hash]
# random unique string that can never change (DO NOT LOSE)
swift_hash_path_suffix = `od -t x8 -N 8 -A n &lt;/dev/random`
EOF
cd /etc/swift
swift-ring-builder account.builder create 18 3 1
swift-ring-builder container.builder create 18 3 1
swift-ring-builder object.builder create 18 3 1
export STORAGE_LOCAL_NET_IP01=172.16.0.11
export STORAGE_LOCAL_NET_IP02=172.16.0.12
export STORAGE_LOCAL_NET_IP03=172.16.0.13
export ZONE01=1
export ZONE02=2
export ZONE03=3
export WEIGHT=100
export DEVICE=sda6
swift-ring-builder account.builder add z$ZONE01-$STORAGE_LOCAL_NET_IP01:6002/$DEVICE $WEIGHT
swift-ring-builder container.builder add z$ZONE01-$STORAGE_LOCAL_NET_IP01:6001/$DEVICE $WEIGHT
swift-ring-builder object.builder add z$ZONE01-$STORAGE_LOCAL_NET_IP01:6000/$DEVICE $WEIGHT
swift-ring-builder account.builder add z$ZONE02-$STORAGE_LOCAL_NET_IP02:6002/$DEVICE $WEIGHT
swift-ring-builder container.builder add z$ZONE02-$STORAGE_LOCAL_NET_IP02:6001/$DEVICE $WEIGHT
swift-ring-builder object.builder add z$ZONE02-$STORAGE_LOCAL_NET_IP02:6000/$DEVICE $WEIGHT
swift-ring-builder account.builder add z$ZONE03-$STORAGE_LOCAL_NET_IP03:6002/$DEVICE $WEIGHT
swift-ring-builder container.builder add z$ZONE03-$STORAGE_LOCAL_NET_IP03:6001/$DEVICE $WEIGHT
swift-ring-builder object.builder add z$ZONE03-$STORAGE_LOCAL_NET_IP03:6000/$DEVICE $WEIGHT
swift-ring-builder account.builder
swift-ring-builder container.builder
swift-ring-builder object.builder
swift-ring-builder account.builder rebalance
swift-ring-builder container.builder rebalance
swift-ring-builder object.builder rebalance
</code></pre>

<p>で、起動。</p>

<pre><code>swift-proxy# chown -R swift:swift /etc/swift
swift-proxy# swift-init proxy start
</code></pre>

<p>おしまい。</p>

<h2 id="swift-storage-構築">swift-storage 構築</h2>

<p>swift-storage の構築は各ノードで下記の内容をコピペしてください。今回は3台分だ
けど、マシンが余ってたら4台でも5台でも OK ！</p>

<pre><code>apt-get update
apt-get install swift python-swift
mkdir /etc/swift
chown -R swift:swift /etc/swift

export STORAGE_LOCAL_NET_IP=172.16.0.11

apt-get install swift-account swift-container swift-object xfsprogs
mkfs.xfs -i size=1024 /dev/sda6
echo &quot;/dev/sda6 /srv/node/sda6 xfs noatime,nodiratime,nobarrier,logbufs=8 0 0&quot; &gt;&gt; /etc/fstab
mkdir -p /srv/node/sda6
mount /srv/node/sda6
chown -R swift:swift /srv/node
cat &gt;/etc/rsyncd.conf &lt;&lt;EOF
uid = swift
gid = swift
log file = /var/log/rsyncd.log
pid file = /var/run/rsyncd.pid
address = $STORAGE_LOCAL_NET_IP

[account]
max connections = 2
path = /srv/node/
read only = false
lock file = /var/lock/account.lock

[container]
max connections = 2
path = /srv/node/
read only = false
lock file = /var/lock/container.lock

[object]
max connections = 2
path = /srv/node/
read only = false
lock file = /var/lock/object.lock
EOF
perl -pi -e 's/RSYNC_ENABLE=false/RSYNC_ENABLE=true/' /etc/default/rsync
service rsync start
cat &gt;/etc/swift/account-server.conf &lt;&lt;EOF
[DEFAULT]
bind_ip = $STORAGE_LOCAL_NET_IP
workers = 2

[pipeline:main]
pipeline = account-server

[app:account-server]
use = egg:swift#account

[account-replicator]

[account-auditor]

[account-reaper]
EOF
cat &gt;/etc/swift/container-server.conf &lt;&lt;EOF
[DEFAULT]
bind_ip = $STORAGE_LOCAL_NET_IP
workers = 2

[pipeline:main]
pipeline = container-server

[app:container-server]
use = egg:swift#container

[container-replicator]

[container-updater]

[container-auditor]

[container-sync]
EOF
cat &gt;/etc/swift/object-server.conf &lt;&lt;EOF
[DEFAULT]
bind_ip = $STORAGE_LOCAL_NET_IP
workers = 2

[pipeline:main]
pipeline = object-server

[app:object-server]
use = egg:swift#object

[object-replicator]

[object-updater]

[object-auditor]
EOF
</code></pre>

<p>環境変数 ${STORAGE_LOCAL_NET_IP} を3台毎に変えて、各台で流し込んであげたら、
swift-proxy で生成した /etc/swift.conf とリング情報達を各 swift-storage に
配置します。</p>

<pre><code>swift-proxy     # scp /etc/swift/swift.conf /etc/swift/*ring.gz 172.16.0.11:/tmp/
swift-proxy     # scp /etc/swift/swift.conf /etc/swift/*ring.gz 172.16.0.12:/tmp/
swift-proxy     # scp /etc/swift/swift.conf /etc/swift/*ring.gz 172.16.0.13:/tmp/
swift-storage01 # mv /tmp/swift.conf /tmp/*ring.gz /etc/swift/
swift-storage01 # chown -R swift:swift /etc/swift
swift-storage02 # mv /tmp/swift.conf /tmp/*ring.gz /etc/swift/
swift-storage02 # chown -R swift:swift /etc/swift
swift-storage03 # mv /tmp/swift.conf /tmp/*ring.gz /etc/swift/
swift-storage03 # chown -R swift:swift /etc/swift
</code></pre>

<p>swift-storage を各台で起動します。</p>

<pre><code>swift-storage01 # swift-init all start
swift-storage02 # swift-init all start
swift-storage03 # swift-init all start
</code></pre>

<h2 id="アクセスしてみる">アクセスしてみる</h2>

<p>完成したので、swift クライアントでアクセスしてみる。</p>

<pre><code>% swift -A http://172.16.0.10:8080/auth/v1.0 -U system:root -K testpass stat
Account: AUTH_system
Containers: 4
Objects: 15
Bytes: 23866252
Connection: keep-alive
Accept-Ranges: bytes
</code></pre>

<p>ファイルをアップロード・ダウンロードしてみる。</p>

<pre><code>% swift -A http://172.16.0.10:8080/auth/v1.0 -U system:root -K testpass upload test /etc/hosts
% swift -A http://172.16.0.10:8080/auth/v1.0 -U system:root -K testpass list
% test
% cd /tmp/
% swift -A http://172.16.0.10:8080/auth/v1.0 -U system:root -K testpass download test
% ls /tmp/etc/hosts
</code></pre>

<p>もちろん、HTTP な API なので curl 等の HTTP ブラウザを使ってもアクセスできる！</p>

<pre><code>% curl -k -v -H 'X-Storage-User: system:root' -H 'X-Storage-Pass: testpass' http://172.16.0.10:8080/auth/v1.0
&lt; HTTP/1.1 200 OK
&lt; Server: nginx/1.1.19
&lt; Date: Mon, 03 Sep 2012 04:58:30 GMT
&lt; Content-Length: 0
&lt; Connection: keep-alive
&lt; X-Storage-Url: https://172.16.0.10:8080/v1/AUTH_system
&lt; X-Storage-Token: AUTH_tk8a19f76c9bce4077aee02aef76257020
&lt; X-Auth-Token: AUTH_tk8a19f96c9bce4077aee02aef76257020
&lt;
* Connection #0 to host 172.16.0.10 left intact
* Closing connection #0
* SSLv3, TLS alert, Client hello (1):
</code></pre>

<p>得られた X-Auth-Token, X-Storage-Url を使ってアクセスする。</p>

<pre><code>% curl -k -v -H 'X-Auth-Token: &lt;token-from-x-auth-token-above&gt;' &lt;url-from-x-storage-url-above&gt;
&lt; HTTP/1.1 200 OK
&lt; Server: nginx/1.1.19
&lt; Date: Mon, 03 Sep 2012 04:59:47 GMT
&lt; Content-Type: text/plain; charset=utf-8
&lt; Content-Length: 34
&lt; Connection: keep-alive
&lt; X-Account-Object-Count: 15
&lt; X-Account-Bytes-Used: 23866252
&lt; X-Account-Container-Count: 4
&lt; Accept-Ranges: bytes
&lt;
test
* Connection #0 to host 172.16.0.10 left intact
* Closing connection #0
* SSLv3, TLS alert, Client hello (1):
</code></pre>

<p>さっき放り込んだ &lsquo;test&rsquo; が swift 上にあることが確認できる。</p>

<p><a href="http://cyberduck.ch/">http://cyberduck.ch/</a> ここにある CyberDuck という GUI なツールを使ってもアクセス出来るよ！
HTTPS が必須になるので一工夫する必要があるのだけど、そのあたりは頑張ってみてください。</p>

<p>オンラインでのノードの追加・削除なんてことも出来ます。次回時間があったら解説しますね。</p>

<p>今回は swift-ring-builder コマンドでレプリカ数 &lsquo;3&rsquo; を指定したので、アップロー
ドしたファイル(オブジェクトと言う) は必ず 3 個配置される。なので 1 台の
swift-storage が故障しても大丈夫。ノードを増やせばストレージ全体の容量も増やせ
る。また、swift-proxy は単純な HTTP なので負荷分散機・もしくはソフトウェアのロー
ドバランサを入れれば swift-proxy 自体の冗長も組めるほか、ストレージ I/O の拡張
にもつながる。pound, nginx などを使って冗長組んでみてください。その時に
memcached の内容は共有させてあげる必要があるので、これまた一工夫が必要なのだけ
ど。時間があったら今度解説します。</p>

<p>自宅でも簡単に分散オブジェクトストレージが組める swift。使わない手は無いですよぉ。</p>
</p>

    <footer>
        <ul class="actions">
            <li><a href="https://jedipunkz.github.io/blog/2012/11/04/swift-tempauth/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    
                        Category
                    
                
            </li>
        
    

    
    
        <li><a href='/categories/infrastructure'>infrastructure</a></li>
    
</ul>

    </footer>
</article>


        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="https://jedipunkz.github.io/blog/2012/10/06/secret-training-of-opscode-chef/">Secret Training of Opscode Chef</a></h2>
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2012-10-06'>
            October 6, 2012</time>
        <span class="author"></span>
        
        
    </div>
</header>

    

    
    <p><p>昨日、開かれた &ldquo;Opscode Chef のシークレットトレーニング&rdquo; に参加してきました。</p>

<p>場所はうちの会社で KDDI ウェブコミュニケーションズ。主催はクリエーションオンラ
インさんでした。講師は Sean OMeara (@someara) さん。今後 Chef のトレーニングを
日本で開くため、事前に内容についてフィードバックが欲しかったそうで、オープンな
レッスンではありませんでしたが、次回以降、日本でも期待できそうです。</p>

<p>内容は chef の基本・メリット・考え方などを網羅した資料で1時間程進められ、その
後はハンズオンがメインでした。今日は実際にハンズオンの内容を書いていこうかと思
います。</p>

<p>chef workstation 環境は揃っている前提にします。また chef server として opscode
の hosted chef (opscode が提供している chef のホスティングサービス,
chef-server として動作します) を使います。またターゲットホストは当日は ec2 イ
ンスタンスを使いましたが、chef ワークステーションから到達できるホストであれば
何でも良いでしょう。</p>

<p>まずは chef-repo のクローン。講習会で使われたものです。</p>

<pre><code>git clone https://github.com/opscode/chef-repo-workshop-sysadmin.git chef-repo
</code></pre>

<p>予め cookbook が入っています。</p>

<p>次に、manage.opscode.com へアクセスしアカウントを作ります。Free アカウントが誰
でも作れるようになっています。</p>

<p><a href="https://manage.opscode.com">https://manage.opscode.com</a> へアクセス -&gt; Sign Up をクリック -&gt; アカウント情報
を入力 -&gt; submit -&gt; メールにて verify -&gt; 自分のアカウント名をクリック -&gt; Get a
new key をクリックし &lt;アカウント名&gt;.pem をダウンロード -&gt; create a
organization をクリックし Free を選択し、適当な名前で organization を作成。
validation key と knife.rb をダウンロード</p>

<p>これらで得た3つのファイル (2つの pem とknife.rb) を chef-repo/.chef/ 配下に置
きます。これで準備 OK。knife.rb を見ると、opscode の chef ホスティングにアクセ
スするよう記述があります。</p>

<pre><code>% cp &lt;somewhere&gt;/knife.rb &lt;somewhere&gt;/&lt;account&gt;.pem &lt;somewhere&gt;/&lt;account&gt;-validation.pem chef-repo/.chef/
</code></pre>

<p>トレーニング用 chef-repo には予め幾つかの cookbook と role, data_bag が入って
います。これらを knife を使ってアップロードします。</p>

<pre><code>% cd chef-repo
% knife cookbook upload -a
% knife role from file role/*.rb
% knife data bag create users
% knife data bag from file users nagiosadmin.json
</code></pre>

<p>そして bootstrap を実行。.chef/bootstrap ディレクトリに chef-full.erb ファイル
が入っていて bash スクリプトになっている。knife bootstrap でこの bash スクリプ
トをターゲットホスト上で実行することになる。中身はと言うと chef 環境をインストー
ルしているようだ。</p>

<p>chef 環境をどうやってノードに入れているかなぁ。preseed 使うかな。手作業じゃ意
味ないしなぁと考えていたのですが、こうやればいいのですね。参考になります。これ
は簡単。</p>

<p>ではいよいよ bootstrap を実行。</p>

<pre><code>% knife bootstrap &lt;IPADDRESS&gt; -r 'role[base],role[monitoring]' --sudo -x &lt;USER&gt; -P &lt;PASSWD&gt;
</code></pre>

<p>IP アドレス、ssh ユーザ名・パスワードは適宜入れてください。これで cookbooks ディ
レクトリ配下の各種 cookbook が実行されました。中身は nagios とそれに依存する
apache2, openssl, mysql, php 等。</p>

<p>次に cookbook を新たにダウンロードし knife upload してみます。</p>

<pre><code>% knife cookbook site download chef-client
% tar zxvf chef-client-1.2.0.tar.gz -C cookbooks/
% knife cookbook upload chef-client
</code></pre>

<p>「アカウントの pem がない場合 validation が用いられるが、一旦サーバと通信出来た
ら validation は必要なくなる。それどころか wi-fi パスワードのようなものなので
validation は削除することを強くすすめる」と Sean が言っていました。chef 環境は
すでに bootstrap で入っているものの、validation を削除するための recipe を
base という role に追加し、実行してみます。</p>

<p>Sean の言っていたこと、間違っていたら指摘してください( &gt;&lt; ) 英語だったので自信
ないです。</p>

<pre><code>% vim role/base.rb
name &quot;base&quot;
description &quot;Base role applied to all nodes.&quot;
run_list(
  &quot;recipe[apt]&quot;,
  &quot;recipe[nagios::client]&quot;
  &quot;recipe[chef-client::delete_validation]&quot;
)

default_attributes(
  &quot;nagios&quot; =&gt; {
  &quot;server_role&quot; =&gt; &quot;monitoring&quot;
  }
)
</code></pre>

<p>role をアップロード。</p>

<pre><code>% knife role from file roles/base.rb
</code></pre>

<p>ターゲットホストで chef-client を実行。ここで バージョン 10.14 から登場した
why-run を試してから実行。</p>

<pre><code>target# chef-client -Fdoc -lfatal --color --why-run
target# chef-client -Fdoc -lfatal --color
</code></pre>

<p>もしくはワークステーションから knife ssh を使っても良い。</p>

<pre><code>% knife search node &quot;role:base&quot; -a cloud.public_ipv4
% knife ssh &quot;role:base&quot; &quot;sudo chef-client -Fmin&quot; -x ubuntu -P opscodechef -a cloud.public_ipv4
</code></pre>

<p>-a cloud.public_ipv4 とは、AWS EC2 や OpenStack, CloudStack 環境ではインスタン
スの eth0 インターフェースにプライベート IP アドレスが付与されているケースが
殆どなため、グローバル IP アドレスを検索し実行している。</p>

<p>大きな流れはこれでおしまい。</p>

<p>トレーニングでは bento, minitest, cucumber-chef 等の紹介があったが、詳細な内容
については見送られた。昼休み1時間をはさんで計7時間の長丁場だったが、chef 初級
を脱するのには最適なトレーニングだった。これからトレーニング内容や種別を組んで
いくそうなので、内容は変わってくるかもしれない。あとでフィードバックをしなく
ちゃ。</p>

<p>個人的には OpenStack に興味を持っているので chef を使って OpenStack をデプロイ
したい。今年6月には &lsquo;Chef for OpenStack&rsquo; というアナウンスがあり、DELL,
RackSpace, HP 等の大企業がパートナーとして参加することになったと発表があった。
今まで openstack cookbook は長くメンテナンスされてこなかったので、これには期待
している。</p>

<p>最後にこの機会を作って下さった クリエーションオンラインさん、opscode の Sean
さん、mr.devops さん、ありがとうございましたー。貴重な体験でした。</p>
</p>

    <footer>
        <ul class="actions">
            <li><a href="https://jedipunkz.github.io/blog/2012/10/06/secret-training-of-opscode-chef/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    
                        Categories
                    
                
            </li>
        
    

    
    
        <li><a href='/categories/infrastructure'>infrastructure</a></li>
    
        <li><a href='/categories/report'>report</a></li>
    
</ul>

    </footer>
</article>


        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="https://jedipunkz.github.io/blog/2012/08/29/7th-openstack-meetup/">第7回 OpenStack 勉強会参加レポート</a></h2>
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2012-08-29'>
            August 29, 2012</time>
        <span class="author"></span>
        
        
    </div>
</header>

    

    
    <p><p>第7回 OpenStack 勉強会に参加してきました。</p>

<pre><code>開催日   : 2012年08月28日
開催場所 : 天王洲アイル ビットアイル
</code></pre>

<p>1年以上前から OpenStack, CloudStack 界隈はウォッチしていたのだけど、実際に構築
してってなると、今月始めばかりで、OpenStack も先週4日間掛けてやっとこさ構築出来たっ
てところ&hellip;orz。前回のブログ記事でへなちょこスクリプト公開しちゃったのを後悔しつ
つ現地に向かいましたw あと、その他に Opscode Chef 等の技術にも興味持って調査し
ていたので、今回の勉強会はまさに直ぐに活かせる内容だった。</p>

<p>では早速、報告があった内容と自分の感想を交えつつ書いていきます。</p>

<h2 id="hp-さんのクラウドサービス-hp-cloud-services">HP さんのクラウドサービス HP Cloud Services</h2>

<pre><code>日本 HP 真壁さま
</code></pre>

<p>HP さんは既に Public クラウドサービスを提供し始めていて Ojbect Storage, CDN 部
分は既にリリース済みだそうだ。compute, block storage 等はベータ版状態でこれか
らリリース。OpenStack ベースな構成で Horizon 部分は自前で開発したもの。既
にサーバ数は万の桁まで到達！ MySQL な DaaS も登場予定だとか。</p>

<p>あと HP だけにクラウドサービスに特化したサーバ機器も出していて、それが HP
Project Moonshot 。ARM/Atom 搭載のサーバで 2,880 nodes/rack が可能だとか！す
げぇ。もちろん電源等のボトルネックとなるリソースは他にも出てきそうだけど。</p>

<p>ノード数って増えると嬉しいのかな？コア数が増えるのは嬉しいけど。</p>

<h2 id="canonical-juju">Canonical JuJu</h2>

<pre><code>Canonical 松本さま
</code></pre>

<p>JuJu は Canonical が提供しているデプロイツールで charms と呼ばれるレシピ集 (っ
て言うと語弊があるのか) に従ってソフトウェアの配布を行うツール。MAAS という物
理サーバのプロビジョニングツールと組み合わせればハードウェアを設置した後のプロ
ビジョニング操作は一気通貫出来る、といったもの。具体的な操作例を挙げてくれたの
で添付してきます。</p>

<pre><code>% juju deploy --repository=/tmp swift-proxy
% juju deploy --repository=/tmp swift-storage
% juju add-relation swift-storage:swift-proxy
% swift-proxy:swift-proxy
% juju add-unit swift-storage # node 追加
</code></pre>

<p>swift-proxy, swift-storage をデプロイし、その後それぞれを関係付けているのが
add-relation。また swift-proxy に対して swift-storage node を追加してくといっ
た操作が add-unit らしい。</p>

<p>Charms と呼ばれるモノの中をのぞかせてもらったが Shell Script と json ファイル
集になっていた。インフラ系のエンジニアに操作してもらうにはこれがベスト、といっ
たところなのだろう。Opscode Chef の様な自由度があるかどうかは、触ってみないと
分からない。時間を見つけて調べてみるかぁ。</p>

<p>ちなにみ今日 MAAS について調べたのですが、これは PXE Boot と DHCP のコンフィギュ
レーションを GUI でするってものなのですね。後に出てくる Crowbar とはだいぶ違う。
間違っていたら指摘してください..。</p>

<p>参考 URL : <a href="https://wiki.ubuntu.com/ServerTeam/MAAS">https://wiki.ubuntu.com/ServerTeam/MAAS</a></p>

<h2 id="redhat-の-openstack-への取り組み">RedHat の OpenStack への取り組み</h2>

<pre><code>RedHat 中井さま
</code></pre>

<p>OpenStack ディストリビューションを提供し始めたことで最近話題になっていたが、い
よいよ今年2012年10月リリース予定の folsom をベースとしたリリースを2013年に控え
ているそうだ。ここで初めて有償サポートが開始されるそう。より簡単に構築が出来て、
技術的な不安定を持っているユーザを取り込んでいくのだろう。面白いネタも貰えた。
将来、Swift 代替で Gluster-FS が扱えるようになる可能性があるそうだ。また KVM
にコミットしているエンジニアを抱えている彼らだが、KVM から直接 Gluster-FS 上の
VM イメージを操作出来るように修正加える案も出ているそうだ。これが実現すれば、
nova ノードのサーバリソースに依存しない大きな Disk イメージを扱うことも可能に
なるだろう。</p>

<p>また、Canonical JuJu, Opscode Chef に並ぶツールの紹介もあった。CloudForms がそ
れなのだが、各社と共通するコンセプトを持っているようだ。開発環境・本番環境への
シームレスなデプロイ、と。</p>

<h2 id="dell-crowbar">DELL Crowbar</h2>

<pre><code>DELL 増月さま
</code></pre>

<p>ある意味、僕にとって一番の収穫だったのが DELL の Crowbar。DELL サーバに依存せ
ず使えるデプロイツールで、IPMI, RAID, BIOS 等のハードウェア構成も自動構築が出
来るそう！また Opscode Chef がベースになっていて barclamp と呼ばれる Chef で
言う Cookbooks を元にソフトウェアをデプロイしていくそうだ。Chef Server 環境が
必須で chef-solo のような操作には対応していなそうなのが残念だった。Web ベース
の GUI インターフェースで操作するらしい。デモも当日見れました。</p>

<p>ハードウェア構成も自動構築出来るツールは Canonical の MAAS があるが、一歩踏み
込んだ構成が組めそう。尚、Opscode の Cookbooks を再利用するのは少し難しい状況
のようだ。この辺りは 2.0 バージョンで改善されるそうだ。Chef との依存関係をより
シンプルなものにするそう。</p>

<p>他ベンダのと差別化を図るのかと思いきや、サーバ機器に依存しないツールを出してく
る DELL さんの思いは、どこにあるのだろう。あと BIOS, RAID 周りをソフトウェアで
プロビジョニングしていく受け口の I/F は IPMI なのかな？質問すればよかった。</p>

<h2 id="gmo-お名前-kvm">GMO お名前 KVM</h2>

<p>先月の OSC で発表になった資料をベースに説明して頂いた。diablo ベースで CentOS
上に構築されているらしい。また griddynamic.net のパッケージ (知らなかった) を
利用して (なぜ素直に Ubuntu 使わないのかな？) 構築したそうだ。griddynamic.net
のパッケージは既にエキスパイアしているらしい&hellip;。nova ノードは既に200台規模。
libvirt, kvm 周りにパッチを独自で当てているそうで、その具体的内容が聞けた。た
だこの辺は OpenStack のアップデートに追いつく作業がめちゃ大変になるだろうなぁ
と想像する。..</p>

<h2 id="全体を通して">全体を通して</h2>

<p>Opscode Chef に並ぶ技術が出始めてきた。OpenStack で nodes を追加するところまで
自動化したとしても vm 上の操作を手作業するわけにはいかないし、必然なのだろう。
よりディストリビューションに依存しない、インフラ系・アプリ系共に理解出来る、自
由度のある、汎用性のある技術を我々が選びながら使っていく必要がありそう。僕らイ
ンフラ系エンジニアの仕事内容も、この辺りにシフトしていく時代はもう目の前まで来
ているだろう。OpenStack を構築する手順が JuJu 等でコマンド一発なのを見て唖然と
したのも確か。誰でもできる操作になるのも必然で、ただどういう操作がされているか
を理解し、必要に応じて改変して開発していく力は身に着けておかないと、インフラ系
は特に、仕事内容が単純化していく一方になる気がする。危機を感じつつチャンスに結
びつけるいい機会なのかなぁ。あとは監視周りも自動コンフィギュレーションされない
と、真の自動化には至らないなぁ。</p>

<p>当日は BitIsle スタッフのみなさん、コミュニティのみなさん、ありがとうございま
したぁー。</p>
</p>

    <footer>
        <ul class="actions">
            <li><a href="https://jedipunkz.github.io/blog/2012/08/29/7th-openstack-meetup/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    
                        Categories
                    
                
            </li>
        
    

    
    
        <li><a href='/categories/infrastructure'>infrastructure</a></li>
    
        <li><a href='/categories/report'>report</a></li>
    
</ul>

    </footer>
</article>


        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="https://jedipunkz.github.io/blog/2012/08/26/all-in-one-openstack-installation/">OpenStack ESSEX オールインワン インストール</a></h2>
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2012-08-26'>
            August 26, 2012</time>
        <span class="author"></span>
        
        
    </div>
</header>

    

    
    <p><p>OpenStack のインストールってしんどいなぁ、って感じて devstack
<a href="http://devstack.org/">http://devstack.org/</a> とかで構築して中を覗いていたのですが、そもそも devstack
って再起動してしまえば何も起動してこないし、swift がインストールされないしで。
やっぱり公式のマニュアル見ながらインストールするしかないかぁって&hellip;。感じてい
たのですが&hellip;。</p>

<p><a href="http://docs.openstack.org/essex/openstack-compute/starter/os-compute-starterguide-trunk.pdf">http://docs.openstack.org/essex/openstack-compute/starter/os-compute-starterguide-trunk.pdf</a></p>

<p>このマニュアルの前提は、ネットワーク2セグメント・server1, server2 の計2台が前
提なのですが、環境作るのがしんどいので、オールインワンな構築がしたい！サーバ1台で OpenStack ESSEX を
インストールしたい！で、シェルスクリプトを作ったのでそれを使ったインストール方法を紹介します。</p>

<p><img src="http://jedipunkz.github.com/pix/openstack_thinkpad.jpg"></p>

<p>ぼくの Thinkpad に OpenStack ESSEX をインストールしてブラウザで localhost に接続して
いる画面です。ちゃんと KVM VM が起動して noVNC で接続できています。自己満足やぁ。</p>

<h2 id="前提条件">前提条件</h2>

<ul>
<li>Ubuntu Server 12.04 LTS amd64 がインストールされていること</li>
<li>Intel-VT もしくは AMD−Vなマシン</li>
<li>NIC が一つ以上ついているマシン</li>
<li>/dev/sda6, /dev/sda7 (デバイス名は何でもいい) の2つが未使用で空いていること</li>
</ul>

<p>です。</p>

<h2 id="構成">構成</h2>

<p>1 NIC を前提に eth0 と eth0:0 の2つを想定すると、こんな構成になります。eth0:0
は完全にダミーで IP アドレスは何でもいいです。br100 ブリッジデバイス上で VM が
NW I/F を持ちます。floating range ってのは OpenStack で言うグローバル IP レン
ジ。グローバルである必要は無いですが eth0 と同じレンジの IP アドレスを VM に付
与出来ます。/dev/sda6 が nova-volumes で /dev/sda7 が swift 。なので OS インス
トール時に2つのデバイスを未使用で空けておいてください。</p>

<pre><code>+--+--+--+
|VM|VM|VM|  192.168.4.32/27
+--+--+--+..
+----------+ +--------+
|          | | br100  | 192.168.4.33/27 -&gt; floating range : 10.200.8.32/27
|          | +--------+
|          | | eth0:0 | 192.168.3.1       disk devices
|   Host   | +--------+   (dummy)  +------------------------+
|          |                       | /dev/sda6 nova-volumes |
|          | +--------+            +------------------------+
|          | |  eth0  | ${HOST_IP} | /dev/sda7 swift        |
+----------+ +--------+            +------------------------+
|              nw I/Fs
+----------+
|   CPE    |
+----------+
</code></pre>

<h2 id="インストール手順">インストール手順</h2>

<p>インストール手順は簡単です。</p>

<pre><code>% sudo -i
# git clone git://github.com/jedipunkz/openstack_install.git
</code></pre>

<p>して取得したスクリプトを環境に合わせて環境変数設定します。スクリプト上部のこれ
らの内容を、環境に合わせて設定。${HOST_IP} と ${NOVA_VOLUMES_DEV},
${SWIFT_DEV} だけ気をつければ OK です。その他は内部ネットワークの設定なので何
でもつながります。</p>

<pre><code># -----------------------------------------------------------------
# Environment Parameter
# -----------------------------------------------------------------
HOST_IP='10.200.8.15'
HOST_MASK='255.255.255.0'
HOST_NETWORK='10.200.8.0'
HOST_BROADCAST='10.200.8.255'
GATEWAY='10.200.8.1'
MYSQL_PASS='secret'
FIXED_RANGE='192.168.4.1/27'
FLOATING_RANGE='10.200.8.32/27'
FLAT_NETWORK_DHCP_START='192.168.4.33'
ISCSI_IP_PREFIX='192.168.4'
NOVA_VOLUMES_DEV='/dev/sda6'
SWIFT_DEV='/dev/sda7'
</code></pre>

<p>で実行。</p>

<pre><code># chmod +x openstack_install/openstack_install.sh
# ./openstak_install/openstack_install.sh allinone
( wait some minutes...)
</code></pre>

<p>マシンによりますが、10分弱すると OpenStack が構築されているはずです。</p>

<h2 id="os-イメージと-ssh-キーペアのインストール">OS イメージと SSH キーペアのインストール</h2>

<p>上記の手順で OpenStack は構築されるのですが、VM を起動するには OS イメージが必
要ですよね。これは自分で用意するしかないです。ただ、これは簡単で下記の手順で出
来ます。</p>

<h4 id="os-イメージ作成">OS イメージ作成</h4>

<p>サンプルで Ubuntu Server 12.04 LTS amd64 なイメージをここで作ってみます。</p>

<pre><code># kvm-image create -f qcow2 server.img 5G
# wget http://gb.releases.ubuntu.com//precise/ubuntu-12.04-server-amd64.iso
# kvm -m 256 -cdrom ubuntu-12.04-server-amd64.iso -drive file=server.img,if=virtio,index=0 -boot d -net nic -net user -nographic -vnc :0
</code></pre>

<p>手元の端末の VNC ツールで ${HOST_IP}:0 に接続し OS のインストールを済ませます。
その後、下記のコマンドで HDD から起動してあげて&hellip;</p>

<pre><code># kvm -m 256 -drive file=server.img,if=virtio,index=0 -boot c -net nic -net user -nographic -vnc :0
</code></pre>

<p>再度、VNC で VM に接続して..</p>

<pre><code># sudo rm -rf /etc/udev/rules.d/70-persistent-net.rules
# shutdown -h now
</code></pre>

<p>上記の操作をしたら OS イメージ作成は終わり。その他のディストリビューションでの
イメージ作成については公式マニュアルに書いてあります。</p>

<h4 id="glance-に-os-イメージをインストール">Glance に OS イメージをインストール</h4>

<p>作成した OS イメージを Glance に追加します。先ほどのスクリプトで生成された
/root/.openstack が Glance に接続するために必要なので zsh の場合 source してから&hellip;</p>

<pre><code># source /root/.openstack
# glance add name=&quot;Ubuntu Server 12.04LTS&quot; is_public=true container_format=ovf disk_format=qcow2 &lt; server.img
</code></pre>

<p>で追加出来ます。.openstack は bash でも取得できるのでその際は</p>

<pre><code># . /root/.openstack
</code></pre>

<p>してください。root ユーザ以外でも操作出来ます。</p>

<h4 id="ssh-キーペアの生成とインストール">SSH キーペアの生成とインストール</h4>

<p>VM に割り当てる SSH キーペアを作ってインストールする手順です。</p>

<pre><code># ssh-keygen
# nova keypair-add --pub_key .ssh/id_rsa.pub mykey
# nova keypair-list
</code></pre>

<h4 id="horizon-へ接続">Horizon へ接続</h4>

<p>いよいよ Horizon へ接続です。Horizon は OpenStack ESSEX から取り込まれた Web
UI です。VM の作成・削除、ネットワークの設定等がブラウザで操作出来ます。</p>

<pre><code>http://${HOST_IP
</code></pre>

<p>に接続してユーザ : &lsquo;admin&rsquo;, パスワード &lsquo;admin&rsquo; でログインしてください。</p>

<h2 id="まとめ">まとめ</h2>

<p>OpenStack はしんどいｗ ですが来月 <sup>2012</sup>&frasl;<sub>09</sub> リリース予定の Folsom は &lsquo;Easy
Setup&rsquo; がフューチャされてるそうです。期待。手動で構築していると glance のとこ
ろで ID 地獄にハマりますｗ 今回の手順で all in one な環境ができたら、色々覗い
てみてコンポーネント毎に Node を切り出すってことも考えないといけないと思います。
それぞれは HTTP ベースの API で接続できれば OK なので切り出すこと自体は簡単。
冗長を組む方法は.. これから調べます。keystone, glance を拡張・冗長させるって出
来るのか？難しそう。CloudStack と違って rabbitmq-server でキューイングしてくれ
るので、Node が増えた時の対処は考えれれているよう。</p>

<p>あと、OS イメージではなくて AMI で VM を作る方法もあるのですが AMI の作成方法は Web
を見ていると沢山載っていますので参考にして作ってみてください。</p>
</p>

    <footer>
        <ul class="actions">
            <li><a href="https://jedipunkz.github.io/blog/2012/08/26/all-in-one-openstack-installation/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    
                        Category
                    
                
            </li>
        
    

    
    
        <li><a href='/categories/infrastructure'>infrastructure</a></li>
    
</ul>

    </footer>
</article>


        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="https://jedipunkz.github.io/blog/2012/08/18/opscode-bootstrap-chef-server/">Opscode Bootstrap を使った Chef-Server 構築</a></h2>
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2012-08-18'>
            August 18, 2012</time>
        <span class="author"></span>
        
        
    </div>
</header>

    

    
    <p><p>chef-server の構築は少し面倒だと前回の記事
<a href="http://jedipunkz.github.com/blog/2012/08/18/chef-solo/">http://jedipunkz.github.com/blog/2012/08/18/chef-solo/</a> に書いたのですが、
opscode が提供している bootstrap を用いると、構築作業がほぼ自動化出来ます。
今回はこの手順を書いていきます。</p>

<h2 id="chef-のインストール">chef のインストール</h2>

<p>前回同様に rbenv を使って ruby をインストールし chef を gem でインストールして
いきます。</p>

<pre><code>% sudo apt-get update
% sudo apt-get install zlib1g-dev build-essential libssl-dev
% sudo -i
# cd ~
# git clone git://github.com/sstephenson/rbenv.git .rbenv
# echo 'export PATH=&quot;$HOME/.rbenv/bin:$PATH&quot;' &gt;&gt; ~/.zshrc
# echo 'eval &quot;$(rbenv init -)&quot;' &gt;&gt; ~/.zshrc
</code></pre>

<p>ruby-build をインストールします。</p>

<pre><code># mkdir -p ~/.rbenv/plugins
# cd ~/.rbenv/plugins
# git clone git://github.com/sstephenson/ruby-build.git
</code></pre>

<p>ruby-1.9.2 インストール</p>

<pre><code># rbenv install 1.9.2-p290
# rbenv global 1.9.2-p290
# rbenv rehash
</code></pre>

<p>gem を使って、chef, chef-server-api をインストールします</p>

<pre><code># gem install chef
# gem install chef-server-api
</code></pre>

<h2 id="opscode-bootstrap-を使った-chef-server-の構築">opscode bootstrap を使った chef-server の構築</h2>

<p>まずは chef-solo の環境整備。この bootstrap は chef-solo で実行出来るクックブッ
ク集になっています。中を覗くと &lsquo;apache2, chef, chef-server, couchdb, erlang,
rabgitmq&rsquo; などなど必要なミドルウェア群のクックブックが入っていることが判ります。</p>

<p>まずは chef-solo の環境を整備します。</p>

<pre><code># mkdir /etc/chef
# vi /etc/chef/solo.rb
# cat /etc/chef/solo.rb
file_cache_path &quot;/tmp/chef-solo&quot;
cookbook_path &quot;/tmp/chef-solo/cookbooks&quot;
# vi /etc/chef/chef.json
# cat /etc/chef/chef.json
{
  &quot;chef_server&quot;: {
  &quot;server_url&quot;: &quot;http://localhost:4000&quot;
  },
  &quot;run_list&quot;: [ &quot;recipe[chef-server::rubygems-install]&quot; ]
}
</code></pre>

<p>solo.rb で指定したパスは任意のもので構いません。</p>

<p>Amazon S3 上に opscode bootstrap があります。いよいよ chef-solo で bootstrap
を実行します。</p>

<pre><code># chef-solo -c /etc/chef/solo.rb -j /etc/chef/chef.json -r http://s3.amazonaws.com/chef-solo/bootstrap-latest.tar.gz
</code></pre>

<p>これで chef-server 構築は終わりです。実行したホストに couchDB, Erlang などが構
成されていることが分かると思います。</p>

<p>次に knife の環境を整備します。knife は chef の操作を行うためのコマンドライン
ツールです。</p>

<pre><code># mkdir -p ~/.chef
# cp /etc/chef/validation.pem /etc/chef/webui.pem ~/.chef
# sudo chown -R root ~/.chef
# knife configure -i
Where should I put the config file? [~/.chef/knife.rb] 
Please enter the chef server URL: [http://localhost:4000] 
Please enter a clientname for the new client: [root]
Please enter the existing admin clientname: [chef-webui] 
Please enter the location of the existing admin client's private key:
# [/etc/chef/webui.pem] /root/.chef/webui.pem
Please enter the validation clientname: [chef-validator] 
Please enter the location of the validation key:
# [/etc/chef/validation.pem] /root/.chef/validation.pem
Please enter the path to a chef repository (or leave blank): 
WARN: Creating initial API user...
INFO: Created (or updated) client[root]
WARN: Configuration file written to /home/root/.chef/knife.rb
</code></pre>

<p>パラメータはほぼそのまま入力してください。pem ファイルのパス指定だけ先ほど
root ユーザの HOME ディレクトリにインストールしたモノを指定してください。</p>

<p>これで下記のように knife が使えるようになっています。</p>

<pre><code># knife client list
chef-validator
chef-webui
root
</code></pre>

<p>今回は以上です。この chef-server の構築を knife::server というツールで実現する
方法もあります。</p>

<p><a href="http://fnichol.github.com/knife-server/">http://fnichol.github.com/knife-server/</a></p>

<p>同じく bootstrap を指定して構築するツールなのですが、これを使う利点として</p>

<ul>
<li>chef-server 構成のバックアップが取れる</li>
<li>バックアップを元に復元できる</li>
</ul>

<p>があります。これは便利。ただし knife が最初から使える環境に限ります。</p>

<p>これらツールを使うことを前提にしないと、作業が複雑化するため、必須だと思います。
手作業はミスの元ですし。ただ、一度は手作業でやってみて構成を理解することはしな
くてはならないでしょう。couchDB, Rabbitmq などの新しいミドルウェアについての理
解も深めなくてはならないでしょうし、これらをスケールさせることを前提にしておか
ないとノードの数が増える度に負荷が上昇していくので将来困るでしょう。前回の記事
でも触れましたが chef-solo を用いた場合はそれらの心配が無くなります。</p>
</p>

    <footer>
        <ul class="actions">
            <li><a href="https://jedipunkz.github.io/blog/2012/08/18/opscode-bootstrap-chef-server/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    
                        Category
                    
                
            </li>
        
    

    
    
        <li><a href='/categories/infrastructure'>infrastructure</a></li>
    
</ul>

    </footer>
</article>


        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="https://jedipunkz.github.io/blog/2012/08/18/chef-solo/">chef-solo で学ぶ chef の基本動作</a></h2>
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2012-08-18'>
            August 18, 2012</time>
        <span class="author"></span>
        
        
    </div>
</header>

    

    
    <p><p>仕事で Opesocd Chef の情報収集をしてたのですが、僕が感じるにこれはインフラエン
ジニアの未来だと。逆に言うとインフラエンジニアの危機。AWS のようなクラウドサー
ビスがあればアプリケーションエンジニアが今までインフラエンジニアが行っていた作
業を自ら出来てしまうからです。</p>

<p>インフラエンジニアなら身に付けるしかない！って僕が感じる Chef について
chef-solo を通して理解するために情報まとめました。</p>

<p>chef には chef-server 構成で動作するものと chef-solo というサーバ無しで動作す
るものがある。chef-server は構築するのが少し大変 (後に方法をブログに書きたい)
なので今回は chef-solo を使ってみる。ちなみに Opscode が chef-server のホスティ
ングサービスを展開している。彼らとしてはこちらがメイン。</p>

<h2 id="chef-solo-の入れ方">chef-solo の入れ方</h2>

<p>opscode が推奨している ruby-1.9.2 をインストールする。rvm は色々問題を招き寄せ
るので rbenv を使って環境整えます。root ユーザ環境内に入れてください。</p>

<p>必要なパッケージをインストール</p>

<pre><code>% sudo apt-get update
% sudo apt-get install build-essential zlib1g-dev libssl-dev
</code></pre>

<p>root ユーザにてrbenv をインストール</p>

<pre><code>% sudo -i
# cd ~
# git clone git://github.com/sstephenson/rbenv.git .rbenv
# echo 'export PATH=&quot;$HOME/.rbenv/bin:$PATH&quot;' &gt;&gt; ~/.zshrc
# echo 'eval &quot;$(rbenv init -)&quot;' &gt;&gt; ~/.zshrc
</code></pre>

<p>ruby-build をインストール</p>

<pre><code># mkdir -p ~/.rbenv/plugins
# cd ~/.rbenv/plugins
# git clone git://github.com/sstephenson/ruby-build.git
</code></pre>

<p>opscode が推奨している ruby バージョン 1.9.2 をインストール</p>

<pre><code># rbenv install 1.9.2-p290
# rbenv global 1.9.2-p290
# rbenv rehash
</code></pre>

<p>capistrano, chef のインストールを gem を使い行う</p>

<pre><code># gem install chef
# rbenv rehash
</code></pre>

<p>これらは &lsquo;root&rsquo; ユーザ環境内に構築する必要がある。chef がそれを前提としている
からだ。また、perl と違い ruby は後方互換性がないので将来のことを考え rbenv で
バージョンを管理し続ける必要がある、と思う。</p>

<h2 id="chef-solo-の設定">chef-solo の設定</h2>

<p>/etc/chef/chef.json ファイルを修正することで、chef-solo で実行する recipe の追
加を行う。これは複数指定することが可能。</p>

<pre><code>{
    &quot;run_list&quot;: [
        &quot;recipe[ntp]&quot;,
    ]
}
</code></pre>

<p>上記は ntp レシピ を追加した例。次に /etc/chef/solo.rb を生成する。これは
chef-solo 動作に必要な PATH 指定を主に行う。</p>

<pre><code>file_cache_path &quot;/tmp/chef-solo&quot;
cookbook_path [&quot;/home/jedipunkz/cookbooks&quot;]
role_path &quot;/home/jedipunkz/role&quot;
log_level :debug
</code></pre>

<p>上記パラメータの説明は下記の通り。</p>

<ul>
<li>file_cache_path : cache 用のディレクトリ指定</li>
<li>cookbook_path : cookbook を配置するディレクトリ指定</li>
<li>role_path : role ディレクトリ指定</li>
<li>log_level : Log Level の指定</li>
</ul>

<h2 id="サンプルクックブックのダウンロードと理解">サンプルクックブックのダウンロードと理解</h2>

<p>サンプルとして opscode が提供している &lsquo;ntp&rsquo; を持ってくる。中身が簡単に理解出来
るものなので最初理解するために持ってくるものとしては最適。</p>

<pre><code>% cd /home/jedipunkz/cookbooks
% git clone https://github.com/opscode-cookbooks/ntp.git
</code></pre>

<p>持ってきたクックブックの構造は</p>

<pre><code>ntp .
    |- attributes
    |- templates
    |- recipes
    |- meradata.rb
    |-..
    |-..
</code></pre>

<p>となっている。attribute/default.rb の一部分を抜粋を記してみた。</p>

<pre><code>default['ntp']['servers']   = %w{ 0.pool.ntp.org 1.pool.ntp.org 2.pool.ntp.org 3.pool.ntp.org }
default['ntp']['packages'] = %w{ ntp ntpdate }
default['ntp']['service'] = &quot;ntp&quot;
default['ntp']['varlibdir'] = &quot;/var/lib/ntp&quot;
default['ntp']['conf_owner'] = &quot;root&quot;
default['ntp']['conf_group'] = &quot;root&quot;
default['ntp']['var_owner'] = &quot;ntp&quot;
default['ntp']['var_group'] = &quot;ntp&quot;
</code></pre>

<p>chef は ruby の DSL で記述するが template や recipe 内で指定するパラメータ集と
なるのが attribute となる。上を見てみると ntp のパッケージ名やディレクトリのオー
ナー情報等が記されている。</p>

<p>templates/default/ntp.conf.erb を見てみると&hellip;</p>

<pre><code>driftfile &lt;%= node['ntp']['driftfile'] %&gt;
statsdir &lt;%= node['ntp']['statsdir'] %&gt;

statistics loopstats peerstats clockstats
filegen loopstats file loopstats type day enable
filegen peerstats file peerstats type day enable
filegen clockstats file clockstats type day enable

&lt;%# If ntp.peers is not empty %&gt;
&lt;% unless node['ntp']['peers'].empty? -%&gt;
  &lt;%# Loop through defined peers, but don't peer with ourself %&gt;
  &lt;% node['ntp']['peers'].each do |ntppeer| -%&gt;
    &lt;% if node['ipaddress'] != ntppeer and node['fqdn'] != ntppeer %&gt;
peer &lt;%= ntppeer %&gt; iburst
restrict &lt;%= ntppeer %&gt; nomodify
    &lt;% end -%&gt;
  &lt;% end -%&gt;
&lt;% end -%&gt;
</code></pre>

<p>これはインストールする /etc/ntp.conf (recipde で後に指定する) の内容そのままだ。
先程も書いたが chef は ruby の DSL 記述が基本なので attribute で指定したパラメー
タを持ってきて、こういったコンフィグファイルを生成出来る。では最後に recipe を
見てみる。この recipe が chef の本体と言っていいところですね。上部の抜粋です。</p>

<pre><code>node['ntp']['packages'].each do |ntppkg|
  package ntppkg
end
</code></pre>

<p>この [&lsquo;ntp&rsquo;][&lsquo;packages&rsquo;] は attributes/default.rb に %w{ ntp ntpdate } と書い
てある。つまり ntp, ntpdate の配列を ntppkg として回して chef resources の
&lsquo;package&rsquo; を使ってインストールしている。resources については chef の公式ドキュ
メントを読むと良い。recipe で使える記述全てが1ページにまとまっている。</p>

<p><a href="http://wiki.opscode.com/display/chef/Resources">http://wiki.opscode.com/display/chef/Resources</a></p>

<p>次に recipe の下部を抜粋してみた。chef resources の template によって ntp.conf
をインストールしている。</p>

<pre><code>template &quot;/etc/ntp.conf&quot; do
  source &quot;ntp.conf.erb&quot;
  owner node['ntp']['conf_owner'] 
  group node['ntp']['conf_group']
  mode &quot;0644&quot;
  notifies :restart, resources(:service =&gt; node['ntp']['service'])
end
</code></pre>

<p>source によって template/default/ntp.conf.erb を呼び出し owner, group でファイ
ルのオーナー情報を、mode でパーミッションを指定している。また修正が入った際に
ntp サービスの再起動を行っているのが最終行だ。</p>

<p>抜粋で例を挙げながらだったが、Resources の記述方法さえ理解してしまえば全てが理
解出来るだろうし、自分でクックブックを作ることも簡単だろう。</p>

<h2 id="chef-solo-の実行">chef-solo の実行</h2>

<p>ではいよいよ chef-solo の実行。</p>

<p>上記で生成した chef.json と solo.rb を指定し chef-solo を実行することで上記
run_list で指定した recipe &lsquo;ntp&rsquo; が実行される。</p>

<pre><code>% sudo -i
# chef-solo -c /etc/chef/solo.rb -j /etc/chef/chef.json
</code></pre>

<h2 id="まとめ">まとめ</h2>

<p>chef-server 構成の組み方は後日ブログで書いてみたい。先日 #DevLOVE に参加した際
にも話題になったが、chef-solo を使うか chef-server 構成を組むか、まだ議論が必
要そう。chef-server 構成を組むことは簡単では無いが普通にエンジニアなら組めるだ
ろう。が、組んだところで拡張性・冗長性・を考えた構成を組むにはまだまだノウハウ
が足りない。また couchDB, rabbitmq など比較的新しいミドルウェアが使われている
ので、これから経験積まないと難しいだろう。それに比べて chef-solo は上記の通り
とてもシンプル。しかも chef-solo を実行する node 自身は必然的に数が増え拡張す
るし、それを受ける apt レポジトリは単純な HTTP なので拡張・冗長は簡単だろう。</p>

<p>また、capistrano と chef-solo を組み合わせることで、role といった概念をもたせ
たり、workstation で一括操作といった利便性も持たせることが出来る。ある意味
chef-solo を使うなら必然的な点になりそう。capistrano との組み合わせについても
後日ブログで書いてみたい。</p>

<p>chef を理解すること自体はそんなには難しくないし、これからの時代に必要になるこ
とは眼に見えているので、学んでおいて損はしないだろう。</p>
</p>

    <footer>
        <ul class="actions">
            <li><a href="https://jedipunkz.github.io/blog/2012/08/18/chef-solo/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    
                        Category
                    
                
            </li>
        
    

    
    
        <li><a href='/categories/infrastructure'>infrastructure</a></li>
    
</ul>

    </footer>
</article>


        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="https://jedipunkz.github.io/blog/2012/07/22/number-devlove-nican-jia-sitekimasita.-chef-de-devops/">#DevLOVE に参加してきました。Chef De DevOps</a></h2>
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2012-07-22'>
            July 22, 2012</time>
        <span class="author"></span>
        
        
    </div>
</header>

    

    
    <p><p>2012年07月21日に大崎のフィーチャーアーキテクトさんで行われた #DevLOVE (Chef De
DevOps) に参加してきました。</p>

<pre><code>開催日 : 2012年07月21日(土曜日) 15:00 - 20:40
場所   : 大崎 フューチャーアーキテクトさま
URL    : http://www.zusaar.com/event/314003
</code></pre>

<p>仕事場でも Chef の利用を考え始めていて今回いい機会でした。半年前と比べるとだい
ぶ揃って来ましたが、まだまだ資料の少ない Chef。貴重な機会でした。</p>

<p>プログラムは下の通り。</p>

<pre><code>*『Chefの下準備』by Ryutaro YOSHIBA [ @ryuzee ]
*『Chef自慢のレシピ披露』 by 中島弘貴さん [ @nakashii_ ]
* ワークショップ『みんなでCooking』
* dialog『試食会』
* Niftyさんのスーパー宣伝タイム!!!
*『渾身会』
</code></pre>

<p>@ryuzee さんの &ldquo;Chef の下準備&rdquo; は SlideShare に使った資料が公開されています。</p>

<p><iframe src="http://www.slideshare.net/slideshow/embed_code/13712176"
width="427" height="356" frameborder="0" marginwidth="0" marginheight="0"
scrolling="no" style="border:1px solid #CCC;border-width:1px 1px
0;margin-bottom:5px" allowfullscreen> </iframe> <div
style="margin-bottom:5px"> <strong> <a
href="http://www.slideshare.net/Ryuzee/20120721-chef-devlove" title="20120721
chefの下準備 #devlove" target="_blank">20120721 chefの下準備 #devlove</a>
</strong> from <strong><a href="http://www.slideshare.net/Ryuzee"
target="_blank">Ryuzee YOSHIBA</a></strong> </div></p>

<p>印象的だったのが、VirtualBox + Vagrant という環境。実際に使っていらっしゃいま
した。MacBook の中に仮想環境とそのインターフェースである Vegrant を使って、デ
プロイのテスト等が実施できるそうです。また、Vegrant 設定ファイルは Chef のレシ
ピを自動読込して、常に本番環境と同じ状態にしているそうです。CloudFormation と
いうキーワードや Capistrano というキーワードが出てきました。最近よく耳にするワー
ドです。また CI は Jenkins だよね、だったり。</p>

<p>3番目のプログラム &ldquo;ワークショップ、みんなで Cooking&rdquo; は 4-6 人の組みになり、実
際に Chef のレシピを書いてみようというもの。今回は wordpress の構築のためのレ
シピを書いていきました。僕らの組みも時間ギリギリでレシピの投入を終えました。
wordpress の設定ファイル wp-config.php と mysql への wordpress 用データベース
の作成を実際に attribute, template, script ら Resources を使ってレシピを書きま
した。簡単な例でしたが、みなとコミュニケーションがとれたのでいい機会でした。</p>

<p>dialog &ldquo;試食会&rdquo; では、グループ毎、またグループを入れ糧のディスカッション。使っ
てみてどうだったか？を話し合ってそこから議論を伸ばしていきました。</p>

<p>やっぱり僕も参加する前からそうだったのですが、一番皆が気になっているのが、</p>

<pre><code>&quot;chef-solo + capistrano ? それとも chef-server がいいの？&quot;
</code></pre>

<p>でした。実際に使っていらっしゃる CA さんの話によると、20台までは chef-solo +
capistrano の構成が良いと。そして100台規模になると chef-server が良いそうです。
具体的に何が chef-solo で問題になるのかが聞けなかったのですが、ちょっと僕らの
課題にしてみようかと思います。また、CA さんでは puppet を使っていらっしゃる部
署もあるそうで、chef-server の動作が不安定？とかで400台規模になると puppet が
良くなると。そして chef-server はいまは rabbitmq, couchDB, erlang などの構成で
出来ているのですが、そのうちどれかが (erlang の solr ?) が mysql に置き換わる
と噂を聞きました。</p>

<p>また、nifty さんが現在 opscode chef wiki を翻訳されているのですが、僕も非常に
興味があります。参加させてもらおうかな。また nifty さんが nifty cloud 用
knife-ec2 を公開しているそうで説明がありました。自社にクラウドシステムがあると、
色々楽しめるよなぁ&hellip;。いいな。</p>

<p>[2012/07/23 15:00 追記]
nifty の @tily さんが当日使った資料を公開なさったので貼り付けておきます。</p>

<p><iframe src="http://www.slideshare.net/slideshow/embed_code/13721102"
width="427" height="356" frameborder="0" marginwidth="0" marginheight="0"
scrolling="no" style="border:1px solid #CCC;border-width:1px 1px
0;margin-bottom:5px" allowfullscreen> </iframe> <div
style="margin-bottom:5px"> <strong> <a
href="http://www.slideshare.net/tidnlyam/chef-13721102" title="ニフティ社内の
Chef 利用について" target="_blank">ニフティ社内の Chef 利用について</a>
</strong> from <strong><a href="http://www.slideshare.net/tidnlyam"
target="_blank">tidnlyam</a></strong> </div></p>

<p>以上が &ldquo;Chef De DevOps&rdquo; の参加レポートで、ここからは僕らの課題でありここ1週間
くらいで取り組もうとしている点。</p>

<p>chef-server の構築ですが、ubuntu + opscode の deb package を使う方法もあるので
すが、これだと opscode が推奨している ruby のバージョン 1.9.2 ではなく 1.8.7
になってしまいます。これは ubuntu, debian の stable release もしくは
development release が frozen しているからです。なので、今僕が考えているのは、
chef-solo と opscode bootstrap の組み合わせで構築する方法です。</p>

<p><a href="http://wiki.opscode.com/display/chef/Installing+Chef+Server+using+Chef+Solo">http://wiki.opscode.com/display/chef/Installing+Chef+Server+using+Chef+Solo</a></p>

<p>この bootstrap は opscode が chef-server 構築用レシピとして公開しているもので
す。これを使えば chef client さえ入っていれば構築できてしまうという。この手順
は一度手元でも確認してみました。(Ubuntu Server 12.04 LTS amd64).</p>

<p>また Chef のメーリングリストで聞いてみたところ、やはり推奨の ruby バージョンは
1.9.2 であって、この bootstrap の方法と、あとは knife::server というものです。</p>

<p>まだ僕は手元で確認できていないのですが、こちらにあるようです。</p>

<p><a href="http://fnichol.github.com/knife-server/">http://fnichol.github.com/knife-server/</a></p>

<p>chef-server 構成だと rabbitmq に queue が溜まったり、couchDB のディスクを溢れ
させたりとトラブル起きた時の切り分けだったり対処方法だったり、まだまだ情報少な
いので苦労するだろうなぁと個人的には感じました。chef-solo + capistrano の構成
も考慮しつつ、このあたり調べて行こうと思います。</p>
</p>

    <footer>
        <ul class="actions">
            <li><a href="https://jedipunkz.github.io/blog/2012/07/22/number-devlove-nican-jia-sitekimasita.-chef-de-devops/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    
                        Category
                    
                
            </li>
        
    

    
    
        <li><a href='/categories/infrastructure'>infrastructure</a></li>
    
</ul>

    </footer>
</article>


        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="https://jedipunkz.github.io/blog/2012/06/16/dns-report-interop2012/">DNS の猛威とその対策, 参加レポ #interop2012</a></h2>
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2012-06-16'>
            June 16, 2012</time>
        <span class="author"></span>
        
        
    </div>
</header>

    

    
    <p><p>interop 2012 で &lsquo;DNS の猛威とその対策&rsquo; を傍聴してきました。簡単にレポート書い
ておきます。ちょっと油断しただけで大きな問題のアップデートが出てくる DNS。怖い
です..。</p>

<h2 id="本講義の概要">本講義の概要</h2>

<p>ブラジルで大規模な ISP への DNS ポイゾニング攻撃が発生。それら猛威について理解
すると同時に技術的対応策や具体的な対応プロセスについて説明。</p>

<h2 id="イントロダクション-インターネットエクスチェンジ-石田さん">イントロダクション : インターネットエクスチェンジ 石田さん</h2>

<p>DNS を取り巻く状況</p>

<ul>
<li>DNS を乗っ取って悪事を働く試み : DNS Changer</li>
<li>DNS そのものをセキュアにする方向性 : DNSSEC</li>
<li>DNS に様々な制御を任せる方向性 : SPF, AAAA, DANE, 児童ポルノブロッキング</li>
</ul>

<h2 id="事例-iij-松崎さん">事例 : IIJ 松崎さん</h2>

<h4 id="2011-11-ブラジルの事例"><sup>2011</sup>&frasl;<sub>11</sub> ブラジルの事例</h4>

<p>著名サイトへのアクセスを行うと malware が仕込まれたサイトへ誘導。ホームルータ
のキャッシュがポイゾニングされた。</p>

<h4 id="とあるホームルータの問題">とあるホームルータの問題</h4>

<ul>
<li>admin パスワードが管理 web で見える</li>
<li>wan からのアクセスが有効</li>
<li>同じチップセットを使っている製品で同様の問題..</li>
<li>wan からルータへアクセスすると html ソースにアカウント情報が平文で書かれてい
た</li>
</ul>

<p>これは怖い..。</p>

<h4 id="攻撃活動の実施">攻撃活動の実施</h4>

<p>攻撃者が行う手順。</p>

<ul>
<li>脆弱性な CPE 発見</li>
<li>パスワード書き換え</li>
<li>CPE が参照する DNS の書き換え</li>
<li>著名サイト向け DNS への応答を書き換え</li>
<li>malware サイトへ誘導</li>
<li>銀行の安全客員ツールを無効にする malware をインストールさせる</li>
<li>幾つかの銀行向け DNS 応答を書き換え、目的のフィッシングサイトに誘導。DNS 書
き換えは短い期間のみであった。</li>
</ul>

<h4 id="規模">規模</h4>

<p>2011年時点、450万の CPE の DNS が書き換えられていた。今年も 30万以上の CPE が
影響を受けたまま。</p>

<h4 id="その後">その後</h4>

<p>攻撃者が脆弱な CPE を探す試みはまだ続いている。ブラジル以外でも被害報告が。</p>

<h3 id="その他の事例-dns-changer">その他の事例 DNS Changer</h3>

<p>LAN 内の DHCP サーバに攻撃して配布する DNS を書き換えるとも言われている。
その後、FBI が参照用 DNS(攻撃者管理) を差し押さえ。いきなり止めると、ユーザが
インターネットへの接続ができなくなるので、同じ IP アドレスでキャッシュサーバを
運用。まだ35万程度の感染ホストがあるので、キャッシュ DNS の運用を 2012/7/9 ま
で延長決定。</p>

<ul>
<li>JPCERT が用意している、確認サイト</li>
</ul>

<p>このサイトにアクセスすることで自環境が汚染されているかどうかが判ります。</p>

<p><a href="http://www.dns-ok.jpcert.or.jp/">http://www.dns-ok.jpcert.or.jp/</a></p>

<h2 id="幽霊ドメイン名について-jprs-坂口さん">幽霊ドメイン名について : JPRS 坂口さん</h2>

<h4 id="近年注目されている猛威">近年注目されている猛威</h4>

<ul>
<li>プロトコルによる定義が明確でない部分を突いた攻撃 (幽霊ドメイン名)</li>
<li>プロトコルの脆弱性をついた攻撃 (キャッシュポイゾニング)</li>
</ul>

<h4 id="傾向と対策">傾向と対策</h4>

<ul>
<li>1980年代から利用されていた</li>
<li>性善説から生まれた</li>
<li>利用者用途が大きく変動</li>
<li>DNS の重要性は未だ変わっていない</li>
</ul>

<p>DNS プロトコルを正しく理解が対策の第一歩!</p>

<h4 id="幽霊ドメイン名について">幽霊ドメイン名について</h4>

<ul>
<li>2012年2月8日 中国 Haixin Duan さんによる論文として発表</li>
<li>その前日にISC が緊急セキュリティアドバイザリを発表</li>
</ul>

<h4 id="幽霊ドメインが引き起こす問題">幽霊ドメインが引き起こす問題</h4>

<ul>
<li>ドメインを管理していたものからそのドメインを引き剥がすことができる</li>
<li>強制的にドメイン名を使用不可にしても使われ続ける</li>
<li>強制的に移転させても使われ続ける</li>
</ul>

<h4 id="動作原理">動作原理</h4>

<pre><code>キャッシュ -&gt; Root -&gt; JP DNS -&gt; 権威 DNS
</code></pre>

<p>の場合、キャッシュ上の TTL が切れたレコードに対して権威 DNS に問い合わせするが、
TTL が切れていないレコードについても問い合わせる。その際に新しい情報が入ってき
た場合上書きするか？破棄するか？は、実装次第。NS ホストを定期的に問い合わせす
ることで TTL を巻き戻し、永遠にキャッシュを利用させる攻撃手法。悪意のあるサイ
トのドメインを差し押さえても、使用され続ける可能性が出てくる。</p>

<h4 id="対策">対策</h4>

<ul>
<li>幽霊ドメインが発生しない実装へ書き換え (bind9, unbound は実装済み)</li>
<li>幽霊ドメイン名のキャッシュ情報をクリアする (ISC が推奨)</li>
</ul>

<h4 id="unbound-bind9-で取られた対策">Unbound, Bind9 で取られた対策</h4>

<p>権威 DNS に問い合わせはするが、TTL については上書きしない</p>

<h2 id="問題の対策-iij-山本さん">問題の対策 : IIJ 山本さん</h2>

<p>前提</p>

<ul>
<li>ブラジルの事例についてはキャッシュサーバで対策しても無益。</li>
</ul>

<h4 id="従来">従来</h4>

<ul>
<li>従来のキャッシュ DNS への攻撃はキャッシュポイゾニング</li>
<li>ISP のキャッシュ DNS サーバが標的</li>
<li>歴史的経緯でアクセスコントロールが緩い</li>
<li>プロトコル/実装の脆弱性を突き、偽のレコードをキャッシュさせる</li>
<li>理論的には20年前から知られていたが、実際の攻撃が困難だった</li>
</ul>

<h4 id="近年">近年</h4>

<ul>
<li>2008, カミンスキー攻撃が発表される</li>
<li>キャッシュしたレコードは TTL が来るまで再度検索されないが、これを可能にした</li>
<li>理論的な猛威から現実的なそれへ</li>
</ul>

<h4 id="対策-1">対策</h4>

<ul>
<li>問い合わせる際の Port 番号をランダム化 (queryID(16bit) x port (16bit))</li>
<li>一部商用サーバでは攻撃を検知する機能がアリ (攻撃を検知したら問い合わせを tcp
に切り替える)</li>
<li>ISP では ingress-filtering を可能な限り実施する</li>
<li>Open Recursive はやめる -&gt; 攻撃の機会を大幅に低減できる</li>
<li>DNSSEC の導入をすすめる -&gt; 中長期的な対策</li>
</ul>

<h4 id="dnssec-が短期的対策にならない理由">DNSSEC が短期的対策にならない理由</h4>

<ul>
<li>検証するキャッシュサーバがまだ少ない</li>
<li>DNSSEC で署名しているドメイン名がまだほとんど無い</li>
<li>鶏と卵問題</li>
<li>DNSSEC そのものの複雑さ -&gt; 理解しているエンジニアの数が少ない</li>
</ul>

<h4 id="dns-changer-への対策">DNS Changer への対策</h4>

<ul>
<li>CPE ベンダで対策するしか無い</li>
<li>DNS サーバでできることは無い</li>
</ul>

<p>ISP がやるとしたら&hellip;</p>

<ul>
<li>OP25B ならぬ OP53B 対策を行うか？</li>
<li>DNS トラフィックを見張る (Google Public DNS など例外はあるが、自社キャッシュ
以外への問い合わせは誤差の範囲のはず)</li>
</ul>

<h2 id="dns-の課題-iij-松崎さま">DNS の課題 : IIJ 松崎さま</h2>

<ul>
<li>児童ポルノフィルタ : 問題のあるサイトのドメイン名を書き換える</li>
<li>DNS64 : A へ書き換える -&gt; DNSSEC との併用が難しいことが取り上げられている &lt; RFC</li>
</ul>

<p>&lsquo;アクセス制御&rsquo;・&rsquo;書き換え&rsquo;, これらは攻撃者が行うことと同じ!</p>

<h2 id="所感-まとめ">所感, まとめ</h2>

<p>以上簡単でしたが、レポートでした。こういったイベントに1年出席しないだけで、知
らないことが出てくる DNS 界隈。毎年大きな脆弱性の出る Bind。使えて当たり前、障
害が起こると大問題になる DNS。管理者にとってつらい状況だけど、ユーザにとって無
くてはならないシステムなので、運用・開発に携わっている人間は、近年の状況をウォッ
チし続けていく必要がある。この講義を傍聴しているなかで、自社の環境の組み換えを
ぼんやり考えていました。</p>
</p>

    <footer>
        <ul class="actions">
            <li><a href="https://jedipunkz.github.io/blog/2012/06/16/dns-report-interop2012/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    
                        Category
                    
                
            </li>
        
    

    
    
        <li><a href='/categories/infrastructure'>infrastructure</a></li>
    
</ul>

    </footer>
</article>


        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="https://jedipunkz.github.io/blog/2012/06/14/vyatta-handson-interop2012/">Vyatta ハンズオン参加レポ #interop2012</a></h2>
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2012-06-14'>
            June 14, 2012</time>
        <span class="author"></span>
        
        
    </div>
</header>

    

    
    <p><p>interop 2012 で開催された &ldquo;仮想ルータ Vyatta を使ったネットワーク構築法&rdquo; に参
加してきました。簡単ですがレポートを書いておきます。</p>

<pre><code>開催日 : 2012/06/14(木)
場所   : 幕張メッセ Interop 2012
</code></pre>

<p>最初に所感。反省です。サーバエンジニアの視点でしか感じられていなかった。次期バー
ジョンの vPlane 実装などエンタープライズ向けとしても利用出来る可能性を感じる
し、比較的小さなリソースでハンズオン参加者30人程度の vyatta ルータを動かしてサ
クサク動いているのを見て、簡単にパフォーマンスがどうとか
<a href="http://jedipunkz.github.com/blog/2012/06/13/vyatta-vpn/">前回の記事</a>で言うべ
きじゃなかったぁ。ホント反省。</p>

<p>ではハンズオンの内容。</p>

<h2 id="最初に-基本情報の話">最初に、基本情報の話</h2>

<p>有償版と無償版の違い</p>

<ul>
<li>メジャーリリースのみの無償版に対して有償版はマイナーリリースもあり</li>
<li>有償版は保守あり</li>
<li>仮想 image template 機能が有償版であり</li>
<li>API, Web GUI, Config Sync, Systen Image Cloning が有償版であり</li>
</ul>

<p>image template, config sync, cloning など、有償版ではあると嬉しい機能がモリモ
リ。</p>

<h2 id="最近の利用ケース">最近の利用ケース</h2>

<ul>
<li>Vyatta + VM で VPN 接続環境構築</li>
<li>キャンパスネットワーク</li>
</ul>

<p>キャンパスネットワークのユースケースが一番多いそうだ。また、会場内にアンケート
をとった結果、仮想環境での構築を想定されている方が多数だった。</p>

<h2 id="構成と特徴">構成と特徴</h2>

<ul>
<li>Debian Gnu/Linux ベース</li>
<li>Quagga, StrongSwam が内部で動作</li>
</ul>

<p>apt-get など馴染み深いコマンドが使えます。
<a href="http://www.vyatta4people.org/tag/vybuddy/">http://www.vyatta4people.org/tag/vybuddy/</a>
ここに色々ノウハウがあるらしい。僕はまだ見ていません。まほろば工房の近藤さんに
教えて頂きました。あとでチェックします。</p>

<h2 id="バージョン">バージョン</h2>

<p>stable リリースは 6.4 。次期バージョン 6.5 では
<a href="http://www.vyatta.com/technology/vplane">vPlane</a> の実装が予定されている。これ
は IA サーバのコア毎に役割を変えるといったモノ。ノードが忙しくなった時に例えば
転送を司るコアには影響を与えない等。これは重要だ。サーバと違ってネットワーク機
器は何があっても死守しなくちゃいけない機能があるもんなぁ。6.5 に期待。</p>

<p>ここで、ハンズオンで課題になった IPSec の話を少しだけ説明します。</p>

<pre><code>192.168.18.0/24
+------+       +----------+
| vm01 |-------| vyatta01 |pppoe XXX.XXX.XXX.XXX
+------+       +----------+            |
               |192.168.20.0/24        | IPSec
+------+       +----------+            |
| vm02 |-------| vyatta02 |pppoe YYY.YYY.YYY.YYY
+------+       +----------+
192.168.19.0/24
</code></pre>

<p>上図の環境で vm01 が vm02 に IPSec を用いて接続するための方法を記しています。
vyatta 同士は 192.168.20.0/24 のネットワークで接続されていますが、互いにルーティ
ングテーブルは書いていないものとします。まずは vyatta01 に対しての設定。</p>

<p>あ、pppoe による NAT の設定は予めしてあるものとします。</p>

<pre><code># set vpn ipsec ipsec-interfaces interface pppoe1
# set vpn ipsec ike-group IKE-G proposal 1 encryption aes256
# set vpn ipsec ike-group IKE-G proposal 1 hash sha1
# set vpn ipsec ike-group IKE-G lifetime 3600
</code></pre>

<p>鍵交換の方式 IKE の設定をします。</p>

<pre><code># set vpn ipsec esp-group ESP-G proposal 1 encryption aes256
# set vpn ipsec esp-group ESP-G proposal 1 hash sha1
# set vpn ipsec esp-group ESP-G lifetime 1800
</code></pre>

<p>ESP の設定をします。鍵の破棄・生成時間 1800 を設定しています。</p>

<pre><code># edit vpn ipsec site-to-site peer YYY.YYY.YYY.YYY
# set authentication mode pre-shared-secret
# set authentication pre-shared-secret hogehoge
</code></pre>

<p>site-to-site peer を指定して接続先 vyatta のグローバル IP アドレスを指定します。
また pre-shared-secret でパスフレーズを指定します。</p>

<pre><code># set ike-group IKE-G
# set local-ip YYY.YYY.YYY.YYY
# set tunnel 1 local subnet 192.168.18.0/24
# set tunnel 1 remote subnet 192.168.19.0/24
# set tunnel 1 esp-group ESP-G
</code></pre>

<p>自グローバル IP, 自プライベートネットワーク、リモートネットワークの情報諸々、
設定します。</p>

<pre><code># set nat source rule 10 destination address !192.168.19.0/24
# commit
</code></pre>

<p>また最後に IPsec で接続する先のネットワークへのパケットの場合、NAT しないよう
にします。</p>

<p>次は逆に vyatta01 に対しても設定を投入します。諸々の値は逆にする必要があります。
これを実施すると、vm01 から vm02 に対して pppoe interface 同士の IPsec を介し
て接続できるのが確認出来ました。</p>

<p>私の職場で開発した製品にも投入してみようかなと目論んでいます。楽しかった。</p>

<p>最後に、この場を提供して下さった方々に感謝します。</p>

<h2 id="講演者">講演者</h2>

<ul>
<li>株式会社まほろば工房 近藤邦昭さま</li>
<li>有限会社銀座堂 浅間正和さま</li>
<li>さくらインターネット 大久保修一さま</li>
<li>伊藤忠テクノソリューションズ 伊藤哲史さま</li>
</ul>
</p>

    <footer>
        <ul class="actions">
            <li><a href="https://jedipunkz.github.io/blog/2012/06/14/vyatta-handson-interop2012/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    
                        Category
                    
                
            </li>
        
    

    
    
        <li><a href='/categories/infrastructure'>infrastructure</a></li>
    
</ul>

    </footer>
</article>


        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="https://jedipunkz.github.io/blog/2012/06/13/vyatta-vpn/">Vyatta で構築する簡単 VPN サーバ</a></h2>
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2012-06-13'>
            June 13, 2012</time>
        <span class="author"></span>
        
        
    </div>
</header>

    

    
    <p><p>Vyatta で VPN しようと思ったら信じられないくらい簡単に構築できたので共有します。</p>

<p>今回は PPTP (Point-to-Point Tunneling Protocol) を用いました。</p>

<p>さっそく手順に。</p>

<pre><code>$ configure
# set vpn pptp remote-access authentication local-users username ${USER} password ${PASSWORD}
# set vpn pptp remote-access authentication mode local
# set vpn pptp remote-access client-ip-pool start ${IP_START}
# set vpn pptp remote-access client-ip-pool stop ${IP_END}
# set vpn pptp remote-access outside-address ${GLOBAL_IP}
# set vpn pptp remote-access dns-servers server-1 8.8.8.8
# set vpn pptp remote-access dns-servers server-1 8.8.4.4
# commit
# save
</code></pre>

<p>これだけです。</p>

<p>認証のためのユーザを1行目で作っています。client-ip-pool で VPN 接続端末に付与
する IP アドレスのレンジを指定して outside-address で Listen Port を指定します。
DNS リゾルバに指定させたいアドレスを dns-servers で指定したら終わりです。</p>

<p>私は手元の iPhone で自宅に VPN 接続して使っています。これで iPhone か 自宅内の
機器に直接アクセスできるので便利です。</p>

<p>あと、Vyatta をしばらく自宅で使ってみての所感です。</p>

<p>Vyatta は汎用機にインストールできるし VM としても動作させられるし便利です。が、
実際に起動しているプロセス等を見ていくと、Linux 界では古くからあるレガシなソフ
トウェアが起動しているだけに見えます。Vyatta の UI はこれらソフトウェアのコン
フィグレーションを簡易化するラッパー的なモノになっているのが分かります。</p>

<p>汎用性がある一方、パフォーマンスはあまり期待出来ないかもしれません。実際にリッ
チなコンテンツを閲覧した時のパフォーマンスは Buffalo 製コンシューマ向け機器に
劣ります。Linux なのでチューニングは出来ますが、予め幾つかのチューニングは入っ
ていますし、あくまでもチューニングなので劇的なパフォーマンス改善には繋がりませ
ん。</p>

<p>FreeBSD 系 ? で pfsense という &lsquo;open source firewall distribution&rsquo; もあるよう
なので、いずれ試してみたいです。</p>
</p>

    <footer>
        <ul class="actions">
            <li><a href="https://jedipunkz.github.io/blog/2012/06/13/vyatta-vpn/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    
                        Category
                    
                
            </li>
        
    

    
    
        <li><a href='/categories/infrastructure'>infrastructure</a></li>
    
</ul>

    </footer>
</article>


        

        
<ul class="actions pagination">
    
        <li><a href="/categories/infrastructure/page/9/"
                class="button big previous">Previous Page</a></li>
    

    
        <li><a href="/categories/infrastructure/page/11/"
                class="button big next">Next Page</a></li>
    
</ul>

    </div>
    
<section id="sidebar">

    
        <section id="intro">
            
            
            
            <ul class="icons">
                
                    <li><a href="https://jedipunkz.github.io/categories/infrastructure/index.xml" type="application/rss+xml"
                        target="_blank" title="RSS" class="fa fa-rss"></a></li>
                
                
            </ul>
        </section>

    
        <section id="recent-posts">
            <ul class="posts">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    
                

                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://jedipunkz.github.io/blog/2018/12/31/istio/">Istio, Helm を使って Getting Started 的なアプリをデプロイ</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2018-12-31'>
                                    December 31, 2018</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://jedipunkz.github.io/blog/2017/07/02/test-kitchen-cluster/">Docker,Test-Kitchen,Ansible でクラスタを構成する</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2017-07-02'>
                                    July 2, 2017</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://jedipunkz.github.io/blog/2017/04/13/gke-lb/">GCP ロードバランサと GKE クラスタを Terraform を使って構築する</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2017-04-13'>
                                    April 13, 2017</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://jedipunkz.github.io/blog/2017/02/12/serverless-fission/">Serverless on Kubernetes : Fission を使ってみた</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2017-02-12'>
                                    February 12, 2017</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://jedipunkz.github.io/blog/2017/01/13/kubernetes-deployments/">Kubernetes Deployments を使ってみた！</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2017-01-13'>
                                    January 13, 2017</time>
                            </header>
                        </article>
                    </li>
                

                
                    <li>
                        <ul class="actions">
                            <li><a href=
                            
                                "/post/"
                            
                            class="button">View more posts</a></li>
                        </ul>
                    </li>
                
            </ul>
        </section>

    
    
    
    
        <section id="categories">
            <ul class="posts">
                <header>
                    <h3><a href="/categories/">Categories</a></h3>
                </header>

                
                    
                

                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/infrastructure/">infrastructure</a>
                                <span style="float:right;">110</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/report/">report</a>
                                <span style="float:right;">9</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/tools/">tools</a>
                                <span style="float:right;">11</span>
                            </header>
                        </article>
                    </li>
                
            </ul>
        </section>
    

    
        

    
        <section id="footer">
            <ul class="icons">
                
                    <li><a href="https://jedipunkz.github.io/categories/infrastructure/index.xml" type="application/rss+xml"
                        target="_blank" title="RSS" class="fa fa-rss"></a></li>
                
                
            </ul>

            <p class="copyright">&copy; ジェダイさんのブログ. テーマデザインは <a href="//github.com/jpescador" target="_blank">Julio Pescador</a>さんによるものです。 </p>
        </section>

</section>

            </div>
        <a id="back-to-top" href="#" class="fa fa-arrow-up fa-border fa-2x"></a>
        

        
        
            
        

        
        
            <script src="/js/jquery.min.js"></script>
            <script src="/js/skel.min.js"></script>
            <script src="/js/util.js"></script>
            <script src="/js/main.js"></script>
            <script src="/js/backToTop.js"></script>
            <script src="/js/highlight.pack.js"></script>
        

        

            
            <script>hljs.initHighlightingOnLoad();</script>
            
    </body>
</html>

