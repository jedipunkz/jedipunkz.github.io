


    
        
    




<!DOCTYPE HTML>

<html>
    <head>
        
            <title>report Posts - ジェダイさんのブログ</title>
        

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="generator" content="Hugo 0.17" />
        


        
        
            
                <meta name="description" content="技術ネタを書いていきます">
            
        

        
        <meta property="og:title" content="report" />
<meta property="og:description" content="技術ネタを書いていきます" />
<meta property="og:type" content="website" />
<meta property="og:url" content="http://jedipunkz.github.io/categories/report/" />


<meta property="og:updated_time" content="2013-09-09T00:00:00&#43;00:00"/>









        
<meta itemprop="name" content="report">
<meta itemprop="description" content="技術ネタを書いていきます">


        

        

        
        
            
        

        
        
            <link rel="stylesheet" href="/css/google-font.css" />
            <link rel="stylesheet" href="/css/font-awesome.min.css" />
            <link rel="stylesheet" href="/css/main.css" />
            <link rel="stylesheet" href="/css/add-on.css" />
            <link rel="stylesheet" href="/css/monokai-sublime.css">
        

        

        
        
        
            
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-30563095-1', 'auto');
ga('send', 'pageview');
</script>

        
    </head>
    <body>

        
        <div id="wrapper">

    
<header id="header">
    
        <h2><a href="/">ジェダイさんのブログ</i></a></h2>
    

    <nav class="links">
        <ul>
            
                <li>
                    <a href="/post">
                        
                            <i class="fa fa-newspaper-o">&nbsp;</i>Blog
                    </a>
                </li>
            
                <li>
                    <a href="/categories">
                        Categories
                    </a>
                </li>
            
                <li>
                    <a href="/about">
                        About
                    </a>
                </li>
            
        </ul>
    </nav>
    <nav class="main">
        <ul>
            
            <li class="search">
                <a class="fa-search" href="#search">Search</a>
                <form id="search" method="get" action="//google.com/search">
                    <input type="text" name="q" placeholder="Search" />
                    <input type="hidden" name="q" value="site:http://jedipunkz.github.io/">
                </form>
            </li>
            <li class="menu">
                <a class="fa-bars" href="#menu">Menu</a>
            </li>
        </ul>
    </nav>
</header>


<section id="menu">

    
        <section>
            <form class="search" method="get" action="//google.com/search">
                <input type="text" name="q" placeholder="Search" />
                <input type="hidden" name="q" value="site:http://jedipunkz.github.io/">
            </form>
        </section>

    
        <section>
            <ul class="links">
                
                    <li>
                        <a href="/post">
                            <h3>
                                
                                    <i class="fa fa-newspaper-o">&nbsp;</i>
                                
                                Blog
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories">
                            <h3>
                                
                                Categories
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/about">
                            <h3>
                                
                                About
                            </h3>
                        </a>
                    </li>
                
            </ul>
        </section>

    
        <section>
            <ul class="links">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    <li>
                        <a href="http://jedipunkz.github.io/blog/2016/11/27/etcd-operator/"><p>coreos の etcd operator を触ってみた</p></a>
                    </li>
                
                    <li>
                        <a href="http://jedipunkz.github.io/blog/2016/11/20/helm/"><p>Helm を使って Kubernetes を管理する</p></a>
                    </li>
                
                    <li>
                        <a href="http://jedipunkz.github.io/blog/2016/11/03/kubernetes-scheduledjob/"><p>kubernetes1.4 で実装された ScheduledJob を試してみた！</p></a>
                    </li>
                
                    <li>
                        <a href="http://jedipunkz.github.io/blog/2016/07/25/minikube/"><p>Minikube で簡易 kubernetes 環境構築</p></a>
                    </li>
                
            </ul>
        </section>

    
        
</section>

    
    <div id="main">
        <h1>report</h1>
        
        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="http://jedipunkz.github.io/blog/2013/09/09/14th-openstack-study-hackathon/">第14回 OpenStack 勉強会参加ログ</a></h2>
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2013-09-09'>
            September 9, 2013</time>
        <span class="author"></span>
        
            <p>3 minute read</p>
        
        
    </div>
</header>

    

    
    <p>こんにちは。@jedipunkz です。</p>

<p>OpenStack 第14回勉強会 ハッカソンに参加してきました。その時の自分の作業ログを
記しておきます。自分の作業内容は &lsquo;OpenStack + Docker 構築&rsquo; です。</p>

<pre><code>場所 : CreationLine さま
日時 : 2013年9月8日(土)
</code></pre>

<p>当日の atnd。</p>

<p><a href="http://atnd.org/events/42891">http://atnd.org/events/42891</a></p>

<p>当日発表のあった内容</p>

<ul>
<li>Ansible で OpenStack を実際に皆の前でデプロイ！</li>
<li>Yoshiyama さん開発 LogCas お披露目</li>
<li>Havana の機能改善・機能追加内容確認</li>
<li>その他 Horizon の機能についてだったり openstack.jp の運用についてなど</li>
</ul>

<p>自分が話を聞きながら黙々とやったことは</p>

<ul>
<li>OpenStack + Docker 構築</li>
</ul>

<p>結果&hellip; NG 動かず。時間切れ。公式の wiki の手順がだいぶ変なので手順を修正しながら進めました。</p>

<p>公式の wiki はこちらにあります。</p>

<p><a href="https://wiki.openstack.org/wiki/Docker">https://wiki.openstack.org/wiki/Docker</a></p>

<p>その修正しながらメモった手順を下記に貼り付けておきます。</p>

<h2 id="作業環境">作業環境</h2>

<ul>
<li>ホスト : Ubuntu 12.04.3 Precise</li>
<li>OpenStack バージョン : devstack (2013/09/08 master ブランチ)</li>
<li>構成 : オールインワン (with heat, ceilometer, neutron)</li>
</ul>

<h2 id="普通に動かすとエラーが出力される">普通に動かすとエラーが出力される</h2>

<p>これは devstack (2013/09/08 時点) での不具合なので直ちに修正されるかも。</p>

<p>デフォルトのエンコーディングが &lsquo;ascii&rsquo; になっているのが原因らしい.</p>

<pre><code class="language-python">% python
Python 2.7.3 (default, Apr 10 2013, 06:20:15)
[GCC 4.6.3] on linux2
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; import sys
&gt;&gt;&gt; sys.getdefaultencoding()
'ascii'
&gt;&gt;&gt;
</code></pre>

<h2 id="エラーの内容は">エラーの内容は…</h2>

<p>この状態だと… 下記のようなエラーが nova から出力される。むむむ。</p>

<pre><code class="language-bash">% nova boot --image &quot;ubuntu:latest&quot; --flavor 1 vm01
ERROR: UnicodeError: 'ascii' codec can't decode byte 0xe5 in position 2: ordinal not in range(128) (HTTP 400) (Request-ID: req-40ebfb9b-d76a-40b8-8f75-facb4dd73db4)
</code></pre>

<p>とりあえず暫定処置として、下記のように setdefaultencoding(&lsquo;utf-8&rsquo;) を追記。ち
なみに devstack デプロイ前にこの作業を済ませました。デプロイ後だと色々めんどい。
当日、何度もめんどい場面に遭遇しました&hellip;</p>

<pre><code class="language-bash">% ${EDITOR} /usr/lib/python2.7/sitecustomize.py
# install the apport exception handler if available
try:
    import apport_python_hook
except ImportError:
    pass
else:
    apport_python_hook.install()

# 下記の2行を追記
import sys
sys.setdefaultencoding('utf-8')
</code></pre>

<h2 id="ubuntu12-04-の場合-linux-kernel-3-8-にアップデート">Ubuntu12.04 の場合 Linux Kernel 3.8 にアップデート</h2>

<p>wiki には載っていないが docker が Linux Kernel 3.8 以上を推奨しているため
raring から 3.8 を持ってくる。</p>

<pre><code class="language-bash">% sudo apt-get update
% sudo apt-get install linux-image-generic-lts-raring linux-headers-generic-lts-raring
% sudo reboot
</code></pre>

<h2 id="socat-インストール">socat インストール</h2>

<p>後に実行する install_docker.sh スクリプトが必要とする。実行前に入れないとと痛
い目見る。当日何度も痛い目見ました&hellip;</p>

<pre><code class="language-bash">% sudo apt-get install socat
</code></pre>

<h2 id="localrc-追記">localrc 追記</h2>

<p>localrc に下記を追記。その他のパラメータは各自のモノで良い。</p>

<pre><code>VIRT_DRIVER=docker
</code></pre>

<h2 id="install-docker-sh-実行">install_docker.sh 実行</h2>

<p>一般ユーザ権限で OK 。中で sudo している。が、極稀に sudo のタイムアウトが来る
ので、色々しんどい。ちなみに僕はここで何度もやりなおしました。&hellip;</p>

<pre><code class="language-bash">% ./tools/docker/install_docker.sh
</code></pre>

<h2 id="devstack-インストール">devstack インストール</h2>

<p>devstack をデプロイする。</p>

<pre><code class="language-bash">% ./stack.sh
</code></pre>

<h2 id="index-docker-io-から-ubuntu-イメージをダウンロード">index.docker.io から &lsquo;ubuntu&rsquo; イメージをダウンロード</h2>

<p>index.docker.io のトップレベルから &lsquo;ubuntu&rsquo; イメージを取得。どのイメージでも良い。</p>

<pre><code class="language-bash">% sudo docker pull ubuntu
Pulling repository ubuntu
8dbd9e392a96: Download complete
b750fe79269d: Download complete
27cf78414709: Download complete
````

docker-registry (プライベートレポジトリ) に対して push する -&gt; Glance に登録
----

この状態で docker-registry.sh というプロセスが起動しているはず。これは docker   
のプライベートレポジトリに相当。5042 tcp で待ち受けているので下記のように tag を打った後、プライベートレポジトリに
アップロード。

``` bash
% sudo docker tag ubuntu 10.200.9.25:5042/ubuntu
% sudo docker push 10.200.9.25:5042/ubuntu
The push refers to a repository [10.200.9.25:5042/ubuntu] (len: 1)
Sending image list
Pushing repository 10.200.9.25:5042/ubuntu (1 tags)
Pushing 8dbd9e392a964056420e5d58ca5cc376ef18e2de93b5cc90e868a1bbc8318c1c
Pushing tags for rev [8dbd9e392a964056420e5d58ca5cc376ef18e2de93b5cc90e868a1bbc8318c1c] on {http://10.200.9.25:5042/v1/repositories/ubuntu/tags/latest}
</code></pre>

<p>docker のレポジトリについてはここが参考になる。</p>

<p><a href="http://docs.docker.io/en/latest/use/workingwithrepository/">http://docs.docker.io/en/latest/use/workingwithrepository/</a></p>

<h2 id="glance-に登録されていることを確認">glance に登録されていることを確認</h2>

<p>&lsquo;ubuntu:latest&rsquo; が表示されるはず。やった。</p>

<pre><code class="language-bash">% glance image-list
+--------------------------------------+---------------------------------+-------------+------------------+----------+--------+
| ID                                   | Name                           | Disk Format | Container Format | Size  | Status |
+--------------------------------------+---------------------------------+-------------+------------------+----------+--------+
| f5845be4-1ac0-42c7-9280-a8c316be6beb | cirros-0.3.1-x86_64-uec         | ami       | ami            | 25165824 | active |
| aa8bcdff-6eb9-402b-9e27-675648dbe311 | cirros-0.3.1-x86_64-uec-kernel  | aki       | aki            | 4955792  | active |
| f8857736-5613-401a-b28c-02c286271af4 | cirros-0.3.1-x86_64-uec-ramdisk | ari       | ari            | 3714968  | active |
| ae56cacb-7eb6-413e-bd75-46f3cd63123b | docker-busybox:latest         | raw         | docker          | 2271796  | active |
| 613b05c3-30f6-4c53-aa94-103ea516373e | ubuntu:latest                 | raw         | docker          | 71497587 | active |
+--------------------------------------+---------------------------------+-------------+------------------+----------+--------+
</code></pre>

<h2 id="nova-boot">nova boot</h2>

<p>ぐったり&hellip; nova-scheduler がエラー吐いてるぽいけど、原因つかめず。ハッカソン時間切れ。</p>

<pre><code class="language-bash">% nova boot --image &quot;ubuntu:latest&quot; --flavor m1.tiny vm01
% nova list
+--------------------------------------+------+--------+------------+-------------+----------+
| ID                                   | Name | Status | Task State | Power State | Networks |
+--------------------------------------+------+--------+------------+-------------+----------+
| e1563b55-bb5d-43a6-a1fc-c3bc63600ac7 | vm01 | ERROR  | None       | NOSTATE     |          |
+--------------------------------------+------+--------+------------+-------------+----------+
</code></pre>

<h2 id="エラー内容">エラー内容..</h2>

<p>下記のエラーが出力されていた。なんだか OpenStack のメッセージじゃないような。
調べてたら素の Python のメッセージらしく。うーん。devstack なので仕方ない。</p>

<pre><code>    Sep  7 14:53:08 devstack01 2013-09-07 14:53:08.490 ERROR nova.compute.manager [req-d4ff6a45-88bc-4d6e-8f9d-43de79e601c6 demo demo] [instance: fdd0fdfb-aaa2-4e91-98cc-cdb347e9ae09] Instance failed to spawn#0122013-09-07 14:53:08.490 31835 TRACE nova.compute.manager [instance: fdd0fdfb-aaa2-4e91-98cc-cdb347e9ae09] Traceback (most recent call last):#0122013-09-07 14:53:08.490 31835 TRACE nova.compute.manager [instance: fdd0fdfb-aaa2-4e91-98cc-cdb347e9ae09]   File &quot;/opt/stack/nova/nova/compute/manager.py&quot;, line 1416, in _spawn#0122013-09-07 14:53:08.490 31835 TRACE nova.compute.manager [instance: fdd0fdfb-aaa2-4e91-98cc-cdb347e9ae09]     block_device_info)#0122013-09-07 14:53:08.490 31835 TRACE nova.compute.manager [instance: fdd0fdfb-aaa2-4e91-98cc-cdb347e9ae09]   File &quot;/opt/stack/nova/nova/virt/docker/driver.py&quot;, line 305, in spawn#0122013-09-07 14:53:08.490 31835 TRACE nova.compute.manager [instance: fdd0fdfb-aaa2-4e91-98cc-cdb347e9ae09]     raise exception.InstanceDeployFailure(msg.format(e),#0122013-09-07 14:53:08.490 31835 TRACE nova.compute.manager [instance: fdd0fdfb-aaa2-4e91-98cc-cdb347e9ae09]   File &quot;/opt/stack/nova/nova/openstack/common/gettextutils.py&quot;, line 255, in __getattribute__#0122013-09-07 14:53:08.490 31835 TRACE nova.compute.manager [instance: fdd0fdfb-aaa2-4e91-98cc-cdb347e9ae09]     return UserString.UserString.__getattribute__(self, name)#0122013-09-07 14:53:08.490 31835 TRACE nova.compute.manager [instance: fdd0fdfb-aaa2-4e91-98cc-cdb347e9ae09] AttributeError: 'Message' object has no attribute 'format'#0122013-09-07 14:53:08.490 31835 TRACE nova.compute.manager [instance: fdd0fdfb-aaa2-4e91-98cc-cdb347e9ae09]
</code></pre>

<h2 id="所感とまとめ">所感とまとめ</h2>

<p>前半の1,2時間、みなさんの話に聞き入ってしまったので時間が…。発表の内容も皆さ
んの会話も楽しかった。また参加したい。Netron 周りで聞きたい事とか色々あったの
だけどコアデベロッパの方に聞けなかったのが後悔。今度教えてもらおう。あとやっぱ
りみなさん詳しい。その情報どこから？ということまでよく知っているし知識が深い。
理解度がまだまだちゃうなぁと実感。次回も参加させていただこうと思います。</p>

    <footer>
        <ul class="actions">
            <li><a href="http://jedipunkz.github.io/blog/2013/09/09/14th-openstack-study-hackathon/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    

                    

                    
                        Categories
                    
                
            </li>
        
    

    
    
        <li><a href='/categoriesinfrastructure'>infrastructure</a></li>
    
        <li><a href='/categoriesreport'>report</a></li>
    
</ul>

    </footer>
</article>


        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="http://jedipunkz.github.io/blog/2013/04/06/cloudmanagement/">クラウドマネジメント勉強会レポ</a></h2>
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2013-04-06'>
            April 6, 2013</time>
        <span class="author"></span>
        
            <p>2 minute read</p>
        
        
    </div>
</header>

    

    
    <p>クラウドマネジメント勉強会に参加してきた。今が旬なのか定員140名が埋まっていま
した。クラウドフェデレーションサービス各種の話が聞ける貴重な勉強会の場でした。</p>

<pre><code>場所 : スクエアエニックスさん
日程 : 2013年4月5日 19:00 -
</code></pre>

<p>少し長くなるので、早速。</p>

<h2 id="クラウド運用管理研究会">クラウド運用管理研究会</h2>

<p>クラウド利用推進機構が運営するクラウド運用管理研究会は下記の3つに分別されるそ
うです。今回は一項目の &lsquo;クラウドマネジメントツール研究会&rsquo; にあたるそう。別の研
究会も既に勉強会を実施しているそうです。</p>

<ul>
<li>クラウドマネジメントツール研究会</li>
<li>デザインパターン研究会</li>
<li>運用管理・監視研究会</li>
</ul>

<h1 id="aws-opsworks">AWS OpsWorks</h1>

<pre><code>アマゾンデータサービスジャパン AWS 片山さん, 船崎さん
</code></pre>

<p>OpsWorks は最近話題になった AWS 利用者に無料で提供されるクラウドフェデレーショ
ンサービス。Web UI で操作し簡単デプロイを実現するサービスです。</p>

<h2 id="opsworks-が自動化するモノ">OpsWorks が自動化するモノ</h2>

<ul>
<li>サーバ設定</li>
<li>ミドルウェア構築</li>
</ul>

<h2 id="特徴">特徴</h2>

<ul>
<li>Chef フレームワークを利用 (chef-solo を内部的に利用)</li>
<li>任意の cookbooks を利用可能</li>
<li>LB, AP, DB などをレイヤ化, 任意のレイヤも作成可能</li>
</ul>

<h2 id="opsworks-の流れ">OpsWorks の流れ</h2>

<ul>
<li>Stack 作成</li>
<li>レイヤ作成 (LB, AP, DB, 任意)</li>
<li>レシピの作成</li>
<li>レイヤにインスタンス作成</li>
</ul>

<h2 id="下記をレイヤ化で区別する">下記をレイヤ化で区別する</h2>

<ul>
<li>Package インストール</li>
<li>OS 設定</li>
<li>アプリデプロイ</li>
</ul>

<h2 id="所感">所感</h2>

<p>AWS OpsWorks の登場で他のクラウドフェデレーションサービスがどうなるの？とさえ
思った。AWS はインターネット・ホスティング業界のあらゆるサービスを押さえようと
している感がある。もう隙間がない！ｗ OpsWorks に関してまだ問題は残っているそう
だ。VPC, micro 現在未対応など。が解決に向けて作業しているそう。</p>

<h1 id="aeolus-conductor">Aeolus Conductor</h1>

<pre><code>RedHat 中井さん
</code></pre>

<h2 id="概要">概要</h2>

<p>複数クラウドに対応したイメージ作成・アプリケーション環境構築の自動化ツール</p>

<ul>
<li>アプリのデプロイ機能にフォーカス</li>
<li>Red Hat CoudForms が商用版</li>
<li>マルチクラウド (ユーザにクラウドが割り当てられる, Hybrid, EC2, RHEV)</li>
</ul>

<h2 id="自動化について中井さんの案-手作り">自動化について中井さんの案 (手作り)</h2>

<ul>
<li>libvirt キック</li>
<li>kickstart 実行</li>
<li>post script にて puppet 実行</li>
<li>manifest は github で管理</li>
</ul>

<p>これらは単一のサーバのみで実施できて、複数台構成等を前提に出来ない等の問題があ
る。それらを解決するのが Aeolus Conductor。</p>

<h2 id="aeolus-conductor-の要素">Aeolus Conductor の要素</h2>

<ul>
<li>システムテンプレート用意 (XML) : OS 構成内容が記されている</li>
<li>マシンイメージ JEOS</li>
<li>アプリケーションブループリント (アプリデプロイ設計書)
shell script である。puppet, chef を呼び出しても OK.</li>
<li>Config サーバを介して VM 間の構成を管理している : インテグレート！ DB, Web</li>
</ul>

<h2 id="aeolus-conductor-の不便な点">Aeolus Conductor の不便な点</h2>

<ul>
<li>特定のクラウド特有の機能には未対応</li>
<li>複数 VM デプロイ時のワークフロー処理が不十分</li>
</ul>

<h2 id="所感-1">所感</h2>

<p>画面を見させてもらったが AWS EC2, RHEV (RedHat の仮想化ソフト) とマルチクラウ
ドに対応していた。ユーザにどのクラウドを割り当てるか？等の権限委譲が出来るもの
ユニーク。</p>

<h1 id="scalr">Scalr</h1>

<pre><code>Scalr ユーザ会 梶川さん (IDC フロンティア)
</code></pre>

<h2 id="概要-特徴">概要, 特徴</h2>

<ul>
<li>オープンソースのマルチクラウド管理ツール</li>
<li>利用出来るクラウド : AWS, Eucalyptus, RackSpace, nimbula, OpenStack, &hellip;</li>
<li>冗長化・オートスケール可能</li>
<li>モニタリングも自動で開始</li>
<li>DNS 管理, オートスケール時、自動的に修正が行われる</li>
<li>スクリプト実行 (任意のタイミングで可能、またタイミングを作成可能)</li>
<li>各サービスのコンフィグプリセット管理 (ミドルウェアのパラメータ？)</li>
</ul>

<h2 id="所感-2">所感</h2>

<p>Scalr ユーザ会のメンバ募集中だそうだ。個人的にオープンソースの Scalr を試そう
と思ったことがあるのだが、手順の wiki が解りづらかった。商用サービスを使わせる
ためにわざと解りづらくしているのか？と思うほど。ユーザ拡大のために是非ドキュメ
ントの整備をお願いしたい。</p>

<h1 id="rightscale-の利用効果と苦労話">RightScale の利用効果と苦労話</h1>

<pre><code>So-net エンタテインメント 成田さん
</code></pre>

<h2 id="利用効果">利用効果</h2>

<ul>
<li>1つのスクリプトを複数台に対して実行可能</li>
<li>手作業が自動化へ</li>
<li>ベストプラクティスの利用が可能に</li>
<li>モニタリングの自動化へ</li>
<li>サーバ台数のスケジューリング化</li>
<li>セキュリティグループはマクロで作成</li>
<li>権限分離による開発者・プロデューサに役割移譲</li>
<li>履歴管理の自動記録</li>
<li>chef recipe が right スクリプトとして走らせられる</li>
</ul>

<h2 id="苦労話">苦労話</h2>

<ul>
<li>Alert 設定のミスでメール大量受信</li>
<li>自動化スクリプトのエラー対応</li>
<li>計画メンテナンスの後は要注意 (仕様変更)</li>
<li>RightScale 上の表示を過信しない, 詳しくはクラウドサービス側を確認</li>
<li>LANG=ja_JP.UTF-8 するとコケる</li>
<li>メンテナンスは金曜日日中 (月に一回)</li>
</ul>

<h2 id="所感-3">所感</h2>

<p>実際に運用している方の話はとても貴重。特に苦労ネタはなかなか知ることが出来ない
ので。自動化のためにスクリプトを書くのがインフラ系エンジニアの仕事になると知ら
せてくれた。Right スクリプトには Chef のレシピも走らせることが出来る、というも
が魅力。またインフラ系エンジニア以外の職種の人にも権限委譲し UI を操作してもら
える辺りは、業務の最適化のために大いに利用できると感じた。</p>

<h1 id="chef-の話">Chef の話</h1>

<pre><code>Engine Yard @yando さん
</code></pre>

<h2 id="engine-yard-とは">Engine Yard とは</h2>

<ul>
<li>PaaS</li>
<li>AWS + Chef + サポート, 監視</li>
<li>chef-solo をキック</li>
<li>chef recipe の管理は Engine Yard が行う</li>
</ul>

<h2 id="chef-へのモチベーション">Chef へのモチベーション</h2>

<ul>
<li>冪等性</li>
<li>シェルスクリプトだと構築直後の状態しか保証されない</li>
</ul>

<h2 id="chef-solo-の話">chef-solo の話</h2>

<ul>
<li>knife-solo でノードに SSH せずに実行</li>
</ul>

<h2 id="利用するにあたって直面する課題">利用するにあたって直面する課題</h2>

<ul>
<li>レシピの実装 -&gt; github 上のレシピを参照・利用</li>
<li>Vagrant の利用でレシピの複数プラットフォーム上でのテスト</li>
<li>レシピの配布方法 -&gt; github, berkshelf, knife solo, nfs, chef-server</li>
<li>レシピの反映 -&gt; capistrano, chef-client, cron</li>
</ul>

<h2 id="engine-yard-local">Engine Yard Local</h2>

<ul>
<li>クラウドと同じレシピでローカルに開発環境を構築出来るツール</li>
<li>クラウドはコストが掛かるし遅いので出来る事ならローカルで、という発想</li>
</ul>

<h2 id="所感-4">所感</h2>

<p>Chef 流行ってますね。うんうん、(・∀・)ｲｲ!! 個人的には Chef の Cookbooks 開発
はインフラエンジニアにしてもらいたい。Engine Yard のような PaaS 使うならアレだ
けどクラウド使うなら運用は引き続き必要だし、運用を意識した Cookbooks 開発は絶
対に必要になってくるからだ。Chef の関連技術がものすごいスピードで進化している
のも魅力。より便利で旬な技術をすぐに利用し貢献する、という良いサイクルをうちの
会社でも実現したい。だって楽しいから。chef-solo 使うの？chef サーバ使うの？と
いう話はここでも挙がってた。どこかでブログにしようかな。僕は chef サーバ使わな
い理由がないと思ってる。</p>

    <footer>
        <ul class="actions">
            <li><a href="http://jedipunkz.github.io/blog/2013/04/06/cloudmanagement/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    

                    

                    
                        Categories
                    
                
            </li>
        
    

    
    
        <li><a href='/categoriesinfrastructure'>infrastructure</a></li>
    
        <li><a href='/categoriesreport'>report</a></li>
    
</ul>

    </footer>
</article>


        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="http://jedipunkz.github.io/blog/2013/02/10/di-11hui-openstack-study11-openstack-chef-repo/">第11回OpenStack勉強会で話してきた</a></h2>
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2013-02-10'>
            February 10, 2013</time>
        <span class="author"></span>
        
            <p>4 minute read</p>
        
        
    </div>
</header>

    

    
    <p>2013年2月9日に行われた OpenStack 勉強会第11回で話してきました。</p>

<p>openstack-chef-repo と言う、Opscode Chef で OpenStack を構築する内容を話して
きました。その時に説明出来なかった詳細についてブログに書いておきます。</p>

<p><iframe src="http://www.slideshare.net/slideshow/embed_code/16434817"
width="427" height="356" frameborder="0" marginwidth="0" marginheight="0"
scrolling="no" style="border:1px solid #CCC;border-width:1px 1px
0;margin-bottom:5px" allowfullscreen webkitallowfullscreen mozallowfullscreen>
</iframe> <div style="margin-bottom:5px"> <strong> <a
href="http://www.slideshare.net/tomokazubobhirai/openstack-chefrepo"
title="Openstack chef-repo" target="_blank">Openstack chef-repo</a> </strong>
from <strong><a href="http://www.slideshare.net/tomokazubobhirai"
target="_blank">Tomokazu Hirai</a></strong> </div></p>

<p>説明で使ったスライドです。</p>

<h2 id="まえがき">まえがき</h2>

<p>Essex ベースで構築することしか今は出来ません。Folsom に関しては &lsquo;直ちに開発が
スタートする&rsquo; と記されていました。今回は Opscode と RackSpace のエンジニアが共
同で開発を進めているので期待しています。今まで個人で OpenStack の各コンポーネ
ントの cookbook を開発されていた方がいらっしゃるのだけど汎用性を持たせるという
意味で非常に難しく、またどの方の開発に追従していけばよいか判断困っていました。
よって今回こそ期待。</p>

<h2 id="前提の構成">前提の構成</h2>

<pre><code>+-------------+
| chef-server |
+-------------+ 10.0.0.10
|
+---------------+ 10.0.0.0/24
|               |
+-------------+ +-------------+
| workstation | |    node     |
+-------------+ +-------------+
10.0.0.11       10.0.0.12
</code></pre>

<ul>
<li>chef-server : chef API を持つ chef-server 。cookbook, role..などのデータを持つ</li>
<li>workstation : openstack-chef-repo を使うノード。knife が使える必要がある。</li>
<li>node        : OpenStack を構築するターゲットノード</li>
</ul>

<h2 id="目次">目次</h2>

<ul>
<li>chef-server の構築 (BootStrap 使う)</li>
<li>openstack-chef-repo を使用する準備</li>
<li>openstack-chef-repo 実行</li>
</ul>

<h2 id="chef-server-の構築">chef-server の構築</h2>

<p>Opscode の wiki に記されている通りなのですが、簡単に書いておきます。今回は
bootstrap 方式で用意します。</p>

<p>chef-server ノードに chef をインストールします。chef-solo を用いるからです。</p>

<pre><code>chef-server# gem install chef
</code></pre>

<p>chef-solo を使うための設定情報を /etc/chef/solo.rb に記します。</p>

<pre><code>chef-server# mkdir /etc/chef
chef-server# ${EDITOR} /etc/chef/solo.rb
file_cache_path &quot;/tmp/chef-solo&quot;
cookbook_path &quot;/tmp/chef-solo/cookbooks&quot;
</code></pre>

<p>chef-solo を実行する際に使う json ファイルを用意します。attribute を上書きする
ことが出来ます。今回は webui を有効にした状態にします。</p>

<pre><code>chef-server# ${EDITOR} ~/chef.json
{
  &quot;chef_server&quot;: {
    &quot;server_url&quot;: &quot;http://localhost:4000&quot;,
    &quot;init_style&quot;: &quot;runit&quot;
  },
  &quot;run_list&quot;: [ &quot;recipe[chef-server::rubygems-install]&quot; ]
}
</code></pre>

<p>bootstrap して chef-server を構築します。</p>

<pre><code>chef-server# chef-solo -c /etc/chef/solo.rb -j ~/chef.json -r http://s3.amazonaws.com/chef-solo/bootstrap-latest.tar.gz
</code></pre>

<p>chef-server が完成したはずです。workstation で knife を使うために &lsquo;client&rsquo; を
作ります。chef 10.x では user ではなく client が knife を実行します。</p>

<pre><code>chef-server% mkdir ~/.chef
chef-server% sudo cp /etc/chef/validation.pem ~/.chef/
chef-server% sudo cp /etc/chef/webui.pem ~/.chef/
chef-server% sudo chown &lt;my-username&gt;:&lt;my-group&gt; ~/.chef
</code></pre>

<p>knife を使うために下記の操作を行います。</p>

<pre><code>chef-server% cd ~
chef-server% knife configure -i
Where should I put the config file? [~/.chef/knife.rb]
Please enter the chef server URL: [http://10.0.0.1:4000]
Please enter a clientname for the new client: [jedipunkz]
Please enter the existing admin clientname: [chef-webui]
Please enter the location of the existing admin client's private key:[/etc/chef/webui.pem] /home/jedipunkz/.chef/webui.pem
Please enter the validation clientname: [chef-validator]
Please enter the location of the validation key:[/etc/chef/validation.pem] /home/jedipunkz/.chef/validation.pem
Please enter the path to a chef repository (or leave blank):
Creating initial API user...
Created client[jedipunkz]
Configuration file written to /home/jedipunkz/.chef/knife.rb
</code></pre>

<p>workstaion ノードで knife を操作するための &lsquo;worker&rsquo; client を作成します。</p>

<pre><code>chef-server% export EDITOR=vim
chef-server% knife client create worker -a -f worker.pem
chef-server% knife client list
  chef-validator
  chef-webui
  chefserver.example.com
  jedipunkz
  worker
</code></pre>

<h2 id="openstack-chef-repo-を使用する準備">openstack-chef-repo を使用する準備</h2>

<p>workstation で openstack-chef-repo を使うための準備をします。</p>

<p>まずは knife を使えるように下記のように knife.rb や pem の手元への転送を行います。</p>

<pre><code>workstation% gem install chef librarian spiceweasel
workstation% cd ~
workstation% git clone git://github.com/opscode/openstack-chef-repo.git
workstation% cd openstack-chef-repo
workstation% vim .chef/knife.rb
log_level                :info
log_location             STDOUT
node_name                'worker'
client_key               '/home/jedipunkz/openstack-chef-repo/.chef/worker.pem'
validation_client_name   'chef-validator'
validation_key           '/home/jedipunkz/openstack-chef-repo/.chef/validation.pem'
chef_server_url          'http://10.0.0.10:4000'
cache_type               'BasicFile'
cache_options( :path =&gt; '/home/jedipunkz/openstack-chef-repo/.chef/checksums' )
cookbook_path           '/home/jedipunkz/openstack-chef-repo/cookbooks'
workstation% scp 10.0.0.10:~/worker.pem .chef/
workstation% scp 10.0.0.10:~/.chef/validation.pem .chef/
</code></pre>

<p>librarian を使って OpenStack 構築に必要な cookbooks をダンロードします。Cheffile
というファイルに何をどこから取得するのか記されいてそれにしたがってダウンロードされます。</p>

<pre><code>workstation% libratrian-chef update
</code></pre>

<p>環境に合わせて production.yml を修正します。今回必要最低限の箇所のみ修正します。
&ldquo;osops_networks&rdquo; という箇所に nova-network に渡すネットワーク情報があるので今回の
環境 10.0.0.0/24 に修正します。全体はこのような内容になります。</p>

<pre><code>workstation% ${EDITOR} production.yml
name &quot;production&quot;
description &quot;Defines the network and database settings you're going to use with OpenStack. The networks will be used in the libraries provided by the osops-utils cookbook. This example is for FlatDHCP with 2 physical networks.&quot;

override_attributes(
  &quot;glance&quot; =&gt; {
    &quot;image_upload&quot; =&gt; true,
    &quot;images&quot; =&gt; [&quot;precise&quot;,&quot;cirros&quot;],
  },
  &quot;mysql&quot; =&gt; {
    &quot;allow_remote_root&quot; =&gt; true,
    &quot;root_network_acl&quot; =&gt; &quot;%&quot;
  },
  &quot;osops_networks&quot; =&gt; {
    &quot;public&quot; =&gt; &quot;10.0.0.0/24&quot;,
    &quot;management&quot; =&gt; &quot;10.0.0.0/24&quot;,
    &quot;nova&quot; =&gt; &quot;10.0.0.0/24&quot;
  },
  &quot;nova&quot; =&gt; {
    &quot;network&quot; =&gt; {
      &quot;fixed_range&quot; =&gt; &quot;192.168.100.0/24&quot;,
      &quot;public_interface&quot; =&gt; &quot;eth0&quot;
    },
    &quot;networks&quot; =&gt; [
      {
        &quot;label&quot; =&gt; &quot;public&quot;,
        &quot;ipv4_cidr&quot; =&gt; &quot;192.168.100.0/24&quot;,
        &quot;num_networks&quot; =&gt; &quot;1&quot;,
        &quot;network_size&quot; =&gt; &quot;255&quot;,
        &quot;bridge&quot; =&gt; &quot;br100&quot;,
        &quot;bridge_dev&quot; =&gt; &quot;eth0&quot;,
        &quot;dns1&quot; =&gt; &quot;8.8.8.8&quot;,
        &quot;dns2&quot; =&gt; &quot;8.8.4.4&quot;
      }
    ]
  }
  )  
</code></pre>

<p>infrastructure.yml という spiceweasel が参照するファイルの修正を行います。
cookbooks, roles, environments, data bags, node とパラメータがあり node
のみ記されていないので今回用意したターゲットノードの情報を追記します。</p>

<p>node には予め SSH 公開鍵を設置する必要があります。また下記は root ユーザでログ
インしていますが、sudo してもらっても構わないです。role で指定した &lsquo;allinone&rsquo;
は OpenStack の全てのコンポーネントを一台のノードにインストールするためのもの
です。これを他の role 例えば &lsquo;keystone&rsquo; 等を指定して複数のノードに OpenStack
を展開することも可能なはずです。試していませんが。</p>

<pre><code>workstation% vim infrastructure.yml
... 省略
nodes:
- 10.0.0.12:
  run_list: role[allinone]
  options: -i ~/.ssh/id_rsa -x root -E production
</code></pre>

<h2 id="openstack-chef-repo-実行">openstack-chef-repo 実行</h2>

<p>準備が整ったので spiceweasel を使って knife コマンドの出力チェックと実行をして
みます。先ほど追記した infrastructure.yml を使います。</p>

<pre><code>workstation% spiceweasel infrastructure.yml
knife cookbook upload apache2
knife cookbook upload apt
knife cookbook upload aws
knife cookbook upload build-essential
knife cookbook upload ntp
knife cookbook upload openssh
knife cookbook upload openssl
knife cookbook upload postgresql
knife cookbook upload selinux
knife cookbook upload xfs
knife cookbook upload yum
knife cookbook upload erlang
knife cookbook upload mysql
knife cookbook upload rabbitmq
knife cookbook upload database
knife cookbook upload omnibus_updater
knife cookbook upload lxc
knife cookbook upload sysctl
knife cookbook upload osops-utils
knife cookbook upload mysql-openstack
knife cookbook upload rabbitmq-openstack
knife cookbook upload keystone
knife cookbook upload glance
knife cookbook upload nova
knife cookbook upload horizon
knife environment from file production.rb
knife role from file base.rb
knife role from file lxc.rb
knife role from file mysql-master.rb
knife role from file rabbitmq-server.rb
knife role from file keystone.rb
knife role from file glance-api.rb
knife role from file glance-registry.rb
knife role from file glance.rb
knife role from file nova-setup.rb
knife role from file nova-scheduler.rb
knife role from file nova-api-ec2.rb
knife role from file nova-api-os-compute.rb
knife role from file nova-volume.rb
knife role from file nova-vncproxy.rb
knife role from file horizon-server.rb
knife role from file single-controller.rb
knife role from file single-compute.rb
knife role from file allinone.rb
knife bootstrap 10.0.0.12 -i ~/.ssh/id_rsa -x root -E production -r 'role[allinone]'  
</code></pre>

<p>この操作で spiceweasel は role ファイルの中身と yml ファイルを読み、依存関係を
チェックしてくれます。</p>

<p>ではいよいよ実行。</p>

<pre><code>workstaion% spiceweasel -e infrastructure.yml
</code></pre>

<p>数分で OpenStack 環境が構築出来ると思います。</p>

<h2 id="所感">所感</h2>

<p>現時点ではまだ essex ベースの OpenStack しか構築出来ない。folsom 以降について
は直ちに行われる。また先にも記したが Opscode と RackSpace のエンジニアが共同で
作業に入ったので今後に期待。複数の OpenStack cookboooks を見てきたが個人で開発
するのは厳しいと感じています。fedra, centos, ubuntu, debian &hellip; いろんなプラッ
トフォームを前提に開発するのは厳しい&hellip;。pull request する余力があればやってみ
たい。また合わせて各コンポーネントの cookbooks についても同様に参加していきた
い。</p>

<p>chef は繰り返し実行されるので継続的にデプロイが可能であり、chef Resources が我々
の操作を抽象化してくれる。尚且つ API で開発も容易になる。学習コストは若干高い
し、cookbooks の開発も正直しんどい。だけどインフラを chef でコントロールする意
味はとても大きい。その他のメリットとして属人的な操作に依存したシステムを無くす
という事もある。</p>

<p>OpenStack のドキュメントにはデプロイ方法として dodai-deploy と puppet が掲載さ
れている。chef は載っていない。これは cookbooks の開発が遅れている状況が理由に
あると思う。今回 Opscode の中の Matt Ray さんの下記の資料</p>

<p><a href="http://www.slideshare.net/mattray/chef-11-previewchef-for-openstack">http://www.slideshare.net/mattray/chef-11-previewchef-for-openstack</a></p>

<p>を見て、これからに期待したいと感じた。</p>

    <footer>
        <ul class="actions">
            <li><a href="http://jedipunkz.github.io/blog/2013/02/10/di-11hui-openstack-study11-openstack-chef-repo/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    

                    

                    
                        Categories
                    
                
            </li>
        
    

    
    
        <li><a href='/categoriesinfrastructure'>infrastructure</a></li>
    
        <li><a href='/categoriesreport'>report</a></li>
    
</ul>

    </footer>
</article>


        

        
<ul class="actions pagination">
    
        <li><a href="/categories/report/"
                class="button big previous">Previous Page</a></li>
    

    
        <li><a href="/categories/report/page/3/"
                class="button big next">Next Page</a></li>
    
</ul>

    </div>
    
<section id="sidebar">

    
        <section id="intro">
            
            
                
                    <img src="/pix/jedipunkz.jpg" class="intro-circle" width="250" alt="jedipunkz icon" />
                
            
            
                <header>
                    <h2></h2>
                    <p>ジェダイさんです。インフラエンジニアからインフラ寄りのソフトウェアエンジニアになるために勉強していきます。</p>
                </header>
            
            <ul class="icons">
                
                    <li><a href="http://jedipunkz.github.io/categories/report/index.xml" type="application/rss+xml"
                        target="_blank" title="RSS" class="fa fa-rss"></a></li>
                
                
                    
<li><a href="//github.com/jedipunkz" target="_blank" title="GitHub" class="fa fa-github"></a></li>

















































<li><a href="//twitter.com/jedipunkz" target="_blank" title="Twitter" class="fa fa-twitter"></a></li>




                
            </ul>
        </section>

    
        <section id="recent-posts">
            <ul class="posts">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    
                

                
                    <li>
                        <article>
                            <header>
                                <h3><a href="http://jedipunkz.github.io/blog/2016/11/27/etcd-operator/">coreos の etcd operator を触ってみた</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2016-11-27'>
                                    November 27, 2016</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="http://jedipunkz.github.io/blog/2016/11/20/helm/">Helm を使って Kubernetes を管理する</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2016-11-20'>
                                    November 20, 2016</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="http://jedipunkz.github.io/blog/2016/11/03/kubernetes-scheduledjob/">kubernetes1.4 で実装された ScheduledJob を試してみた！</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2016-11-03'>
                                    November 3, 2016</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="http://jedipunkz.github.io/blog/2016/07/25/minikube/">Minikube で簡易 kubernetes 環境構築</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2016-07-25'>
                                    July 25, 2016</time>
                            </header>
                        </article>
                    </li>
                

                
                    <li>
                        <ul class="actions">
                            <li><a href=
                            
                                /post/
                            
                            class="button">View more posts</a></li>
                        </ul>
                    </li>
                
            </ul>
        </section>

    
    
    
    
        <section id="categories">
            <ul class="posts">
                <header>
                    <h3><a href="/categories/">Categories</a></h3>
                </header>

                
                    
                

                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/infrastructure/">infrastructure</a>
                                <span style="float:right;">104</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/tools/">tools</a>
                                <span style="float:right;">11</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/report/">report</a>
                                <span style="float:right;">9</span>
                            </header>
                        </article>
                    </li>
                
            </ul>
        </section>
    

    
        
        <section class="blurb">
            <h2>About</h2>
            <p>ソフトウェア寄りのエンジニアになるため勉強をしています。勉強したことをメモしていければと思います。</p>

            <ul class="actions">
                <li><a href="/about/" class="button">Learn More</a></li>
            </ul>
        </section>
        

    
        <section id="footer">
            <ul class="icons">
                
                    <li><a href="http://jedipunkz.github.io/categories/report/index.xml" type="application/rss+xml"
                        target="_blank" title="RSS" class="fa fa-rss"></a></li>
                
                
                    
<li><a href="//github.com/jedipunkz" target="_blank" title="GitHub" class="fa fa-github"></a></li>

















































<li><a href="//twitter.com/jedipunkz" target="_blank" title="Twitter" class="fa fa-twitter"></a></li>




                
            </ul>

            <p class="copyright">&copy; ジェダイさんのブログ. テーマデザインは <a href="//github.com/jpescador" target="_blank">Julio Pescador</a>さんによるものです。 </p>
        </section>

</section>

            </div>
        <a id="back-to-top" href="#" class="fa fa-arrow-up fa-border fa-2x"></a>
        

        
        
            
        

        
        
            <script src="/js/jquery.min.js"></script>
            <script src="/js/skel.min.js"></script>
            <script src="/js/util.js"></script>
            <script src="/js/main.js"></script>
            <script src="/js/backToTop.js"></script>
            <script src="/js/highlight.pack.js"></script>
        

        

            
            <script>hljs.initHighlightingOnLoad();</script>
            
    </body>
</html>

