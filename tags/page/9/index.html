


    




<!DOCTYPE HTML>

<html>
    <head>
        
            <title>Tags - ジェダイさんのブログ</title>
        

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="generator" content="Hugo 0.53" />
        


        
        
            
        

        <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Tags"/>
<meta name="twitter:description" content=""/>

        <meta property="og:title" content="Tags" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://jedipunkz.github.io/tags/" />
<meta property="og:updated_time" content="2013-04-06T00:00:00&#43;00:00"/>

        
<meta itemprop="name" content="Tags">
<meta itemprop="description" content="">


        

        

        
        
            
        

        
        
            <link rel="stylesheet" href="/css/google-font.css" />
            <link rel="stylesheet" href="/css/font-awesome.min.css" />
            <link rel="stylesheet" href="/css/main.css" />
            <link rel="stylesheet" href="/css/add-on.css" />
            <link rel="stylesheet" href="/css/monokai-sublime.css">
        

        

        
        
        
            
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-30563095-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

        
    </head>
    <body>

        
        <div id="wrapper">

    
<header id="header">
    
        <h2><a href="/"></i></a></h2>
    

    <nav class="links">
        <ul>
            
                <li>
                    <a href="">
                        Blog
                    </a>
                </li>
            
                <li>
                    <a href="about/index.html">
                        About
                    </a>
                </li>
            
        </ul>
    </nav>
    <nav class="main">
        <ul>
            
            <li class="search">
                <a class="fa-search" href="#search">Search</a>
                <form id="search" method="get" action="//google.com/search">
                    <input type="text" name="q" placeholder="Search" />
                    <input type="hidden" name="q" value="site:https://jedipunkz.github.io">
                </form>
            </li>
            <li class="menu">
                <a class="fa-bars" href="#menu">Menu</a>
            </li>
        </ul>
    </nav>
</header>


<section id="menu">

    
        <section>
            <form class="search" method="get" action="//google.com/search">
                <input type="text" name="q" placeholder="Search" />
                <input type="hidden" name="q" value="site:https://jedipunkz.github.io">
            </form>
        </section>

    
        <section>
            <ul class="links">
                
                    <li>
                        <a href="">
                            <h3>
                                
                                Blog
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="about/index.html">
                            <h3>
                                
                                About
                            </h3>
                        </a>
                    </li>
                
            </ul>
        </section>

    
        <section>
            <ul class="links">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    <li>
                        <a href="https://jedipunkz.github.io/blog/2018/12/31/istio/"><p>Istio, Helm を使って Getting Started 的なアプリをデプロイ</p></a>
                    </li>
                
                    <li>
                        <a href="https://jedipunkz.github.io/blog/2017/07/02/test-kitchen-cluster/"><p>Docker,Test-Kitchen,Ansible でクラスタを構成する</p></a>
                    </li>
                
                    <li>
                        <a href="https://jedipunkz.github.io/blog/2017/04/13/gke-lb/"><p>GCP ロードバランサと GKE クラスタを Terraform を使って構築する</p></a>
                    </li>
                
                    <li>
                        <a href="https://jedipunkz.github.io/blog/2017/02/12/serverless-fission/"><p>Serverless on Kubernetes : Fission を使ってみた</p></a>
                    </li>
                
                    <li>
                        <a href="https://jedipunkz.github.io/blog/2017/01/13/kubernetes-deployments/"><p>Kubernetes Deployments を使ってみた！</p></a>
                    </li>
                
            </ul>
        </section>

    
        
</section>

    
    <div id="main">
        
        
            
        

        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="https://jedipunkz.github.io/blog/2013/04/06/chef-11-private-network/">Chef 11 サーバのローカルネットワーク上構築</a></h2>
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2013-04-06'>
            April 6, 2013</time>
        <span class="author"></span>
        
        
    </div>
</header>

    

    
    <p><p>chef-solo を使うの？Chef サーバを使うの？という議論は結構前からあるし、答えは
「それぞれの環境次第」だと思うのだが、僕は個人的に Chef サーバを使ってます。ホ
ステッド Chef を使いたいけどお金ないし。会社で導入する時はホステッド Chef を契
約してもらうことを企んでます。(・∀・) 何故なら cookbooks を開発することがエン
ジニアの仕事の本質であって Chef サーバを運用管理することは本質ではないから。そ
れこそクラウド使えという話だと思う。</p>

<p>でも！Chef に慣れるには無料で使いたいし、継続的に Cookbooks をターゲットノード
で実行したい。ということで Chef サーバを構築して使っています。</p>

<p>Chef 10 の時代は Chef サーバの構築方法は下記の通り3つありました。</p>

<ul>
<li>手作業！</li>
<li>Bootstrap 構築</li>
<li>Opscode レポジトリの Debian, Ubuntu, CentOS パッケージ構築</li>
</ul>

<p>それが Chef 11 では</p>

<ul>
<li>Ubuntu, RHEL のパッケージ (パッケージインストールですべて環境が揃う)</li>
</ul>

<p><a href="http://www.opscode.com/chef/install/">http://www.opscode.com/chef/install/</a></p>

<p>この方法1つだけ。でも簡単になりました。</p>

<p>&lsquo;Chef Server&rsquo; タブを選択するとダウンロード出来る。じっくりは deb ファイルの中
身を見たことがないけど、チラ見した時に chef を deb の中で実行しているように見
えた。徹底してるｗ</p>

<p>Chef 10 時代のパッケージと違って行う操作は下記の2つのコマンドだけ。</p>

<pre><code>% sudo dpkg -i chef-server_11.0.6-1.ubuntu.12.04_amd64.deb # ダウンロードしたもの
% sudo chef-server-ctl reconfigure
</code></pre>

<p>簡単。でも&hellip; この状態だと https://&lt;サーバの FQDN&gt; でサーバが Listen している。
IP アドレスでアクセスしてもリダイレクトされる。つまり、ローカルネットワーク上
に構築することが出来ない。安易に hosts で解決も出来ない。何故ならターゲットノー
ドは通常まっさらな状態なので bootstrap するたびに hosts を書くなんてアホらしい
しやってはいけない。</p>

<p>今日の本題。ローカルネットワーク上に Chef 11 サーバを構築する方法を調べました。</p>

<h2 id="修正箇所">修正箇所</h2>

<ul>
<li>/var/opt/chef-server/chef-pedant/etc/pedant_config.rb</li>
</ul>

<p>URL を IP アドレスに変更する。</p>

<pre><code>chef_server &quot;https://chef.example.com&quot;
</code></pre>

<ul>
<li>/var/opt/chef-server/erchef/etc/app.config</li>
</ul>

<p>URL を IP アドレスに変更する。</p>

<pre><code>{s3_url, &quot;https://chef.example.com&quot;},
</code></pre>

<ul>
<li>/var/opt/chef-server/nginx/etc/nginx.conf</li>
</ul>

<p>URL を IP アドレスに変更する。2箇所あるので注意。鍵ファイルにも FQDN が記され
ているがそれらは変更しない。</p>

<pre><code>server_name chef.example.com;
</code></pre>

<ul>
<li>/etc/chef-server/chef-server-running.json</li>
</ul>

<p>URL を IP アドレスに変更する。鍵ファイルにも FQDN が記されているがそれらは変更
しない。</p>

<pre><code>&quot;vip&quot;: &quot;chef.example.com&quot;,
&quot;api_fqdn&quot;: &quot;chef.example.com&quot;,
&quot;web_ui_fqdn&quot;: &quot;chef.example.com&quot;,
&quot;server_name&quot;: &quot;chef.example.com&quot;,
&quot;url&quot;: &quot;https://chef.example.com&quot;,
</code></pre>

<p>最後に Chef サーバを再起動する。</p>

<pre><code>% sudo chef-server-ctl restart
</code></pre>

<h2 id="まとめ">まとめ</h2>

<p>会社で、この環境を使って色々試しています。今のところ不具合なく動作している。強
引ワザなのでもっと綺麗な方法を知っている方がいましたら教えて下さい。
m ( _ _ ) m</p>
</p>

    <footer>
        <ul class="actions">
            <li><a href="https://jedipunkz.github.io/blog/2013/04/06/chef-11-private-network/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    
                        Category
                    
                
            </li>
        
    

    
    
        <li><a href='/categories/infrastructure'>infrastructure</a></li>
    
</ul>

    </footer>
</article>

        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="https://jedipunkz.github.io/blog/2013/04/06/cloudmanagement/">クラウドマネジメント勉強会レポ</a></h2>
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2013-04-06'>
            April 6, 2013</time>
        <span class="author"></span>
        
        
    </div>
</header>

    

    
    <p><p>クラウドマネジメント勉強会に参加してきた。今が旬なのか定員140名が埋まっていま
した。クラウドフェデレーションサービス各種の話が聞ける貴重な勉強会の場でした。</p>

<pre><code>場所 : スクエアエニックスさん
日程 : 2013年4月5日 19:00 -
</code></pre>

<p>少し長くなるので、早速。</p>

<h2 id="クラウド運用管理研究会">クラウド運用管理研究会</h2>

<p>クラウド利用推進機構が運営するクラウド運用管理研究会は下記の3つに分別されるそ
うです。今回は一項目の &lsquo;クラウドマネジメントツール研究会&rsquo; にあたるそう。別の研
究会も既に勉強会を実施しているそうです。</p>

<ul>
<li>クラウドマネジメントツール研究会</li>
<li>デザインパターン研究会</li>
<li>運用管理・監視研究会</li>
</ul>

<h1 id="aws-opsworks">AWS OpsWorks</h1>

<pre><code>アマゾンデータサービスジャパン AWS 片山さん, 船崎さん
</code></pre>

<p>OpsWorks は最近話題になった AWS 利用者に無料で提供されるクラウドフェデレーショ
ンサービス。Web UI で操作し簡単デプロイを実現するサービスです。</p>

<h2 id="opsworks-が自動化するモノ">OpsWorks が自動化するモノ</h2>

<ul>
<li>サーバ設定</li>
<li>ミドルウェア構築</li>
</ul>

<h2 id="特徴">特徴</h2>

<ul>
<li>Chef フレームワークを利用 (chef-solo を内部的に利用)</li>
<li>任意の cookbooks を利用可能</li>
<li>LB, AP, DB などをレイヤ化, 任意のレイヤも作成可能</li>
</ul>

<h2 id="opsworks-の流れ">OpsWorks の流れ</h2>

<ul>
<li>Stack 作成</li>
<li>レイヤ作成 (LB, AP, DB, 任意)</li>
<li>レシピの作成</li>
<li>レイヤにインスタンス作成</li>
</ul>

<h2 id="下記をレイヤ化で区別する">下記をレイヤ化で区別する</h2>

<ul>
<li>Package インストール</li>
<li>OS 設定</li>
<li>アプリデプロイ</li>
</ul>

<h2 id="所感">所感</h2>

<p>AWS OpsWorks の登場で他のクラウドフェデレーションサービスがどうなるの？とさえ
思った。AWS はインターネット・ホスティング業界のあらゆるサービスを押さえようと
している感がある。もう隙間がない！ｗ OpsWorks に関してまだ問題は残っているそう
だ。VPC, micro 現在未対応など。が解決に向けて作業しているそう。</p>

<h1 id="aeolus-conductor">Aeolus Conductor</h1>

<pre><code>RedHat 中井さん
</code></pre>

<h2 id="概要">概要</h2>

<p>複数クラウドに対応したイメージ作成・アプリケーション環境構築の自動化ツール</p>

<ul>
<li>アプリのデプロイ機能にフォーカス</li>
<li>Red Hat CoudForms が商用版</li>
<li>マルチクラウド (ユーザにクラウドが割り当てられる, Hybrid, EC2, RHEV)</li>
</ul>

<h2 id="自動化について中井さんの案-手作り">自動化について中井さんの案 (手作り)</h2>

<ul>
<li>libvirt キック</li>
<li>kickstart 実行</li>
<li>post script にて puppet 実行</li>
<li>manifest は github で管理</li>
</ul>

<p>これらは単一のサーバのみで実施できて、複数台構成等を前提に出来ない等の問題があ
る。それらを解決するのが Aeolus Conductor。</p>

<h2 id="aeolus-conductor-の要素">Aeolus Conductor の要素</h2>

<ul>
<li>システムテンプレート用意 (XML) : OS 構成内容が記されている</li>
<li>マシンイメージ JEOS</li>
<li>アプリケーションブループリント (アプリデプロイ設計書)
shell script である。puppet, chef を呼び出しても OK.</li>
<li>Config サーバを介して VM 間の構成を管理している : インテグレート！ DB, Web</li>
</ul>

<h2 id="aeolus-conductor-の不便な点">Aeolus Conductor の不便な点</h2>

<ul>
<li>特定のクラウド特有の機能には未対応</li>
<li>複数 VM デプロイ時のワークフロー処理が不十分</li>
</ul>

<h2 id="所感-1">所感</h2>

<p>画面を見させてもらったが AWS EC2, RHEV (RedHat の仮想化ソフト) とマルチクラウ
ドに対応していた。ユーザにどのクラウドを割り当てるか？等の権限委譲が出来るもの
ユニーク。</p>

<h1 id="scalr">Scalr</h1>

<pre><code>Scalr ユーザ会 梶川さん (IDC フロンティア)
</code></pre>

<h2 id="概要-特徴">概要, 特徴</h2>

<ul>
<li>オープンソースのマルチクラウド管理ツール</li>
<li>利用出来るクラウド : AWS, Eucalyptus, RackSpace, nimbula, OpenStack, &hellip;</li>
<li>冗長化・オートスケール可能</li>
<li>モニタリングも自動で開始</li>
<li>DNS 管理, オートスケール時、自動的に修正が行われる</li>
<li>スクリプト実行 (任意のタイミングで可能、またタイミングを作成可能)</li>
<li>各サービスのコンフィグプリセット管理 (ミドルウェアのパラメータ？)</li>
</ul>

<h2 id="所感-2">所感</h2>

<p>Scalr ユーザ会のメンバ募集中だそうだ。個人的にオープンソースの Scalr を試そう
と思ったことがあるのだが、手順の wiki が解りづらかった。商用サービスを使わせる
ためにわざと解りづらくしているのか？と思うほど。ユーザ拡大のために是非ドキュメ
ントの整備をお願いしたい。</p>

<h1 id="rightscale-の利用効果と苦労話">RightScale の利用効果と苦労話</h1>

<pre><code>So-net エンタテインメント 成田さん
</code></pre>

<h2 id="利用効果">利用効果</h2>

<ul>
<li>1つのスクリプトを複数台に対して実行可能</li>
<li>手作業が自動化へ</li>
<li>ベストプラクティスの利用が可能に</li>
<li>モニタリングの自動化へ</li>
<li>サーバ台数のスケジューリング化</li>
<li>セキュリティグループはマクロで作成</li>
<li>権限分離による開発者・プロデューサに役割移譲</li>
<li>履歴管理の自動記録</li>
<li>chef recipe が right スクリプトとして走らせられる</li>
</ul>

<h2 id="苦労話">苦労話</h2>

<ul>
<li>Alert 設定のミスでメール大量受信</li>
<li>自動化スクリプトのエラー対応</li>
<li>計画メンテナンスの後は要注意 (仕様変更)</li>
<li>RightScale 上の表示を過信しない, 詳しくはクラウドサービス側を確認</li>
<li>LANG=ja_JP.UTF-8 するとコケる</li>
<li>メンテナンスは金曜日日中 (月に一回)</li>
</ul>

<h2 id="所感-3">所感</h2>

<p>実際に運用している方の話はとても貴重。特に苦労ネタはなかなか知ることが出来ない
ので。自動化のためにスクリプトを書くのがインフラ系エンジニアの仕事になると知ら
せてくれた。Right スクリプトには Chef のレシピも走らせることが出来る、というも
が魅力。またインフラ系エンジニア以外の職種の人にも権限委譲し UI を操作してもら
える辺りは、業務の最適化のために大いに利用できると感じた。</p>

<h1 id="chef-の話">Chef の話</h1>

<pre><code>Engine Yard @yando さん
</code></pre>

<h2 id="engine-yard-とは">Engine Yard とは</h2>

<ul>
<li>PaaS</li>
<li>AWS + Chef + サポート, 監視</li>
<li>chef-solo をキック</li>
<li>chef recipe の管理は Engine Yard が行う</li>
</ul>

<h2 id="chef-へのモチベーション">Chef へのモチベーション</h2>

<ul>
<li>冪等性</li>
<li>シェルスクリプトだと構築直後の状態しか保証されない</li>
</ul>

<h2 id="chef-solo-の話">chef-solo の話</h2>

<ul>
<li>knife-solo でノードに SSH せずに実行</li>
</ul>

<h2 id="利用するにあたって直面する課題">利用するにあたって直面する課題</h2>

<ul>
<li>レシピの実装 -&gt; github 上のレシピを参照・利用</li>
<li>Vagrant の利用でレシピの複数プラットフォーム上でのテスト</li>
<li>レシピの配布方法 -&gt; github, berkshelf, knife solo, nfs, chef-server</li>
<li>レシピの反映 -&gt; capistrano, chef-client, cron</li>
</ul>

<h2 id="engine-yard-local">Engine Yard Local</h2>

<ul>
<li>クラウドと同じレシピでローカルに開発環境を構築出来るツール</li>
<li>クラウドはコストが掛かるし遅いので出来る事ならローカルで、という発想</li>
</ul>

<h2 id="所感-4">所感</h2>

<p>Chef 流行ってますね。うんうん、(・∀・)ｲｲ!! 個人的には Chef の Cookbooks 開発
はインフラエンジニアにしてもらいたい。Engine Yard のような PaaS 使うならアレだ
けどクラウド使うなら運用は引き続き必要だし、運用を意識した Cookbooks 開発は絶
対に必要になってくるからだ。Chef の関連技術がものすごいスピードで進化している
のも魅力。より便利で旬な技術をすぐに利用し貢献する、という良いサイクルをうちの
会社でも実現したい。だって楽しいから。chef-solo 使うの？chef サーバ使うの？と
いう話はここでも挙がってた。どこかでブログにしようかな。僕は chef サーバ使わな
い理由がないと思ってる。</p>
</p>

    <footer>
        <ul class="actions">
            <li><a href="https://jedipunkz.github.io/blog/2013/04/06/cloudmanagement/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    
                        Categories
                    
                
            </li>
        
    

    
    
        <li><a href='/categories/infrastructure'>infrastructure</a></li>
    
        <li><a href='/categories/report'>report</a></li>
    
</ul>

    </footer>
</article>

        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="https://jedipunkz.github.io/blog/2013/03/28/netbsd-on-openstack/">NetBSD on OpenStack</a></h2>
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2013-03-28'>
            March 28, 2013</time>
        <span class="author"></span>
        
        
    </div>
</header>

    

    
    <p><p>もう数日で OpenStack の次期バージョン版 Grizzly がリリースされるタイミングだが
現行バージョン Folsom の OpenStack の上に NetBSD を載せてみた。完全にお遊び
だけど&hellip;。</p>

<p>結局、ほとんど何も特別な対応取ることなく NetBSD が動いた。もちろんハイパーバイ
ザは KVM です。だけど少し条件がある。</p>

<p>qemu の不具合があり Ubuntu 12.04 LTS + Ubuntu Cloud Archives の組み合わせでは
NetBSD が動作しなかった。下記のようなカーネルパニックが発生。</p>

<pre><code>panic: pci_make_tag: bad request
</code></pre>

<p>この不具合に相当するんじゃないかと思ってる。</p>

<p><a href="https://bugs.launchpad.net/qemu/+bug/897771">https://bugs.launchpad.net/qemu/+bug/897771</a></p>

<p>よって下記の組み合わせで動作を確認した。</p>

<ul>
<li>Ubuntu 12.10 + OpenStack (Native Packages)</li>
<li>qemu, kvm : 1.2.0+noroms-0ubuntu2.12.10.3</li>
<li>NetBSD 6.1 RC2 amd64</li>
</ul>

<h2 id="前提条件">前提条件</h2>

<p>OpenStack Folsom が動作していること。</p>

<h2 id="netbsd-os-イメージ作成">NetBSD OS イメージ作成</h2>

<p>nova-compute が動作しているホストの qemu-kvm を利用する。OpenStack 上に何でも
良いので OS を動作させこの kvm プロセスのパラメータを参考に kvm コマンドを実行
し NetBSD をインストールさせた。一番確実な方法。</p>

<pre><code>% cd ~/
% wget http://ftp.netbsd.org/pub/NetBSD/iso/6.1_RC2/NetBSD-6.1_RC2-amd64.iso
% kvm-img create -f qcow2 netbsd.img 5G
% /usr/bin/kvm -M pc-1.0 -cpu \
core2duo,+lahf_lm,+rdtscp,+hypervisor,+avx,+osxsave,+save,+aes,+popcnt,+sse4.2,+sse4.1,+cx16,+vmx,+pclmuldq,+ht,+ss,+ds \
-enable-kvm -m 512 -smp 1,sockets=1,cores=1,threads=1 -device piix3-usb-uhci,id=usb,bus=pci.0,addr=0x1.0x2 \
-drive file=~/netbsd.img,if=none,id=drive-virtio-disk0,format=qcow2,cache=none \
-device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x4,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 \
-net nic,model=virtio -vnc :9 -cdrom ~/NetBSD-6.1_RC2-amd64.iso
</code></pre>

<p>VNC :9 に接続して NetBSD を普通ににインストールする。</p>

<p>インストールが終わったら CDROM デバイスを外して起動。</p>

<pre><code>% core2duo,+lahf_lm,+rdtscp,+hypervisor,+avx,+osxsave,+save,+aes,+popcnt,+sse4.2,+sse4.1,+cx16,+vmx,+pclmuldq,+ht,+ss,+ds \
-enable-kvm -m 512 -smp 1,sockets=1,cores=1,threads=1 -device piix3-usb-uhci,id=usb,bus=pci.0,addr=0x1.0x2 \
-drive file=~/netbsd.img,if=none,id=drive-virtio-disk0,format=qcow2,cache=none \
-device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x4,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 \
-net nic,model=virtio -vnc :9
</code></pre>

<p>VNC :9 に接続し下記の操作を行う。</p>

<p>vioif0 という virtio なネットワークインターフェースが起動するので下記のように
追記する。</p>

<pre><code># vi /etc/rc.conf # 下記を追記
ifconfig_vioif0=dhcp
sshd=YES
</code></pre>

<p>OpenStack の metadata server から nova の管理するキーペア鍵を取得し
authorized_keys に配置する様、/etc/rc.local に追記する。curl とか便利なツール
はもちろん！入っていないので ftp コマンドでなんとかする。</p>

<pre><code class="language-bash"># vi /etc/rc.local # 下記を追記
if [ ! -d /root/.ssh ]; then
    mkdir -p /root/.ssh
fi
echo &gt;&gt; /root/.ssh/authorized_keys
cd /tmp
ftp http://169.254.169.254/latest/meta-data/public-keys/0/openssh-key
cat openssh-key | grep 'ssh-rsa' &gt;&gt; /root/.ssh/authorized_keys
echo &quot;AUTHORIZED_KEYS:&quot;
echo &quot;*********************&quot;
cat /root/.ssh/authorized_keys
echo &quot;*********************&quot;
</code></pre>

<p>nova のキーペアでログインしたいので sshd は root ユーザでログイン出来るように
修正行う。</p>

<pre><code># vi /etc/ssh/sshd_config
PermitRootLogin yes
</code></pre>

<p>OS をシャットダウンしてイメージ作成は終わり。</p>

<h2 id="glance-へ登録">Glance へ登録</h2>

<p>netbsd.img を Glance に接続できるホストへ移動しイメージ登録を行う。</p>

<pre><code>% glance add name=&quot;NetBSD 6.1 RC2 amd64&quot; is_public=true \
  container_format=ovf disk_format=qcow2 &lt; ~/netbsd.img
</code></pre>

<h2 id="まとめ">まとめ</h2>

<p>何も手を加えていない&hellip;。NetBSD 6.1 は最初から Virtio が有効になっているので何
も考えることなくイメージ作成が出来た。コツは nova-compute が実際に動作している
ホストでイメージを作ること。ハイパーバイザの OS が若干古いホストでも作業してみ
たのだが、OpenStack に載せた途端カーネルパニックに陥った。Qemu はものすごいス
ピードで進化しているのでバージョンの差異は致命的であると共に、日に日に快適な環
境が整ってきているとも言える。</p>
</p>

    <footer>
        <ul class="actions">
            <li><a href="https://jedipunkz.github.io/blog/2013/03/28/netbsd-on-openstack/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    
                        Category
                    
                
            </li>
        
    

    
    
        <li><a href='/categories/infrastructure'>infrastructure</a></li>
    
</ul>

    </footer>
</article>

        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="https://jedipunkz.github.io/blog/2013/03/17/berkshelf-chef-cookbook-manage/">Berkshelf で Chef Cookbook の管理</a></h2>
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2013-03-17'>
            March 17, 2013</time>
        <span class="author"></span>
        
        
    </div>
</header>

    

    
    <p><p>こんにちは。<a href="https://twitter.com/jedipunkz">@jedipunkz</a> です。</p>

<p>今日は Chef Cookbook の管理をしてくれる Berkshelf について。</p>

<p>Berkshelf は Librarian-Chef と同じく Cookbook の管理をしてくれるツールです。依
存関係のクリアもしてくれます。Opscode の中の人 @someara さんにこんなこと言われ
て、</p>

<p><blockquote class="twitter-tweet" lang="ja"><p>@<a
href="https://twitter.com/jedipunkz">jedipunkz</a> berkshelf &gt;
librarian-chef</p>&mdash; somearaさん (@someara) <a
href="https://twitter.com/someara/status/298664663976120321">2013年2月5日
</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></p>

<p>Librarian-chef じゃなくて Berkshelf 使えってことだろうなぁと思ったので僕は
Bekshelf を使うようにしてます。先日ブログ記事にした openstack-chef-repo も以前
は Librarian-chef を使っていたのですが最近 Berkshelf に置き換わりました。
openstack-chef-repo は Opscode の中の人の @mattray さん達が管理しています。</p>

<p>では早速。</p>

<h2 id="インストール">インストール</h2>

<p>インストールは簡単。gem install するだけです。</p>

<pre><code>% gem install berkshelf
</code></pre>

<h2 id="使い方">使い方</h2>

<p>chef-repo 配下で Berksfile を下記のように書きます。</p>

<pre><code>site :opscode

cookbook 'chef-client'
cookbook 'nginx', '= 0.101.2'
</code></pre>

<p>berks コマンドを実行して Cookbooks をダウンロードします。</p>

<pre><code>% export BERKSHELF_PATH=/Users/jedipunkz/chef-repo
% berks install
</code></pre>

<p>それぞれ依存関係のある Cookbook 達もダウンロードされます。これでいちいち依存を
解決しつつダウンロードなんてこともしなくて済む。</p>

<p>ここで言えるのは chef-repo とこの Berksfile だけ git 等で管理すれば良いという
こと。Cookbooks 達はそれぞれ別のレポジトリに git で管理する形が良いと思う。
プロジェクトで chef を使っていて chef-repo ごと管理しがちだと思うけど、この方
が Cookbook を他のプロジェクトでも使いまわせるメリットがある。</p>

<h2 id="opscode-コミュニティ管理外の-cookbooks">opscode コミュニティ管理外の Cookbooks</h2>

<p>自分で管理している cookbook 等も Berkshelf で管理出来ます。下記のように書くと、</p>

<pre><code>site : opscode

cookbook 'chef-client'
cookbook 'nginx', '= 0.101.2'
cookbook &quot;pxe_install_server&quot;, git: 'https://github.com/jedipunkz/pxe_install_server'
</code></pre>

<p>github から直接 git clone をしてくれます。</p>

<h2 id="cookbooks-のアップデート">Cookbooks のアップデート</h2>

<p>Cookbook は独立した git レポジトリで管理すると良いと書きましたが、それぞれの
Cookbooks は自分が若しくは他人が開発が進むので berks を使って最新の Cookbooks
にアップデートすることも出来る。</p>

<pre><code>% berks update
</code></pre>

<h2 id="バージョン指定">バージョン指定</h2>

<p>Cookbook のバージョン指定ももちろん出来る。先の例では</p>

<pre><code>cookbook 'nginx', '= 0.101.2'
</code></pre>

<p>では 0.101.2 と言うバージョンを指定した。その他</p>

<ul>
<li>Equal to (=)</li>
<li>Greater than (&gt;)</li>
<li>Greater than equal to (&lt;)</li>
<li>Less than (&lt;)</li>
<li>Less than equal to (&lt;=)</li>
<li>Pessimistic (~&gt;)</li>
</ul>

<p>が指定出来るようだ。</p>

<h2 id="まとめ">まとめ</h2>

<p>Cookbooks の管理は今のところ Berkshelf だけで OK。紹介したもの以外にも幾つか機
能があるので公式のサイトで確認してみて欲しい。個人的には path: 指定が
Berksfile で出来ないのが不便。公式のサイトには一応記述あるのだが動かなかった。
そのうち改善されるだろう。また Chef サーバに Cookbooks をアップロードする機能
もあるが、まぁこれは knife でも出来るしいいか。一番欲しかったのは &lsquo;依存関係の
クリア&rsquo; だったので。また Berksfile, Berksfile.lock のファイルさえプロジェクト
で管理すれば良いと言うのが個人的には綺麗になるなぁという印象。</p>

<p>昔、Linux の rpm コマンドでパッケージを入れてて依存関係にあるパッケージをコマ
ンド打つたびにダウンロードして&hellip;と言う問題を yum が解決してくれて。それに似て
るなぁと見ていて思った。</p>
</p>

    <footer>
        <ul class="actions">
            <li><a href="https://jedipunkz.github.io/blog/2013/03/17/berkshelf-chef-cookbook-manage/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    
                        Category
                    
                
            </li>
        
    

    
    
        <li><a href='/categories/infrastructure'>infrastructure</a></li>
    
</ul>

    </footer>
</article>

        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="https://jedipunkz.github.io/blog/2013/03/15/chef-contenuously-deploy/">chef-client の継続的デリバリ</a></h2>
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2013-03-15'>
            March 15, 2013</time>
        <span class="author"></span>
        
        
    </div>
</header>

    

    
    <p><p>こんにちは。<a href="https://twitter.com/jedipunkz">@jedipunkz</a> です。</p>

<p>久々に Chef の話題。</p>

<p>有名な方々が最近 Chef について記事書いたりで Chef が再び盛り上がってきましたね。
僕のブログにも chef-solo で検索してアクセスしてくる方が増えているようです。</p>

<p>ちょうど今、仕事で試験的なサービスを立ち上げてそこで Chef を使っているのですが Server,
Workstation, Target Node(s) の構成で使っていて、僕らは最初から chef-solo と
capistrano でってことは考えていませんでした。もちろん chef-solo + capistrano
の環境も調査しましたが、今の Server 構成が便利なのでもう戻れない。</p>

<p>今日は Chef サーバ構成の良さについての記事ではないですが、それについては次回、
時間見つけて書こうかと思ってます。</p>

<p>今日は &lsquo;chef-client をどうアップデートするか&rsquo; について。せっかく Chef
でサーバ構成を継続的にデプロイ出来ても Chef 自身をアップデート出来ないと悲しい
ですよね。chef-client が稼働しているインスタンスなんて起動して利用してすぐに破
棄だって時代ですが、なかなかそうもいなかい気がしています。</p>

<p>「ほら、だから chef-solo 使えばいいんだよ！」って思ってるあなた！違うんですよー。
そのデメリットを上回るメリットが Chef サーバ構成にあるんです。次回書きますｗ</p>

<p>Chef10 から Chef11 と試験してみるにはちょうど良い時期でした。今回の構成は&hellip;</p>

<h2 id="旧環境">旧環境</h2>

<pre><code>+------------------+
|   chef server    |
|  version 10.18   |
+------------------+
^
|
+--------------------+
|                    |
|                    |
+------------------+ +------------------+
| chef workstation | |   target node    |
|  version 10.24   | |  version 10.24   |
+------------------+ +------------------+
</code></pre>

<ul>
<li>chef server は apt.opscode.com レポジトリを利用した Chef 10.18 なもの</li>
<li>chef workstaion は version 10.24 (2013年3月15日現在 10.x 系最新)</li>
<li>target node は chef workstaion から knife bootstrap を行い構成</li>
</ul>

<p>knife bootstrap の際に下記のオプションを指定します。</p>

<pre><code>% knife bootstrap -N vmtest01 -r 'role[base]' \ -i -x root -d chef-full
</code></pre>

<p>distro は chef-full を選択。chef-full については下記にコードがあります。</p>

<p><a href="https://github.com/opscode/chef/blob/master/lib/chef/knife/bootstrap/chef-full.erb">https://github.com/opscode/chef/blob/master/lib/chef/knife/bootstrap/chef-full.erb</a></p>

<p>コードを抜粋すると、omnibus インストーラをダンロードして実行しているのがわかり
ます。つまり Chef11 環境で再度 knife bootstrap すれば新しい Chef がインストー
ルされるはず。</p>

<pre><code class="language-bash">install_sh=&quot;http://opscode.com/chef/install.sh&quot;
version_string=&quot;-v &lt;%= chef_version %&gt;&quot;

if ! exists /usr/bin/chef-client; then
  if exists wget; then
    bash &lt;(wget &lt;%= &quot;--proxy=on &quot; if knife_config[:bootstrap_proxy] %&gt; ${install_sh} -O -) ${version_string}
  elif exists curl; then
    bash &lt;(curl -L &lt;%= &quot;--proxy \&quot;#{knife_config[:bootstrap_proxy]}\&quot; &quot; if knife_config[:bootstrap_proxy] %&gt; ${install_sh}) ${version_string}
  else
    echo &quot;Neither wget nor curl found. Please install one and try again.&quot; &gt;&amp;2
    exit 1
  fi
fi
</code></pre>

<p>このように Chef10 で運用している状態を Chef11 に移行します。新しい環境は&hellip;</p>

<h2 id="新環境">新環境</h2>

<pre><code>+------------------+ +------------------+
|   chef server    | |   chef server    |
|  version 10.18   | |  version 11.0.6  |
+------------------+ +------------------+
                     ^
                     |
+--------------------+
|                    |
|                    |
+------------------+ +------------------+
| chef workstation | |   target node    |
|  version 11.4    | |  version 11.4    |
+------------------+ +------------------+
</code></pre>

<ul>
<li>chef server は omnibus インストールから構築</li>
<li>chef workstation は version 11.4 (2013年3月15日現在最新)</li>
</ul>

<h2 id="移行手順">移行手順</h2>

<h4 id="chef11-サーバを用意する">Chef11 サーバを用意する</h4>

<p>Omnibus インストーラでコマンド3つ打つだけで Chef サーバは構築出来ます。Chef11
からはこの方法が推奨されているようです。bootstrap を使った方法より簡単ですし。</p>

<pre><code>% wget https://opscode-omnitruck-release.s3.amazonaws.com/ubuntu/12.04/x86_64/chef-server_11.0.6-1.ubuntu.12.04_amd64.deb
% sudo dpkg -i chef-server_11.0.6-1.ubuntu.12.04_amd64.deb
% sudo chef-server-ctl reconfigure
</code></pre>

<h4 id="chef11-workstation-を用意する">Chef11 Workstation を用意する</h4>

<p>詳細は割愛します。chef10 と同じです。手順としては</p>

<ul>
<li>chef10 の chef-repo をコピー</li>
<li>pem ファイル群を chef11 server からコピー</li>
<li>knife configure -i にて knife.rb の生成</li>
<li>cookbooks, roles, data_bags, environments 等を chef11 にアップロード。若干修正が必要な場合がある。</li>
</ul>

<p>です。</p>

<h4 id="target-node-における旧-chef-client-の停止と削除">Target Node における旧 chef-client の停止と削除</h4>

<p>稼働している Chef10 の chef-client を停止し削除、そして pem ファイル達を退避し
てあげます。ここでは ssh で消す例を書きますが、これこそ Cookbook を書いて実行
すれば良いと思います。</p>

<pre><code>% ssh -i &lt;ssh_secret_key&gt; -l root &lt;ip_address&gt; \
'service chef-client stop; apt-get -y remove chef; mv /etc/chef /etc/chef.old'
</code></pre>

<h4 id="再-knife-bootstrap-実行">再 knife bootstrap 実行</h4>

<p>Chef11 の Workstation から knife bootstrap を実行します。これによって Target
Node に Chef11 の環境がインストールされ Chef11 Server と接続出来ます。</p>

<pre><code>% knife bootstrap &lt;ip_address&gt; -N vmtest01 -r 'role[base]' -i &lt;ssh_secret_key&gt; \
-x root -d chef-full
</code></pre>

<p>role[base] 中の run_list に&rsquo;chef-client::service&rsquo; を追加すると chef-client が
常時稼動してくれて定期的に Chef Server と接続、更新してくれます。</p>

<h2 id="まとめと考察">まとめと考察</h2>

<p>chef-client の更新は簡単に出来た！</p>

<p>今回はデフォルトの distro &lsquo;chef-full&rsquo; の例で書いたのだけど、distro には他にも
下記がある。</p>

<p><a href="https://github.com/opscode/chef/tree/master/lib/chef/knife/bootstrap">https://github.com/opscode/chef/tree/master/lib/chef/knife/bootstrap</a></p>

<p>Linux のディストリビューション名がついた distro は ruby をパッケージで, Chef
を gem でインストールしている。下記は distro &lsquo;ubuntu12.04-gems&rsquo; のコードの抜粋
です。</p>

<pre><code class="language-bash">if [ ! -f /usr/bin/chef-client ]; then
  aptitude update
  aptitude install -y ruby ruby1.8-dev build-essential wget libruby1.8 rubygems
fi
  
gem update --no-rdoc --no-ri
gem install ohai --no-rdoc --no-ri --verbose
gem install chef --no-rdoc --no-ri --verbose &lt;%= bootstrap_version_string %&gt;
</code></pre>

<p>ruby はディストリビューションが用意しているパッケージを。Chef は
bootstrap_version_string を指定し gem でインストールしている。</p>

<p>つまり &lsquo;ubuntu12.04-gems&rsquo; でも chef-client の更新は出来る。ちなみに試してみま
した。chef-client の停止・削除を下記の通り行うと、全く同じ knife bootstrap コ
マンドで chef-client のアップデートが行えた。</p>

<pre><code>% ssh -i &lt;ssh_secret_key&gt; -l root &lt;ip_address&gt; 'service chef-client stop; mv \
/usr/local/bin/chef-client /usr/local/bin/chef-client.old; mv /etc/chef /etc/chef.old'
</code></pre>

<p>以上です。</p>

<p>なんか簡単なこと書くのに長くなっちゃったけど&hellip;。運用を僕らはまだ出来ていない
のだけど、その時のことを考えると今回の試験はしてみたかったし、いい結果が出てよ
かった。Chef がメジャーバージョンアップされて Chef Server の構成が大きく代わっ
ても対応した cookbook, role, .. があればスムースに移行出来る。</p>

<p>Chef 無しにはインフラエンジニアやってられない時代が来たって感じｗ Chef 周りた
のしー！</p>

<p>追伸: 今回の方法より良いベストプラクティス的な方法があれば教えて下さい。</p>
</p>

    <footer>
        <ul class="actions">
            <li><a href="https://jedipunkz.github.io/blog/2013/03/15/chef-contenuously-deploy/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    
                        Category
                    
                
            </li>
        
    

    
    
        <li><a href='/categories/infrastructure'>infrastructure</a></li>
    
</ul>

    </footer>
</article>

        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="https://jedipunkz.github.io/blog/2013/03/06/pry/">pry のススメ</a></h2>
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2013-03-06'>
            March 6, 2013</time>
        <span class="author"></span>
        
        
    </div>
</header>

    

    
    <p><p>OpenStack をコードで管理するためのフレームワークは幾つか存在するのだけど Ruby
で記述出来る Fog が良い！と隣に座ってるアプリエンジニアが言うので僕も最近少し
触ってます。</p>

<p>Fog を使った OpenStack を管理するコードを書くことも大事なのだけど、Fog のコン
トリビュートってことで幾つかの機能を付け足して (Quantum Router 周り) ってこと
をやってました。まだ取り込まれてないけど。</p>

<p>その開発の中で pry の存在を教えてもらいその便利さに驚いたので少し説明します。
バリバリ開発系の人は既に知っているだろうけど、インフラ系エンジニアの僕にとって
は感激モノでした。</p>

<p>pry は irb 代替な Ruby のインタラクティブシェルです。下記の URL から持ってこれ
ます。</p>

<p><a href="https://github.com/pry/pry">https://github.com/pry/pry</a></p>

<p>シンタックスハイライトされたり json のレスポンスが綺麗に成形されたり irb 的に
使うだけでも便利なのだけど &lsquo;?&rsquo; や &lsquo;$&rsquo; でコードのシンタックスを確認したりコード
内容を確認したり出来るのがアツい！</p>

<p>ちょうど今回追加した Fog の機能を使って説明していみます。</p>

<p>Fog のコードを require して OpenStack に接続するための情報を設定し OpenStack
Quantum に接続します。これで準備完了。</p>

<pre><code class="language-ruby">[38] pry(main)&gt; require '/home/jedipunkz/fog/lib/fog.rb'
[49] pry(main)&gt; @connection_hash = {
[49] pry(main)*   :openstack_username =&gt; 'demo',
[49] pry(main)*   :openstack_api_key =&gt; 'demo',
[49] pry(main)*   :openstack_tenant =&gt; 'service',
[49] pry(main)*   :openstack_auth_url =&gt;
'http://172.16.1.11:5000/v2.0/tokens',
[49] pry(main)*   :provider =&gt; 'OpenStack',
[49] pry(main)* }
[50] pry(main)&gt; @quantum = Fog::Network.new(@connection_hash)
</code></pre>

<p>試しに Router 一覧を取得します。list_routers メソッドです。</p>

<pre><code class="language-ruby">[54] pry(main)&gt; @quantum.list_routers()
=&gt; #&lt;Excon::Response:0x00000003da3560
 @body=
  &quot;{\&quot;routers\&quot;: [{\&quot;status\&quot;: \&quot;ACTIVE\&quot;, \&quot;external_gateway_info\&quot;: {\&quot;network_id\&quot;: \&quot;b8ef37a9-9ed1-4b6d-862d-fe9e381a2f2a\&quot;}, \&quot;name\&quot;: \&quot;router-admin\&quot;, \&quot;admin_state_up\&quot;: true, \&quot;tenant_id\&quot;: \&quot;5e9544d4823a44d59f3591144049f691\&quot;, \&quot;id\&quot;: \&quot;35c65e2c-5cd8-4eb5-87a8-c370988c101a\&quot;}]}&quot;,
 @data=
  {:body=&gt;
    {&quot;routers&quot;=&gt;
      [{&quot;status&quot;=&gt;&quot;ACTIVE&quot;,
        &quot;external_gateway_info&quot;=&gt;
         {&quot;network_id&quot;=&gt;&quot;b8ef37a9-9ed1-4b6d-862d-fe9e381a2f2a&quot;},
        &quot;name&quot;=&gt;&quot;router-admin&quot;,
        &quot;admin_state_up&quot;=&gt;true,
        &quot;tenant_id&quot;=&gt;&quot;5e9544d4823a44d59f3591144049f691&quot;,
        &quot;id&quot;=&gt;&quot;35c65e2c-5cd8-4eb5-87a8-c370988c101a&quot;}]},
   :headers=&gt;
    {&quot;Content-Type&quot;=&gt;&quot;application/json&quot;,
     &quot;Content-Length&quot;=&gt;&quot;259&quot;,
     &quot;Date&quot;=&gt;&quot;Wed, 06 Mar 2013 06:53:22 GMT&quot;},
   :status=&gt;200,
   :remote_ip=&gt;&quot;172.16.1.11&quot;},
 @headers=
  {&quot;Content-Type&quot;=&gt;&quot;application/json&quot;,
   &quot;Content-Length&quot;=&gt;&quot;259&quot;,
   &quot;Date&quot;=&gt;&quot;Wed, 06 Mar 2013 06:53:22 GMT&quot;},
 @remote_ip=&quot;172.16.1.11&quot;,
 @status=200&gt;
</code></pre>

<p>綺麗に色付けされてレスポンスがあります。</p>

<p>次に &lsquo;cd @quantum&rsquo; して cd します。そして &lsquo;? メソッド名&rsquo; するとメソッドのシン
タックスを確認出来ます。試しに Router を生成する create_router メソッドを見て
みます。</p>

<pre><code class="language-ruby">[56] pry(main)&gt; cd @quantum
[59] pry(#&lt;Fog::Network::OpenStack::Real&gt;):1&gt; ? create_router

From: /home/jedipunkz/fog/lib/fog/openstack/requests/network/create_router.rb @ line 6:
Owner: Fog::Network::OpenStack::Real
Visibility: public
Signature: create_router(name, options=?)
Number of lines: 1
</code></pre>

<p>そして &lsquo;$ メソッド名&rsquo; するとコードが確認出来ます。</p>

<pre><code class="language-ruby">[64] pry(#&lt;Fog::Network::OpenStack::Real&gt;):1&gt; $ create_router

From: /home/jedipunkz/fog/lib/fog/openstack/requests/network/create_router.rb @ line 6:
Owner: Fog::Network::OpenStack::Real
Visibility: public
Number of lines: 27

def create_router(name, options = {})
  data = {
    'router' =&gt; {
      'name' =&gt; name,
    }
  }

  vanilla_options = [
    :admin_state_up,
    :tenant_id,
    :network_id,
    :external_gateway_info,
    :status,
    :subnet_id
  ]

  vanilla_options.reject{ |o| options[o].nil? }.each do |key|
    data['router'][key] = options[key]
  end

  request(
    :body     =&gt; Fog::JSON.encode(data),
    :expects  =&gt; [201],
    :method   =&gt; 'POST',
    :path     =&gt; 'routers'
  )
end
</code></pre>

<p>あとは &lsquo;puts @quantum&rsquo; 等するとオブジェクトの内容が確認出来たり、&rsquo;ls @quantum&rsquo;
すると @quantum オブジェクトのメソッド一覧が確認出来たり。</p>

<p>開発の効率が上がるなぁと感激。</p>

<p>春なので OpenStack もそろろろ次期リリースの時期。それぞれのコンポーネントの機
能が拡張されているようなので Fog 等のフレームワークにコントリビュートする機会
もますます増えそう。Fog やその他のクラウドフレームワークはなんだかんだ言って
AWS のフューチャがメインなので OpenStack の機能追加に追いついていない感がある。
もし興味持っている人が居たら是非一緒に OpenStack 界隈を盛り上げましょう。</p>
</p>

    <footer>
        <ul class="actions">
            <li><a href="https://jedipunkz.github.io/blog/2013/03/06/pry/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    
                        Category
                    
                
            </li>
        
    

    
    
        <li><a href='/categories/tools'>tools</a></li>
    
</ul>

    </footer>
</article>

        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="https://jedipunkz.github.io/blog/2013/02/10/di-11hui-openstack-study11-openstack-chef-repo/">第11回OpenStack勉強会で話してきた</a></h2>
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2013-02-10'>
            February 10, 2013</time>
        <span class="author"></span>
        
        
    </div>
</header>

    

    
    <p><p>2013年2月9日に行われた OpenStack 勉強会第11回で話してきました。</p>

<p>openstack-chef-repo と言う、Opscode Chef で OpenStack を構築する内容を話して
きました。その時に説明出来なかった詳細についてブログに書いておきます。</p>

<p><iframe src="http://www.slideshare.net/slideshow/embed_code/16434817"
width="427" height="356" frameborder="0" marginwidth="0" marginheight="0"
scrolling="no" style="border:1px solid #CCC;border-width:1px 1px
0;margin-bottom:5px" allowfullscreen webkitallowfullscreen mozallowfullscreen>
</iframe> <div style="margin-bottom:5px"> <strong> <a
href="http://www.slideshare.net/tomokazubobhirai/openstack-chefrepo"
title="Openstack chef-repo" target="_blank">Openstack chef-repo</a> </strong>
from <strong><a href="http://www.slideshare.net/tomokazubobhirai"
target="_blank">Tomokazu Hirai</a></strong> </div></p>

<p>説明で使ったスライドです。</p>

<h2 id="まえがき">まえがき</h2>

<p>Essex ベースで構築することしか今は出来ません。Folsom に関しては &lsquo;直ちに開発が
スタートする&rsquo; と記されていました。今回は Opscode と RackSpace のエンジニアが共
同で開発を進めているので期待しています。今まで個人で OpenStack の各コンポーネ
ントの cookbook を開発されていた方がいらっしゃるのだけど汎用性を持たせるという
意味で非常に難しく、またどの方の開発に追従していけばよいか判断困っていました。
よって今回こそ期待。</p>

<h2 id="前提の構成">前提の構成</h2>

<pre><code>+-------------+
| chef-server |
+-------------+ 10.0.0.10
|
+---------------+ 10.0.0.0/24
|               |
+-------------+ +-------------+
| workstation | |    node     |
+-------------+ +-------------+
10.0.0.11       10.0.0.12
</code></pre>

<ul>
<li>chef-server : chef API を持つ chef-server 。cookbook, role..などのデータを持つ</li>
<li>workstation : openstack-chef-repo を使うノード。knife が使える必要がある。</li>
<li>node        : OpenStack を構築するターゲットノード</li>
</ul>

<h2 id="目次">目次</h2>

<ul>
<li>chef-server の構築 (BootStrap 使う)</li>
<li>openstack-chef-repo を使用する準備</li>
<li>openstack-chef-repo 実行</li>
</ul>

<h2 id="chef-server-の構築">chef-server の構築</h2>

<p>Opscode の wiki に記されている通りなのですが、簡単に書いておきます。今回は
bootstrap 方式で用意します。</p>

<p>chef-server ノードに chef をインストールします。chef-solo を用いるからです。</p>

<pre><code>chef-server# gem install chef
</code></pre>

<p>chef-solo を使うための設定情報を /etc/chef/solo.rb に記します。</p>

<pre><code>chef-server# mkdir /etc/chef
chef-server# ${EDITOR} /etc/chef/solo.rb
file_cache_path &quot;/tmp/chef-solo&quot;
cookbook_path &quot;/tmp/chef-solo/cookbooks&quot;
</code></pre>

<p>chef-solo を実行する際に使う json ファイルを用意します。attribute を上書きする
ことが出来ます。今回は webui を有効にした状態にします。</p>

<pre><code>chef-server# ${EDITOR} ~/chef.json
{
  &quot;chef_server&quot;: {
    &quot;server_url&quot;: &quot;http://localhost:4000&quot;,
    &quot;init_style&quot;: &quot;runit&quot;
  },
  &quot;run_list&quot;: [ &quot;recipe[chef-server::rubygems-install]&quot; ]
}
</code></pre>

<p>bootstrap して chef-server を構築します。</p>

<pre><code>chef-server# chef-solo -c /etc/chef/solo.rb -j ~/chef.json -r http://s3.amazonaws.com/chef-solo/bootstrap-latest.tar.gz
</code></pre>

<p>chef-server が完成したはずです。workstation で knife を使うために &lsquo;client&rsquo; を
作ります。chef 10.x では user ではなく client が knife を実行します。</p>

<pre><code>chef-server% mkdir ~/.chef
chef-server% sudo cp /etc/chef/validation.pem ~/.chef/
chef-server% sudo cp /etc/chef/webui.pem ~/.chef/
chef-server% sudo chown &lt;my-username&gt;:&lt;my-group&gt; ~/.chef
</code></pre>

<p>knife を使うために下記の操作を行います。</p>

<pre><code>chef-server% cd ~
chef-server% knife configure -i
Where should I put the config file? [~/.chef/knife.rb]
Please enter the chef server URL: [http://10.0.0.1:4000]
Please enter a clientname for the new client: [jedipunkz]
Please enter the existing admin clientname: [chef-webui]
Please enter the location of the existing admin client's private key:[/etc/chef/webui.pem] /home/jedipunkz/.chef/webui.pem
Please enter the validation clientname: [chef-validator]
Please enter the location of the validation key:[/etc/chef/validation.pem] /home/jedipunkz/.chef/validation.pem
Please enter the path to a chef repository (or leave blank):
Creating initial API user...
Created client[jedipunkz]
Configuration file written to /home/jedipunkz/.chef/knife.rb
</code></pre>

<p>workstaion ノードで knife を操作するための &lsquo;worker&rsquo; client を作成します。</p>

<pre><code>chef-server% export EDITOR=vim
chef-server% knife client create worker -a -f worker.pem
chef-server% knife client list
  chef-validator
  chef-webui
  chefserver.example.com
  jedipunkz
  worker
</code></pre>

<h2 id="openstack-chef-repo-を使用する準備">openstack-chef-repo を使用する準備</h2>

<p>workstation で openstack-chef-repo を使うための準備をします。</p>

<p>まずは knife を使えるように下記のように knife.rb や pem の手元への転送を行います。</p>

<pre><code>workstation% gem install chef librarian spiceweasel
workstation% cd ~
workstation% git clone git://github.com/opscode/openstack-chef-repo.git
workstation% cd openstack-chef-repo
workstation% vim .chef/knife.rb
log_level                :info
log_location             STDOUT
node_name                'worker'
client_key               '/home/jedipunkz/openstack-chef-repo/.chef/worker.pem'
validation_client_name   'chef-validator'
validation_key           '/home/jedipunkz/openstack-chef-repo/.chef/validation.pem'
chef_server_url          'http://10.0.0.10:4000'
cache_type               'BasicFile'
cache_options( :path =&gt; '/home/jedipunkz/openstack-chef-repo/.chef/checksums' )
cookbook_path           '/home/jedipunkz/openstack-chef-repo/cookbooks'
workstation% scp 10.0.0.10:~/worker.pem .chef/
workstation% scp 10.0.0.10:~/.chef/validation.pem .chef/
</code></pre>

<p>librarian を使って OpenStack 構築に必要な cookbooks をダンロードします。Cheffile
というファイルに何をどこから取得するのか記されいてそれにしたがってダウンロードされます。</p>

<pre><code>workstation% libratrian-chef update
</code></pre>

<p>環境に合わせて production.yml を修正します。今回必要最低限の箇所のみ修正します。
&ldquo;osops_networks&rdquo; という箇所に nova-network に渡すネットワーク情報があるので今回の
環境 10.0.0.0/24 に修正します。全体はこのような内容になります。</p>

<pre><code>workstation% ${EDITOR} production.yml
name &quot;production&quot;
description &quot;Defines the network and database settings you're going to use with OpenStack. The networks will be used in the libraries provided by the osops-utils cookbook. This example is for FlatDHCP with 2 physical networks.&quot;

override_attributes(
  &quot;glance&quot; =&gt; {
    &quot;image_upload&quot; =&gt; true,
    &quot;images&quot; =&gt; [&quot;precise&quot;,&quot;cirros&quot;],
  },
  &quot;mysql&quot; =&gt; {
    &quot;allow_remote_root&quot; =&gt; true,
    &quot;root_network_acl&quot; =&gt; &quot;%&quot;
  },
  &quot;osops_networks&quot; =&gt; {
    &quot;public&quot; =&gt; &quot;10.0.0.0/24&quot;,
    &quot;management&quot; =&gt; &quot;10.0.0.0/24&quot;,
    &quot;nova&quot; =&gt; &quot;10.0.0.0/24&quot;
  },
  &quot;nova&quot; =&gt; {
    &quot;network&quot; =&gt; {
      &quot;fixed_range&quot; =&gt; &quot;192.168.100.0/24&quot;,
      &quot;public_interface&quot; =&gt; &quot;eth0&quot;
    },
    &quot;networks&quot; =&gt; [
      {
        &quot;label&quot; =&gt; &quot;public&quot;,
        &quot;ipv4_cidr&quot; =&gt; &quot;192.168.100.0/24&quot;,
        &quot;num_networks&quot; =&gt; &quot;1&quot;,
        &quot;network_size&quot; =&gt; &quot;255&quot;,
        &quot;bridge&quot; =&gt; &quot;br100&quot;,
        &quot;bridge_dev&quot; =&gt; &quot;eth0&quot;,
        &quot;dns1&quot; =&gt; &quot;8.8.8.8&quot;,
        &quot;dns2&quot; =&gt; &quot;8.8.4.4&quot;
      }
    ]
  }
  )  
</code></pre>

<p>infrastructure.yml という spiceweasel が参照するファイルの修正を行います。
cookbooks, roles, environments, data bags, node とパラメータがあり node
のみ記されていないので今回用意したターゲットノードの情報を追記します。</p>

<p>node には予め SSH 公開鍵を設置する必要があります。また下記は root ユーザでログ
インしていますが、sudo してもらっても構わないです。role で指定した &lsquo;allinone&rsquo;
は OpenStack の全てのコンポーネントを一台のノードにインストールするためのもの
です。これを他の role 例えば &lsquo;keystone&rsquo; 等を指定して複数のノードに OpenStack
を展開することも可能なはずです。試していませんが。</p>

<pre><code>workstation% vim infrastructure.yml
... 省略
nodes:
- 10.0.0.12:
  run_list: role[allinone]
  options: -i ~/.ssh/id_rsa -x root -E production
</code></pre>

<h2 id="openstack-chef-repo-実行">openstack-chef-repo 実行</h2>

<p>準備が整ったので spiceweasel を使って knife コマンドの出力チェックと実行をして
みます。先ほど追記した infrastructure.yml を使います。</p>

<pre><code>workstation% spiceweasel infrastructure.yml
knife cookbook upload apache2
knife cookbook upload apt
knife cookbook upload aws
knife cookbook upload build-essential
knife cookbook upload ntp
knife cookbook upload openssh
knife cookbook upload openssl
knife cookbook upload postgresql
knife cookbook upload selinux
knife cookbook upload xfs
knife cookbook upload yum
knife cookbook upload erlang
knife cookbook upload mysql
knife cookbook upload rabbitmq
knife cookbook upload database
knife cookbook upload omnibus_updater
knife cookbook upload lxc
knife cookbook upload sysctl
knife cookbook upload osops-utils
knife cookbook upload mysql-openstack
knife cookbook upload rabbitmq-openstack
knife cookbook upload keystone
knife cookbook upload glance
knife cookbook upload nova
knife cookbook upload horizon
knife environment from file production.rb
knife role from file base.rb
knife role from file lxc.rb
knife role from file mysql-master.rb
knife role from file rabbitmq-server.rb
knife role from file keystone.rb
knife role from file glance-api.rb
knife role from file glance-registry.rb
knife role from file glance.rb
knife role from file nova-setup.rb
knife role from file nova-scheduler.rb
knife role from file nova-api-ec2.rb
knife role from file nova-api-os-compute.rb
knife role from file nova-volume.rb
knife role from file nova-vncproxy.rb
knife role from file horizon-server.rb
knife role from file single-controller.rb
knife role from file single-compute.rb
knife role from file allinone.rb
knife bootstrap 10.0.0.12 -i ~/.ssh/id_rsa -x root -E production -r 'role[allinone]'  
</code></pre>

<p>この操作で spiceweasel は role ファイルの中身と yml ファイルを読み、依存関係を
チェックしてくれます。</p>

<p>ではいよいよ実行。</p>

<pre><code>workstaion% spiceweasel -e infrastructure.yml
</code></pre>

<p>数分で OpenStack 環境が構築出来ると思います。</p>

<h2 id="所感">所感</h2>

<p>現時点ではまだ essex ベースの OpenStack しか構築出来ない。folsom 以降について
は直ちに行われる。また先にも記したが Opscode と RackSpace のエンジニアが共同で
作業に入ったので今後に期待。複数の OpenStack cookboooks を見てきたが個人で開発
するのは厳しいと感じています。fedra, centos, ubuntu, debian &hellip; いろんなプラッ
トフォームを前提に開発するのは厳しい&hellip;。pull request する余力があればやってみ
たい。また合わせて各コンポーネントの cookbooks についても同様に参加していきた
い。</p>

<p>chef は繰り返し実行されるので継続的にデプロイが可能であり、chef Resources が我々
の操作を抽象化してくれる。尚且つ API で開発も容易になる。学習コストは若干高い
し、cookbooks の開発も正直しんどい。だけどインフラを chef でコントロールする意
味はとても大きい。その他のメリットとして属人的な操作に依存したシステムを無くす
という事もある。</p>

<p>OpenStack のドキュメントにはデプロイ方法として dodai-deploy と puppet が掲載さ
れている。chef は載っていない。これは cookbooks の開発が遅れている状況が理由に
あると思う。今回 Opscode の中の Matt Ray さんの下記の資料</p>

<p><a href="http://www.slideshare.net/mattray/chef-11-previewchef-for-openstack">http://www.slideshare.net/mattray/chef-11-previewchef-for-openstack</a></p>

<p>を見て、これからに期待したいと感じた。</p>
</p>

    <footer>
        <ul class="actions">
            <li><a href="https://jedipunkz.github.io/blog/2013/02/10/di-11hui-openstack-study11-openstack-chef-repo/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    
                        Categories
                    
                
            </li>
        
    

    
    
        <li><a href='/categories/infrastructure'>infrastructure</a></li>
    
        <li><a href='/categories/report'>report</a></li>
    
</ul>

    </footer>
</article>

        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="https://jedipunkz.github.io/blog/2013/02/01/spiceweasel-knife-bootstrap/">Spiceweasel で knife バッチ処理</a></h2>
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2013-02-01'>
            February 1, 2013</time>
        <span class="author"></span>
        
        
    </div>
</header>

    

    
    <p><p>Spiceweasel <a href="https://github.com/mattray/spiceweasel#cookbooks">https://github.com/mattray/spiceweasel#cookbooks</a> を使ってみた。</p>

<p>Spiceweasel は Chef の cookbook のダウンロード, role/cookbook の chef server
へのアップロード, ブートストラップ等をバッチ処理的に行なってくれる(もしくはコ
マンドラインを出力してくれる)ツールで、自分的にイケてるなと感じたのでブログに
書いておきます。</p>

<p>クラウドフェデレーション的サービスというかフロントエンドサービスというか、複数
のクラウドを扱えるサービスは増えてきているけど、chef を扱えるエンジニアであれ
ば、この Spiceweasel で簡単・一括デプロイ出来るので良いのではないかと。</p>

<p>早速だけど chef-repo にこんな yamp ファイルを用意します。</p>

<pre><code>cookbooks:
- apt:
- nginx:

roles:
- base:

nodes:
- 172.24.17.3:
    run_list: role[base]
    options: -i ~/.ssh/testkey01 -x root -N webset01
- 172.24.17.4:
    run_list: role[base]
    options: -i ~/.ssh/testkey01 -x root -N webset02
</code></pre>

<p>上から説明すると&hellip;</p>

<ul>
<li>&lsquo;apt&rsquo;, &lsquo;nginx&rsquo; の cookbook を opscode レポジトリからダウンロード</li>
<li>&lsquo;apt&rsquo;, &lsquo;nginx&rsquo; の cookbook を chef-server へアップロード</li>
<li>roles/base.rb を chef-server へアップロード</li>
<li>2つのノードに対して bootstrap 仕掛ける</li>
</ul>

<p>ってことをやるためのファイルです。予め chef-repo と roles は用意してあげる必要
があります。この辺りは knife の操作のための準備と全く同じ。また Spiceweasel は、
この yaml フィアル内の各パラメータや指定した role の内容の依存関係をチェックし
てくれます。</p>

<p>では、このファイルに対して</p>

<pre><code>% spiceweasel &lt;yaml ファイル名&gt;
</code></pre>

<p>すると、結果として下記のようなバッチが取得出来る。</p>

<pre><code>knife cookbook site download apt  --file cookbooks/apt.tgz
tar -C cookbooks/ -xf cookbooks/apt.tgz
rm -f cookbooks/apt.tgz
knife cookbook upload apt
knife cookbook site download test  --file cookbooks/test.tgz
tar -C cookbooks/ -xf cookbooks/test.tgz
rm -f cookbooks/test.tgz
knife cookbook upload test
knife role from file base.rb
knife bootstrap 172.24.17.3 -i ~/.ssh/testkey01 -x root -N webset01 -r 'role[base]'
knife bootstrap 172.24.17.4 -i ~/.ssh/testkey01 -x root -N webset02 -r 'role[base]'
</code></pre>

<p>尚且つ -e オプションを指定すると、実際にこれらのバッチを実行出来る。cookbooks
ディレクトリに予めレシピが存在すればダウンロードのバッチは省略されるぽいし、-d
を指定すると逆にノード削除バッチ処理、-r でリビルドのためのバッチ処理が得られ
る。</p>

<p>削除系・リビルド系は現時点では不具合が見られました。実行すると他の環境にも影響
出るので注意が必要。</p>

<p>個人的にはプライベートレポジトリの cookbooks も取ってこれるようになると嬉しい。
まぁ、Berkshelf 使えばいいのだけど。<a href="http://berkshelf.com/">http://berkshelf.com/</a></p>

<p>開発者の Matt Ray さんの資料によれば Chef for OpenStack もこの Spiceweasel を
使う方向で修正が掛かったらしい。個人的には一番興味あるところ。ちなみに Chef
for OpenStack は folsom ベースが現在 &lsquo;active development&rsquo; 状態らしい。</p>

<p>Opscode のサイトで紹介されているサンプルは古いバージョンでの指定方法らしく、注
意が必要です。</p>

<p><a href="http://wiki.opscode.com/display/chef/Spiceweasel">http://wiki.opscode.com/display/chef/Spiceweasel</a></p>

<h4 id="所感">所感</h4>

<p>chef, knife 周りはいろんな関連技術があるので技術を選定する上で迷ってしまうこと
が多いのだけど、この Spiceweasel には可能性を感じました。って言うのは、Chef が
実装出来ていないインテグレーションやオーケストレーションっていう所まで踏み込め
る可能性があるから。ノード間の関連付けが出来るんです。Swift-Storage と
Swift-Proxy の関連付け、または Load-Balancer と HTTP-Server の関連付け等。継続
的デリバリなインテグレーションって Chef を使ってどう実現するんだ？って思ってい
た時があったのですが、こういったラッパーツールの登場で解決されそうな気がします。</p>
</p>

    <footer>
        <ul class="actions">
            <li><a href="https://jedipunkz.github.io/blog/2013/02/01/spiceweasel-knife-bootstrap/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    
                        Categories
                    
                
            </li>
        
    

    
    
        <li><a href='/categories/infrastructure'>infrastructure</a></li>
    
        <li><a href='/categories/tools'>tools</a></li>
    
</ul>

    </footer>
</article>

        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="https://jedipunkz.github.io/blog/2013/01/14/arch-linux-setup/">Arch Linux セットアップまとめ</a></h2>
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2013-01-14'>
            January 14, 2013</time>
        <span class="author"></span>
        
        
    </div>
</header>

    

    
    <p><p>(2013/08/31 修正しました)</p>

<p>自宅のノート PC にいつも Debian Gnu/Linux unstable を入れて作業してたのだけど、
Arch Linux が試したくなって入れてみた。すごくイイ。ミニマル思考で常に最新。端
末に入れる OS としては最適かも!と思えてきた。Ubuntu はデスクトップ環境で扱う
にはチト大きすぎるし。FreeBSD のコンパイル待ち時間が最近耐えられないし&hellip;。</p>

<p>前リリースの Arch Linux には /arch/setup という簡易インストーラがあったのだけ
ど、それすら最近無くなった。環境作る方法を自分のためにもメモしておきます。</p>

<h4 id="os-イメージ-iso-取得とインストール用-usb-スティック作成">OS イメージ iso 取得とインストール用 USB スティック作成</h4>

<p>Linux, Windows, Mac で作り方が変わるようだけど、自分は Mac OSX を使ってインス
トール USB スティックを作成した。</p>

<p>diskutil で USB スティック装着前後の disk デバイス番号を覚える</p>

<pre><code>% diskutil list
</code></pre>

<p>(ここでは /dev/rdisk4 として進める。)</p>

<p>アンマウントする。</p>

<pre><code>% sudo diskutil unmountDisk /dev/rdisk4
</code></pre>

<p>ダウンロードした iso を USB スティックに書き込む。</p>

<pre><code>% sudo dd if=/path/to/downloaded/iso of=/dev/rdisk4 bs=8192
% sudo diskutil eject /dev/rdisk4
</code></pre>

<h4 id="usb-スティック装着しインストール開始">USB スティック装着しインストール開始</h4>

<p>起動するとメニューが表示されるので x86_64 を選んで起動。プロンプトが表示される。</p>

<p>まず disk のパーティション作成。</p>

<pre><code># fdisk /dev/sda # 環境に合わせてデバイス名変更
# fdisk -l /dev/sda
デバイス ブート      始点        終点     ブロック   Id  システム
/dev/sda1            2048     4196351     2097152   82  Linux スワップ / Solaris
/dev/sda2   *     4196352   156301487    76052568   83  Linux
</code></pre>

<p>上記のように切りました。fdisk の使い方は&hellip;ぐぐってください。また /boot にあたるパーティション
にブートフラグを必ず付けること。</p>

<p>ファイルシステムを作ってマウント。</p>

<pre><code># mkfs.ext4 /dev/sda2
# mount -t ext4 /dev/sda2 /mnt
</code></pre>

<p>コアシステムのインストール</p>

<pre><code># pacstrap /mnt base base-devel
</code></pre>

<p>fstab の配置。必要に応じて /dev/sda1 (上記で作った) をスワップとして加筆。</p>

<pre><code># genfstab -p /mnt &gt;&gt; /mnt/etc/fstab
</code></pre>

<h4 id="chroot-して-dev-sda2-内コアシステムで作業">chroot して /dev/sda2 内コアシステムで作業</h4>

<p>chroot する。</p>

<pre><code># arch-chroot /mnt
</code></pre>

<p>キーマップを us 配列で CTRL と Caps をスワップしたいので下記の作業を実施。</p>

<pre><code># cd /usr/share/kbd/keymaps/i386/qwerty
# cp us.map.gz usx.map.gz
# gunzip usx.map.gz
# vi usx.map
keycode  58 = Control # Caps_Lock を Control に置き換え
# gzip usx.map
# loadkeys usx # キーマップをロード
# vi /etc/vconsole.conf
KEYMAP=usx # 追記
</code></pre>

<p>ロケールの生成。</p>

<pre><code># vi /etc/locale.gen # ja_JP.UTF-8 のコメントアウトを削除
# locale-gen
</code></pre>

<p>タイムゾーンの設定。</p>

<pre><code># ln -s /usr/share/zoneinfo/Asia/Tokyo /etc/localtime
</code></pre>

<p>ホスト名修正。</p>

<pre><code># echo &quot;&lt;ホスト名&gt;&quot; &gt; /etc/hostname
# vi /etc/hosts # 適宜修正
</code></pre>

<p>ネットワークの設定。まずは有線。</p>

<pre><code># systemctl enable dhcpcd@eth0.service
</code></pre>

<p>ブートローダとして syslinux を使う。ディスクデバイス名だけ修正。syslinux のインストーラが
うまくデバイス名を拾ってくれない。</p>

<pre><code># pacman -S syslinux
# vi /boot/syslinux/syslinux.cfg
LABEL arch
    MENU LABEL Arch Linux
    LINUX ../vmlinuz-linux
    APPEND root=/dev/sda2 ro
    INITRD ../initramfs-linux.img
</code></pre>

<p>パスワード設定。</p>

<pre><code># passwd
</code></pre>

<h4 id="再起動し-システムをインストールした-dev-sda2-で起動する">再起動し システムをインストールした /dev/sda2 で起動する。</h4>

<p>再起動し USB スティックを抜く。起動したら root ユーザでログイン。</p>

<p>無線デバイスの設定。</p>

<pre><code># pacman -S dialog wpa_supplicant
# wifi-menu
</code></pre>

<p>検知されたアクセスポイント名が表示されるので希望のモノを選択しパスフレーズを入力。</p>

<p>一般ユーザの作成と sudo 設定。</p>

<pre><code># useradd -u &lt;UID) -d /home/&lt;UESRNAME&gt; -m &lt;USERNAME&gt;
# passwd &lt;USERNAME&gt;
# pacman -S sudo
# vigr # wheel グループに自分を追記
# visudo # wheel のところのコメントアウトを削除
%wheel ALL=(ALL) ALL
</code></pre>

<h4 id="x-周りの設定">X 周りの設定</h4>

<p>X とウィンドウマネージャのインストール。ウィンドウマネージャは好きなものを。私
は awesome を選びました。</p>

<pre><code># pacman -S xorg xorg-xinit xterm rxvt-unicode xf86-video-intel awesome
</code></pre>

<p>日本語フォントのインストールと日本語インプットメソッドの設定。ibus と mozc を選んだ。
結構賢い。とりあえずのフォントとして sazanami を。</p>

<pre><code># vi /etc/pacman.conf # 下記のレポジトリを追記
[pnsft-pur]
SigLevel = Optional TrustAll
Server = http://downloads.sourceforge.net/project/pnsft-aur/pur/$arch
# pacman -Syy
# pacman -S ttf-sazanami ibus-mozc mozc
</code></pre>

<p>一般ユーザの ~/.xinitrc に下記を追記。</p>

<pre><code>% vi ~/.xinitrc
xrdb -merge $HOME/.Xresources

export LANG=ja_JP.UTF-8
export LANGUAGE=ja_JP.UTF-8
export LC_ALL=ja_JP.UTF-8
export LC_CTYPE=ja_JP.UTF-8

export GTK_IM_MODULE=ibus
export QT_IM_MODULE=xim
export XMODIFIERS=@im=ibus
ibus-daemon --daemonize --xim &amp;

setxkbmap -layout us -option ctrl:nocaps
exec awesome
</code></pre>

<p>X を起動。</p>

<pre><code>% startx
</code></pre>

<p>私は awesome を選びましたが、たまに enlightenment も選択します。この時点で enlightenment の
メニューなど、日本語化されているはずだが、厳しければ</p>

<p><a href="https://wiki.archlinux.org/index.php/Input_Japanese_using_uim_(%E6%97%A5%E6%9C%AC%E8%AA%9E)">https://wiki.archlinux.org/index.php/Input_Japanese_using_uim_(%E6%97%A5%E6%9C%AC%E8%AA%9E)</a></p>

<p>にある IPA フォント、VL ゴシックなどを入れる。こちらのほうが数段綺麗。</p>

<p>IPA フォントの入れ方だけメモっておく。</p>

<pre><code>% wget https://aur.archlinux.org/packages/ot/otf-ipafont/otf-ipafont.tar.gz
% tar zxvf otf-ipafont.tar.gz
% cd otf-ipafont
% makepkg -s
% sudo pacman -U &lt;生成された pkg.tar.xz ファイル&gt;
</code></pre>

<p>Thinkpad の真ん中ボタンでスクロールする。</p>

<pre><code># vi /etc/X11/xorg.conf.d/10-thinkpad.conf # 新規生成
Section &quot;InputClass&quot;
  Identifier &quot;Trackpoint Wheel Emulation&quot;
  MatchProduct &quot;TPPS/2 IBM TrackPoint|DualPoint Stick|Synaptics Inc. Composite TouchPad / TrackPoint|ThinkPad USB Keyboard with TrackPoint|USB Trackpoint pointing device|Composite TouchPad / TrackPoint&quot;
  MatchDevicePath &quot;/dev/input/event*&quot;
  Option  &quot;EmulateWheel&quot;  &quot;true&quot;
  Option  &quot;EmulateWheelButton&quot; &quot;2&quot;
  Option  &quot;Emulate3Buttons&quot; &quot;false&quot;
  Option  &quot;XAxisMapping&quot;  &quot;6 7&quot;
  Option  &quot;YAxisMapping&quot;  &quot;4 5&quot;
EndSection
</code></pre>

<p>X の再起動をして終了。</p>

<h4 id="まとめ">まとめ</h4>

<p>今回はブログというより雑多なまとめになったけど、メモするだけでも意味があるので
残しておいた。Debian / Ubuntu より手間は掛かるけど、エンジニアが何をやっている
か掴めるのでいいカンジ。無駄なプロセスいないので起動もめちゃ速いし。何より最新
のソフトウェア (安定したもの) が簡単に使えるのは嬉しい。ここに書いた手順は時間
がすぎるに連れて意味がないものになっていくだろう。開発が活発でここ数年でも結構
劇的にシステムが変更になってるみたい。systemd .. とか。理解するのに苦労する所
はないので、エンジニアであれば誰でも扱えそうなところも魅力。</p>

<p>OS なんて何でもいい時代 (抽象化されつつあるから) だけど、手元の端末に入れる OS
だけは Arch Linux がいいなぁ。</p>
</p>

    <footer>
        <ul class="actions">
            <li><a href="https://jedipunkz.github.io/blog/2013/01/14/arch-linux-setup/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    
                        Category
                    
                
            </li>
        
    

    
    
        <li><a href='/categories/infrastructure'>infrastructure</a></li>
    
</ul>

    </footer>
</article>

        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="https://jedipunkz.github.io/blog/2013/01/12/openstack-on-thinkpad/">OpenStack Folsom on Thinkpad</a></h2>
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2013-01-12'>
            January 12, 2013</time>
        <span class="author"></span>
        
        
    </div>
</header>

    

    
    <p><p>以前紹介した OpenStack Folsom 構築 bash スクリプトなのだけど quantum の代わり
に nova-network も使えるようにしておいた。</p>

<p>構築 bash スクリプトは、</p>

<p><a href="https://github.com/jedipunkz/openstack_folsom_deploy/blob/master/README_jp.md">https://github.com/jedipunkz/openstack_folsom_deploy/blob/master/README_jp.md</a></p>

<p>に詳しい使い方を書いておきました。またパラメータを修正して実行するのだけどパラ
メータについては、</p>

<p><a href="https://github.com/jedipunkz/openstack_folsom_deploy/blob/master/README_parameters_jp.md">https://github.com/jedipunkz/openstack_folsom_deploy/blob/master/README_parameters_jp.md</a></p>

<p>に書いておきました。</p>

<p><img src="http://jedipunkz.github.com/pix/openstack_folsom_thinkpad.jpg"></p>

<p>手持ちの Thinkpad に OpenStack folsom 入れた写真。この写真の OpenStack Folsom
を構築した時の手順を書いておくよ。</p>

<h4 id="os-をインストール">OS をインストール</h4>

<p>OS をインストールします。12.10 を使いました。(12.04 LTS でも可)。/dev/sda6 等、
Cinder 用に一つパーティションを作ってマウントしないでおきます。また固定 IP ア
ドレスを NIC に付与しておきます。</p>

<h4 id="スクリプト取得">スクリプト取得</h4>

<p>スクリプトを取得する。</p>

<pre><code>% sudo apt-get update; sudo apt-get install git-core
% git clone https://github.com/jedipunkz/openstack_folsom_deploy.git
% cd openstack_folsom_deploy
</code></pre>

<h4 id="パラメータ修正">パラメータ修正</h4>

<p>deploy_with_nova-network.conf 内のパラメータを修正します。オールインワン構成な
ので、ほぼほぼ修正せずに実行しますが</p>

<pre><code>HOST_IP='&lt;Thinkpad の IP アドレス&gt;'
</code></pre>

<p>だけ修正。</p>

<h4 id="実行">実行&hellip;</h4>

<p>実行する。</p>

<pre><code>% sudo ./deploy.sh allinone nova-network
</code></pre>

<p>&hellip; 最近 ./deploy.sh create_network nova-network を実行しなくて済むようにしました。</p>

<h4 id="horizon-にアクセスする">Horizon にアクセスする</h4>

<p>ブラウザで <a href="http://localhost/horizon">http://localhost/horizon</a> にアクセスすれば horizon にアクセス出来る。
ユーザ情報は&hellip;</p>

<pre><code>user : demo
pass : demo
</code></pre>

<p>です。Horizon から後でユーザ情報変更してもらって構わないです。</p>

<h4 id="コマンドラインからアクセスする">コマンドラインからアクセスする。</h4>

<p>実行したユーザのホームディレクトリに ~/openstackrc がある。</p>

<ul>
<li>~/openstackrc     # admin アカウント用</li>
<li>~openstackrc-demo # demo ユーザ用</li>
</ul>

<p>読み込んで OpenStack のコマンドを実行する。下記は例です。</p>

<pre><code>% source ~/openstackrc-demo
% nova list
+--------------------------------------+----------+--------+---------------------------------+
| ID                                   | Name     | Status | Networks                        |
+--------------------------------------+----------+--------+---------------------------------+
| 81730be5-f2b3-411c-bfef-9a879e3d7d56 | grievous | ACTIVE | private=10.0.0.5, 192.168.1.195 |
| 0ba8416a-58bd-476d-96a8-2ecc37ae53e6 | luke     | ACTIVE | private=10.0.0.2, 192.168.1.194 |
| 5b1f23b3-c15e-4260-bf6c-f3e965bcd546 | r2d2     | ACTIVE | private=10.0.0.4, 192.168.1.193 |
+--------------------------------------+----------+--------+---------------------------------+
</code></pre>

<h4 id="次のリリース版は">次のリリース版は&hellip;</h4>

<p>bash で書いても&hellip;満足感得られないしコード汚くなるし、人に読んでもらえないし。
ruby で書いても perl で書いても同じ。コマンドをバシバシ打つインフラ系のコード
は汚くなるしまともにテストも出来ない。これからはインフラ系もコードを書く時代だっ
て言っておいてこれじゃアカンぉ。</p>

<p>ならば情報が整理されるって意味だけでも chef のようなフレームワークを使う意味は
大きい。資源を他の人に有効活用してもらえるチャンスも増えるし。chef のクックブッ
クなんてコードじゃないってアプリエンジニアに言われようが、やっぱりフレームワー
ク使うべきだし使いたい。次の OpenStack のリリースの時は Chef のクックブック作
るって決めたよぉー。why-run 出来たり、テストも出来るしね。</p>
</p>

    <footer>
        <ul class="actions">
            <li><a href="https://jedipunkz.github.io/blog/2013/01/12/openstack-on-thinkpad/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    
                        Category
                    
                
            </li>
        
    

    
    
        <li><a href='/categories/infrastructure'>infrastructure</a></li>
    
</ul>

    </footer>
</article>

        

        
<ul class="actions pagination">
    
        <li><a href="/tags/page/8/"
                class="button big previous">Previous Page</a></li>
    

    
        <li><a href="/tags/page/10/"
                class="button big next">Next Page</a></li>
    
</ul>

    </div>
    
<section id="sidebar">

    
        <section id="intro">
            
            
            
            <ul class="icons">
                
                    <li><a href="https://jedipunkz.github.io/tags/index.xml" type="application/rss+xml"
                        target="_blank" title="RSS" class="fa fa-rss"></a></li>
                
                
            </ul>
        </section>

    
        <section id="recent-posts">
            <ul class="posts">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    
                

                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://jedipunkz.github.io/blog/2018/12/31/istio/">Istio, Helm を使って Getting Started 的なアプリをデプロイ</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2018-12-31'>
                                    December 31, 2018</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://jedipunkz.github.io/blog/2017/07/02/test-kitchen-cluster/">Docker,Test-Kitchen,Ansible でクラスタを構成する</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2017-07-02'>
                                    July 2, 2017</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://jedipunkz.github.io/blog/2017/04/13/gke-lb/">GCP ロードバランサと GKE クラスタを Terraform を使って構築する</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2017-04-13'>
                                    April 13, 2017</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://jedipunkz.github.io/blog/2017/02/12/serverless-fission/">Serverless on Kubernetes : Fission を使ってみた</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2017-02-12'>
                                    February 12, 2017</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://jedipunkz.github.io/blog/2017/01/13/kubernetes-deployments/">Kubernetes Deployments を使ってみた！</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2017-01-13'>
                                    January 13, 2017</time>
                            </header>
                        </article>
                    </li>
                

                
                    <li>
                        <ul class="actions">
                            <li><a href=
                            
                                "/post/"
                            
                            class="button">View more posts</a></li>
                        </ul>
                    </li>
                
            </ul>
        </section>

    
    
    
    
        <section id="categories">
            <ul class="posts">
                <header>
                    <h3><a href="/categories/">Categories</a></h3>
                </header>

                
                    
                

                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/infrastructure/">infrastructure</a>
                                <span style="float:right;">110</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/report/">report</a>
                                <span style="float:right;">9</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/tools/">tools</a>
                                <span style="float:right;">11</span>
                            </header>
                        </article>
                    </li>
                
            </ul>
        </section>
    

    
        

    
        <section id="footer">
            <ul class="icons">
                
                    <li><a href="https://jedipunkz.github.io/tags/index.xml" type="application/rss+xml"
                        target="_blank" title="RSS" class="fa fa-rss"></a></li>
                
                
            </ul>

            <p class="copyright">&copy; ジェダイさんのブログ. テーマデザインは <a href="//github.com/jpescador" target="_blank">Julio Pescador</a>さんによるものです。 </p>
        </section>

</section>

            </div>
        <a id="back-to-top" href="#" class="fa fa-arrow-up fa-border fa-2x"></a>
        

        
        
            
        

        
        
            <script src="/js/jquery.min.js"></script>
            <script src="/js/skel.min.js"></script>
            <script src="/js/util.js"></script>
            <script src="/js/main.js"></script>
            <script src="/js/backToTop.js"></script>
            <script src="/js/highlight.pack.js"></script>
        

        

            
            <script>hljs.initHighlightingOnLoad();</script>
            
    </body>
</html>

