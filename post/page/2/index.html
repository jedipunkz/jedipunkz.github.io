


    




<!DOCTYPE HTML>

<html>
    <head>
        
            <title>Posts - ジェダイさんのブログ</title>
        

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="generator" content="Hugo 0.17" />
        


        
        
            
                <meta name="description" content="技術ネタを書いていきます">
            
        

        
        <meta property="og:title" content="Posts" />
<meta property="og:description" content="技術ネタを書いていきます" />
<meta property="og:type" content="website" />
<meta property="og:url" content="http://jedipunkz.github.io/post/" />


<meta property="og:updated_time" content="2016-12-29T09:43:18&#43;09:00"/>









        
<meta itemprop="name" content="Posts">
<meta itemprop="description" content="技術ネタを書いていきます">


        

        

        
        
            
        

        
        
            <link rel="stylesheet" href="/css/google-font.css" />
            <link rel="stylesheet" href="/css/font-awesome.min.css" />
            <link rel="stylesheet" href="/css/main.css" />
            <link rel="stylesheet" href="/css/add-on.css" />
            <link rel="stylesheet" href="/css/monokai-sublime.css">
        

        

        
        
        
            
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-30563095-1', 'auto');
ga('send', 'pageview');
</script>

        
    </head>
    <body>

        
        <div id="wrapper">

    
<header id="header">
    
        <h1><a href="/">ジェダイさんのブログ</i></a></h1>
    

    <nav class="links">
        <ul>
            
                <li>
                    <a href="/post">
                        
                            <i class="fa fa-newspaper-o">&nbsp;</i>Blog
                    </a>
                </li>
            
                <li>
                    <a href="/categories">
                        Categories
                    </a>
                </li>
            
                <li>
                    <a href="/about">
                        About
                    </a>
                </li>
            
        </ul>
    </nav>
    <nav class="main">
        <ul>
            
            <li class="search">
                <a class="fa-search" href="#search">Search</a>
                <form id="search" method="get" action="//google.com/search">
                    <input type="text" name="q" placeholder="Search" />
                    <input type="hidden" name="q" value="site:http://jedipunkz.github.io/">
                </form>
            </li>
            <li class="menu">
                <a class="fa-bars" href="#menu">Menu</a>
            </li>
        </ul>
    </nav>
</header>


<section id="menu">

    
        <section>
            <form class="search" method="get" action="//google.com/search">
                <input type="text" name="q" placeholder="Search" />
                <input type="hidden" name="q" value="site:http://jedipunkz.github.io/">
            </form>
        </section>

    
        <section>
            <ul class="links">
                
                    <li>
                        <a href="/post">
                            <h3>
                                
                                    <i class="fa fa-newspaper-o">&nbsp;</i>
                                
                                Blog
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories">
                            <h3>
                                
                                Categories
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/about">
                            <h3>
                                
                                About
                            </h3>
                        </a>
                    </li>
                
            </ul>
        </section>

    
        <section>
            <ul class="links">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    <li>
                        <a href="http://jedipunkz.github.io/blog/2017/04/13/gke-lb/"><p>GCP ロードバランサと GKE クラスタを Terraform を使って構築する</p></a>
                    </li>
                
                    <li>
                        <a href="http://jedipunkz.github.io/blog/2017/02/12/serverless-fission/"><p>Serverless on Kubernetes : Fission を使ってみた</p></a>
                    </li>
                
                    <li>
                        <a href="http://jedipunkz.github.io/blog/2017/01/13/kubernetes-deployments/"><p>Kubernetes Deployments を使ってみた！</p></a>
                    </li>
                
                    <li>
                        <a href="http://jedipunkz.github.io/blog/2016/12/29/fluentd-sidecar-gcp/"><p>fluentd-sidecar-gcp と Kubernetes Volumes で Cloud Logging ログ転送</p></a>
                    </li>
                
            </ul>
        </section>

    
        
</section>

    
    <div id="main">
        
        
            
        

        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="http://jedipunkz.github.io/blog/2016/12/29/fluentd-sidecar-gcp/">fluentd-sidecar-gcp と Kubernetes Volumes で Cloud Logging ログ転送</a></h2>
        
        
            <p>fluentd-sidecar-gcp と Kubernetes Volumes で Cloud Logging へログ転送</p>
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2016-12-29'>
            December 29, 2016</time>
        <span class="author"></span>
        
            <p>2 minute read</p>
        
        
    </div>
</header>

    

    
    <p>こんにちは @jedipunkz です。</p>

<p>今回は Kubernetes を使った構成で Google-Fluentd をどのコンテナに載せるか？ってことを考えてみたので書きたいと思います。</p>

<p>Kubernetes は Docker を利用したソフトウェアなので Docker と同じく &ldquo;1コンテナ, 1プロセス&rdquo; というポリシがあります。つまり、コンテナ上のプロセスが停止したら Kubernetes がそれを検知してコンテナを起動しなおしてくれます。ですが、複数プロセスを1コンテナに稼働させると、それが出来ません。そうは言っても中には複数のプロセスを稼働させたい場面があります。その場面として考えられる具体的な例として HTTPD サーバのログを Google-Fluentd を使って GCP Cloud Logging に転送したい場合があります。</p>

<p>今回は上記の例を fluentd-sidecar-gcp と kubernetes volumes を使って解決する方法を記したいと思います。</p>

<h2 id="構成のシナリオ">構成のシナリオ</h2>

<p>シナリオとしては下記のとおりです。</p>

<ul>
<li>マルチコンテナポッドを扱う</li>
<li>1つの Kubernetes Volumes を複数コンテナで共有する</li>
<li>HTTPD ログをその Volume に出力</li>
<li>隣接する Google-Fluentd コンテナでその Volume に出力されたログを読み込みログ転送</li>
</ul>

<h2 id="fluentd-sidecar-gcp-とは">fluentd-sidecar-gcp とは</h2>

<p>次に説明するのは fluentd-sidecar-gcp の概略です。これは Kubernetes が contrib で扱っているコンテナです。下記の URL にあります。</p>

<p><a href="https://github.com/kubernetes/contrib/tree/master/logging/fluentd-sidecar-gcp">https://github.com/kubernetes/contrib/tree/master/logging/fluentd-sidecar-gcp</a></p>

<p>Google-Fluentd を稼働させる Dockerfile が用意されているのですが、下記の記述を確認するとこのコンテナに環境変数 $FILES_TO_COLLECT を渡すと Google Fluentd でログを取得してくれることが分かります。</p>

<p><a href="https://github.com/kubernetes/contrib/blob/master/logging/fluentd-sidecar-gcp/config_generator.sh#L22-L37">https://github.com/kubernetes/contrib/blob/master/logging/fluentd-sidecar-gcp/config_generator.sh#L22-L37</a></p>

<p>つまり、fluentd-sidecar-gcp コンテナに隣接する HTTPD コンテナのログが出力される Kubernetes Volumes 上のファイルパスを指定すれば HTTPD のログが取得でき、Google Cloud Logging へログが転送できます。</p>

<h2 id="サンプルの-kubernetes-yaml">サンプルの Kubernetes YAML</h2>

<p>下記にサンプルとして Kubernetes YAML を記します。</p>

<pre><code>apiVersion: v1
kind: Pod
metadata:
  labels:
    run:  my-nginx
  name: nginx-fluentd-logging-example
spec:
  containers:
  - name: nginx-container
    image: nginx
    ports:
    - containerPort: 80
    volumeMounts:
    - name: log-storage
      mountPath: /var/log/nginx
  - name: sidecar-log-collector
    image: gcr.io/google_containers/fluentd-sidecar-gcp:1.4
    resources:
      limits:
        cpu: 100m
        memory: 200Mi
    env:
    - name: FILES_TO_COLLECT
      value: &quot;/mnt/log/nginx/access.log /mnt/log/nginx/error.log&quot;
    volumeMounts:
    - name: log-storage
      readOnly: true
      mountPath: /mnt/log/nginx
  volumes:
  - name: log-storage
    emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: my-nginx
  labels:
    run: my-nginx
spec:
  ports:
  - port: 80
    protocol: TCP
  selector:
    run: my-nginx
</code></pre>

<p>特徴を下記に解説します。</p>

<ul>
<li>nginx-container, sidecar-log-collector のマルチコンテナポッドです。</li>
<li>sidecar-log-collector の image: としては gcr.io/google_containers/fluentd-sidecar-gcp:1.4 が指定されています</li>
<li>&lsquo;log-storage&rsquo; として nginx-container の /var/log/nginx が sidecar-log-collector の /mnt/log/nginx として共有されています</li>
<li>FILES_TO_COLLECT として共有 Volume 上の access.log, error.log が指定されています</li>
</ul>

<p>結果、Nginx コンテナのログが Kubernetes Volume で Google-Fluentd コンテナに読み込み専用で共有され (readOnly 行) 、この Google-Fluentd は環境変数で渡された /mnt/log/nginx/access.log と /mnt/log/nginx/error.log を読み込み開始し、内容を Google Cloud Logging へ転送します。</p>

<h2 id="デプロイ方法">デプロイ方法</h2>

<p>デプロイは下記の通り実施します。</p>

<pre><code>$ kubectl create -f &lt;上記のファイル名&gt;
</code></pre>

<h2 id="結果とまとめ">結果とまとめ</h2>

<p>それぞれのログファイルを Tag を Google-Fluentd で付けた形で Google Cloud Logging へ転送出来ました。ログ毎に結果を Cloud Logging UI 上で確認できます。
本来、Docker なので標準出力にログを出力し Kubernetes がその標準出力を Cloud Logging へ転送してくれるのですが、それだと Tag が付けられないため、ログを分離するのが一苦労だと思います。ですが、今回紹介した方法では Google-Fluentd で Tag を付けてログ転送出来たため、その心配はありません。</p>

<p>この Kubernetes Volumes は他にも利用方法がありそうです。</p>

<p>本来、GKE や Kubernetes を利用される方は Microservice Architecture が採用出来ている方々だと思うのですが、fluentd をアプリコンテナから分離するのは結構悩むところじゃないかと思うので、今回紹介した方法はそう言った場合に有用かと思います。</p>

    <footer>
        <ul class="actions">
            <li><a href="http://jedipunkz.github.io/blog/2016/12/29/fluentd-sidecar-gcp/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
    

    
    
</ul>

    </footer>
</article>

        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="http://jedipunkz.github.io/blog/2016/12/29/cloud-cdn/">Google Cloud CDN を使ってみた</a></h2>
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2016-12-29'>
            December 29, 2016</time>
        <span class="author"></span>
        
            <p>1 minute read</p>
        
        
    </div>
</header>

    

    
    <p>こんにちは。@jedipunkz です。</p>

<p>今回は Google Cloud Platform の Google CloudCDN について調べてみたので記したいと思います。</p>

<p>CloudCDN は GCP のロードバランサのバックエンドサービスに紐付けられるサービスです。このバックエンドサービスで CloudCDN を有効にしていると CDN サービスを機能させることが出来ます。先に書いておくとこの CloudCDN はとてもシンプルで扱いやすいサービスだと判りました。高機能な他の CDN サービスと比べると機能が足らない感ありますが、必要最低限なところを抑えているのと、価格がとても安いです。(価格は下記の URL 参照)</p>

<p>価格表 : <a href="https://cloud.google.com/cdn/pricing">https://cloud.google.com/cdn/pricing</a></p>

<h2 id="構成">構成</h2>

<p>構成と構成の特徴です。</p>

<pre><code>+----------+                                    +---------+
| instance |--+                               +-| EndUser |
+----------+  |  +------------+  +----------+ | +---------+
              +--|LoadBalancer|--| CloudCDN |-+-| EndUser |
+----------+  |  +------------+  +----------+ | +---------+
| instance |--+                               +-| EndUser |
+----------+                                    +---------+
</code></pre>

<ul>
<li>コンテンツが初めてリクエストされた場合キャッシュミスする</li>
<li>キャッシュミスした際に近くにあるキャッシュからコンテンツを取得しようと試みる</li>
<li>近くのキャッシュがコンテンツがある場合、最初のキャッシュにコンテンツが送信される</li>
<li>近くのキャッシュにコンテンツがない場合、HTTP ロードバランサにリクエストが転送される</li>
<li>その後のリクエストはキャッシュが応答する(キャッシュヒット)</li>
<li>キャッシュ間のフィルは EndUser のリクエストに応じて実行される</li>
<li>キャッシュを事前に読み込むことできない</li>
<li>キャッシュは世界各地に配置されている</li>
</ul>

<h2 id="cloudcdn-を導入する方法">CloudCDN を導入する方法</h2>

<p>導入する方法は簡単で下記のとおりです。</p>

<ul>
<li>新規 LB を WebUI で作成</li>
<li>バックエンドサービスを作成</li>
<li>右パネルの下にある [Cloud CDN を有効にする] チェックボックスをオンに</li>
<li>作成ボタンを押下</li>
</ul>

<p>HTTPD サーバ側 (今回は Apache を使います) でキャッシュに関する設定を行います。
下記は例です。3600秒、キャッシュさせる設定になります。</p>

<pre><code>Header set Cache-control &quot;public, max-age=3600&quot;
</code></pre>

<p>キャッシュされる条件は RFC7324 に規定されているとおりです。</p>

<h2 id="特定のキャッシュを削除する方法">特定のキャッシュを削除する方法</h2>

<p>Google Cloud SDK <a href="https://cloud.google.com/sdk/">https://cloud.google.com/sdk/</a> を使うと CLI でコンテンツを指定してキャッシュのクリアが出来ます。また WebUI でもクリアは可能です。</p>

<pre><code>$ gcloud compute url-maps invalidate-cdn-cache &lt;url-map の名前&gt; --path &quot;コンテンツのパス&quot;
</code></pre>

<p>このときに &ndash;path で指定できるコンテンツの記し方は下記のように指定することも可能です。</p>

<pre><code>--path &quot;/cat.png # &lt;--- 1つのコンテンツキャッシュを削除
--path &quot;/*&quot;      # &lt;--- 全てのコンテンツキャッシュを削除
--path &quot;/pix/*&quot;  # &lt;--- ディレクトリ指定で削除
</code></pre>

<h2 id="まとめ">まとめ</h2>

<p>価格が低価格で必要最低限な機能に絞られている印象です。シンプルな分、理解し易いですしキャッシュクリアについても Hubot 化などすれば開発者の方に実行してもらいやすいのではないでしょうか。</p>

    <footer>
        <ul class="actions">
            <li><a href="http://jedipunkz.github.io/blog/2016/12/29/cloud-cdn/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    

                    

                    
                        Category
                    
                
            </li>
        
    

    
    
        <li><a href='/categoriesinfrastructure'>infrastructure</a></li>
    
</ul>

    </footer>
</article>

        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="http://jedipunkz.github.io/blog/2016/11/27/etcd-operator/">coreos の etcd operator を触ってみた</a></h2>
        
        
            <p>coreos が最近アナウンスした etcd operator を触ってみた</p>
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2016-11-27'>
            November 27, 2016</time>
        <span class="author">jedipunkz</span>
        
            <p>3 minute read</p>
        
        
    </div>
</header>

    

    
    <p>こんにちは @jedipunkz です。</p>

<p>今日は某アドベントカレンダーに参加していて記事を書いています。
記事だけ先出ししちゃいます..。</p>

<p>今日は最近 coreos がリリースした &lsquo;etcd-operator&rsquo; を触ってみようかと思います。ほぼ、README に書かれている手順通りに実施するのですが、所感を交えながら作業して記事にしてみたいと思います。</p>

<p>coreos が提供している etcd についてご存知ない方もいらっしゃると思いますが etcd は KVS ストレージでありながら Configuration Management Store として利用できる分散型ストレージです。Docker 等の環境を提供する coreos という軽量 OS 内でも etcd が起動していてクラスタで管理された情報をクラスタ内の各 OS が読み書きできる、といった機能を etcd が提供しています。
詳細については公式サイトを御覧ください。</p>

<p>etcd 公式サイト : <a href="https://coreos.com/etcd/docs/latest/">https://coreos.com/etcd/docs/latest/</a></p>

<p>etcd-operator はこの etcd クラスタを kubernetes 上でクラスタ管理するための簡単に運用管理するためのソフトウェアになります。</p>

<p>etcd-operator 公式アナウンス : <a href="https://coreos.com/blog/introducing-the-etcd-operator.html">https://coreos.com/blog/introducing-the-etcd-operator.html</a></p>

<p>後に実際に触れていきますが下記のような管理が可能になります。</p>

<ul>
<li>etcd クラスタの構築</li>
<li>etcd クラスタのスケールアップ・ダウン</li>
<li>etcd Pod の障害時自動復旧</li>
<li>etcd イメージをオンラインで最新のモノにアップグレード</li>
</ul>

<p>では早速利用してみたいと思います。</p>

<h2 id="必要な環境">必要な環境</h2>

<p>下記の環境が事前に用意されている必要があります。</p>

<ul>
<li>Docker</li>
<li>Kubernetes or minikube+kubernetes (<a href="https://github.com/kubernetes/minikube">https://github.com/kubernetes/minikube</a>)</li>
<li>etcdctl : <a href="https://github.com/coreos/etcd/tree/master/etcdctl">https://github.com/coreos/etcd/tree/master/etcdctl</a></li>
</ul>

<h2 id="作業準備">作業準備</h2>

<p>下記のレポジトリをクローンします。</p>

<pre><code>$ git clone https://github.com/coreos/etcd-operator.git
</code></pre>

<h2 id="operator-のデプロイ">Operator のデプロイ</h2>

<p>下記のような内容のファイルが記さているファイルを利用します。中身を確認しましょう。</p>

<pre><code>$ cat  example/deployment.yaml
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: etcd-operator
spec:
  replicas: 1
  template:
    metadata:
      labels:
        name: etcd-operator
    spec:
      containers:
      - name: etcd-operator
        image: quay.io/coreos/etcd-operator
        env:
        - name: MY_POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
</code></pre>

<p>kind: Deployment で etcd-operator のイメージを使ってレプリカ数1のポッドを起動しているのが分かると思います。実際にデプロイします。</p>

<pre><code>$ kubectl create -f example/deployment.yaml
</code></pre>

<p>どんなポッドが起動したか確認します。</p>

<pre><code>kubectl get pods
NAME                                     READY     STATUS    RESTARTS   AGE
etcd-operator-217127005-futo0            1/1       Running   0          1m
</code></pre>

<p>あと、これは自分も知りませんでしたがサードパーティリソースという枠があるらしく下記のように確認することができます。</p>

<pre><code>kubectl get thirdpartyresources
NAME                      DESCRIPTION             VERSION(S)
etcd-cluster.coreos.com   Managed etcd clusters   v1
</code></pre>

<p>replica数1 ですが、ポッドなのでポッド内のプロセスに問題があれば kubernetes が自動で修復 (場合によってポッドの再構築) されます。また replica 数を増やす運用も考えられそうです。</p>

<h2 id="etcd-クラスタの構築">etcd クラスタの構築</h2>

<p>下記の内容のファイルで etcd をデプロイします。中身を確認しましょう。
API は coreos.com/v1 で kind: EtcdCluster という情報が記されています。また version でイメージバージョンが記されているのかなということが後に確認できます。また size でレプリカ数が記されているようです。</p>

<pre><code>$ cat example/example-etcd-cluster.yaml
apiVersion: &quot;coreos.com/v1&quot;
kind: &quot;EtcdCluster&quot;
metadata:
  name: &quot;etcd-cluster&quot;
spec:
  size: 3
  version: &quot;v3.1.0-alpha.1&quot;
</code></pre>

<p>デプロイをしてみます。</p>

<pre><code>$ kubectl create -f example/example-etcd-cluster.yaml
</code></pre>

<p>クラスタがデプロイされたか見てみます。3つのポッドが確認できます。やはりファイル中 size: 3 はレプリカ数だったようです。</p>

<pre><code>$ kubectl get pods --show-all
NAME                                     READY     STATUS      RESTARTS   AGE
etcd-cluster-0000                        1/1       Running     0          1m
etcd-cluster-0001                        1/1       Running     0          36s
etcd-cluster-0002                        1/1       Running     0          21s
</code></pre>

<p>同様に Service について確認します。etcd-cluster-000[012] の3つが今回作った etcd クラスタです。</p>

<pre><code>$ kubectl get svc
NAME                    CLUSTER-IP   EXTERNAL-IP   PORT(S)             AGE
etcd-cluster            10.0.0.80    &lt;none&gt;        2379/TCP            1m
etcd-cluster-0000       10.0.0.13    &lt;none&gt;        2380/TCP,2379/TCP   1m
etcd-cluster-0001       10.0.0.111   &lt;none&gt;        2380/TCP,2379/TCP   1m
etcd-cluster-0002       10.0.0.183   &lt;none&gt;        2380/TCP,2379/TCP   50s
kubernetes              10.0.0.1     &lt;none&gt;        443/TCP             5d
</code></pre>

<h2 id="etcd-クラスタをスケールアウト">etcd クラスタをスケールアウト</h2>

<p>では etcd クラスタのレプリカ数を増やすことでスケールアウトしてみます。が、今現在 (<sup>2016</sup>&frasl;<sub>12</sub>) 時点では一部不具合があるらしく回避策として下記の通り curl を用いてスケールアウトすることが可能なようです。</p>

<p>下記の内容で body.json ファイルを用意します。size: 5 になっていることが確認できて、レプリカ数5になるのだなと判断できます。</p>

<pre><code>$ cat body.json
{
  &quot;apiVersion&quot;: &quot;coreos.com/v1&quot;,
  &quot;kind&quot;: &quot;EtcdCluster&quot;,
  &quot;metadata&quot;: {
    &quot;name&quot;: &quot;etcd-cluster&quot;,
    &quot;namespace&quot;: &quot;default&quot;
  },
  &quot;spec&quot;: {
    &quot;size&quot;: 5
  }
}
</code></pre>

<p>ここで curl で実行するためプロキシを稼働します。</p>

<pre><code>$ kubectl proxy --port=8080
</code></pre>

<p>curl で先程作った body.json を PUT してみます。</p>

<pre><code>curl -H 'Content-Type: application/json' -X PUT --data @body.json http://127.0.0.1:8080/apis/coreos.com/v1/namespaces/default/etcdclusters/etcd-cluster
</code></pre>

<p>クラスタがスケールアウトされたか確認しましょう。</p>

<pre><code>kubectl get pods --show-all
NAME                                     READY     STATUS    RESTARTS   AGE
etcd-cluster-0000                        1/1       Running   0          5m
etcd-cluster-0001                        1/1       Running   0          4m
etcd-cluster-0002                        1/1       Running   0          4m
etcd-cluster-0003                        1/1       Running   0          32s
etcd-cluster-0004                        1/1       Running   0          17s
etcd-operator-217127005-futo0            1/1       Running   0          9m
</code></pre>

<p>5台構成のクラスタにスケールアウトしたことが確認できます。</p>

<h2 id="etcd-にアクセス">etcd にアクセス</h2>

<p>5台構成の etcd クラスタがデプロイできたので etcd に etcdctl を使ってアクセスしてみましょう。事前に etcdctl をインストールする必要があります。また私の環境もそうだったのですがローカルの Mac に minikube を使って kubernetes 環境を構築しているので下記のように nodePort を作るため作業が必要です。</p>

<pre><code>$ kubectl create -f example/example-etcd-cluster-nodeport-service.json
$ export ETCDCTL_API=3
$ export ETCDCTL_ENDPOINTS=$(minikube service etcd-cluster-client-service --url)
$ etcdctl put foo bar
$ etcdctl get foo
foo
bar
</code></pre>

<p>etcdctl でキー・値を入力・読み込みが可能であることが分かりました！</p>

<h2 id="ポッドの自動復旧">ポッドの自動復旧</h2>

<p>kubernetes を普段使っている方は分かると思うのですがポッドを落としても kubernetes が自動復旧してくれます。ここで一つポッドを削除してみようと思います。</p>

<pre><code>$kubectl get pods
NAME                                     READY     STATUS    RESTARTS   AGE
etcd-cluster-0000                        1/1       Running   0          11m
etcd-cluster-0001                        1/1       Running   0          11m
etcd-cluster-0002                        1/1       Running   0          11m
etcd-cluster-0003                        1/1       Running   0          6m
etcd-cluster-0004                        1/1       Running   0          6m
etcd-operator-217127005-futo0            1/1       Running   0          16m

$kubect delete pod etcd-cluster-0004
</code></pre>

<p>しばらくすると下記の通り etcd-cluster-0004 に代わり etcd-cluster-0005 が稼働していることが確認できると思います。</p>

<pre><code>$ kubectl get pods
NAME                                     READY     STATUS    RESTARTS   AGE
etcd-cluster-0000                        1/1       Running   0          12m
etcd-cluster-0001                        1/1       Running   0          12m
etcd-cluster-0002                        1/1       Running   0          11m
etcd-cluster-0003                        1/1       Running   0          7m
etcd-cluster-0005                        1/1       Running   0          3s
etcd-operator-217127005-futo0            1/1       Running   0          17m
</code></pre>

<h2 id="まとめ">まとめ</h2>

<p>kubernetes の上で構成することでうまく kubernetes のメリットを活かしつつ etcd クラスタを構成できていると言えると思います。記事執筆時ではまだ不具合が幾つかありました (上記の curl で実施した箇所や、イメージのアップグレード) が、etcd を手動で構築するより kubernetes で構成するほうがメリットが多いことは明らかです。また kubernetes のポッドから kubernetes dns を介してサービスネームに直接アクセスできるのでポッドから etcd に情報を読み書きすることも容易になりそうです。</p>

<p>ですが etcd に収めるデータの性質によっては運用面で厳しくなることも想定できます。coreos 内で etcd クラスタを介して互いのコンテナ間でコンフィグを共有し合う使い方は非常に意味があると思うのですが、coreos 外の独自のソフトウェアがいろんな種別のデータを etcd クラスタに外から入出力することの意味はそれほど無いように思えます。であれば高耐久性で運用のし易い軽量な KVS ソフトウェアを使うべきだからです。</p>

<p>また今回紹介した etcd-operator とは別に coreos が同時にアナウンスした(<a href="https://coreos.com/blog/the-prometheus-operator.html">https://coreos.com/blog/the-prometheus-operator.html</a>) に関しても興味を持っているので後に触ってみたいと思います。</p>

<p>何と言うか所感として最後に述べるとサーバレスが叫ばれている中でわざわざクラスタソフトウェアを自前で管理するのか？と疑問も確かに残ります。それこそクラウドプラットフォームが提供すべき機能だと思うからです..。</p>

    <footer>
        <ul class="actions">
            <li><a href="http://jedipunkz.github.io/blog/2016/11/27/etcd-operator/" class="button big">Continue Reading</a></li>
        </ul>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    

                    

                    
                        Category
                    
                
            </li>
        
    

    
    
        <li><a href='/categoriesinfrastructure'>infrastructure</a></li>
    
</ul>

    </footer>
</article>

        

        
<ul class="actions pagination">
    
        <li><a href="/post/"
                class="button big previous">Previous Page</a></li>
    

    
        <li><a href="/post/page/3/"
                class="button big next">Next Page</a></li>
    
</ul>

    </div>
    
<section id="sidebar">

    
        <section id="intro">
            
            
                
                    <img src="/pix/jedipunkz.jpg" class="intro-circle" width="250" alt="jedipunkz icon" />
                
            
            
                <header>
                    <h2></h2>
                    <p>ジェダイさんです。インフラエンジニアからインフラ寄りのソフトウェアエンジニアになるために勉強していきます。</p>
                </header>
            
            <ul class="icons">
                
                    <li><a href="http://jedipunkz.github.io/post/index.xml" type="application/rss+xml"
                        target="_blank" title="RSS" class="fa fa-rss"></a></li>
                
                
                    
<li><a href="//github.com/jedipunkz" target="_blank" title="GitHub" class="fa fa-github"></a></li>

















































<li><a href="//twitter.com/jedipunkz" target="_blank" title="Twitter" class="fa fa-twitter"></a></li>




                
            </ul>
        </section>

    
        <section id="recent-posts">
            <ul class="posts">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    
                

                
                    <li>
                        <article>
                            <header>
                                <h3><a href="http://jedipunkz.github.io/blog/2017/04/13/gke-lb/">GCP ロードバランサと GKE クラスタを Terraform を使って構築する</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2017-04-13'>
                                    April 13, 2017</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="http://jedipunkz.github.io/blog/2017/02/12/serverless-fission/">Serverless on Kubernetes : Fission を使ってみた</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2017-02-12'>
                                    February 12, 2017</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="http://jedipunkz.github.io/blog/2017/01/13/kubernetes-deployments/">Kubernetes Deployments を使ってみた！</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2017-01-13'>
                                    January 13, 2017</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="http://jedipunkz.github.io/blog/2016/12/29/fluentd-sidecar-gcp/">fluentd-sidecar-gcp と Kubernetes Volumes で Cloud Logging ログ転送</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2016-12-29'>
                                    December 29, 2016</time>
                            </header>
                        </article>
                    </li>
                

                
                    <li>
                        <ul class="actions">
                            <li><a href=
                            
                                /post/
                            
                            class="button">View more posts</a></li>
                        </ul>
                    </li>
                
            </ul>
        </section>

    
    
    
    
        <section id="categories">
            <ul class="posts">
                <header>
                    <h3><a href="/categories/">Categories</a></h3>
                </header>

                
                    
                

                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/infrastructure/">infrastructure</a>
                                <span style="float:right;">108</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/tools/">tools</a>
                                <span style="float:right;">11</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/report/">report</a>
                                <span style="float:right;">9</span>
                            </header>
                        </article>
                    </li>
                
            </ul>
        </section>
    

    
        
        <section class="blurb">
            <h2>About</h2>
            <p>ソフトウェア寄りのエンジニアになるため勉強をしています。勉強したことをメモしていければと思います。</p>

            <ul class="actions">
                <li><a href="/about/" class="button">Learn More</a></li>
            </ul>
        </section>
        

    
        <section id="footer">
            <ul class="icons">
                
                    <li><a href="http://jedipunkz.github.io/post/index.xml" type="application/rss+xml"
                        target="_blank" title="RSS" class="fa fa-rss"></a></li>
                
                
                    
<li><a href="//github.com/jedipunkz" target="_blank" title="GitHub" class="fa fa-github"></a></li>

















































<li><a href="//twitter.com/jedipunkz" target="_blank" title="Twitter" class="fa fa-twitter"></a></li>




                
            </ul>

            <p class="copyright">&copy; ジェダイさんのブログ. テーマデザインは <a href="//github.com/jpescador" target="_blank">Julio Pescador</a>さんによるものです。 </p>
        </section>

</section>

            </div>
        <a id="back-to-top" href="#" class="fa fa-arrow-up fa-border fa-2x"></a>
        

        
        
            
        

        
        
            <script src="/js/jquery.min.js"></script>
            <script src="/js/skel.min.js"></script>
            <script src="/js/util.js"></script>
            <script src="/js/main.js"></script>
            <script src="/js/backToTop.js"></script>
            <script src="/js/highlight.pack.js"></script>
        

        

            
            <script>hljs.initHighlightingOnLoad();</script>
            
    </body>
</html>

