<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Istio Sidecar Injection を理解する | jedipunkz 🚀 のブログ</title>
<meta name="keywords" content="">
<meta name="description" content="こんにちは。@jedipunkz です。
前回の記事 「Istio, Helm を使って Getting Started 的なアプリをデプロイ」で kubernetes 上で istio をインストールし sidecar injection を有効化しサンプルアプリケーションを起動しました。その結果、sidecar 的に envoy コンテナが起動するところまで確認しました。今回はもう少し単純な pod を用いて &lsquo;sidecar injection&rsquo; の中身をもう少しだけ深掘りして見ていきたいと思います。
Rquirements
記事と同等の動きを確認するために下記のソフトウェアが必要になります。
それぞれのソフトウェアは事前にインストールされた前提で記事を記していきます。

macos or linux os
kubectl
istioctl
minikube

参考 URL
下記の istio 公式ドキュメントを参考に動作確認しました。

https://istio.io/docs/setup/kubernetes/additional-setup/sidecar-injection/
https://istio.io/docs/setup/kubernetes/additional-setup/sidecar-injection/

minikube で kubenetes をデプロイ
前回同様に minikube 上で動作を確認していきます。パラメータは適宜、自分の環境に読み替えてください。
minikube start --memory=8192 --cpus=4 --kubernetes-version=v1.10.0 \
  --extra-config=controller-manager.cluster-signing-cert-file=&#34;/var/lib/minikube/certs/ca.crt&#34; \
  --extra-config=controller-manager.cluster-signing-key-file=&#34;/var/lib/minikube/certs/ca.key&#34; \
  --vm-driver=virtualbox
istio を稼働させる
下記のコマンドを用いてカレントディレクトリに istio のサンプル yaml が入ったフォルダを展開します。
curl -L https://git.io/getLatestIstio | sh -
次に下記のコマンドで kubernetes 上に istio をインストールします。
istio コンテナ間の通信をプレインテキスト or TLS で行うよう istio-demo.yml を apply しています。">
<meta name="author" content="jedipunkz">
<link rel="canonical" href="https://jedipunkz.github.io/post/istio-sidecar-injection/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.ff74e95652f7dc8be9c79a75145f63445c00bcf8fc21f87252d8f3ff54a5aa46.css" integrity="sha256-/3TpVlL33Ivpx5p1FF9jRFwAvPj8IfhyUtjz/1SlqkY=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://jedipunkz.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://jedipunkz.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://jedipunkz.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://jedipunkz.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://jedipunkz.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://jedipunkz.github.io/post/istio-sidecar-injection/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><link rel="stylesheet" href="/css/custom.css">
<style>
 
.post-content code,
.post-content pre code,
.post-content .highlight code,
.post-content .highlighttable code {
    font-size: 1em !important;
}

 
.post-content p code,
.post-content li code,
.post-content td code {
    font-size: 1em !important;
}
</style><script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "\"Istio Sidecar Injection を理解する\"",
  "description": "\"こんにちは。@jedipunkz です。\\n前回の記事 「Istio, Helm を使って Getting Started 的なアプリをデプロイ」で kubernetes 上で istio をインストールし sidecar injection を有効化しサンプルアプリケーションを起動しました。その結果、sidecar 的に envoy コンテナが起動するところまで確認しました。今回はもう少し単純な pod を用いて \\u0026lsquo;sidecar injection\\u0026rsquo; の中身をもう少しだけ深掘りして見ていきたいと思います。\\nRquirements 記事と同等の動きを確認するために下記のソフトウェアが必要になります。 それぞれのソフトウェアは事前にインストールされた前提で記事を記していきます。\\nmacos or linux os kubectl istioctl minikube 参考 URL 下記の istio 公式ドキュメントを参考に動作確認しました。\\nhttps://istio.io/docs/setup/kubernetes/additional-setup/sidecar-injection/ https://istio.io/docs/setup/kubernetes/additional-setup/sidecar-injection/ minikube で kubenetes をデプロイ 前回同様に minikube 上で動作を確認していきます。パラメータは適宜、自分の環境に読み替えてください。\\nminikube start --memory=8192 --cpus=4 --kubernetes-version=v1.10.0 \\\\ --extra-config=controller-manager.cluster-signing-cert-file=\\u0026#34;/var/lib/minikube/certs/ca.crt\\u0026#34; \\\\ --extra-config=controller-manager.cluster-signing-key-file=\\u0026#34;/var/lib/minikube/certs/ca.key\\u0026#34; \\\\ --vm-driver=virtualbox istio を稼働させる 下記のコマンドを用いてカレントディレクトリに istio のサンプル yaml が入ったフォルダを展開します。\\ncurl -L https://git.io/getLatestIstio | sh - 次に下記のコマンドで kubernetes 上に istio をインストールします。 istio コンテナ間の通信をプレインテキスト or TLS で行うよう istio-demo.yml を apply しています。\\n\"",
  "datePublished": "2019-04-24T22:55:45\u002b09:00",
  "dateModified": "2019-04-24T22:55:45\u002b09:00",
  "author": {
    "@type": "Person",
    "name": "\"jedipunkz\""
  },
  "publisher": {
    "@type": "Person",
    "name": "\"jedipunkz\"",
    "logo": {
      "@type": "ImageObject",
      "url": "https:\/\/jedipunkz.github.io\/jedipunkz.jpg"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https:\/\/jedipunkz.github.io\/post\/istio-sidecar-injection\/"
  }
}
</script>
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-2H91XCYVZ8"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-2H91XCYVZ8');
        }
      </script><meta property="og:url" content="https://jedipunkz.github.io/post/istio-sidecar-injection/">
  <meta property="og:site_name" content="jedipunkz 🚀 のブログ">
  <meta property="og:title" content="Istio Sidecar Injection を理解する">
  <meta property="og:description" content="こんにちは。@jedipunkz です。
前回の記事 「Istio, Helm を使って Getting Started 的なアプリをデプロイ」で kubernetes 上で istio をインストールし sidecar injection を有効化しサンプルアプリケーションを起動しました。その結果、sidecar 的に envoy コンテナが起動するところまで確認しました。今回はもう少し単純な pod を用いて ‘sidecar injection’ の中身をもう少しだけ深掘りして見ていきたいと思います。
Rquirements 記事と同等の動きを確認するために下記のソフトウェアが必要になります。 それぞれのソフトウェアは事前にインストールされた前提で記事を記していきます。
macos or linux os kubectl istioctl minikube 参考 URL 下記の istio 公式ドキュメントを参考に動作確認しました。
https://istio.io/docs/setup/kubernetes/additional-setup/sidecar-injection/ https://istio.io/docs/setup/kubernetes/additional-setup/sidecar-injection/ minikube で kubenetes をデプロイ 前回同様に minikube 上で動作を確認していきます。パラメータは適宜、自分の環境に読み替えてください。
minikube start --memory=8192 --cpus=4 --kubernetes-version=v1.10.0 \ --extra-config=controller-manager.cluster-signing-cert-file=&#34;/var/lib/minikube/certs/ca.crt&#34; \ --extra-config=controller-manager.cluster-signing-key-file=&#34;/var/lib/minikube/certs/ca.key&#34; \ --vm-driver=virtualbox istio を稼働させる 下記のコマンドを用いてカレントディレクトリに istio のサンプル yaml が入ったフォルダを展開します。
curl -L https://git.io/getLatestIstio | sh - 次に下記のコマンドで kubernetes 上に istio をインストールします。 istio コンテナ間の通信をプレインテキスト or TLS で行うよう istio-demo.yml を apply しています。">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2019-04-24T22:55:45+09:00">
    <meta property="article:modified_time" content="2019-04-24T22:55:45+09:00">
      <meta property="og:image" content="https://jedipunkz.github.io/jedipunkz.jpg">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://jedipunkz.github.io/jedipunkz.jpg">
<meta name="twitter:title" content="Istio Sidecar Injection を理解する">
<meta name="twitter:description" content="こんにちは。@jedipunkz です。
前回の記事 「Istio, Helm を使って Getting Started 的なアプリをデプロイ」で kubernetes 上で istio をインストールし sidecar injection を有効化しサンプルアプリケーションを起動しました。その結果、sidecar 的に envoy コンテナが起動するところまで確認しました。今回はもう少し単純な pod を用いて &lsquo;sidecar injection&rsquo; の中身をもう少しだけ深掘りして見ていきたいと思います。
Rquirements
記事と同等の動きを確認するために下記のソフトウェアが必要になります。
それぞれのソフトウェアは事前にインストールされた前提で記事を記していきます。

macos or linux os
kubectl
istioctl
minikube

参考 URL
下記の istio 公式ドキュメントを参考に動作確認しました。

https://istio.io/docs/setup/kubernetes/additional-setup/sidecar-injection/
https://istio.io/docs/setup/kubernetes/additional-setup/sidecar-injection/

minikube で kubenetes をデプロイ
前回同様に minikube 上で動作を確認していきます。パラメータは適宜、自分の環境に読み替えてください。
minikube start --memory=8192 --cpus=4 --kubernetes-version=v1.10.0 \
  --extra-config=controller-manager.cluster-signing-cert-file=&#34;/var/lib/minikube/certs/ca.crt&#34; \
  --extra-config=controller-manager.cluster-signing-key-file=&#34;/var/lib/minikube/certs/ca.key&#34; \
  --vm-driver=virtualbox
istio を稼働させる
下記のコマンドを用いてカレントディレクトリに istio のサンプル yaml が入ったフォルダを展開します。
curl -L https://git.io/getLatestIstio | sh -
次に下記のコマンドで kubernetes 上に istio をインストールします。
istio コンテナ間の通信をプレインテキスト or TLS で行うよう istio-demo.yml を apply しています。">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://jedipunkz.github.io/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Istio Sidecar Injection を理解する",
      "item": "https://jedipunkz.github.io/post/istio-sidecar-injection/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Istio Sidecar Injection を理解する",
  "name": "Istio Sidecar Injection を理解する",
  "description": "こんにちは。@jedipunkz です。\n前回の記事 「Istio, Helm を使って Getting Started 的なアプリをデプロイ」で kubernetes 上で istio をインストールし sidecar injection を有効化しサンプルアプリケーションを起動しました。その結果、sidecar 的に envoy コンテナが起動するところまで確認しました。今回はもう少し単純な pod を用いて \u0026lsquo;sidecar injection\u0026rsquo; の中身をもう少しだけ深掘りして見ていきたいと思います。\nRquirements 記事と同等の動きを確認するために下記のソフトウェアが必要になります。 それぞれのソフトウェアは事前にインストールされた前提で記事を記していきます。\nmacos or linux os kubectl istioctl minikube 参考 URL 下記の istio 公式ドキュメントを参考に動作確認しました。\nhttps://istio.io/docs/setup/kubernetes/additional-setup/sidecar-injection/ https://istio.io/docs/setup/kubernetes/additional-setup/sidecar-injection/ minikube で kubenetes をデプロイ 前回同様に minikube 上で動作を確認していきます。パラメータは適宜、自分の環境に読み替えてください。\nminikube start --memory=8192 --cpus=4 --kubernetes-version=v1.10.0 \\ --extra-config=controller-manager.cluster-signing-cert-file=\u0026#34;/var/lib/minikube/certs/ca.crt\u0026#34; \\ --extra-config=controller-manager.cluster-signing-key-file=\u0026#34;/var/lib/minikube/certs/ca.key\u0026#34; \\ --vm-driver=virtualbox istio を稼働させる 下記のコマンドを用いてカレントディレクトリに istio のサンプル yaml が入ったフォルダを展開します。\ncurl -L https://git.io/getLatestIstio | sh - 次に下記のコマンドで kubernetes 上に istio をインストールします。 istio コンテナ間の通信をプレインテキスト or TLS で行うよう istio-demo.yml を apply しています。\n",
  "keywords": [
    
  ],
  "articleBody": "こんにちは。@jedipunkz です。\n前回の記事 「Istio, Helm を使って Getting Started 的なアプリをデプロイ」で kubernetes 上で istio をインストールし sidecar injection を有効化しサンプルアプリケーションを起動しました。その結果、sidecar 的に envoy コンテナが起動するところまで確認しました。今回はもう少し単純な pod を用いて ‘sidecar injection’ の中身をもう少しだけ深掘りして見ていきたいと思います。\nRquirements 記事と同等の動きを確認するために下記のソフトウェアが必要になります。 それぞれのソフトウェアは事前にインストールされた前提で記事を記していきます。\nmacos or linux os kubectl istioctl minikube 参考 URL 下記の istio 公式ドキュメントを参考に動作確認しました。\nhttps://istio.io/docs/setup/kubernetes/additional-setup/sidecar-injection/ https://istio.io/docs/setup/kubernetes/additional-setup/sidecar-injection/ minikube で kubenetes をデプロイ 前回同様に minikube 上で動作を確認していきます。パラメータは適宜、自分の環境に読み替えてください。\nminikube start --memory=8192 --cpus=4 --kubernetes-version=v1.10.0 \\ --extra-config=controller-manager.cluster-signing-cert-file=\"/var/lib/minikube/certs/ca.crt\" \\ --extra-config=controller-manager.cluster-signing-key-file=\"/var/lib/minikube/certs/ca.key\" \\ --vm-driver=virtualbox istio を稼働させる 下記のコマンドを用いてカレントディレクトリに istio のサンプル yaml が入ったフォルダを展開します。\ncurl -L https://git.io/getLatestIstio | sh - 次に下記のコマンドで kubernetes 上に istio をインストールします。 istio コンテナ間の通信をプレインテキスト or TLS で行うよう istio-demo.yml を apply しています。\ncd istio-1.1.3/ kubectl apply -f install/kubernetes/helm/istio-init/files/crd-10.yaml kubectl apply -f install/kubernetes/helm/istio-init/files/crd-11.yaml kubectl apply -f install/kubernetes/helm/istio-init/files/crd-certmanager-10.yaml kubectl apply -f install/kubernetes/helm/istio-init/files/crd-certmanager-11.yaml kubectl apply -f install/kubernetes/istio-demo.yaml 稼働状況を確認します。まず Service の状態です。\nkubectl get svc -n istio-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE grafana ClusterIP 10.98.111.63 3000/TCP 9s istio-citadel ClusterIP 10.97.197.128 8060/TCP,15014/TCP 8s istio-egressgateway ClusterIP 10.96.35.77 80/TCP,443/TCP,15443/TCP 9s istio-galley ClusterIP 10.100.143.114 443/TCP,15014/TCP,9901/TCP 9s istio-ingressgateway LoadBalancer 10.105.202.136 15020:30773/TCP,80:31380/TCP,443:31390/TCP,31400:31400/TCP,15029:31398/TCP,15030:32184/TCP,15031:31724/TCP,15032:30064/TCP,15443:30160/TCP 9s istio-pilot ClusterIP 10.102.53.62 15010/TCP,15011/TCP,8080/TCP,15014/TCP 8s istio-policy ClusterIP 10.105.107.53 9091/TCP,15004/TCP,15014/TCP 8s istio-sidecar-injector ClusterIP 10.104.82.138 443/TCP 8s istio-telemetry ClusterIP 10.97.117.166 9091/TCP,15004/TCP,15014/TCP,42422/TCP 8s jaeger-agent ClusterIP None 5775/UDP,6831/UDP,6832/UDP 7s jaeger-collector ClusterIP 10.107.35.224 14267/TCP,14268/TCP 7s jaeger-query ClusterIP 10.108.172.46 16686/TCP 7s kiali ClusterIP 10.107.129.129 20001/TCP 8s prometheus ClusterIP 10.109.114.141 9090/TCP 8s tracing ClusterIP 10.108.154.22 80/TCP 7s zipkin ClusterIP 10.96.151.43 9411/TCP 7s Pod の状態です。\nkubectl get pods -n istio-system NAME READY STATUS RESTARTS AGE grafana-688b8999cd-d4clx 1/1 Running 0 115m istio-citadel-5749f4b6dd-jd6qm 1/1 Running 0 115m istio-cleanup-secrets-1.1.3-mv8lq 0/1 Completed 0 115m istio-egressgateway-666b76dbf7-mjjx6 1/1 Running 0 115m istio-galley-d68bdc684-nwtzz 1/1 Running 0 115m istio-grafana-post-install-1.1.3-gkn4s 0/1 Completed 0 115m istio-ingressgateway-d67598f4-pwddm 1/1 Running 0 115m istio-pilot-865f6997cd-7jmq4 2/2 Running 0 115m istio-policy-56957d4666-vljk9 2/2 Running 5 115m istio-security-post-install-1.1.3-f894p 0/1 Completed 0 115m istio-sidecar-injector-5cf67ccc65-9p69k 1/1 Running 0 115m istio-telemetry-786796559d-dqwr2 2/2 Running 5 115m istio-tracing-5d8f57c8ff-xps9b 1/1 Running 0 115m kiali-95fcf457f-kfdhp 1/1 Running 0 115m prometheus-5554746896-ccs5x 1/1 Running 0 115m istio-injection な状態でサンプル pod コンテナ ‘sleep’ を起動 ここで sleep コマンドが起動するだけの pod コンテナを istio-injection=enabled な状態でデプロイします。まず先程ダウンロードしたディレクトリ上の sleep.yaml を見てみましょう。\ncat sample/sleep/sleep.yaml apiVersion: v1 kind: ServiceAccount metadata: name: sleep --- apiVersion: v1 kind: Service metadata: name: sleep labels: app: sleep spec: ports: - port: 80 name: http selector: app: sleep --- apiVersion: extensions/v1beta1 kind: Deployment metadata: name: sleep spec: replicas: 1 template: metadata: labels: app: sleep spec: serviceAccountName: sleep containers: - name: sleep image: pstauffer/curl command: [\"/bin/sleep\", \"3650d\"] imagePullPolicy: IfNotPresent --- この yaml ファイルを用いるのですが、istioctl コマンドのサブコマンド kube-inject を用いることでこの元となる yaml ファイルを istio-injection=enabled な状態の yaml ファイルに変換することが出来ます。よって kubectl コマンドで apply する手順は下記になります。\nkubectl apply -f \u003c(istioctl kube-inject -f samples/sleep/sleep.yaml) デプロイされた状態を確認し sidecar コンテナを知る デプロイされた Deployment を見てみましょう。\nkubectl get deployments sleep -o yaml apiVersion: extensions/v1beta1 kind: Deployment metadata: annotations: deployment.kubernetes.io/revision: \"1\" spec: containers: - command: - /bin/sleep - 3650d image: pstauffer/curl imagePullPolicy: IfNotPresent name: sleep image: docker.io/istio/proxyv2:1.1.3 imagePullPolicy: IfNotPresent name: istio-proxy ports: - containerPort: 15090 image: docker.io/istio/proxy_init:1.1.3 imagePullPolicy: IfNotPresent name: istio-init pstauffer/curl イメージ内で ‘/bin/sleep’ コマンドが起動しているコンテナと隣接して istio-proxy と istio-init というコンテナが起動していることが確認出来ると思います。それぞれの役割は下記のとおりです。\nistio-proxy : 他の istio からの通信をサービスコンテナに中継するためのコンテナ istio-init : istio-proxy コンテナを介す通信を iptables で制御するためのコンテナ これらが istio を用いることで起動した sidecar コンテナとなります。\n下記の通り pods を describe することでもこれらのコンテナが稼働していることが分かります。\nkubectl describe pod sleep-759d5cb4ff-btqvl Init Containers: istio-init: Container ID: docker://ded035851fa141997fdca47a0c317203cda650a0f9dce2f8d46ab264aa0e168b Image: docker.io/istio/proxy_init:1.1.3 Image ID: docker-pullable://istio/proxy_init@sha256:000d022d27c198faa6cc9b03d806482d08071e146423d6e9f81aa135499c4ed3 Port: Host Port: Containers: sleep: Container ID: docker://b6121c749a2eb394b81728063046eb0eb48ea1b48c464debe395e4b58768513c Image: pstauffer/curl Image ID: docker-pullable://pstauffer/curl@sha256:2663156457abb72d269eb19fe53c2d49e2e4a9fdcb9fa8f082d0282d82eb8e42 Port: Host Port: istio-proxy: Container ID: docker://0baee18b7d6ecec985b61fd10eff3409131245d390fad8f274d420f0807bc941 Image: docker.io/istio/proxyv2:1.1.3 Image ID: docker-pullable://istio/proxyv2@sha256:b682918f2f8fcca14b3a61bbd58f4118311eebc20799f24b72ceddc5cd749306 Port: 15090/TCP Host Port: 0/TCP sidecar のテンプレートとなる configmap を確認する 今回 istio-injection=enabled な状態で ‘sleep’ コンテナをデプロイし本体のコンテナとは別に sidecar なコンテナ2つが稼働することが確認できました。次に説明するのが configmap です。どの様な状態でどの様なコンテナを sidecar 的に稼働させるかのルールを記したものが istio-sidecar-injector という configmap になります。その configmap の内容を確認してみましょう。\nkubectl -n istio-system get configmap istio-sidecar-injector -o=jsonpath='{.data.config}' policy: enabled template: |- rewriteAppHTTPProbe: false initContainers: [[ if ne (annotation .ObjectMeta `sidecar.istio.io/interceptionMode` .ProxyConfig.InterceptionMode) \"NONE\" ]] - name: istio-init image: \"docker.io/istio/proxy_init:1.1.3\" args: - \"-p\" - [[ .MeshConfig.ProxyListenPort ]] - \"-u\" - 1337 - \"-m\" - [[ annotation .ObjectMeta `sidecar.istio.io/interceptionMode` .ProxyConfig.InterceptionMode ]] - \"-i\" - \"[[ annotation .ObjectMeta `traffic.sidecar.istio.io/includeOutboundIPRanges` \"*\" ]]\" - \"-x\" - \"[[ annotation .ObjectMeta `traffic.sidecar.istio.io/excludeOutboundIPRanges` \"\" ]]\" - \"-b\" - \"[[ annotation .ObjectMeta `traffic.sidecar.istio.io/includeInboundPorts` (includeInboundPorts .Spec.Containers) ]]\" - \"-d\" - \"[[ excludeInboundPort (annotation .ObjectMeta `status.sidecar.istio.io/port` 15020 ) (annotation .ObjectMeta `traffic.sidecar.istio.io/excludeInboundPorts` \"\" ) ]]\" [[ if (isset .ObjectMeta.Annotations `traffic.sidecar.istio.io/kubevirtInterfaces`) -]] - \"-k\" - \"[[ index .ObjectMeta.Annotations `traffic.sidecar.istio.io/kubevirtInterfaces` ]]\" [[ end -]] imagePullPolicy: IfNotPresent resources: requests: cpu: 10m memory: 10Mi limits: cpu: 100m memory: 50Mi securityContext: runAsUser: 0 runAsNonRoot: false capabilities: add: - NET_ADMIN restartPolicy: Always [[ end -]] containers: - name: istio-proxy image: [[ annotation .ObjectMeta `sidecar.istio.io/proxyImage` \"docker.io/istio/proxyv2:1.1.3\" ]] ports: - containerPort: 15090 protocol: TCP name: http-envoy-prom この configmap から下記のパラメータが記されていることが分かります。\nコンテナイメージ CPU 割当 メモリ割り当て 修正するために必要な権限 ポート指定 プロトコル etc.. pod の iptables を確認してトラヒックを理解する 次に minikube のホストにログインしサービス pod (今回は ‘sleep’) に割り当てられた iptables の内容を確認してみましょう。\nminikube ssh docker ps | grep sleep b6121c749a2e pstauffer/curl \"/bin/sleep 3650d\" 3 hours ago Up 3 hours k8s_sleep_sleep-759d5cb4ff-btqvl_default_6f3f6854-6651-11e9-970b-080027d5d6a7_0 この docker id `b6121c749a2e’ と nsenter コマンドを用いて pod (sleep) に適用されている iptables の内容を確認します。\ndocker inspect b6121c749a2e --format '{{ .State.Pid }}' 20066 sudo nsenter -t 20066 -n iptables -t nat -S -P PREROUTING ACCEPT -P INPUT ACCEPT -P OUTPUT ACCEPT -P POSTROUTING ACCEPT -N ISTIO_IN_REDIRECT -N ISTIO_OUTPUT -N ISTIO_REDIRECT -A OUTPUT -p tcp -j ISTIO_OUTPUT -A ISTIO_IN_REDIRECT -p tcp -j REDIRECT --to-ports 15001 -A ISTIO_OUTPUT ! -d 127.0.0.1/32 -o lo -j ISTIO_REDIRECT -A ISTIO_OUTPUT -m owner --uid-owner 1337 -j RETURN -A ISTIO_OUTPUT -m owner --gid-owner 1337 -j RETURN -A ISTIO_OUTPUT -d 127.0.0.1/32 -j RETURN -A ISTIO_OUTPUT -j ISTIO_REDIRECT -A ISTIO_REDIRECT -p tcp -j REDIRECT --to-ports 15001 結果から、この pod は INBOUND 通信のリダイレクト先ポートとして 15001 番ポートが指定されているのが分かります。このポートは istio-proxy が待ち受けているポートになります。また OUTBOUND 通信に関しても同様に 15001 番ポートにリダイレクトされているのが分かります。よって ‘sleep’ pod コンテナの全ての通信が istio-proxy を介すようになっています。また今回は単純に sleep するだけのコンテナを起動しましたが、http サーバ等を起動する pod を立ち上げた場合 -A ISTIO_INBOUND -p tcp -m tcp --dport 80 -j ISTIO_IN_REDIRECT といった制御も確認出来ると思います。\nまとめ kubernetes 上に istio をインストールすることで、テストで起動した pod コンテナに隣接する形で sidecar コンテナ istio-proxy, istio-init コンテナが起動することが確認出来ました。またそれらのコンテナを起動するテンプレートとなる configmap の内容を確認することができました。この configmap は修正することが可能な様です。そしてこの pod コンテナのインバウンド・アウトバウンドの通信は全て istio-proxy コンテナにリダイレクトされていることも分かりました。また今回は configmap の内容を確認するに留まりましたが、istio の機能としては routing, service discovery 等も有しているため、次回は routing あたりを調べようかと思っています。この routing を操作することで今回確認した iptables の内容も変わってくるのではないでしょうか。\n",
  "wordCount" : "929",
  "inLanguage": "en",
  "image": "https://jedipunkz.github.io/jedipunkz.jpg","datePublished": "2019-04-24T22:55:45+09:00",
  "dateModified": "2019-04-24T22:55:45+09:00",
  "author":{
    "@type": "Person",
    "name": "jedipunkz"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://jedipunkz.github.io/post/istio-sidecar-injection/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "jedipunkz 🚀 のブログ",
    "logo": {
      "@type": "ImageObject",
      "url": "https://jedipunkz.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://jedipunkz.github.io/" accesskey="h" title="jedipunkz 🚀 のブログ (Alt + H)">jedipunkz 🚀 のブログ</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://jedipunkz.github.io/about" title="About Me">
                    <span>About Me</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://jedipunkz.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://jedipunkz.github.io/post/">Posts</a></div>
    <h1 class="post-title">
      Istio Sidecar Injection を理解する
    </h1>
    
  </header> 
  <div class="post-content"><p>こんにちは。<a href="https://twitter.com/jedipunkz">@jedipunkz</a> です。</p>
<p>前回の記事 <a href="https://jedipunkz.github.io/blog/2018/12/31/istio/">「Istio, Helm を使って Getting Started 的なアプリをデプロイ」</a>で kubernetes 上で istio をインストールし sidecar injection を有効化しサンプルアプリケーションを起動しました。その結果、sidecar 的に envoy コンテナが起動するところまで確認しました。今回はもう少し単純な pod を用いて &lsquo;sidecar injection&rsquo; の中身をもう少しだけ深掘りして見ていきたいと思います。</p>
<h3 id="rquirements">Rquirements<a hidden class="anchor" aria-hidden="true" href="#rquirements">#</a></h3>
<p>記事と同等の動きを確認するために下記のソフトウェアが必要になります。
それぞれのソフトウェアは事前にインストールされた前提で記事を記していきます。</p>
<ul>
<li>macos or linux os</li>
<li>kubectl</li>
<li>istioctl</li>
<li>minikube</li>
</ul>
<h3 id="参考-url">参考 URL<a hidden class="anchor" aria-hidden="true" href="#参考-url">#</a></h3>
<p>下記の istio 公式ドキュメントを参考に動作確認しました。</p>
<ul>
<li><a href="https://istio.io/docs/setup/kubernetes/additional-setup/sidecar-injection/">https://istio.io/docs/setup/kubernetes/additional-setup/sidecar-injection/</a></li>
<li><a href="https://istio.io/docs/setup/kubernetes/additional-setup/sidecar-injection/">https://istio.io/docs/setup/kubernetes/additional-setup/sidecar-injection/</a></li>
</ul>
<h3 id="minikube-で-kubenetes-をデプロイ">minikube で kubenetes をデプロイ<a hidden class="anchor" aria-hidden="true" href="#minikube-で-kubenetes-をデプロイ">#</a></h3>
<p>前回同様に minikube 上で動作を確認していきます。パラメータは適宜、自分の環境に読み替えてください。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">minikube start --memory<span class="o">=</span><span class="m">8192</span> --cpus<span class="o">=</span><span class="m">4</span> --kubernetes-version<span class="o">=</span>v1.10.0 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --extra-config<span class="o">=</span>controller-manager.cluster-signing-cert-file<span class="o">=</span><span class="s2">&#34;/var/lib/minikube/certs/ca.crt&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --extra-config<span class="o">=</span>controller-manager.cluster-signing-key-file<span class="o">=</span><span class="s2">&#34;/var/lib/minikube/certs/ca.key&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --vm-driver<span class="o">=</span>virtualbox
</span></span></code></pre></div><h3 id="istio-を稼働させる">istio を稼働させる<a hidden class="anchor" aria-hidden="true" href="#istio-を稼働させる">#</a></h3>
<p>下記のコマンドを用いてカレントディレクトリに istio のサンプル yaml が入ったフォルダを展開します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -L https://git.io/getLatestIstio <span class="p">|</span> sh -
</span></span></code></pre></div><p>次に下記のコマンドで kubernetes 上に istio をインストールします。
istio コンテナ間の通信をプレインテキスト or TLS で行うよう istio-demo.yml を apply しています。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span> istio-1.1.3/
</span></span><span class="line"><span class="cl">kubectl apply -f install/kubernetes/helm/istio-init/files/crd-10.yaml
</span></span><span class="line"><span class="cl">kubectl apply -f install/kubernetes/helm/istio-init/files/crd-11.yaml
</span></span><span class="line"><span class="cl">kubectl apply -f install/kubernetes/helm/istio-init/files/crd-certmanager-10.yaml
</span></span><span class="line"><span class="cl">kubectl apply -f install/kubernetes/helm/istio-init/files/crd-certmanager-11.yaml
</span></span><span class="line"><span class="cl">kubectl apply -f install/kubernetes/istio-demo.yaml
</span></span></code></pre></div><p>稼働状況を確認します。まず Service の状態です。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl get svc -n istio-system
</span></span><span class="line"><span class="cl">NAME                     TYPE           CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>                                                                                                                                      AGE
</span></span><span class="line"><span class="cl">grafana                  ClusterIP      10.98.111.63     &lt;none&gt;        3000/TCP                                                                                                                                     9s
</span></span><span class="line"><span class="cl">istio-citadel            ClusterIP      10.97.197.128    &lt;none&gt;        8060/TCP,15014/TCP                                                                                                                           8s
</span></span><span class="line"><span class="cl">istio-egressgateway      ClusterIP      10.96.35.77      &lt;none&gt;        80/TCP,443/TCP,15443/TCP                                                                                                                     9s
</span></span><span class="line"><span class="cl">istio-galley             ClusterIP      10.100.143.114   &lt;none&gt;        443/TCP,15014/TCP,9901/TCP                                                                                                                   9s
</span></span><span class="line"><span class="cl">istio-ingressgateway     LoadBalancer   10.105.202.136   &lt;pending&gt;     15020:30773/TCP,80:31380/TCP,443:31390/TCP,31400:31400/TCP,15029:31398/TCP,15030:32184/TCP,15031:31724/TCP,15032:30064/TCP,15443:30160/TCP   9s
</span></span><span class="line"><span class="cl">istio-pilot              ClusterIP      10.102.53.62     &lt;none&gt;        15010/TCP,15011/TCP,8080/TCP,15014/TCP                                                                                                       8s
</span></span><span class="line"><span class="cl">istio-policy             ClusterIP      10.105.107.53    &lt;none&gt;        9091/TCP,15004/TCP,15014/TCP                                                                                                                 8s
</span></span><span class="line"><span class="cl">istio-sidecar-injector   ClusterIP      10.104.82.138    &lt;none&gt;        443/TCP                                                                                                                                      8s
</span></span><span class="line"><span class="cl">istio-telemetry          ClusterIP      10.97.117.166    &lt;none&gt;        9091/TCP,15004/TCP,15014/TCP,42422/TCP                                                                                                       8s
</span></span><span class="line"><span class="cl">jaeger-agent             ClusterIP      None             &lt;none&gt;        5775/UDP,6831/UDP,6832/UDP                                                                                                                   7s
</span></span><span class="line"><span class="cl">jaeger-collector         ClusterIP      10.107.35.224    &lt;none&gt;        14267/TCP,14268/TCP                                                                                                                          7s
</span></span><span class="line"><span class="cl">jaeger-query             ClusterIP      10.108.172.46    &lt;none&gt;        16686/TCP                                                                                                                                    7s
</span></span><span class="line"><span class="cl">kiali                    ClusterIP      10.107.129.129   &lt;none&gt;        20001/TCP                                                                                                                                    8s
</span></span><span class="line"><span class="cl">prometheus               ClusterIP      10.109.114.141   &lt;none&gt;        9090/TCP                                                                                                                                     8s
</span></span><span class="line"><span class="cl">tracing                  ClusterIP      10.108.154.22    &lt;none&gt;        80/TCP                                                                                                                                       7s
</span></span><span class="line"><span class="cl">zipkin                   ClusterIP      10.96.151.43     &lt;none&gt;        9411/TCP                                                                                                                                     7s
</span></span></code></pre></div><p>Pod の状態です。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl get pods -n istio-system
</span></span><span class="line"><span class="cl">NAME                                      READY   STATUS      RESTARTS   AGE
</span></span><span class="line"><span class="cl">grafana-688b8999cd-d4clx                  1/1     Running     <span class="m">0</span>          115m
</span></span><span class="line"><span class="cl">istio-citadel-5749f4b6dd-jd6qm            1/1     Running     <span class="m">0</span>          115m
</span></span><span class="line"><span class="cl">istio-cleanup-secrets-1.1.3-mv8lq         0/1     Completed   <span class="m">0</span>          115m
</span></span><span class="line"><span class="cl">istio-egressgateway-666b76dbf7-mjjx6      1/1     Running     <span class="m">0</span>          115m
</span></span><span class="line"><span class="cl">istio-galley-d68bdc684-nwtzz              1/1     Running     <span class="m">0</span>          115m
</span></span><span class="line"><span class="cl">istio-grafana-post-install-1.1.3-gkn4s    0/1     Completed   <span class="m">0</span>          115m
</span></span><span class="line"><span class="cl">istio-ingressgateway-d67598f4-pwddm       1/1     Running     <span class="m">0</span>          115m
</span></span><span class="line"><span class="cl">istio-pilot-865f6997cd-7jmq4              2/2     Running     <span class="m">0</span>          115m
</span></span><span class="line"><span class="cl">istio-policy-56957d4666-vljk9             2/2     Running     <span class="m">5</span>          115m
</span></span><span class="line"><span class="cl">istio-security-post-install-1.1.3-f894p   0/1     Completed   <span class="m">0</span>          115m
</span></span><span class="line"><span class="cl">istio-sidecar-injector-5cf67ccc65-9p69k   1/1     Running     <span class="m">0</span>          115m
</span></span><span class="line"><span class="cl">istio-telemetry-786796559d-dqwr2          2/2     Running     <span class="m">5</span>          115m
</span></span><span class="line"><span class="cl">istio-tracing-5d8f57c8ff-xps9b            1/1     Running     <span class="m">0</span>          115m
</span></span><span class="line"><span class="cl">kiali-95fcf457f-kfdhp                     1/1     Running     <span class="m">0</span>          115m
</span></span><span class="line"><span class="cl">prometheus-5554746896-ccs5x               1/1     Running     <span class="m">0</span>          115m
</span></span></code></pre></div><h3 id="istio-injection-な状態でサンプル-pod-コンテナ-sleep-を起動">istio-injection な状態でサンプル pod コンテナ &lsquo;sleep&rsquo; を起動<a hidden class="anchor" aria-hidden="true" href="#istio-injection-な状態でサンプル-pod-コンテナ-sleep-を起動">#</a></h3>
<p>ここで sleep コマンドが起動するだけの pod コンテナを istio-injection=enabled な状態でデプロイします。まず先程ダウンロードしたディレクトリ上の sleep.yaml を見てみましょう。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat sample/sleep/sleep.yaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: ServiceAccount
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: sleep
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">kind: Service
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: sleep
</span></span><span class="line"><span class="cl">  labels:
</span></span><span class="line"><span class="cl">    app: sleep
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  ports:
</span></span><span class="line"><span class="cl">  - port: <span class="m">80</span>
</span></span><span class="line"><span class="cl">    name: http
</span></span><span class="line"><span class="cl">  selector:
</span></span><span class="line"><span class="cl">    app: sleep
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">apiVersion: extensions/v1beta1
</span></span><span class="line"><span class="cl">kind: Deployment
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  name: sleep
</span></span><span class="line"><span class="cl">spec:
</span></span><span class="line"><span class="cl">  replicas: <span class="m">1</span>
</span></span><span class="line"><span class="cl">  template:
</span></span><span class="line"><span class="cl">    metadata:
</span></span><span class="line"><span class="cl">      labels:
</span></span><span class="line"><span class="cl">        app: sleep
</span></span><span class="line"><span class="cl">    spec:
</span></span><span class="line"><span class="cl">      serviceAccountName: sleep
</span></span><span class="line"><span class="cl">      containers:
</span></span><span class="line"><span class="cl">      - name: sleep
</span></span><span class="line"><span class="cl">        image: pstauffer/curl
</span></span><span class="line"><span class="cl">        command: <span class="o">[</span><span class="s2">&#34;/bin/sleep&#34;</span>, <span class="s2">&#34;3650d&#34;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">        imagePullPolicy: IfNotPresent
</span></span><span class="line"><span class="cl">---
</span></span></code></pre></div><p>この yaml ファイルを用いるのですが、istioctl コマンドのサブコマンド <code>kube-inject</code> を用いることでこの元となる yaml ファイルを istio-injection=enabled な状態の yaml ファイルに変換することが出来ます。よって kubectl コマンドで apply する手順は下記になります。</p>
<pre tabindex="0"><code>kubectl apply -f &lt;(istioctl kube-inject -f samples/sleep/sleep.yaml)
</code></pre><h3 id="デプロイされた状態を確認し-sidecar-コンテナを知る">デプロイされた状態を確認し sidecar コンテナを知る<a hidden class="anchor" aria-hidden="true" href="#デプロイされた状態を確認し-sidecar-コンテナを知る">#</a></h3>
<p>デプロイされた Deployment を見てみましょう。</p>
<pre tabindex="0"><code>kubectl get deployments sleep -o yaml
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  annotations:
    deployment.kubernetes.io/revision: &#34;1&#34;
&lt;snip&gt;
    spec:
      containers:
      - command:
        - /bin/sleep
        - 3650d
        image: pstauffer/curl
        imagePullPolicy: IfNotPresent
        name: sleep
&lt;snip&gt;
        image: docker.io/istio/proxyv2:1.1.3
        imagePullPolicy: IfNotPresent
        name: istio-proxy
        ports:
        - containerPort: 15090
&lt;snip&gt;
        image: docker.io/istio/proxy_init:1.1.3
        imagePullPolicy: IfNotPresent
        name: istio-init
&lt;snip&gt;
</code></pre><p><code>pstauffer/curl</code> イメージ内で &lsquo;/bin/sleep&rsquo; コマンドが起動しているコンテナと隣接して <code>istio-proxy</code> と <code>istio-init</code> というコンテナが起動していることが確認出来ると思います。それぞれの役割は下記のとおりです。</p>
<ul>
<li>istio-proxy : 他の istio からの通信をサービスコンテナに中継するためのコンテナ</li>
<li>istio-init : istio-proxy コンテナを介す通信を iptables で制御するためのコンテナ</li>
</ul>
<p>これらが istio を用いることで起動した sidecar コンテナとなります。</p>
<p>下記の通り pods を describe することでもこれらのコンテナが稼働していることが分かります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl describe pod sleep-759d5cb4ff-btqvl
</span></span><span class="line"><span class="cl">&lt;snip&gt;
</span></span><span class="line"><span class="cl">Init Containers:
</span></span><span class="line"><span class="cl">  istio-init:
</span></span><span class="line"><span class="cl">    Container ID:  docker://ded035851fa141997fdca47a0c317203cda650a0f9dce2f8d46ab264aa0e168b
</span></span><span class="line"><span class="cl">    Image:         docker.io/istio/proxy_init:1.1.3
</span></span><span class="line"><span class="cl">    Image ID:      docker-pullable://istio/proxy_init@sha256:000d022d27c198faa6cc9b03d806482d08071e146423d6e9f81aa135499c4ed3
</span></span><span class="line"><span class="cl">    Port:          &lt;none&gt;
</span></span><span class="line"><span class="cl">    Host Port:     &lt;none&gt;
</span></span><span class="line"><span class="cl">&lt;snip&gt;
</span></span><span class="line"><span class="cl">Containers:
</span></span><span class="line"><span class="cl">  sleep:
</span></span><span class="line"><span class="cl">    Container ID:  docker://b6121c749a2eb394b81728063046eb0eb48ea1b48c464debe395e4b58768513c
</span></span><span class="line"><span class="cl">    Image:         pstauffer/curl
</span></span><span class="line"><span class="cl">    Image ID:      docker-pullable://pstauffer/curl@sha256:2663156457abb72d269eb19fe53c2d49e2e4a9fdcb9fa8f082d0282d82eb8e42
</span></span><span class="line"><span class="cl">    Port:          &lt;none&gt;
</span></span><span class="line"><span class="cl">    Host Port:     &lt;none&gt;
</span></span><span class="line"><span class="cl">&lt;snip&gt;
</span></span><span class="line"><span class="cl">  istio-proxy:
</span></span><span class="line"><span class="cl">    Container ID:  docker://0baee18b7d6ecec985b61fd10eff3409131245d390fad8f274d420f0807bc941
</span></span><span class="line"><span class="cl">    Image:         docker.io/istio/proxyv2:1.1.3
</span></span><span class="line"><span class="cl">    Image ID:      docker-pullable://istio/proxyv2@sha256:b682918f2f8fcca14b3a61bbd58f4118311eebc20799f24b72ceddc5cd749306
</span></span><span class="line"><span class="cl">    Port:          15090/TCP
</span></span><span class="line"><span class="cl">    Host Port:     0/TCP
</span></span></code></pre></div><h3 id="sidecar-のテンプレートとなる-configmap-を確認する">sidecar のテンプレートとなる configmap を確認する<a hidden class="anchor" aria-hidden="true" href="#sidecar-のテンプレートとなる-configmap-を確認する">#</a></h3>
<p>今回 istio-injection=enabled な状態で &lsquo;sleep&rsquo; コンテナをデプロイし本体のコンテナとは別に sidecar なコンテナ2つが稼働することが確認できました。次に説明するのが configmap です。どの様な状態でどの様なコンテナを sidecar 的に稼働させるかのルールを記したものが <code>istio-sidecar-injector</code> という configmap になります。その configmap の内容を確認してみましょう。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl -n istio-system get configmap istio-sidecar-injector -o<span class="o">=</span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.data.config}&#39;</span>
</span></span><span class="line"><span class="cl">policy: enabled
</span></span><span class="line"><span class="cl">template: <span class="p">|</span>-
</span></span><span class="line"><span class="cl">  rewriteAppHTTPProbe: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">  initContainers:
</span></span><span class="line"><span class="cl">  <span class="o">[[</span> <span class="k">if</span> ne <span class="o">(</span>annotation .ObjectMeta <span class="sb">`</span>sidecar.istio.io/interceptionMode<span class="sb">`</span> .ProxyConfig.InterceptionMode<span class="o">)</span> <span class="s2">&#34;NONE&#34;</span> <span class="o">]]</span>
</span></span><span class="line"><span class="cl">  - name: istio-init
</span></span><span class="line"><span class="cl">    image: <span class="s2">&#34;docker.io/istio/proxy_init:1.1.3&#34;</span>
</span></span><span class="line"><span class="cl">    args:
</span></span><span class="line"><span class="cl">    - <span class="s2">&#34;-p&#34;</span>
</span></span><span class="line"><span class="cl">    - <span class="o">[[</span> .MeshConfig.ProxyListenPort <span class="o">]]</span>
</span></span><span class="line"><span class="cl">    - <span class="s2">&#34;-u&#34;</span>
</span></span><span class="line"><span class="cl">    - <span class="m">1337</span>
</span></span><span class="line"><span class="cl">    - <span class="s2">&#34;-m&#34;</span>
</span></span><span class="line"><span class="cl">    - <span class="o">[[</span> annotation .ObjectMeta <span class="sb">`</span>sidecar.istio.io/interceptionMode<span class="sb">`</span> .ProxyConfig.InterceptionMode <span class="o">]]</span>
</span></span><span class="line"><span class="cl">    - <span class="s2">&#34;-i&#34;</span>
</span></span><span class="line"><span class="cl">    - <span class="s2">&#34;[[ annotation .ObjectMeta `traffic.sidecar.istio.io/includeOutboundIPRanges`  &#34;</span>*<span class="s2">&#34;  ]]&#34;</span>
</span></span><span class="line"><span class="cl">    - <span class="s2">&#34;-x&#34;</span>
</span></span><span class="line"><span class="cl">    - <span class="s2">&#34;[[ annotation .ObjectMeta `traffic.sidecar.istio.io/excludeOutboundIPRanges`  &#34;&#34;  ]]&#34;</span>
</span></span><span class="line"><span class="cl">    - <span class="s2">&#34;-b&#34;</span>
</span></span><span class="line"><span class="cl">    - <span class="s2">&#34;[[ annotation .ObjectMeta `traffic.sidecar.istio.io/includeInboundPorts` (includeInboundPorts .Spec.Containers) ]]&#34;</span>
</span></span><span class="line"><span class="cl">    - <span class="s2">&#34;-d&#34;</span>
</span></span><span class="line"><span class="cl">    - <span class="s2">&#34;[[ excludeInboundPort (annotation .ObjectMeta `status.sidecar.istio.io/port`  15020 ) (annotation .ObjectMeta `traffic.sidecar.istio.io/excludeInboundPorts`  &#34;&#34; ) ]]&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">[[</span> <span class="k">if</span> <span class="o">(</span>isset .ObjectMeta.Annotations <span class="sb">`</span>traffic.sidecar.istio.io/kubevirtInterfaces<span class="sb">`</span><span class="o">)</span> -<span class="o">]]</span>
</span></span><span class="line"><span class="cl">    - <span class="s2">&#34;-k&#34;</span>
</span></span><span class="line"><span class="cl">    - <span class="s2">&#34;[[ index .ObjectMeta.Annotations `traffic.sidecar.istio.io/kubevirtInterfaces` ]]&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="o">[[</span> end -<span class="o">]]</span>
</span></span><span class="line"><span class="cl">    imagePullPolicy: IfNotPresent
</span></span><span class="line"><span class="cl">    resources:
</span></span><span class="line"><span class="cl">      requests:
</span></span><span class="line"><span class="cl">        cpu: 10m
</span></span><span class="line"><span class="cl">        memory: 10Mi
</span></span><span class="line"><span class="cl">      limits:
</span></span><span class="line"><span class="cl">        cpu: 100m
</span></span><span class="line"><span class="cl">        memory: 50Mi
</span></span><span class="line"><span class="cl">    securityContext:
</span></span><span class="line"><span class="cl">      runAsUser: <span class="m">0</span>
</span></span><span class="line"><span class="cl">      runAsNonRoot: <span class="nb">false</span>
</span></span><span class="line"><span class="cl">      capabilities:
</span></span><span class="line"><span class="cl">        add:
</span></span><span class="line"><span class="cl">        - NET_ADMIN
</span></span><span class="line"><span class="cl">    restartPolicy: Always
</span></span><span class="line"><span class="cl">  <span class="o">[[</span> end -<span class="o">]]</span>
</span></span><span class="line"><span class="cl">  containers:
</span></span><span class="line"><span class="cl">  - name: istio-proxy
</span></span><span class="line"><span class="cl">    image: <span class="o">[[</span> annotation .ObjectMeta <span class="sb">`</span>sidecar.istio.io/proxyImage<span class="sb">`</span>  <span class="s2">&#34;docker.io/istio/proxyv2:1.1.3&#34;</span>  <span class="o">]]</span>
</span></span><span class="line"><span class="cl">    ports:
</span></span><span class="line"><span class="cl">    - containerPort: <span class="m">15090</span>
</span></span><span class="line"><span class="cl">      protocol: TCP
</span></span><span class="line"><span class="cl">      name: http-envoy-prom
</span></span><span class="line"><span class="cl">    &lt;snip&gt;
</span></span></code></pre></div><p>この configmap から下記のパラメータが記されていることが分かります。</p>
<ul>
<li>コンテナイメージ</li>
<li>CPU 割当</li>
<li>メモリ割り当て</li>
<li>修正するために必要な権限</li>
<li>ポート指定</li>
<li>プロトコル</li>
<li>etc..</li>
</ul>
<h3 id="pod-の-iptables-を確認してトラヒックを理解する">pod の iptables を確認してトラヒックを理解する<a hidden class="anchor" aria-hidden="true" href="#pod-の-iptables-を確認してトラヒックを理解する">#</a></h3>
<p>次に minikube のホストにログインしサービス pod (今回は &lsquo;sleep&rsquo;) に割り当てられた iptables の内容を確認してみましょう。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">minikube ssh
</span></span><span class="line"><span class="cl">docker ps <span class="p">|</span> grep sleep
</span></span><span class="line"><span class="cl">b6121c749a2e        pstauffer/curl             <span class="s2">&#34;/bin/sleep 3650d&#34;</span>       <span class="m">3</span> hours ago         Up <span class="m">3</span> hours                              k8s_sleep_sleep-759d5cb4ff-btqvl_default_6f3f6854-6651-11e9-970b-080027d5d6a7_0
</span></span></code></pre></div><p>この docker id `b6121c749a2e&rsquo; と nsenter コマンドを用いて pod (sleep) に適用されている iptables の内容を確認します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">docker inspect b6121c749a2e --format <span class="s1">&#39;{{ .State.Pid }}&#39;</span>
</span></span><span class="line"><span class="cl"><span class="m">20066</span>
</span></span></code></pre></div><pre tabindex="0"><code>sudo nsenter -t 20066 -n iptables -t nat -S
-P PREROUTING ACCEPT
-P INPUT ACCEPT
-P OUTPUT ACCEPT
-P POSTROUTING ACCEPT
-N ISTIO_IN_REDIRECT
-N ISTIO_OUTPUT
-N ISTIO_REDIRECT
-A OUTPUT -p tcp -j ISTIO_OUTPUT
-A ISTIO_IN_REDIRECT -p tcp -j REDIRECT --to-ports 15001
-A ISTIO_OUTPUT ! -d 127.0.0.1/32 -o lo -j ISTIO_REDIRECT
-A ISTIO_OUTPUT -m owner --uid-owner 1337 -j RETURN
-A ISTIO_OUTPUT -m owner --gid-owner 1337 -j RETURN
-A ISTIO_OUTPUT -d 127.0.0.1/32 -j RETURN
-A ISTIO_OUTPUT -j ISTIO_REDIRECT
-A ISTIO_REDIRECT -p tcp -j REDIRECT --to-ports 15001
</code></pre><p>結果から、この pod は INBOUND 通信のリダイレクト先ポートとして 15001 番ポートが指定されているのが分かります。このポートは istio-proxy が待ち受けているポートになります。また OUTBOUND 通信に関しても同様に 15001 番ポートにリダイレクトされているのが分かります。よって &lsquo;sleep&rsquo; pod コンテナの全ての通信が istio-proxy を介すようになっています。また今回は単純に sleep するだけのコンテナを起動しましたが、http サーバ等を起動する pod を立ち上げた場合 <code>-A ISTIO_INBOUND -p tcp -m tcp --dport 80 -j ISTIO_IN_REDIRECT</code> といった制御も確認出来ると思います。</p>
<h3 id="まとめ">まとめ<a hidden class="anchor" aria-hidden="true" href="#まとめ">#</a></h3>
<p>kubernetes 上に istio をインストールすることで、テストで起動した pod コンテナに隣接する形で sidecar コンテナ istio-proxy, istio-init コンテナが起動することが確認出来ました。またそれらのコンテナを起動するテンプレートとなる configmap の内容を確認することができました。この configmap は修正することが可能な様です。そしてこの pod コンテナのインバウンド・アウトバウンドの通信は全て istio-proxy コンテナにリダイレクトされていることも分かりました。また今回は configmap の内容を確認するに留まりましたが、istio の機能としては routing, service discovery 等も有しているため、次回は routing あたりを調べようかと思っています。この routing を操作することで今回確認した iptables の内容も変わってくるのではないでしょうか。</p>


  </div>

  <footer class="post-footer">
<nav class="paginav">
  <a class="prev" href="https://jedipunkz.github.io/post/consul-helm-chart/">
    <span class="title">« Prev</span>
    <br>
    <span>Consul Helm Chart で Kubernetes 上に Consul をデプロイ</span>
  </a>
  <a class="next" href="https://jedipunkz.github.io/post/2018/12/31/istio/">
    <span class="title">Next »</span>
    <br>
    <span>Istio, Helm を使って Getting Started 的なアプリをデプロイ</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Istio Sidecar Injection を理解する on x"
            href="https://x.com/intent/tweet/?text=Istio%20Sidecar%20Injection%20%e3%82%92%e7%90%86%e8%a7%a3%e3%81%99%e3%82%8b&amp;url=https%3a%2f%2fjedipunkz.github.io%2fpost%2fistio-sidecar-injection%2f&amp;hashtags=">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Istio Sidecar Injection を理解する on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fjedipunkz.github.io%2fpost%2fistio-sidecar-injection%2f&amp;title=Istio%20Sidecar%20Injection%20%e3%82%92%e7%90%86%e8%a7%a3%e3%81%99%e3%82%8b&amp;summary=Istio%20Sidecar%20Injection%20%e3%82%92%e7%90%86%e8%a7%a3%e3%81%99%e3%82%8b&amp;source=https%3a%2f%2fjedipunkz.github.io%2fpost%2fistio-sidecar-injection%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Istio Sidecar Injection を理解する on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2fjedipunkz.github.io%2fpost%2fistio-sidecar-injection%2f&title=Istio%20Sidecar%20Injection%20%e3%82%92%e7%90%86%e8%a7%a3%e3%81%99%e3%82%8b">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Istio Sidecar Injection を理解する on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fjedipunkz.github.io%2fpost%2fistio-sidecar-injection%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Istio Sidecar Injection を理解する on whatsapp"
            href="https://api.whatsapp.com/send?text=Istio%20Sidecar%20Injection%20%e3%82%92%e7%90%86%e8%a7%a3%e3%81%99%e3%82%8b%20-%20https%3a%2f%2fjedipunkz.github.io%2fpost%2fistio-sidecar-injection%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Istio Sidecar Injection を理解する on telegram"
            href="https://telegram.me/share/url?text=Istio%20Sidecar%20Injection%20%e3%82%92%e7%90%86%e8%a7%a3%e3%81%99%e3%82%8b&amp;url=https%3a%2f%2fjedipunkz.github.io%2fpost%2fistio-sidecar-injection%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Istio Sidecar Injection を理解する on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Istio%20Sidecar%20Injection%20%e3%82%92%e7%90%86%e8%a7%a3%e3%81%99%e3%82%8b&u=https%3a%2f%2fjedipunkz.github.io%2fpost%2fistio-sidecar-injection%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://jedipunkz.github.io/">jedipunkz 🚀 のブログ</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
