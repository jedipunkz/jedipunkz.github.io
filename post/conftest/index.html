<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Conftest OPA ã§ Terraform ã‚³ãƒ¼ãƒ‰é–‹ç™ºã«åˆ¶ç´„ã‚’è¨­ã‘ã‚‹ | jedipunkz ğŸš€ ã®ãƒ–ãƒ­ã‚°</title>
<meta name="keywords" content="">
<meta name="description" content="Conftest ã¨ Terraform ã‚’ä½¿ã„åŸºæœ¬çš„ãªæ§‹æ–‡ã‚’ç†è§£ã—ã¤ã¤å®Ÿéš›ã« Rego ãƒãƒªã‚·ã‚’æ›¸ã„ã¦å‹•ä½œã•ã›ã¦ã¿ãŸè¨˜äº‹ã§ã™">
<meta name="author" content="jedipunkz">
<link rel="canonical" href="https://jedipunkz.github.io/post/conftest/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.7870d8f9fce407bbb2d51fa13ef155db43e9604862bc816e63896929025b4170.css" integrity="sha256-eHDY&#43;fzkB7uy1R&#43;hPvFV20PpYEhivIFuY4lpKQJbQXA=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://jedipunkz.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://jedipunkz.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://jedipunkz.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://jedipunkz.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://jedipunkz.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://jedipunkz.github.io/post/conftest/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><link rel="stylesheet" href="/css/custom.css">
<link rel="stylesheet" href="/css/syntax.css">
<style>
 
.post-content code,
.post-content pre code,
.post-content .highlight code,
.post-content .highlighttable code {
    font-size: 1em !important;
}

 
.post-content p code,
.post-content li code,
.post-content td code {
    font-size: 1em !important;
}
</style><script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "\"Conftest OPA ã§ Terraform ã‚³ãƒ¼ãƒ‰é–‹ç™ºã«åˆ¶ç´„ã‚’è¨­ã‘ã‚‹\"",
  "description": "\"Conftest ã¨ Terraform ã‚’ä½¿ã„åŸºæœ¬çš„ãªæ§‹æ–‡ã‚’ç†è§£ã—ã¤ã¤å®Ÿéš›ã« Rego ãƒãƒªã‚·ã‚’æ›¸ã„ã¦å‹•ä½œã•ã›ã¦ã¿ãŸè¨˜äº‹ã§ã™\"",
  "datePublished": "2025-12-07T10:42:32\u002b09:00",
  "dateModified": "2025-12-07T10:42:32\u002b09:00",
  "author": {
    "@type": "Person",
    "name": "\"jedipunkz\""
  },
  "publisher": {
    "@type": "Person",
    "name": "\"jedipunkz\"",
    "logo": {
      "@type": "ImageObject",
      "url": "https:\/\/jedipunkz.github.io\/jedipunkz.jpg"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https:\/\/jedipunkz.github.io\/post\/conftest\/"
  }
}
</script>
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-2H91XCYVZ8"></script>
      <script>
        var doNotTrack = false;
        if ( true ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-2H91XCYVZ8');
        }
      </script><meta property="og:url" content="https://jedipunkz.github.io/post/conftest/">
  <meta property="og:site_name" content="jedipunkz ğŸš€ ã®ãƒ–ãƒ­ã‚°">
  <meta property="og:title" content="Conftest OPA ã§ Terraform ã‚³ãƒ¼ãƒ‰é–‹ç™ºã«åˆ¶ç´„ã‚’è¨­ã‘ã‚‹">
  <meta property="og:description" content="Conftest ã¨ Terraform ã‚’ä½¿ã„åŸºæœ¬çš„ãªæ§‹æ–‡ã‚’ç†è§£ã—ã¤ã¤å®Ÿéš›ã« Rego ãƒãƒªã‚·ã‚’æ›¸ã„ã¦å‹•ä½œã•ã›ã¦ã¿ãŸè¨˜äº‹ã§ã™">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2025-12-07T10:42:32+09:00">
    <meta property="article:modified_time" content="2025-12-07T10:42:32+09:00">
      <meta property="og:image" content="https://jedipunkz.github.io/jedipunkz.jpg">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://jedipunkz.github.io/jedipunkz.jpg">
<meta name="twitter:title" content="Conftest OPA ã§ Terraform ã‚³ãƒ¼ãƒ‰é–‹ç™ºã«åˆ¶ç´„ã‚’è¨­ã‘ã‚‹">
<meta name="twitter:description" content="Conftest ã¨ Terraform ã‚’ä½¿ã„åŸºæœ¬çš„ãªæ§‹æ–‡ã‚’ç†è§£ã—ã¤ã¤å®Ÿéš›ã« Rego ãƒãƒªã‚·ã‚’æ›¸ã„ã¦å‹•ä½œã•ã›ã¦ã¿ãŸè¨˜äº‹ã§ã™">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://jedipunkz.github.io/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Conftest OPA ã§ Terraform ã‚³ãƒ¼ãƒ‰é–‹ç™ºã«åˆ¶ç´„ã‚’è¨­ã‘ã‚‹",
      "item": "https://jedipunkz.github.io/post/conftest/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Conftest OPA ã§ Terraform ã‚³ãƒ¼ãƒ‰é–‹ç™ºã«åˆ¶ç´„ã‚’è¨­ã‘ã‚‹",
  "name": "Conftest OPA ã§ Terraform ã‚³ãƒ¼ãƒ‰é–‹ç™ºã«åˆ¶ç´„ã‚’è¨­ã‘ã‚‹",
  "description": "Conftest ã¨ Terraform ã‚’ä½¿ã„åŸºæœ¬çš„ãªæ§‹æ–‡ã‚’ç†è§£ã—ã¤ã¤å®Ÿéš›ã« Rego ãƒãƒªã‚·ã‚’æ›¸ã„ã¦å‹•ä½œã•ã›ã¦ã¿ãŸè¨˜äº‹ã§ã™",
  "keywords": [
    
  ],
  "articleBody": "ã“ã‚“ã«ã¡ã¯ã€‚jedipunkzğŸš€ ã§ã™ã€‚\nConftest ã¨ Open Policy Agent (OPA) ã‚’ä½¿ã£ãŸ Terraform ã®ãƒãƒªã‚·ãƒ¼æ¤œè¨¼ã‚’è¡Œã£ãŸã®ã§ãã‚Œã‚’è¨˜äº‹ã«ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚ãƒãƒªã‚·ã‚’æ›¸ãã“ã¨ã§ Terraform ã‚³ãƒ¼ãƒ‰ã«åˆ¶ç´„ã‚’åŠ ãˆã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶(ä¾‹ãˆã°æš—å·åŒ–è¦ä»¶ã‚„ãƒãƒ¼ãƒˆé–‹æ”¾è¦ä»¶ç­‰) ã‚’æº€ãŸã—ãŸã‚Šãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«ãã£ãŸã‚¤ãƒ³ãƒ•ãƒ©ã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚æ¯å›ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§äººã«ãƒã‚§ãƒƒã‚¯ã•ã›ã‚‹ã‚ˆã‚Šã‚‚ç¢ºå®Ÿã«åˆ¶ç´„ã‚’å®ˆã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ã®ã§ãŠã™ã™ã‚ã§ã™ã€‚\nã“ã®è¨˜äº‹ã§ã¯ã€Conftest ã¨ OPA ã‚’ä½¿ã£ã¦ã€Terraform ã‚³ãƒ¼ãƒ‰ã«è‡ªå‹•çš„ã«ãƒãƒªã‚·ãƒ¼ãƒã‚§ãƒƒã‚¯ã‚’é©ç”¨ã™ã‚‹æ–¹æ³•ã‚’ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å½¢å¼ã§è§£èª¬ã—ã¾ã™ã€‚\n1. Conftest æ¦‚è¦ã¨åŸºæœ¬ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ« 1.1 Conftest ã¨ã¯ï¼Ÿ Conftest ã¯ã€æ§‹é€ åŒ–ã•ã‚ŒãŸè¨­å®šãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦ãƒãƒªã‚·ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚Open Policy Agent (OPA) ã® Rego è¨€èªã‚’ä½¿ç”¨ã—ã¦ãƒãƒªã‚·ãƒ¼ã‚’è¨˜è¿°ã—ã€ã•ã¾ã–ã¾ãªè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œè¨¼ã§ãã¾ã™ã€‚\nConftest ã®ç‰¹å¾´ æ±ç”¨æ€§ãŒé«˜ã„\nTerraformï¼ˆ.tfã€tfplan.jsonï¼‰ Kubernetesï¼ˆYAMLã€JSONï¼‰ Dockerfile ãã®ä»–ã® JSON/YAML ãƒ•ã‚¡ã‚¤ãƒ« ã‚·ãƒ³ãƒ—ãƒ«ã§è»½é‡\nå˜ä¸€ã®ãƒã‚¤ãƒŠãƒªã§å‹•ä½œ å¤–éƒ¨ä¾å­˜ãªã— CI/CD ã«ç°¡å˜ã«çµ±åˆå¯èƒ½ OPA ã® Rego è¨€èªã‚’æ¡ç”¨\nå®£è¨€çš„ãªãƒãƒªã‚·ãƒ¼è¨˜è¿° å¼·åŠ›ãªãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚° ãƒ†ã‚¹ãƒˆå¯èƒ½ãªãƒãƒªã‚·ãƒ¼ã‚³ãƒ¼ãƒ‰ ãªãœ Conftest ãŒå¿…è¦ãªã®ã‹ï¼Ÿ å¾“æ¥ã®ã‚¤ãƒ³ãƒ•ãƒ©ç®¡ç†ã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªèª²é¡ŒãŒã‚ã‚Šã¾ã—ãŸã€‚\nãƒ¬ãƒ“ãƒ¥ãƒ¼ã§æ¯å›åŒã˜æŒ‡æ‘˜ï¼ˆã€Œæš—å·åŒ–ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€ãªã©ï¼‰ äººçš„ãƒŸã‚¹ã«ã‚ˆã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ›ãƒ¼ãƒ« ç’°å¢ƒé–“ã§ã®è¨­å®šã®ä¸æ•´åˆ ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹é•åã®è¦‹è½ã¨ã— Conftest ã‚’ä½¿ã†ã“ã¨ã§ã€ã“ã‚Œã‚‰ã®èª²é¡Œã‚’è§£æ±ºã§ãã¾ã™ã€‚\nãƒãƒªã‚·ãƒ¼ã‚’ã‚³ãƒ¼ãƒ‰ã§è‡ªå‹•ãƒã‚§ãƒƒã‚¯ ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«å•é¡Œã‚’æ¤œå‡º ä¸€è²«ã—ãŸã‚¬ãƒãƒŠãƒ³ã‚¹ã®å®Ÿç¾ ãƒ¬ãƒ“ãƒ¥ãƒ¼è² è·ã®è»½æ¸› 1.2 ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— 1.2.1 Conftest ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« macOS ã®å ´åˆï¼š\nbrew install conftest Linux ã®å ´åˆï¼š\nLATEST_VERSION=$(curl -s https://api.github.com/repos/open-policy-agent/conftest/releases/latest | grep '\"tag_name\"' | sed -E 's/.*\"v([^\"]+)\".*/\\1/') wget \"https://github.com/open-policy-agent/conftest/releases/download/v${LATEST_VERSION}/conftest_${LATEST_VERSION}_Linux_x86_64.tar.gz\" tar xzf conftest_${LATEST_VERSION}_Linux_x86_64.tar.gz sudo mv conftest /usr/local/bin/ 1.3 æœ€åˆã®ãƒãƒªã‚·ãƒ¼ã‚’æ›¸ã„ã¦ã¿ã‚‹ ã§ã¯ã€æœ€åˆã®ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚\nãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ ä½œæ¥­ç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™ã€‚\nmkdir conftest-tutorial cd conftest-tutorial mkdir policy ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ï¼š\nconftest-tutorial/ â”œâ”€â”€ policy/ # ãƒãƒªã‚·ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½® â””â”€â”€ (Terraform ãƒ•ã‚¡ã‚¤ãƒ«) ç°¡å˜ãª Terraform ã‚³ãƒ¼ãƒ‰ã‚’ç”¨æ„ example.tf ã‚’ä½œæˆã—ã¾ã™ã€‚\n# S3 ãƒã‚±ãƒƒãƒˆï¼ˆå‘½åè¦å‰‡é•åã®ä¾‹ï¼‰ resource \"aws_s3_bucket\" \"example\" { bucket = \"my-test-bucket\" } # EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆå¤ã„ä¸–ä»£ã®ä¾‹ï¼‰ resource \"aws_instance\" \"web\" { ami = \"ami-0c55b159cbfafe1f0\" instance_type = \"t2.micro\" } ã“ã®ã‚³ãƒ¼ãƒ‰ã®å•é¡Œç‚¹ï¼š\nS3 ãƒã‚±ãƒƒãƒˆåãŒ mycompany- ã§å§‹ã¾ã£ã¦ã„ãªã„ï¼ˆå‘½åè¦å‰‡é•åï¼‰ EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒ t2 ä¸–ä»£ã‚’ä½¿ç”¨ï¼ˆt3 ã¸ã®ç§»è¡Œã‚’æ¨å¥¨ï¼‰ ã“ã‚Œã‚‰ã®å•é¡Œã‚’ãƒãƒªã‚·ãƒ¼ã§è‡ªå‹•æ¤œå‡ºã—ã¾ã™ã€‚\næœ€åˆã®ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆ policy/basic.rego ã‚’ä½œæˆã—ã¾ã™ï¼š\npackage main import future.keywords.contains import future.keywords.if # t2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯éæ¨å¥¨ deny contains msg if { # aws_instance ãƒªã‚½ãƒ¼ã‚¹ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ input.resource.aws_instance # ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åã‚’å–å¾—ï¼ˆ\"web\" ãªã©ï¼‰ instance_name := [name | input.resource.aws_instance[name]][_] # ãƒªã‚½ãƒ¼ã‚¹ã®è©³ç´°ã‚’å–å¾— resource := input.resource.aws_instance[instance_name][_] instance_type := resource.instance_type # é™çš„ãªå€¤ã®ã¿ãƒã‚§ãƒƒã‚¯ï¼ˆå¤‰æ•°å‚ç…§ã¯é™¤å¤–ï¼‰ is_string(instance_type) startswith(instance_type, \"t2.\") msg := sprintf( \"EC2 instance '%s' uses t2 generation. Migration to t3 is recommended\", [instance_name] ) } # S3 ãƒã‚±ãƒƒãƒˆåã«ã¯ä¼šç¤¾ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãŒå¿…è¦ deny contains msg if { # aws_s3_bucket ãƒªã‚½ãƒ¼ã‚¹ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ input.resource.aws_s3_bucket # ãƒã‚±ãƒƒãƒˆåã‚’å–å¾—ï¼ˆ\"example\" ãªã©ï¼‰ bucket_name := [name | input.resource.aws_s3_bucket[name]][_] # ãƒã‚±ãƒƒãƒˆã®è©³ç´°ã‚’å–å¾— resource := input.resource.aws_s3_bucket[bucket_name][_] bucket := resource.bucket # é™çš„ãªå€¤ã®ã¿ãƒã‚§ãƒƒã‚¯ is_string(bucket) not startswith(bucket, \"mycompany-\") msg := sprintf( \"S3 bucket '%s' must start with 'mycompany-'\", [bucket] ) } ãƒãƒªã‚·ãƒ¼ã®è§£èª¬:\npackage main: Conftest ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ import future.keywords.*: ãƒ¢ãƒ€ãƒ³ãª Rego æ§‹æ–‡ã‚’ä½¿ç”¨ deny contains msg if { ... }: ãƒãƒªã‚·ãƒ¼é•åã‚’å®šç¾©ï¼ˆãƒ†ã‚¹ãƒˆå¤±æ•—ï¼‰ sprintf(): ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¸ˆã¿ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç”Ÿæˆ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ ä½œæˆã—ãŸãƒãƒªã‚·ãƒ¼ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ï¼š\n$ conftest test example.tf --parser hcl2 å®Ÿè¡Œçµæœ:\nFAIL - example.tf - main - EC2 instance 'web' uses t2 generation. Migration to t3 is recommended FAIL - example.tf - main - S3 bucket 'my-test-bucket' must start with 'mycompany-' 5 tests, 3 passed, 0 warnings, 2 failures, 0 exceptions 2ã¤ã®ãƒãƒªã‚·ãƒ¼é•åã‚’æ­£ã—ãæ¤œå‡ºã—ã¾ã—ãŸã€‚\nã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£èª¬:\n--parser hcl2: HCL2 å½¢å¼ã§ Terraform ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‘ãƒ¼ã‚¹ --policy policy/: ãƒãƒªã‚·ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ policy/ ã‚’å‚ç…§ï¼‰ ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã¦ã¿ã‚‹ ãƒãƒªã‚·ãƒ¼é•åã‚’ä¿®æ­£ã—ã¾ã™ï¼š\n# ä¿®æ­£å¾Œ: example.tf resource \"aws_s3_bucket\" \"example\" { bucket = \"mycompany-test-bucket\" # ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ  } resource \"aws_instance\" \"web\" { ami = \"ami-0c55b159cbfafe1f0\" instance_type = \"t3.micro\" # t3 ä¸–ä»£ã«å¤‰æ›´ } å†åº¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼š\n$ conftest test example-fixed.tf --parser hcl2 å®Ÿè¡Œçµæœ:\n5 tests, 5 passed, 0 warnings, 0 failures, 0 exceptions ã™ã¹ã¦ã®ãƒãƒªã‚·ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚\n1.4 Rego ã®åŸºæœ¬æ§‹æ–‡ Rego ã¯å®£è¨€çš„ãªãƒãƒªã‚·ãƒ¼è¨€èªã§ã™ã€‚ã“ã“ã§ã¯ã€Conftest ã§ã‚ˆãä½¿ã†æ§‹æ–‡ã‚’ã«è§£èª¬ã—ã¾ã™ã€‚\n1.4.1 å¤‰æ•°ã¨ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ åŸºæœ¬çš„ãªãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹\n# ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ input.resource.aws_instance[\"web\"][0].instance_type # å¤‰æ•°ã¸ã®ä»£å…¥ instance := input.resource.aws_instance[\"web\"][0] instance_type := instance.instance_type # \"t2.micro\" é…åˆ—å†…åŒ…è¡¨è¨˜(ãƒªã‚¹ãƒˆç”Ÿæˆ)\n# ã™ã¹ã¦ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åã‚’å–å¾— instance_names := [name | input.resource.aws_instance[name]] # çµæœ: [\"web\", \"app\", \"db\"] # ã™ã¹ã¦ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ã‚’å–å¾— instance_types := [type | instance := input.resource.aws_instance[_][_] type := instance.instance_type ] # çµæœ: [\"t2.micro\", \"t3.small\", \"m5.large\"] ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ _ ã®ä½¿ç”¨\n# é…åˆ—ã®å„è¦ç´ ã‚’å–å¾—ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ä¸è¦ï¼‰ instance := input.planned_values.root_module.resources[_] # ã™ã¹ã¦ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åã‚’å–å¾— instance_name := [name | input.resource.aws_instance[name]][_] _ ã¯ã€Œä»»æ„ã®å€¤ã€ã‚’æ„å‘³ã—ã€ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ä½¿ç”¨ã—ã¾ã™ã€‚\n1.4.2 æ¡ä»¶åˆ†å²ã¨è«–ç†æ¼”ç®— AND æ¡ä»¶ï¼ˆæ”¹è¡Œã§æ¥ç¶šï¼‰:\ndeny contains msg if { instance := input.resource.aws_instance[_][_] instance.instance_type == \"t2.micro\" # æ¡ä»¶1 not instance.tags # æ¡ä»¶2 (AND) msg := \"t2.micro ã§ã‚¿ã‚°ãªã—ã¯ç¦æ­¢\" } ã™ã¹ã¦ã®æ¡ä»¶ãŒçœŸã®å ´åˆã®ã¿ãƒ«ãƒ¼ãƒ«ãŒé©ç”¨ã•ã‚Œã¾ã™ã€‚\nOR æ¡ä»¶(ã‚»ãƒƒãƒˆã§å®Ÿç¾)\n# æ–¹æ³•1 ã‚»ãƒƒãƒˆãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ— deny contains msg if { instance := input.resource.aws_instance[_][_] instance_type := instance.instance_type # t2.micro ã¾ãŸã¯ t2.small ã®å ´åˆ {\"t2.micro\", \"t2.small\"}[instance_type] msg := \"t2 ã‚·ãƒªãƒ¼ã‚ºã¯éæ¨å¥¨\" } # æ–¹æ³•2 è¤‡æ•°ã®ãƒ«ãƒ¼ãƒ« deny contains msg if { instance := input.resource.aws_instance[_][_] instance.instance_type == \"t2.micro\" msg := \"t2.micro ã¯éæ¨å¥¨\" } deny contains msg if { instance := input.resource.aws_instance[_][_] instance.instance_type == \"t2.small\" msg := \"t2.small ã¯éæ¨å¥¨\" } NOT æ¡ä»¶:\ndeny contains msg if { bucket := input.resource.aws_s3_bucket[_][_] # ã‚¿ã‚°ãŒå­˜åœ¨ã—ãªã„ not bucket.tags msg := \"S3 bucket requires tags\" } deny contains msg if { bucket := input.resource.aws_s3_bucket[_][_] bucket.tags # Environment ã‚¿ã‚°ãŒå­˜åœ¨ã—ãªã„ not bucket.tags.Environment msg := \"Environment tag is required\" } 1.4.3 çµ„ã¿è¾¼ã¿é–¢æ•° æ–‡å­—åˆ—æ“ä½œ:\n# æ–‡å­—åˆ—ã®é–‹å§‹ãƒã‚§ãƒƒã‚¯ startswith(\"t2.micro\", \"t2.\") # true # æ–‡å­—åˆ—ã®åŒ…å«ãƒã‚§ãƒƒã‚¯ contains(\"t2.micro\", \"micro\") # true # æ–‡å­—åˆ—ã®é€£çµ concat(\"-\", [\"my\", \"bucket\"]) # \"my-bucket\" # æ–‡å­—åˆ—ã®åˆ†å‰² split(\"10.0.0.0/16\", \"/\") # [\"10.0.0.0\", \"16\"] # å¤§æ–‡å­—ãƒ»å°æ–‡å­—å¤‰æ› upper(\"test\") # \"TEST\" lower(\"TEST\") # \"test\" å‹ãƒã‚§ãƒƒã‚¯:\nis_string(\"hello\") # true is_number(42) # true is_boolean(true) # true is_array([1, 2, 3]) # true is_object({\"key\": \"value\"}) # true æ•°å€¤æ“ä½œ:\n# é…åˆ—ã®ã‚«ã‚¦ãƒ³ãƒˆ count([1, 2, 3]) # 3 # æ•°å€¤ã®å¤‰æ› to_number(\"42\") # 42 # æœ€å¤§å€¤ãƒ»æœ€å°å€¤ max([1, 5, 3]) # 5 min([1, 5, 3]) # 1 ã‚»ãƒƒãƒˆæ“ä½œ:\n# ã‚»ãƒƒãƒˆå®šç¾© allowed_types := {\"t3.micro\", \"t3.small\", \"t3.medium\"} # ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—ãƒã‚§ãƒƒã‚¯ allowed_types[\"t3.micro\"] # true allowed_types[\"t2.micro\"] # false # ã‚»ãƒƒãƒˆã®çµåˆ union({1, 2}, {2, 3}) # {1, 2, 3} # ã‚»ãƒƒãƒˆã®å·®é›†åˆ set1 := {1, 2, 3} set2 := {2, 3, 4} diff := set1 - set2 # {1} 1.4.4 sprintf ã«ã‚ˆã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ sprintf ã¯ã€å¤‰æ•°ã‚’å«ã‚€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆã™ã‚‹éš›ã«éå¸¸ã«ä¾¿åˆ©ã§ã™ã€‚\n# åŸºæœ¬çš„ãªä½¿ç”¨ msg := sprintf(\"EC2 instance '%s' is not allowed\", [\"web\"]) # çµæœ: \"EC2 instance 'web' is not allowed\" # è¤‡æ•°ã®å¤‰æ•° msg := sprintf( \"EC2 instance '%s' instance type '%s' is not allowed\", [\"web\", \"t2.micro\"] ) # çµæœ: \"EC2 instance 'web' instance type 't2.micro' is not allowed\" # æ•°å€¤ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ msg := sprintf(\"Volume size is too large: %d GB\", [1000]) # çµæœ: \"Volume size is too large: 1000 GB\" # è¤‡é›‘ãªä¾‹ msg := sprintf( \"%s '%s' has issues:\\n\" + \" - Type: %s (Allowed: %v)\\n\" + \" - Region: %s\", [\"EC2\", \"web\", \"t2.micro\", allowed_types, \"us-west-2\"] ) ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæŒ‡å®šå­:\n%s: æ–‡å­—åˆ— %d: æ•´æ•° %v: ä»»æ„ã®å€¤ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰ 1.4.5 ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã®å®šç¾© ç¹°ã‚Šè¿”ã—ä½¿ç”¨ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã¯ã€ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã¨ã—ã¦å®šç¾©ã§ãã¾ã™ã€‚\n# ç‰¹å®šã‚¿ã‚¤ãƒ—ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼ get_resources(resource_type) := resources if { resources := [resource | resource := input.planned_values.root_module.resources[_] resource.type == resource_type ] } # ä½¿ç”¨ä¾‹ deny contains msg if { instance := get_resources(\"aws_instance\")[_] instance.values.instance_type == \"t2.micro\" msg := sprintf(\"EC2 instance '%s' uses t2.micro\", [instance.name]) } # è¤‡æ•°ã®æ¡ä»¶ã‚’æŒã¤ãƒ˜ãƒ«ãƒ‘ãƒ¼ is_production(resource) if { resource.values.tags.Environment == \"production\" } # ä½¿ç”¨ä¾‹ deny contains msg if { instance := get_resources(\"aws_instance\")[_] is_production(instance) instance.values.instance_type == \"t2.micro\" msg := \"æœ¬ç•ªç’°å¢ƒã§ t2.micro ã¯ç¦æ­¢\" } 1.4.6 object.get ã«ã‚ˆã‚‹å®‰å…¨ãªã‚¢ã‚¯ã‚»ã‚¹ å­˜åœ¨ã—ãªã„ã‚­ãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚object.get ã‚’ä½¿ã†ã¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’æŒ‡å®šã§ãã¾ã™ã€‚\n# é€šå¸¸ã®ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆã‚­ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ï¼‰ env := instance.values.tags.Environment # tags ãŒå­˜åœ¨ã—ãªã„å ´åˆã‚¨ãƒ©ãƒ¼ # å®‰å…¨ãªã‚¢ã‚¯ã‚»ã‚¹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’æŒ‡å®šï¼‰ env := object.get(instance.values.tags, \"Environment\", \"unknown\") # tags ãŒå­˜åœ¨ã—ãªã„å ´åˆ: \"unknown\" # å®Ÿè·µä¾‹ warn contains msg if { db := get_resources(\"aws_db_instance\")[_] # backup_retention_period ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ 0 period := object.get(db.values, \"backup_retention_period\", 0) period \u003c 7 msg := sprintf( \"RDS '%s' ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿æŒæœŸé–“ãŒçŸ­ã™ãã¾ã™: %dæ—¥\", [db.name, period] ) } 1.4.7 è¤‡åˆæ¡ä»¶ã®ãƒã‚§ãƒƒã‚¯ è¤‡æ•°ã®æ¡ä»¶ã‚’çµ„ã¿åˆã‚ã›ãŸå®Ÿè·µçš„ãªãƒãƒªã‚·ãƒ¼ã®ä¾‹\n# æœ¬ç•ªç’°å¢ƒã® EC2 ã¯å³æ ¼ã«ãƒã‚§ãƒƒã‚¯ deny contains msg if { instance := get_resources(\"aws_instance\")[_] # æœ¬ç•ªç’°å¢ƒã‹ãƒã‚§ãƒƒã‚¯ instance.values.tags.Environment == \"production\" # ã„ãšã‚Œã‹ã®æ¡ä»¶ã‚’æº€ãŸã•ãªã„å ´åˆ violations := [v | # IMDSv2 ãŒç„¡åŠ¹ not instance.values.metadata_options v := \"IMDSv2 ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„\" ] violations2 := [v | # ãƒ«ãƒ¼ãƒˆãƒœãƒªãƒ¥ãƒ¼ãƒ ãŒæš—å·åŒ–ã•ã‚Œã¦ã„ãªã„ instance.values.root_block_device instance.values.root_block_device[_].encrypted == false v := \"ãƒ«ãƒ¼ãƒˆãƒœãƒªãƒ¥ãƒ¼ãƒ ãŒæš—å·åŒ–ã•ã‚Œã¦ã„ãªã„\" ] violations3 := [v | # t2 ä¸–ä»£ã‚’ä½¿ç”¨ startswith(instance.values.instance_type, \"t2.\") v := \"t2 ä¸–ä»£ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½¿ç”¨\" ] # ã™ã¹ã¦ã®é•åã‚’çµåˆ all_violations := array.concat( violations, array.concat(violations2, violations3) ) # 1ã¤ä»¥ä¸Šã®é•åãŒã‚ã‚‹ count(all_violations) \u003e 0 msg := sprintf( \"Production EC2 instance '%s' has the following issues:\\n%v\", [instance.name, all_violations] ) } å®Ÿè¡Œçµæœã®ä¾‹:\nFAIL - Production EC2 instance 'web' has the following issues: [\"IMDSv2 is not configured\", \"Root volume is not encrypted\"] 1.4.8 ãƒ‘ã‚¿ãƒ¼ãƒ³é›† ãƒ‘ã‚¿ãƒ¼ãƒ³1: ã™ã¹ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯\ndeny contains msg if { # ã™ã¹ã¦ã® aws_instance ã‚’å–å¾— instance_name := [name | input.resource.aws_instance[name]][_] instance := input.resource.aws_instance[instance_name][_] # å„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ not instance.tags msg := sprintf(\"EC2 instance '%s' has no tags set\", [instance_name]) } ãƒ‘ã‚¿ãƒ¼ãƒ³2: ç‰¹å®šã®æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã®ã¿ãƒã‚§ãƒƒã‚¯\ndeny contains msg if { instance := get_resources(\"aws_instance\")[_] # æœ¬ç•ªç’°å¢ƒã®ãƒªã‚½ãƒ¼ã‚¹ã®ã¿ instance.values.tags.Environment == \"production\" # æ¡ä»¶ãƒã‚§ãƒƒã‚¯ instance.values.instance_type == \"t2.micro\" msg := sprintf(\"æœ¬ç•ªç’°å¢ƒã§ t2.micro ã¯ç¦æ­¢: '%s'\", [instance.name]) } ãƒ‘ã‚¿ãƒ¼ãƒ³3: é–¢é€£ãƒªã‚½ãƒ¼ã‚¹ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯\n# S3 ãƒã‚±ãƒƒãƒˆã«æš—å·åŒ–è¨­å®šãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ deny contains msg if { bucket := get_resources(\"aws_s3_bucket\")[_] bucket_address := bucket.address # æš—å·åŒ–è¨­å®šãŒå­˜åœ¨ã—ãªã„ not has_encryption(bucket_address) msg := sprintf(\"S3 bucket '%s' requires encryption configuration\", [bucket.name]) } # ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: æš—å·åŒ–è¨­å®šã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ has_encryption(bucket_address) if { encryption := get_resources( \"aws_s3_bucket_server_side_encryption_configuration\" )[_] encryption.values.bucket == bucket_address } ã“ã‚Œã§ Rego ã®åŸºæœ¬æ§‹æ–‡ã¯ç†è§£ã§ãã¾ã—ãŸã€‚æ¬¡ã¯ã€å®Ÿéš›ã® HCL ãƒ•ã‚¡ã‚¤ãƒ«ãƒ†ã‚¹ãƒˆã«é€²ã¿ã¾ã—ã‚‡ã†ã€‚\n2. tfplan.json ã‚’ã‚‚ã¨ã«ã™ã‚‹ãƒ†ã‚¹ãƒˆ HCL ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ†ã‚¹ãƒˆã¯é«˜é€Ÿã§ã™ãŒå¤‰æ•°ã®å€¤ã‚„å‹•çš„ãªè¨­å®šã¯è©•ä¾¡ã§ãã¾ã›ã‚“ã€‚ãã“ã§ tfplan.json ã‚’ä½¿ã£ãŸãƒ†ã‚¹ãƒˆã‚’ç´¹ä»‹ã—ã¾ã™ã€‚\n2.1 ãªãœ tfplan.json ãªã®ã‹ï¼Ÿ HCL ãƒ†ã‚¹ãƒˆã®é™ç•Œ variable \"instance_type\" { default = \"t2.micro\" } resource \"aws_instance\" \"web\" { instance_type = var.instance_type # â† ã“ã®å€¤ã¯ HCL ãƒ†ã‚¹ãƒˆã§ã¯åˆ†ã‹ã‚‰ãªã„ count = var.enable ? 1 : 0 # â† å‹•çš„ãªå€¤ã‚‚è©•ä¾¡ã§ããªã„ } tfplan.json ã®å¼·ã¿ terraform show -json tfplan ã§ç”Ÿæˆã•ã‚Œã‚‹ tfplan.json ã«ã¯ä¸‹è¨˜ãŒå«ã¾ã‚Œã¾ã™ã€‚\nå¤‰æ•°å±•é–‹å¾Œã®å®Ÿéš›ã®å€¤ count/for_each ã®çµæœ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å±•é–‹å¾Œã®çŠ¶æ…‹ è¨ˆç®—ã•ã‚ŒãŸã™ã¹ã¦ã®å€¤ 2.2 tfplan.json ã®ç”Ÿæˆ terraform init terraform plan -out=tfplan terraform show -json tfplan \u003e tfplan.json 2.3 tfplan.json ã®æ§‹é€  { \"format_version\": \"1.2\", \"terraform_version\": \"1.6.0\", \"planned_values\": { \"root_module\": { \"resources\": [ { \"address\": \"aws_instance.web\", \"type\": \"aws_instance\", \"name\": \"web\", \"values\": { \"ami\": \"ami-0c55b159cbfafe1f0\", \"instance_type\": \"t2.micro\", \"tags\": { \"Name\": \"web-server\", \"Environment\": \"production\" } } } ] } } } ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•\n# ãƒªã‚½ãƒ¼ã‚¹ã®å–å¾— resource := input.planned_values.root_module.resources[_] resource.type == \"aws_instance\" resource.values.instance_type # \"t2.micro\" 3 ãƒãƒªã‚·ãƒ¼ä¾‹ 3.1 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ— package main import future.keywords.contains import future.keywords.if # ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: ãƒªã‚½ãƒ¼ã‚¹å–å¾— get_resources(resource_type) := resources if { resources := [resource | resource := input.planned_values.root_module.resources[_] resource.type == resource_type ] } # EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ã®ãƒã‚§ãƒƒã‚¯ deny contains msg if { resource := get_resources(\"aws_instance\")[_] # å®Ÿéš›ã®å€¤ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆå¤‰æ•°å±•é–‹æ¸ˆã¿ï¼‰ resource.values.instance_type == \"t2.micro\" msg := sprintf( \"EC2 instance '%s' must be t2.micro. Current: %s\", [resource.name, resource.values.instance_type] ) } 3.2 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ S3 æš—å·åŒ–ã®å¿…é ˆåŒ– # S3 ãƒã‚±ãƒƒãƒˆã«ã¯æš—å·åŒ–ãŒå¿…é ˆ deny contains msg if { bucket := get_resources(\"aws_s3_bucket\")[_] bucket_address := bucket.address # æš—å·åŒ–è¨­å®šã®æœ‰ç„¡ã‚’ç¢ºèª not has_encryption(bucket_address) msg := sprintf( \"S3 bucket '%s' requires encryption configuration\", [bucket.name] ) } # æš—å·åŒ–è¨­å®šã®å­˜åœ¨ç¢ºèª has_encryption(bucket_address) if { encryption := get_resources(\"aws_s3_bucket_server_side_encryption_configuration\")[_] encryption.values.bucket == bucket_address } IMDSv2 ã®å¿…é ˆåŒ– # EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ IMDSv2 ã‚’å¿…é ˆã¨ã™ã‚‹ deny contains msg if { instance := get_resources(\"aws_instance\")[_] # metadata_options ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ not instance.values.metadata_options msg := sprintf( \"EC2 instance '%s' ã¯ IMDSv2 ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™\", [instance.name] ) } deny contains msg if { instance := get_resources(\"aws_instance\")[_] instance.values.metadata_options # http_tokens ãŒ required ã§ãªã„ instance.values.metadata_options[_].http_tokens != \"required\" msg := sprintf( \"EC2 instance '%s' ã® IMDSv2 ãŒæœ‰åŠ¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“\", [instance.name] ) } 3.3 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã®å³æ ¼ãªãƒã‚§ãƒƒã‚¯ # å±é™ºãªãƒãƒ¼ãƒˆã®å…¨å…¬é–‹ã‚’ç¦æ­¢ deny contains msg if { sg := get_resources(\"aws_security_group\")[_] ingress := sg.values.ingress[_] # 0.0.0.0/0 ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ cidr := ingress.cidr_blocks[_] cidr == \"0.0.0.0/0\" # å±é™ºãªãƒãƒ¼ãƒˆ dangerous_ports := {22, 3389, 3306, 5432} port := dangerous_ports[_] ingress.from_port \u003c= port ingress.to_port \u003e= port port_names := { 22: \"SSH\", 3389: \"RDP\", 3306: \"MySQL\", 5432: \"PostgreSQL\" } msg := sprintf( \"Security group '%s' exposes %s (port %d) to 0.0.0.0/0\", [sg.name, port_names[port], port] ) } 3.4 ã‚¿ã‚°ãƒãƒªã‚·ãƒ¼ # å¿…é ˆã‚¿ã‚°ã®å®šç¾© required_tags := {\"Environment\", \"Owner\", \"Project\"} allowed_environments := {\"production\", \"staging\", \"development\", \"test\"} # ã‚¿ã‚°ä»˜ã‘å¯èƒ½ãªãƒªã‚½ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ— taggable_resources := { \"aws_instance\", \"aws_s3_bucket\", \"aws_db_instance\", \"aws_vpc\" } # å¿…é ˆã‚¿ã‚°ã®å­˜åœ¨ç¢ºèª deny contains msg if { resource_type := taggable_resources[_] resource := get_resources(resource_type)[_] # ã‚¿ã‚°ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ not resource.values.tags msg := sprintf( \"%s '%s' has no tags set. Required tags: %v\", [resource_type, resource.name, required_tags] ) } # ç‰¹å®šã®ã‚¿ã‚°ãŒæ¬ è½ã—ã¦ã„ã‚‹å ´åˆ deny contains msg if { resource_type := taggable_resources[_] resource := get_resources(resource_type)[_] resource.values.tags # å¿…é ˆã‚¿ã‚°ãŒæ¬ è½ required_tag := required_tags[_] not resource.values.tags[required_tag] msg := sprintf( \"%s '%s' is missing required tag '%s'\", [resource_type, resource.name, required_tag] ) } # Environment ã‚¿ã‚°ã®å€¤æ¤œè¨¼ deny contains msg if { resource_type := taggable_resources[_] resource := get_resources(resource_type)[_] resource.values.tags.Environment env := resource.values.tags.Environment not allowed_environments[env] msg := sprintf( \"%s '%s' Environment tag value '%s' is invalid. Allowed values: %v\", [resource_type, resource.name, env, allowed_environments] ) } 3.5 ã‚³ã‚¹ãƒˆæœ€é©åŒ–ãƒãƒªã‚·ãƒ¼ # è¨±å¯ã•ã‚ŒãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ— allowed_instance_types := { \"t3.micro\", \"t3.small\", \"t3.medium\", \"m5.large\", \"m5.xlarge\" } # ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ã®åˆ¶é™ deny contains msg if { instance := get_resources(\"aws_instance\")[_] instance_type := instance.values.instance_type not allowed_instance_types[instance_type] msg := sprintf( \"EC2 instance '%s' instance type '%s' is not allowed. Allowed types: %v\", [instance.name, instance_type, allowed_instance_types] ) } # é–‹ç™ºç’°å¢ƒã§ Multi-AZ ã¯ä¸è¦ warn contains msg if { db := get_resources(\"aws_db_instance\")[_] db.values.tags.Environment == \"development\" db.values.multi_az == true msg := sprintf( \"RDS instance '%s' has Multi-AZ enabled in development. Multi-AZ is usually unnecessary for development and wastes cost\", [db.name] ) } 3.6 è¤‡é›‘ãªãƒãƒªã‚·ãƒ¼ï¼ˆãƒªã‚½ãƒ¼ã‚¹é–“ã®é–¢ä¿‚ï¼‰ # EC2 ãŒ VPC å†…ã«ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª warn contains msg if { instance := get_resources(\"aws_instance\")[_] # subnet_id ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„ not instance.values.subnet_id msg := sprintf( \"EC2 instance '%s' ãŒ VPC å†…ã«é…ç½®ã•ã‚Œã¦ã„ã¾ã›ã‚“\", [instance.name] ) } # æœ¬ç•ªç’°å¢ƒã®ãƒªã‚½ãƒ¼ã‚¹ã¯é©åˆ‡ãªè¨­å®šã‚’æŒã¤ã¹ã deny contains msg if { instance := get_resources(\"aws_instance\")[_] instance.values.tags.Environment == \"production\" # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã®ãƒã‚§ãƒƒã‚¯ violations := [v | not instance.values.metadata_options v := \"IMDSv2 ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„\" ] violations2 := [v | instance.values.root_block_device instance.values.root_block_device[_].encrypted == false v := \"ãƒ«ãƒ¼ãƒˆãƒœãƒªãƒ¥ãƒ¼ãƒ ãŒæš—å·åŒ–ã•ã‚Œã¦ã„ãªã„\" ] all_violations := array.concat(violations, violations2) count(all_violations) \u003e 0 msg := sprintf( \"Production EC2 instance '%s' has issues: %v\", [instance.name, all_violations] ) } 3.7 å®Ÿè¡Œä¾‹ # Terraform ãƒ—ãƒ©ãƒ³ç”Ÿæˆ $ terraform init $ AWS_PROFILE=\"\" AWS_EC2_METADATA_DISABLED=true AWS_ACCESS_KEY_ID=\"test\" AWS_SECRET_ACCESS_KEY=\"test\" AWS_DEFAULT_REGION=\"us-west-2\" terraform plan -out=tfplan $ terraform show -json tfplan \u003e tfplan.json # Conftest å®Ÿè¡Œ $ conftest test tfplan.json --policy policy/ FAIL - tfplan.json - EC2 instance 'web' uses t2.micro. Current: t2.micro FAIL - tfplan.json - S3 bucket 'data' requires encryption configuration FAIL - tfplan.json - Security group 'web' exposes SSH (port 22) to 0.0.0.0/0 5 tests, 2 passed, 0 warnings, 3 failures, 0 exceptions å‚è€ƒè³‡æ–™ å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ Conftest å…¬å¼ã‚µã‚¤ãƒˆ Open Policy Agent ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ Terraform å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãƒ»ã‚¬ã‚¤ãƒ‰ OPA \u0026 Terraform: The Definitive Guide (2025 Edition) Beyond terraform plan: Policy as Code with OPA Securing Terraform Pipelines with Conftest and OPA ãŠã‚ã‚Šã« IaC ã‚³ãƒ¼ãƒ‰é–‹ç™ºã«å¯¾ã—ã¦ Rego ãƒãƒªã‚·ã®åˆ¶ç´„ã‚’åŠ ãˆã‚‹ã“ã¨ã§ã€ã‚ˆã‚Šå®‰å…¨ã«é–‹ç™ºãŒè¡Œãˆã‚‹äº‹ãŒåˆ†ã‹ã‚Šã¾ã—ãŸã€‚ç‰¹ã«è¤‡æ•°åã§é–‹ç™ºã‚’è¡Œã†å ´åˆã‚„ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ãŒç¤¾å†…çš„ã«ã‚ã‚‹å ´åˆã«äººã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã¯æ¼ã‚Œã‚‹æã‚ŒãŒã‚ã‚‹ã®ã§ã€æ©Ÿæ¢°çš„ã«åˆ¶ç´„ã‚’åŠ ãˆã‚‰ã‚Œã‚‹äº‹ã¯ãƒ¡ãƒªãƒƒãƒˆå¤§ãã„ã¨æ€ã£ã¦ã„ã¾ã™ã€‚\nã¾ãŸã€Conftest ã¨ OPA ã¯å­¦ç¿’ã‚³ã‚¹ãƒˆãŒä½ãã™ãã«å§‹ã‚ã‚‰ã‚Œã‚‹ã®ã‚‚ãƒ¡ãƒªãƒƒãƒˆãŒå¤§ãã„ã§ã™ã€‚ã€‚å°ã•ãªãƒãƒªã‚·ãƒ¼ã‹ã‚‰å§‹ã‚ã¦ã€æ®µéšçš„ã«æ‹¡å¤§ã—ã¦ã„ãã®ãŒè‰¯ã„ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚\n",
  "wordCount" : "1985",
  "inLanguage": "en",
  "image": "https://jedipunkz.github.io/jedipunkz.jpg","datePublished": "2025-12-07T10:42:32+09:00",
  "dateModified": "2025-12-07T10:42:32+09:00",
  "author":{
    "@type": "Person",
    "name": "jedipunkz"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://jedipunkz.github.io/post/conftest/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "jedipunkz ğŸš€ ã®ãƒ–ãƒ­ã‚°",
    "logo": {
      "@type": "ImageObject",
      "url": "https://jedipunkz.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://jedipunkz.github.io/" accesskey="h" title="jedipunkz ğŸš€ ã®ãƒ–ãƒ­ã‚° (Alt + H)">jedipunkz ğŸš€ ã®ãƒ–ãƒ­ã‚°</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://jedipunkz.github.io/about" title="About Me">
                    <span>About Me</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://jedipunkz.github.io/">Home</a>&nbsp;Â»&nbsp;<a href="https://jedipunkz.github.io/post/">Posts</a></div>
    <h1 class="post-title">
      Conftest OPA ã§ Terraform ã‚³ãƒ¼ãƒ‰é–‹ç™ºã«åˆ¶ç´„ã‚’è¨­ã‘ã‚‹
    </h1>
    <div class="post-description">
      Conftest ã¨ Terraform ã‚’ä½¿ã„åŸºæœ¬çš„ãªæ§‹æ–‡ã‚’ç†è§£ã—ã¤ã¤å®Ÿéš›ã« Rego ãƒãƒªã‚·ã‚’æ›¸ã„ã¦å‹•ä½œã•ã›ã¦ã¿ãŸè¨˜äº‹ã§ã™
    </div>
    
  </header> 
  <div class="post-content"><p>ã“ã‚“ã«ã¡ã¯ã€‚<a href="https://x.com/jedipunkz">jedipunkzğŸš€</a> ã§ã™ã€‚</p>
<p>Conftest ã¨ Open Policy Agent (OPA) ã‚’ä½¿ã£ãŸ Terraform ã®ãƒãƒªã‚·ãƒ¼æ¤œè¨¼ã‚’è¡Œã£ãŸã®ã§ãã‚Œã‚’è¨˜äº‹ã«ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚ãƒãƒªã‚·ã‚’æ›¸ãã“ã¨ã§ Terraform ã‚³ãƒ¼ãƒ‰ã«åˆ¶ç´„ã‚’åŠ ãˆã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶(ä¾‹ãˆã°æš—å·åŒ–è¦ä»¶ã‚„ãƒãƒ¼ãƒˆé–‹æ”¾è¦ä»¶ç­‰) ã‚’æº€ãŸã—ãŸã‚Šãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«ãã£ãŸã‚¤ãƒ³ãƒ•ãƒ©ã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚æ¯å›ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§äººã«ãƒã‚§ãƒƒã‚¯ã•ã›ã‚‹ã‚ˆã‚Šã‚‚ç¢ºå®Ÿã«åˆ¶ç´„ã‚’å®ˆã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ã®ã§ãŠã™ã™ã‚ã§ã™ã€‚</p>
<p>ã“ã®è¨˜äº‹ã§ã¯ã€Conftest ã¨ OPA ã‚’ä½¿ã£ã¦ã€Terraform ã‚³ãƒ¼ãƒ‰ã«è‡ªå‹•çš„ã«ãƒãƒªã‚·ãƒ¼ãƒã‚§ãƒƒã‚¯ã‚’é©ç”¨ã™ã‚‹æ–¹æ³•ã‚’ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å½¢å¼ã§è§£èª¬ã—ã¾ã™ã€‚</p>
<hr>
<h2 id="1-conftest-æ¦‚è¦ã¨åŸºæœ¬ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«">1. Conftest æ¦‚è¦ã¨åŸºæœ¬ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«<a hidden class="anchor" aria-hidden="true" href="#1-conftest-æ¦‚è¦ã¨åŸºæœ¬ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«">#</a></h2>
<h3 id="11-conftest-ã¨ã¯">1.1 Conftest ã¨ã¯ï¼Ÿ<a hidden class="anchor" aria-hidden="true" href="#11-conftest-ã¨ã¯">#</a></h3>
<p>Conftest ã¯ã€æ§‹é€ åŒ–ã•ã‚ŒãŸè¨­å®šãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦ãƒãƒªã‚·ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚Open Policy Agent (OPA) ã® Rego è¨€èªã‚’ä½¿ç”¨ã—ã¦ãƒãƒªã‚·ãƒ¼ã‚’è¨˜è¿°ã—ã€ã•ã¾ã–ã¾ãªè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œè¨¼ã§ãã¾ã™ã€‚</p>
<h4 id="conftest-ã®ç‰¹å¾´">Conftest ã®ç‰¹å¾´<a hidden class="anchor" aria-hidden="true" href="#conftest-ã®ç‰¹å¾´">#</a></h4>
<ol>
<li>
<p>æ±ç”¨æ€§ãŒé«˜ã„</p>
<ul>
<li>Terraformï¼ˆ.tfã€tfplan.jsonï¼‰</li>
<li>Kubernetesï¼ˆYAMLã€JSONï¼‰</li>
<li>Dockerfile</li>
<li>ãã®ä»–ã® JSON/YAML ãƒ•ã‚¡ã‚¤ãƒ«</li>
</ul>
</li>
<li>
<p>ã‚·ãƒ³ãƒ—ãƒ«ã§è»½é‡</p>
<ul>
<li>å˜ä¸€ã®ãƒã‚¤ãƒŠãƒªã§å‹•ä½œ</li>
<li>å¤–éƒ¨ä¾å­˜ãªã—</li>
<li>CI/CD ã«ç°¡å˜ã«çµ±åˆå¯èƒ½</li>
</ul>
</li>
<li>
<p>OPA ã® Rego è¨€èªã‚’æ¡ç”¨</p>
<ul>
<li>å®£è¨€çš„ãªãƒãƒªã‚·ãƒ¼è¨˜è¿°</li>
<li>å¼·åŠ›ãªãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°</li>
<li>ãƒ†ã‚¹ãƒˆå¯èƒ½ãªãƒãƒªã‚·ãƒ¼ã‚³ãƒ¼ãƒ‰</li>
</ul>
</li>
</ol>
<h4 id="ãªãœ-conftest-ãŒå¿…è¦ãªã®ã‹">ãªãœ Conftest ãŒå¿…è¦ãªã®ã‹ï¼Ÿ<a hidden class="anchor" aria-hidden="true" href="#ãªãœ-conftest-ãŒå¿…è¦ãªã®ã‹">#</a></h4>
<p>å¾“æ¥ã®ã‚¤ãƒ³ãƒ•ãƒ©ç®¡ç†ã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªèª²é¡ŒãŒã‚ã‚Šã¾ã—ãŸã€‚</p>
<ul>
<li>ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§æ¯å›åŒã˜æŒ‡æ‘˜ï¼ˆã€Œæš—å·åŒ–ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€ãªã©ï¼‰</li>
<li>äººçš„ãƒŸã‚¹ã«ã‚ˆã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ›ãƒ¼ãƒ«</li>
<li>ç’°å¢ƒé–“ã§ã®è¨­å®šã®ä¸æ•´åˆ</li>
<li>ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹é•åã®è¦‹è½ã¨ã—</li>
</ul>
<p>Conftest ã‚’ä½¿ã†ã“ã¨ã§ã€ã“ã‚Œã‚‰ã®èª²é¡Œã‚’è§£æ±ºã§ãã¾ã™ã€‚</p>
<ul>
<li>ãƒãƒªã‚·ãƒ¼ã‚’ã‚³ãƒ¼ãƒ‰ã§è‡ªå‹•ãƒã‚§ãƒƒã‚¯</li>
<li>ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«å•é¡Œã‚’æ¤œå‡º</li>
<li>ä¸€è²«ã—ãŸã‚¬ãƒãƒŠãƒ³ã‚¹ã®å®Ÿç¾</li>
<li>ãƒ¬ãƒ“ãƒ¥ãƒ¼è² è·ã®è»½æ¸›</li>
</ul>
<h3 id="12-ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—">1.2 ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—<a hidden class="anchor" aria-hidden="true" href="#12-ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—">#</a></h3>
<h4 id="121-conftest-ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«">1.2.1 Conftest ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«<a hidden class="anchor" aria-hidden="true" href="#121-conftest-ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«">#</a></h4>
<p>macOS ã®å ´åˆï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">brew install conftest
</span></span></code></pre></div><p>Linux ã®å ´åˆï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">LATEST_VERSION</span><span class="o">=</span><span class="k">$(</span>curl -s https://api.github.com/repos/open-policy-agent/conftest/releases/latest <span class="p">|</span> grep <span class="s1">&#39;&#34;tag_name&#34;&#39;</span> <span class="p">|</span> sed -E <span class="s1">&#39;s/.*&#34;v([^&#34;]+)&#34;.*/\1/&#39;</span><span class="k">)</span>
</span></span><span class="line"><span class="cl">wget <span class="s2">&#34;https://github.com/open-policy-agent/conftest/releases/download/v</span><span class="si">${</span><span class="nv">LATEST_VERSION</span><span class="si">}</span><span class="s2">/conftest_</span><span class="si">${</span><span class="nv">LATEST_VERSION</span><span class="si">}</span><span class="s2">_Linux_x86_64.tar.gz&#34;</span>
</span></span><span class="line"><span class="cl">tar xzf conftest_<span class="si">${</span><span class="nv">LATEST_VERSION</span><span class="si">}</span>_Linux_x86_64.tar.gz
</span></span><span class="line"><span class="cl">sudo mv conftest /usr/local/bin/
</span></span></code></pre></div><h3 id="13-æœ€åˆã®ãƒãƒªã‚·ãƒ¼ã‚’æ›¸ã„ã¦ã¿ã‚‹">1.3 æœ€åˆã®ãƒãƒªã‚·ãƒ¼ã‚’æ›¸ã„ã¦ã¿ã‚‹<a hidden class="anchor" aria-hidden="true" href="#13-æœ€åˆã®ãƒãƒªã‚·ãƒ¼ã‚’æ›¸ã„ã¦ã¿ã‚‹">#</a></h3>
<p>ã§ã¯ã€æœ€åˆã®ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚</p>
<h4 id="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ<a hidden class="anchor" aria-hidden="true" href="#ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ">#</a></h4>
<p>ä½œæ¥­ç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkdir conftest-tutorial
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> conftest-tutorial
</span></span><span class="line"><span class="cl">mkdir policy
</span></span></code></pre></div><p>ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ï¼š</p>
<pre tabindex="0"><code>conftest-tutorial/
â”œâ”€â”€ policy/        # ãƒãƒªã‚·ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®
â””â”€â”€ (Terraform ãƒ•ã‚¡ã‚¤ãƒ«)
</code></pre><h4 id="ç°¡å˜ãª-terraform-ã‚³ãƒ¼ãƒ‰ã‚’ç”¨æ„">ç°¡å˜ãª Terraform ã‚³ãƒ¼ãƒ‰ã‚’ç”¨æ„<a hidden class="anchor" aria-hidden="true" href="#ç°¡å˜ãª-terraform-ã‚³ãƒ¼ãƒ‰ã‚’ç”¨æ„">#</a></h4>
<p><code>example.tf</code> ã‚’ä½œæˆã—ã¾ã™ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="c1"># S3 ãƒã‚±ãƒƒãƒˆï¼ˆå‘½åè¦å‰‡é•åã®ä¾‹ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;aws_s3_bucket&#34; &#34;example&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  bucket</span> <span class="o">=</span> <span class="s2">&#34;my-test-bucket&#34;</span>
</span></span><span class="line"><span class="cl">}<span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1">
</span></span></span><span class="line"><span class="cl"><span class="c1"># EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆå¤ã„ä¸–ä»£ã®ä¾‹ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;aws_instance&#34; &#34;web&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  ami</span>           <span class="o">=</span> <span class="s2">&#34;ami-0c55b159cbfafe1f0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  instance_type</span> <span class="o">=</span> <span class="s2">&#34;t2.micro&#34;</span>
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>ã“ã®ã‚³ãƒ¼ãƒ‰ã®å•é¡Œç‚¹ï¼š</p>
<ul>
<li>S3 ãƒã‚±ãƒƒãƒˆåãŒ <code>mycompany-</code> ã§å§‹ã¾ã£ã¦ã„ãªã„ï¼ˆå‘½åè¦å‰‡é•åï¼‰</li>
<li>EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒ t2 ä¸–ä»£ã‚’ä½¿ç”¨ï¼ˆt3 ã¸ã®ç§»è¡Œã‚’æ¨å¥¨ï¼‰</li>
</ul>
<p>ã“ã‚Œã‚‰ã®å•é¡Œã‚’ãƒãƒªã‚·ãƒ¼ã§è‡ªå‹•æ¤œå‡ºã—ã¾ã™ã€‚</p>
<h4 id="æœ€åˆã®ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆ">æœ€åˆã®ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆ<a hidden class="anchor" aria-hidden="true" href="#æœ€åˆã®ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆ">#</a></h4>
<p><code>policy/basic.rego</code> ã‚’ä½œæˆã—ã¾ã™ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rego" data-lang="rego"><span class="line"><span class="cl"><span class="kd">package</span><span class="w"> </span><span class="nx">main</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">import</span><span class="w"> </span><span class="nx">future</span><span class="o">.</span><span class="nx">keywords</span><span class="o">.</span><span class="kd">contains</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">import</span><span class="w"> </span><span class="nx">future</span><span class="o">.</span><span class="nx">keywords</span><span class="o">.</span><span class="kd">if</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># t2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯éæ¨å¥¨</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">deny</span><span class="w"> </span><span class="kd">contains</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># aws_instance ãƒªã‚½ãƒ¼ã‚¹ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">input</span><span class="o">.</span><span class="nx">resource</span><span class="o">.</span><span class="nx">aws_instance</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åã‚’å–å¾—ï¼ˆ&#34;web&#34; ãªã©ï¼‰</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance_name</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[</span><span class="nx">name</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">input</span><span class="o">.</span><span class="nx">resource</span><span class="o">.</span><span class="nx">aws_instance</span><span class="p">[</span><span class="nx">name</span><span class="p">]][</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># ãƒªã‚½ãƒ¼ã‚¹ã®è©³ç´°ã‚’å–å¾—</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">resource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">input</span><span class="o">.</span><span class="nx">resource</span><span class="o">.</span><span class="nx">aws_instance</span><span class="p">[</span><span class="nx">instance_name</span><span class="p">][</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance_type</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">resource</span><span class="o">.</span><span class="nx">instance_type</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># é™çš„ãªå€¤ã®ã¿ãƒã‚§ãƒƒã‚¯ï¼ˆå¤‰æ•°å‚ç…§ã¯é™¤å¤–ï¼‰</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nf">is_string</span><span class="p">(</span><span class="nx">instance_type</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nf">startswith</span><span class="p">(</span><span class="nx">instance_type</span><span class="o">,</span><span class="w"> </span><span class="s2">&#34;t2.&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">sprintf</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s2">&#34;EC2 instance &#39;%s&#39; uses t2 generation. Migration to t3 is recommended&#34;</span><span class="o">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">[</span><span class="nx">instance_name</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># S3 ãƒã‚±ãƒƒãƒˆåã«ã¯ä¼šç¤¾ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãŒå¿…è¦</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">deny</span><span class="w"> </span><span class="kd">contains</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># aws_s3_bucket ãƒªã‚½ãƒ¼ã‚¹ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">input</span><span class="o">.</span><span class="nx">resource</span><span class="o">.</span><span class="nx">aws_s3_bucket</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># ãƒã‚±ãƒƒãƒˆåã‚’å–å¾—ï¼ˆ&#34;example&#34; ãªã©ï¼‰</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">bucket_name</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[</span><span class="nx">name</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">input</span><span class="o">.</span><span class="nx">resource</span><span class="o">.</span><span class="nx">aws_s3_bucket</span><span class="p">[</span><span class="nx">name</span><span class="p">]][</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># ãƒã‚±ãƒƒãƒˆã®è©³ç´°ã‚’å–å¾—</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">resource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">input</span><span class="o">.</span><span class="nx">resource</span><span class="o">.</span><span class="nx">aws_s3_bucket</span><span class="p">[</span><span class="nx">bucket_name</span><span class="p">][</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">bucket</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">resource</span><span class="o">.</span><span class="nx">bucket</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># é™çš„ãªå€¤ã®ã¿ãƒã‚§ãƒƒã‚¯</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nf">is_string</span><span class="p">(</span><span class="nx">bucket</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">not</span><span class="w"> </span><span class="nf">startswith</span><span class="p">(</span><span class="nx">bucket</span><span class="o">,</span><span class="w"> </span><span class="s2">&#34;mycompany-&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">sprintf</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s2">&#34;S3 bucket &#39;%s&#39; must start with &#39;mycompany-&#39;&#34;</span><span class="o">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">[</span><span class="nx">bucket</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ãƒãƒªã‚·ãƒ¼ã®è§£èª¬:</p>
<ol>
<li><code>package main</code>: Conftest ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸</li>
<li><code>import future.keywords.*</code>: ãƒ¢ãƒ€ãƒ³ãª Rego æ§‹æ–‡ã‚’ä½¿ç”¨</li>
<li><code>deny contains msg if { ... }</code>: ãƒãƒªã‚·ãƒ¼é•åã‚’å®šç¾©ï¼ˆãƒ†ã‚¹ãƒˆå¤±æ•—ï¼‰</li>
<li><code>sprintf()</code>: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¸ˆã¿ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç”Ÿæˆ</li>
</ol>
<h4 id="ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ<a hidden class="anchor" aria-hidden="true" href="#ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ">#</a></h4>
<p>ä½œæˆã—ãŸãƒãƒªã‚·ãƒ¼ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ conftest <span class="nb">test</span> example.tf --parser hcl2
</span></span></code></pre></div><p>å®Ÿè¡Œçµæœ:</p>
<pre tabindex="0"><code>FAIL - example.tf - main - EC2 instance &#39;web&#39; uses t2 generation. Migration to t3 is recommended
FAIL - example.tf - main - S3 bucket &#39;my-test-bucket&#39; must start with &#39;mycompany-&#39;

5 tests, 3 passed, 0 warnings, 2 failures, 0 exceptions
</code></pre><p>2ã¤ã®ãƒãƒªã‚·ãƒ¼é•åã‚’æ­£ã—ãæ¤œå‡ºã—ã¾ã—ãŸã€‚</p>
<p>ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£èª¬:</p>
<ul>
<li><code>--parser hcl2</code>: HCL2 å½¢å¼ã§ Terraform ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‘ãƒ¼ã‚¹</li>
<li><code>--policy policy/</code>: ãƒãƒªã‚·ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ <code>policy/</code> ã‚’å‚ç…§ï¼‰</li>
</ul>
<h4 id="ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã¦ã¿ã‚‹">ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã¦ã¿ã‚‹<a hidden class="anchor" aria-hidden="true" href="#ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã¦ã¿ã‚‹">#</a></h4>
<p>ãƒãƒªã‚·ãƒ¼é•åã‚’ä¿®æ­£ã—ã¾ã™ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="c1"># ä¿®æ­£å¾Œ: example.tf
</span></span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;aws_s3_bucket&#34; &#34;example&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  bucket</span> <span class="o">=</span> <span class="s2">&#34;mycompany-test-bucket&#34;</span><span class="c1">  # ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ 
</span></span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;aws_instance&#34; &#34;web&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  ami</span>           <span class="o">=</span> <span class="s2">&#34;ami-0c55b159cbfafe1f0&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">  instance_type</span> <span class="o">=</span> <span class="s2">&#34;t3.micro&#34;</span><span class="c1">  # t3 ä¸–ä»£ã«å¤‰æ›´
</span></span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>å†åº¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ conftest <span class="nb">test</span> example-fixed.tf --parser hcl2
</span></span></code></pre></div><p>å®Ÿè¡Œçµæœ:</p>
<pre tabindex="0"><code>5 tests, 5 passed, 0 warnings, 0 failures, 0 exceptions
</code></pre><p>ã™ã¹ã¦ã®ãƒãƒªã‚·ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚</p>
<h3 id="14-rego-ã®åŸºæœ¬æ§‹æ–‡">1.4 Rego ã®åŸºæœ¬æ§‹æ–‡<a hidden class="anchor" aria-hidden="true" href="#14-rego-ã®åŸºæœ¬æ§‹æ–‡">#</a></h3>
<p>Rego ã¯å®£è¨€çš„ãªãƒãƒªã‚·ãƒ¼è¨€èªã§ã™ã€‚ã“ã“ã§ã¯ã€Conftest ã§ã‚ˆãä½¿ã†æ§‹æ–‡ã‚’ã«è§£èª¬ã—ã¾ã™ã€‚</p>
<h4 id="141-å¤‰æ•°ã¨ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹">1.4.1 å¤‰æ•°ã¨ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹<a hidden class="anchor" aria-hidden="true" href="#141-å¤‰æ•°ã¨ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹">#</a></h4>
<p>åŸºæœ¬çš„ãªãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rego" data-lang="rego"><span class="line"><span class="cl"><span class="c"># ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">input</span><span class="o">.</span><span class="nx">resource</span><span class="o">.</span><span class="nx">aws_instance</span><span class="p">[</span><span class="s2">&#34;web&#34;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="nx">instance_type</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># å¤‰æ•°ã¸ã®ä»£å…¥</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">instance</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">input</span><span class="o">.</span><span class="nx">resource</span><span class="o">.</span><span class="nx">aws_instance</span><span class="p">[</span><span class="s2">&#34;web&#34;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">instance_type</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">instance</span><span class="o">.</span><span class="nx">instance_type</span><span class="w">  </span><span class="c"># &#34;t2.micro&#34;</span><span class="w">
</span></span></span></code></pre></div><p>é…åˆ—å†…åŒ…è¡¨è¨˜(ãƒªã‚¹ãƒˆç”Ÿæˆ)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rego" data-lang="rego"><span class="line"><span class="cl"><span class="c"># ã™ã¹ã¦ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åã‚’å–å¾—</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">instance_names</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[</span><span class="nx">name</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">input</span><span class="o">.</span><span class="nx">resource</span><span class="o">.</span><span class="nx">aws_instance</span><span class="p">[</span><span class="nx">name</span><span class="p">]]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># çµæœ: [&#34;web&#34;, &#34;app&#34;, &#34;db&#34;]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># ã™ã¹ã¦ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ã‚’å–å¾—</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">instance_types</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[</span><span class="nx">type</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">input</span><span class="o">.</span><span class="nx">resource</span><span class="o">.</span><span class="nx">aws_instance</span><span class="p">[</span><span class="nx">_</span><span class="p">][</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">type</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">instance</span><span class="o">.</span><span class="nx">instance_type</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># çµæœ: [&#34;t2.micro&#34;, &#34;t3.small&#34;, &#34;m5.large&#34;]</span><span class="w">
</span></span></span></code></pre></div><p>ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ <code>_</code> ã®ä½¿ç”¨</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rego" data-lang="rego"><span class="line"><span class="cl"><span class="c"># é…åˆ—ã®å„è¦ç´ ã‚’å–å¾—ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ä¸è¦ï¼‰</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">instance</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">input</span><span class="o">.</span><span class="nx">planned_values</span><span class="o">.</span><span class="nx">root_module</span><span class="o">.</span><span class="nx">resources</span><span class="p">[</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># ã™ã¹ã¦ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åã‚’å–å¾—</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">instance_name</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[</span><span class="nx">name</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">input</span><span class="o">.</span><span class="nx">resource</span><span class="o">.</span><span class="nx">aws_instance</span><span class="p">[</span><span class="nx">name</span><span class="p">]][</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span></code></pre></div><p><code>_</code> ã¯ã€Œä»»æ„ã®å€¤ã€ã‚’æ„å‘³ã—ã€ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ä½¿ç”¨ã—ã¾ã™ã€‚</p>
<h4 id="142-æ¡ä»¶åˆ†å²ã¨è«–ç†æ¼”ç®—">1.4.2 æ¡ä»¶åˆ†å²ã¨è«–ç†æ¼”ç®—<a hidden class="anchor" aria-hidden="true" href="#142-æ¡ä»¶åˆ†å²ã¨è«–ç†æ¼”ç®—">#</a></h4>
<p>AND æ¡ä»¶ï¼ˆæ”¹è¡Œã§æ¥ç¶šï¼‰:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rego" data-lang="rego"><span class="line"><span class="cl"><span class="n">deny</span><span class="w"> </span><span class="kd">contains</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">input</span><span class="o">.</span><span class="nx">resource</span><span class="o">.</span><span class="nx">aws_instance</span><span class="p">[</span><span class="nx">_</span><span class="p">][</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance</span><span class="o">.</span><span class="nx">instance_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&#34;t2.micro&#34;</span><span class="w">    </span><span class="c"># æ¡ä»¶1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">not</span><span class="w"> </span><span class="nx">instance</span><span class="o">.</span><span class="nx">tags</span><span class="w">                       </span><span class="c"># æ¡ä»¶2 (AND)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s2">&#34;t2.micro ã§ã‚¿ã‚°ãªã—ã¯ç¦æ­¢&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ã™ã¹ã¦ã®æ¡ä»¶ãŒçœŸã®å ´åˆã®ã¿ãƒ«ãƒ¼ãƒ«ãŒé©ç”¨ã•ã‚Œã¾ã™ã€‚</p>
<p>OR æ¡ä»¶(ã‚»ãƒƒãƒˆã§å®Ÿç¾)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rego" data-lang="rego"><span class="line"><span class="cl"><span class="c"># æ–¹æ³•1 ã‚»ãƒƒãƒˆãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">deny</span><span class="w"> </span><span class="kd">contains</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">input</span><span class="o">.</span><span class="nx">resource</span><span class="o">.</span><span class="nx">aws_instance</span><span class="p">[</span><span class="nx">_</span><span class="p">][</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance_type</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">instance</span><span class="o">.</span><span class="nx">instance_type</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># t2.micro ã¾ãŸã¯ t2.small ã®å ´åˆ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="s2">&#34;t2.micro&#34;</span><span class="o">,</span><span class="w"> </span><span class="s2">&#34;t2.small&#34;</span><span class="p">}[</span><span class="nx">instance_type</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s2">&#34;t2 ã‚·ãƒªãƒ¼ã‚ºã¯éæ¨å¥¨&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># æ–¹æ³•2 è¤‡æ•°ã®ãƒ«ãƒ¼ãƒ«</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">deny</span><span class="w"> </span><span class="kd">contains</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">input</span><span class="o">.</span><span class="nx">resource</span><span class="o">.</span><span class="nx">aws_instance</span><span class="p">[</span><span class="nx">_</span><span class="p">][</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance</span><span class="o">.</span><span class="nx">instance_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&#34;t2.micro&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s2">&#34;t2.micro ã¯éæ¨å¥¨&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">deny</span><span class="w"> </span><span class="kd">contains</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">input</span><span class="o">.</span><span class="nx">resource</span><span class="o">.</span><span class="nx">aws_instance</span><span class="p">[</span><span class="nx">_</span><span class="p">][</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance</span><span class="o">.</span><span class="nx">instance_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&#34;t2.small&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s2">&#34;t2.small ã¯éæ¨å¥¨&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>NOT æ¡ä»¶:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rego" data-lang="rego"><span class="line"><span class="cl"><span class="n">deny</span><span class="w"> </span><span class="kd">contains</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">bucket</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">input</span><span class="o">.</span><span class="nx">resource</span><span class="o">.</span><span class="nx">aws_s3_bucket</span><span class="p">[</span><span class="nx">_</span><span class="p">][</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># ã‚¿ã‚°ãŒå­˜åœ¨ã—ãªã„</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">not</span><span class="w"> </span><span class="nx">bucket</span><span class="o">.</span><span class="nx">tags</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s2">&#34;S3 bucket requires tags&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">deny</span><span class="w"> </span><span class="kd">contains</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">bucket</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">input</span><span class="o">.</span><span class="nx">resource</span><span class="o">.</span><span class="nx">aws_s3_bucket</span><span class="p">[</span><span class="nx">_</span><span class="p">][</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">bucket</span><span class="o">.</span><span class="nx">tags</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># Environment ã‚¿ã‚°ãŒå­˜åœ¨ã—ãªã„</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">not</span><span class="w"> </span><span class="nx">bucket</span><span class="o">.</span><span class="nx">tags</span><span class="o">.</span><span class="nx">Environment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s2">&#34;Environment tag is required&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h4 id="143-çµ„ã¿è¾¼ã¿é–¢æ•°">1.4.3 çµ„ã¿è¾¼ã¿é–¢æ•°<a hidden class="anchor" aria-hidden="true" href="#143-çµ„ã¿è¾¼ã¿é–¢æ•°">#</a></h4>
<p>æ–‡å­—åˆ—æ“ä½œ:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rego" data-lang="rego"><span class="line"><span class="cl"><span class="c"># æ–‡å­—åˆ—ã®é–‹å§‹ãƒã‚§ãƒƒã‚¯</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;t2.micro&#34;</span><span class="o">,</span><span class="w"> </span><span class="s2">&#34;t2.&#34;</span><span class="p">)</span><span class="w">      </span><span class="c"># true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># æ–‡å­—åˆ—ã®åŒ…å«ãƒã‚§ãƒƒã‚¯</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">contains</span><span class="p">(</span><span class="s2">&#34;t2.micro&#34;</span><span class="o">,</span><span class="w"> </span><span class="s2">&#34;micro&#34;</span><span class="p">)</span><span class="w">      </span><span class="c"># true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># æ–‡å­—åˆ—ã®é€£çµ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">concat</span><span class="p">(</span><span class="s2">&#34;-&#34;</span><span class="o">,</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;my&#34;</span><span class="o">,</span><span class="w"> </span><span class="s2">&#34;bucket&#34;</span><span class="p">])</span><span class="w">      </span><span class="c"># &#34;my-bucket&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># æ–‡å­—åˆ—ã®åˆ†å‰²</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">split</span><span class="p">(</span><span class="s2">&#34;10.0.0.0/16&#34;</span><span class="o">,</span><span class="w"> </span><span class="s2">&#34;/&#34;</span><span class="p">)</span><span class="w">          </span><span class="c"># [&#34;10.0.0.0&#34;, &#34;16&#34;]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># å¤§æ–‡å­—ãƒ»å°æ–‡å­—å¤‰æ›</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">upper</span><span class="p">(</span><span class="s2">&#34;test&#34;</span><span class="p">)</span><span class="w">                      </span><span class="c"># &#34;TEST&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">lower</span><span class="p">(</span><span class="s2">&#34;TEST&#34;</span><span class="p">)</span><span class="w">                      </span><span class="c"># &#34;test&#34;</span><span class="w">
</span></span></span></code></pre></div><p>å‹ãƒã‚§ãƒƒã‚¯:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rego" data-lang="rego"><span class="line"><span class="cl"><span class="n">is_string</span><span class="p">(</span><span class="s2">&#34;hello&#34;</span><span class="p">)</span><span class="w">                 </span><span class="c"># true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">is_number</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span><span class="w">                      </span><span class="c"># true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">is_boolean</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w">                   </span><span class="c"># true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">is_array</span><span class="p">([</span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="mi">2</span><span class="o">,</span><span class="w"> </span><span class="mi">3</span><span class="p">])</span><span class="w">                </span><span class="c"># true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">is_object</span><span class="p">({</span><span class="s2">&#34;key&#34;</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;value&#34;</span><span class="p">})</span><span class="w">        </span><span class="c"># true</span><span class="w">
</span></span></span></code></pre></div><p>æ•°å€¤æ“ä½œ:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rego" data-lang="rego"><span class="line"><span class="cl"><span class="c"># é…åˆ—ã®ã‚«ã‚¦ãƒ³ãƒˆ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">count</span><span class="p">([</span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="mi">2</span><span class="o">,</span><span class="w"> </span><span class="mi">3</span><span class="p">])</span><span class="w">                   </span><span class="c"># 3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># æ•°å€¤ã®å¤‰æ›</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">to_number</span><span class="p">(</span><span class="s2">&#34;42&#34;</span><span class="p">)</span><span class="w">                    </span><span class="c"># 42</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># æœ€å¤§å€¤ãƒ»æœ€å°å€¤</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">max</span><span class="p">([</span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="mi">5</span><span class="o">,</span><span class="w"> </span><span class="mi">3</span><span class="p">])</span><span class="w">                     </span><span class="c"># 5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">min</span><span class="p">([</span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="mi">5</span><span class="o">,</span><span class="w"> </span><span class="mi">3</span><span class="p">])</span><span class="w">                     </span><span class="c"># 1</span><span class="w">
</span></span></span></code></pre></div><p>ã‚»ãƒƒãƒˆæ“ä½œ:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rego" data-lang="rego"><span class="line"><span class="cl"><span class="c"># ã‚»ãƒƒãƒˆå®šç¾©</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">allowed_types</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">{</span><span class="s2">&#34;t3.micro&#34;</span><span class="o">,</span><span class="w"> </span><span class="s2">&#34;t3.small&#34;</span><span class="o">,</span><span class="w"> </span><span class="s2">&#34;t3.medium&#34;</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—ãƒã‚§ãƒƒã‚¯</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">allowed_types</span><span class="p">[</span><span class="s2">&#34;t3.micro&#34;</span><span class="p">]</span><span class="w">          </span><span class="c"># true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">allowed_types</span><span class="p">[</span><span class="s2">&#34;t2.micro&#34;</span><span class="p">]</span><span class="w">          </span><span class="c"># false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># ã‚»ãƒƒãƒˆã®çµåˆ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">union</span><span class="p">({</span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="mi">2</span><span class="p">}</span><span class="o">,</span><span class="w"> </span><span class="p">{</span><span class="mi">2</span><span class="o">,</span><span class="w"> </span><span class="mi">3</span><span class="p">})</span><span class="w">             </span><span class="c"># {1, 2, 3}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># ã‚»ãƒƒãƒˆã®å·®é›†åˆ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">set1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="mi">2</span><span class="o">,</span><span class="w"> </span><span class="mi">3</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">set2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">{</span><span class="mi">2</span><span class="o">,</span><span class="w"> </span><span class="mi">3</span><span class="o">,</span><span class="w"> </span><span class="mi">4</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">diff</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">set1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">set2</span><span class="w">                </span><span class="c"># {1}</span><span class="w">
</span></span></span></code></pre></div><h4 id="144-sprintf-ã«ã‚ˆã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ">1.4.4 sprintf ã«ã‚ˆã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ<a hidden class="anchor" aria-hidden="true" href="#144-sprintf-ã«ã‚ˆã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ">#</a></h4>
<p><code>sprintf</code> ã¯ã€å¤‰æ•°ã‚’å«ã‚€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆã™ã‚‹éš›ã«éå¸¸ã«ä¾¿åˆ©ã§ã™ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rego" data-lang="rego"><span class="line"><span class="cl"><span class="c"># åŸºæœ¬çš„ãªä½¿ç”¨</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">sprintf</span><span class="p">(</span><span class="s2">&#34;EC2 instance &#39;%s&#39; is not allowed&#34;</span><span class="o">,</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;web&#34;</span><span class="p">])</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># çµæœ: &#34;EC2 instance &#39;web&#39; is not allowed&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># è¤‡æ•°ã®å¤‰æ•°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">sprintf</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s2">&#34;EC2 instance &#39;%s&#39; instance type &#39;%s&#39; is not allowed&#34;</span><span class="o">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">[</span><span class="s2">&#34;web&#34;</span><span class="o">,</span><span class="w"> </span><span class="s2">&#34;t2.micro&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># çµæœ: &#34;EC2 instance &#39;web&#39; instance type &#39;t2.micro&#39; is not allowed&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># æ•°å€¤ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">sprintf</span><span class="p">(</span><span class="s2">&#34;Volume size is too large: %d GB&#34;</span><span class="o">,</span><span class="w"> </span><span class="p">[</span><span class="mi">1000</span><span class="p">])</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># çµæœ: &#34;Volume size is too large: 1000 GB&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># è¤‡é›‘ãªä¾‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">sprintf</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s2">&#34;%s &#39;%s&#39; has issues:\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s2">&#34;  - Type: %s (Allowed: %v)\n&#34;</span><span class="w"> </span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s2">&#34;  - Region: %s&#34;</span><span class="o">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">[</span><span class="s2">&#34;EC2&#34;</span><span class="o">,</span><span class="w"> </span><span class="s2">&#34;web&#34;</span><span class="o">,</span><span class="w"> </span><span class="s2">&#34;t2.micro&#34;</span><span class="o">,</span><span class="w"> </span><span class="nx">allowed_types</span><span class="o">,</span><span class="w"> </span><span class="s2">&#34;us-west-2&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæŒ‡å®šå­:</p>
<ul>
<li><code>%s</code>: æ–‡å­—åˆ—</li>
<li><code>%d</code>: æ•´æ•°</li>
<li><code>%v</code>: ä»»æ„ã®å€¤ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰</li>
</ul>
<h4 id="145-ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã®å®šç¾©">1.4.5 ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã®å®šç¾©<a hidden class="anchor" aria-hidden="true" href="#145-ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã®å®šç¾©">#</a></h4>
<p>ç¹°ã‚Šè¿”ã—ä½¿ç”¨ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã¯ã€ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã¨ã—ã¦å®šç¾©ã§ãã¾ã™ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rego" data-lang="rego"><span class="line"><span class="cl"><span class="c"># ç‰¹å®šã‚¿ã‚¤ãƒ—ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">get_resources</span><span class="p">(</span><span class="nx">resource_type</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">resources</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">resources</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[</span><span class="nx">resource</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">resource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">input</span><span class="o">.</span><span class="nx">planned_values</span><span class="o">.</span><span class="nx">root_module</span><span class="o">.</span><span class="nx">resources</span><span class="p">[</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">resource</span><span class="o">.</span><span class="nx">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">resource_type</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># ä½¿ç”¨ä¾‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">deny</span><span class="w"> </span><span class="kd">contains</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">get_resources</span><span class="p">(</span><span class="s2">&#34;aws_instance&#34;</span><span class="p">)[</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">instance_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&#34;t2.micro&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">sprintf</span><span class="p">(</span><span class="s2">&#34;EC2 instance &#39;%s&#39; uses t2.micro&#34;</span><span class="o">,</span><span class="w"> </span><span class="p">[</span><span class="nx">instance</span><span class="o">.</span><span class="nx">name</span><span class="p">])</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># è¤‡æ•°ã®æ¡ä»¶ã‚’æŒã¤ãƒ˜ãƒ«ãƒ‘ãƒ¼</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">is_production</span><span class="p">(</span><span class="nx">resource</span><span class="p">)</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">resource</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">tags</span><span class="o">.</span><span class="nx">Environment</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&#34;production&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># ä½¿ç”¨ä¾‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">deny</span><span class="w"> </span><span class="kd">contains</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">get_resources</span><span class="p">(</span><span class="s2">&#34;aws_instance&#34;</span><span class="p">)[</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nf">is_production</span><span class="p">(</span><span class="nx">instance</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">instance_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&#34;t2.micro&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s2">&#34;æœ¬ç•ªç’°å¢ƒã§ t2.micro ã¯ç¦æ­¢&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h4 id="146-objectget-ã«ã‚ˆã‚‹å®‰å…¨ãªã‚¢ã‚¯ã‚»ã‚¹">1.4.6 object.get ã«ã‚ˆã‚‹å®‰å…¨ãªã‚¢ã‚¯ã‚»ã‚¹<a hidden class="anchor" aria-hidden="true" href="#146-objectget-ã«ã‚ˆã‚‹å®‰å…¨ãªã‚¢ã‚¯ã‚»ã‚¹">#</a></h4>
<p>å­˜åœ¨ã—ãªã„ã‚­ãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚<code>object.get</code> ã‚’ä½¿ã†ã¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’æŒ‡å®šã§ãã¾ã™ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rego" data-lang="rego"><span class="line"><span class="cl"><span class="c"># é€šå¸¸ã®ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆã‚­ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ï¼‰</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">env</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">instance</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">tags</span><span class="o">.</span><span class="nx">Environment</span><span class="w">  </span><span class="c"># tags ãŒå­˜åœ¨ã—ãªã„å ´åˆã‚¨ãƒ©ãƒ¼</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># å®‰å…¨ãªã‚¢ã‚¯ã‚»ã‚¹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’æŒ‡å®šï¼‰</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">env</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">object</span><span class="o">.</span><span class="nf">get</span><span class="p">(</span><span class="nx">instance</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">tags</span><span class="o">,</span><span class="w"> </span><span class="s2">&#34;Environment&#34;</span><span class="o">,</span><span class="w"> </span><span class="s2">&#34;unknown&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># tags ãŒå­˜åœ¨ã—ãªã„å ´åˆ: &#34;unknown&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># å®Ÿè·µä¾‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">warn</span><span class="w"> </span><span class="kd">contains</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">db</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">get_resources</span><span class="p">(</span><span class="s2">&#34;aws_db_instance&#34;</span><span class="p">)[</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># backup_retention_period ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ 0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">period</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">object</span><span class="o">.</span><span class="nf">get</span><span class="p">(</span><span class="nx">db</span><span class="o">.</span><span class="nx">values</span><span class="o">,</span><span class="w"> </span><span class="s2">&#34;backup_retention_period&#34;</span><span class="o">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">period</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">7</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">sprintf</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s2">&#34;RDS &#39;%s&#39; ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿æŒæœŸé–“ãŒçŸ­ã™ãã¾ã™: %dæ—¥&#34;</span><span class="o">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">[</span><span class="nx">db</span><span class="o">.</span><span class="nx">name</span><span class="o">,</span><span class="w"> </span><span class="nx">period</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h4 id="147-è¤‡åˆæ¡ä»¶ã®ãƒã‚§ãƒƒã‚¯">1.4.7 è¤‡åˆæ¡ä»¶ã®ãƒã‚§ãƒƒã‚¯<a hidden class="anchor" aria-hidden="true" href="#147-è¤‡åˆæ¡ä»¶ã®ãƒã‚§ãƒƒã‚¯">#</a></h4>
<p>è¤‡æ•°ã®æ¡ä»¶ã‚’çµ„ã¿åˆã‚ã›ãŸå®Ÿè·µçš„ãªãƒãƒªã‚·ãƒ¼ã®ä¾‹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rego" data-lang="rego"><span class="line"><span class="cl"><span class="c"># æœ¬ç•ªç’°å¢ƒã® EC2 ã¯å³æ ¼ã«ãƒã‚§ãƒƒã‚¯</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">deny</span><span class="w"> </span><span class="kd">contains</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">get_resources</span><span class="p">(</span><span class="s2">&#34;aws_instance&#34;</span><span class="p">)[</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># æœ¬ç•ªç’°å¢ƒã‹ãƒã‚§ãƒƒã‚¯</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">tags</span><span class="o">.</span><span class="nx">Environment</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&#34;production&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># ã„ãšã‚Œã‹ã®æ¡ä»¶ã‚’æº€ãŸã•ãªã„å ´åˆ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">violations</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[</span><span class="nx">v</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># IMDSv2 ãŒç„¡åŠ¹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">not</span><span class="w"> </span><span class="nx">instance</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">metadata_options</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">v</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s2">&#34;IMDSv2 ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">violations2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[</span><span class="nx">v</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># ãƒ«ãƒ¼ãƒˆãƒœãƒªãƒ¥ãƒ¼ãƒ ãŒæš—å·åŒ–ã•ã‚Œã¦ã„ãªã„</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">instance</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">root_block_device</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">instance</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">root_block_device</span><span class="p">[</span><span class="nx">_</span><span class="p">]</span><span class="o">.</span><span class="nx">encrypted</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">v</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s2">&#34;ãƒ«ãƒ¼ãƒˆãƒœãƒªãƒ¥ãƒ¼ãƒ ãŒæš—å·åŒ–ã•ã‚Œã¦ã„ãªã„&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">violations3</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[</span><span class="nx">v</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c"># t2 ä¸–ä»£ã‚’ä½¿ç”¨</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nf">startswith</span><span class="p">(</span><span class="nx">instance</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">instance_type</span><span class="o">,</span><span class="w"> </span><span class="s2">&#34;t2.&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">v</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s2">&#34;t2 ä¸–ä»£ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½¿ç”¨&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># ã™ã¹ã¦ã®é•åã‚’çµåˆ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">all_violations</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">array</span><span class="o">.</span><span class="nf">concat</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">violations</span><span class="o">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">array</span><span class="o">.</span><span class="nf">concat</span><span class="p">(</span><span class="nx">violations2</span><span class="o">,</span><span class="w"> </span><span class="nx">violations3</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># 1ã¤ä»¥ä¸Šã®é•åãŒã‚ã‚‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nf">count</span><span class="p">(</span><span class="nx">all_violations</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">sprintf</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s2">&#34;Production EC2 instance &#39;%s&#39; has the following issues:\n%v&#34;</span><span class="o">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">[</span><span class="nx">instance</span><span class="o">.</span><span class="nx">name</span><span class="o">,</span><span class="w"> </span><span class="nx">all_violations</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>å®Ÿè¡Œçµæœã®ä¾‹:</p>
<pre tabindex="0"><code>FAIL - Production EC2 instance &#39;web&#39; has the following issues:
[&#34;IMDSv2 is not configured&#34;, &#34;Root volume is not encrypted&#34;]
</code></pre><h4 id="148-ãƒ‘ã‚¿ãƒ¼ãƒ³é›†">1.4.8 ãƒ‘ã‚¿ãƒ¼ãƒ³é›†<a hidden class="anchor" aria-hidden="true" href="#148-ãƒ‘ã‚¿ãƒ¼ãƒ³é›†">#</a></h4>
<p>ãƒ‘ã‚¿ãƒ¼ãƒ³1: ã™ã¹ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rego" data-lang="rego"><span class="line"><span class="cl"><span class="n">deny</span><span class="w"> </span><span class="kd">contains</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># ã™ã¹ã¦ã® aws_instance ã‚’å–å¾—</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance_name</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[</span><span class="nx">name</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">input</span><span class="o">.</span><span class="nx">resource</span><span class="o">.</span><span class="nx">aws_instance</span><span class="p">[</span><span class="nx">name</span><span class="p">]][</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">input</span><span class="o">.</span><span class="nx">resource</span><span class="o">.</span><span class="nx">aws_instance</span><span class="p">[</span><span class="nx">instance_name</span><span class="p">][</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># å„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">not</span><span class="w"> </span><span class="nx">instance</span><span class="o">.</span><span class="nx">tags</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">sprintf</span><span class="p">(</span><span class="s2">&#34;EC2 instance &#39;%s&#39; has no tags set&#34;</span><span class="o">,</span><span class="w"> </span><span class="p">[</span><span class="nx">instance_name</span><span class="p">])</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ãƒ‘ã‚¿ãƒ¼ãƒ³2: ç‰¹å®šã®æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã®ã¿ãƒã‚§ãƒƒã‚¯</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rego" data-lang="rego"><span class="line"><span class="cl"><span class="n">deny</span><span class="w"> </span><span class="kd">contains</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">get_resources</span><span class="p">(</span><span class="s2">&#34;aws_instance&#34;</span><span class="p">)[</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># æœ¬ç•ªç’°å¢ƒã®ãƒªã‚½ãƒ¼ã‚¹ã®ã¿</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">tags</span><span class="o">.</span><span class="nx">Environment</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&#34;production&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># æ¡ä»¶ãƒã‚§ãƒƒã‚¯</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">instance_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&#34;t2.micro&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">sprintf</span><span class="p">(</span><span class="s2">&#34;æœ¬ç•ªç’°å¢ƒã§ t2.micro ã¯ç¦æ­¢: &#39;%s&#39;&#34;</span><span class="o">,</span><span class="w"> </span><span class="p">[</span><span class="nx">instance</span><span class="o">.</span><span class="nx">name</span><span class="p">])</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ãƒ‘ã‚¿ãƒ¼ãƒ³3: é–¢é€£ãƒªã‚½ãƒ¼ã‚¹ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rego" data-lang="rego"><span class="line"><span class="cl"><span class="c"># S3 ãƒã‚±ãƒƒãƒˆã«æš—å·åŒ–è¨­å®šãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">deny</span><span class="w"> </span><span class="kd">contains</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">bucket</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">get_resources</span><span class="p">(</span><span class="s2">&#34;aws_s3_bucket&#34;</span><span class="p">)[</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">bucket_address</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">bucket</span><span class="o">.</span><span class="nx">address</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># æš—å·åŒ–è¨­å®šãŒå­˜åœ¨ã—ãªã„</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">not</span><span class="w"> </span><span class="nf">has_encryption</span><span class="p">(</span><span class="nx">bucket_address</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">sprintf</span><span class="p">(</span><span class="s2">&#34;S3 bucket &#39;%s&#39; requires encryption configuration&#34;</span><span class="o">,</span><span class="w"> </span><span class="p">[</span><span class="nx">bucket</span><span class="o">.</span><span class="nx">name</span><span class="p">])</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: æš—å·åŒ–è¨­å®šã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">has_encryption</span><span class="p">(</span><span class="nx">bucket_address</span><span class="p">)</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">encryption</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">get_resources</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s2">&#34;aws_s3_bucket_server_side_encryption_configuration&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)[</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">encryption</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">bucket</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">bucket_address</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ã“ã‚Œã§ Rego ã®åŸºæœ¬æ§‹æ–‡ã¯ç†è§£ã§ãã¾ã—ãŸã€‚æ¬¡ã¯ã€å®Ÿéš›ã® HCL ãƒ•ã‚¡ã‚¤ãƒ«ãƒ†ã‚¹ãƒˆã«é€²ã¿ã¾ã—ã‚‡ã†ã€‚</p>
<hr>
<h2 id="2-tfplanjson-ã‚’ã‚‚ã¨ã«ã™ã‚‹ãƒ†ã‚¹ãƒˆ">2. tfplan.json ã‚’ã‚‚ã¨ã«ã™ã‚‹ãƒ†ã‚¹ãƒˆ<a hidden class="anchor" aria-hidden="true" href="#2-tfplanjson-ã‚’ã‚‚ã¨ã«ã™ã‚‹ãƒ†ã‚¹ãƒˆ">#</a></h2>
<p>HCL ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ†ã‚¹ãƒˆã¯é«˜é€Ÿã§ã™ãŒå¤‰æ•°ã®å€¤ã‚„å‹•çš„ãªè¨­å®šã¯è©•ä¾¡ã§ãã¾ã›ã‚“ã€‚ãã“ã§ <code>tfplan.json</code> ã‚’ä½¿ã£ãŸãƒ†ã‚¹ãƒˆã‚’ç´¹ä»‹ã—ã¾ã™ã€‚</p>
<h3 id="21-ãªãœ-tfplanjson-ãªã®ã‹">2.1 ãªãœ tfplan.json ãªã®ã‹ï¼Ÿ<a hidden class="anchor" aria-hidden="true" href="#21-ãªãœ-tfplanjson-ãªã®ã‹">#</a></h3>
<h4 id="hcl-ãƒ†ã‚¹ãƒˆã®é™ç•Œ">HCL ãƒ†ã‚¹ãƒˆã®é™ç•Œ<a hidden class="anchor" aria-hidden="true" href="#hcl-ãƒ†ã‚¹ãƒˆã®é™ç•Œ">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="cl"><span class="k">variable</span> <span class="s2">&#34;instance_type&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  default</span> <span class="o">=</span> <span class="s2">&#34;t2.micro&#34;</span>
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">resource</span> <span class="s2">&#34;aws_instance&#34; &#34;web&#34;</span> {
</span></span><span class="line"><span class="cl"><span class="n">  instance_type</span> <span class="o">=</span> <span class="k">var</span><span class="p">.</span><span class="k">instance_type</span><span class="c1">  # â† ã“ã®å€¤ã¯ HCL ãƒ†ã‚¹ãƒˆã§ã¯åˆ†ã‹ã‚‰ãªã„
</span></span></span><span class="line"><span class="cl"><span class="n">  count</span>         <span class="o">=</span> <span class="k">var</span><span class="p">.</span><span class="k">enable</span> <span class="err">?</span> <span class="m">1</span> <span class="err">:</span> <span class="m">0</span><span class="c1">  # â† å‹•çš„ãªå€¤ã‚‚è©•ä¾¡ã§ããªã„
</span></span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><h4 id="tfplanjson-ã®å¼·ã¿">tfplan.json ã®å¼·ã¿<a hidden class="anchor" aria-hidden="true" href="#tfplanjson-ã®å¼·ã¿">#</a></h4>
<p><code>terraform show -json tfplan</code> ã§ç”Ÿæˆã•ã‚Œã‚‹ tfplan.json ã«ã¯ä¸‹è¨˜ãŒå«ã¾ã‚Œã¾ã™ã€‚</p>
<ul>
<li>å¤‰æ•°å±•é–‹å¾Œã®å®Ÿéš›ã®å€¤</li>
<li>count/for_each ã®çµæœ</li>
<li>ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å±•é–‹å¾Œã®çŠ¶æ…‹</li>
<li>è¨ˆç®—ã•ã‚ŒãŸã™ã¹ã¦ã®å€¤</li>
</ul>
<h3 id="22-tfplanjson-ã®ç”Ÿæˆ">2.2 tfplan.json ã®ç”Ÿæˆ<a hidden class="anchor" aria-hidden="true" href="#22-tfplanjson-ã®ç”Ÿæˆ">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">terraform init
</span></span><span class="line"><span class="cl">terraform plan -out<span class="o">=</span>tfplan
</span></span><span class="line"><span class="cl">terraform show -json tfplan &gt; tfplan.json
</span></span></code></pre></div><h3 id="23-tfplanjson-ã®æ§‹é€ ">2.3 tfplan.json ã®æ§‹é€ <a hidden class="anchor" aria-hidden="true" href="#23-tfplanjson-ã®æ§‹é€ ">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;format_version&#34;</span><span class="p">:</span> <span class="s2">&#34;1.2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;terraform_version&#34;</span><span class="p">:</span> <span class="s2">&#34;1.6.0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;planned_values&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;root_module&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;resources&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="s2">&#34;aws_instance.web&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;aws_instance&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;web&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;values&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;ami&#34;</span><span class="p">:</span> <span class="s2">&#34;ami-0c55b159cbfafe1f0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;instance_type&#34;</span><span class="p">:</span> <span class="s2">&#34;t2.micro&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;tags&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;Name&#34;</span><span class="p">:</span> <span class="s2">&#34;web-server&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;Environment&#34;</span><span class="p">:</span> <span class="s2">&#34;production&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rego" data-lang="rego"><span class="line"><span class="cl"><span class="c"># ãƒªã‚½ãƒ¼ã‚¹ã®å–å¾—</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">resource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">input</span><span class="o">.</span><span class="nx">planned_values</span><span class="o">.</span><span class="nx">root_module</span><span class="o">.</span><span class="nx">resources</span><span class="p">[</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">resource</span><span class="o">.</span><span class="nx">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&#34;aws_instance&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">resource</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">instance_type</span><span class="w">  </span><span class="c"># &#34;t2.micro&#34;</span><span class="w">
</span></span></span></code></pre></div><h2 id="3-ãƒãƒªã‚·ãƒ¼ä¾‹">3 ãƒãƒªã‚·ãƒ¼ä¾‹<a hidden class="anchor" aria-hidden="true" href="#3-ãƒãƒªã‚·ãƒ¼ä¾‹">#</a></h2>
<h3 id="31-ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—">3.1 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—<a hidden class="anchor" aria-hidden="true" href="#31-ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rego" data-lang="rego"><span class="line"><span class="cl"><span class="kd">package</span><span class="w"> </span><span class="nx">main</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">import</span><span class="w"> </span><span class="nx">future</span><span class="o">.</span><span class="nx">keywords</span><span class="o">.</span><span class="kd">contains</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="kd">import</span><span class="w"> </span><span class="nx">future</span><span class="o">.</span><span class="nx">keywords</span><span class="o">.</span><span class="kd">if</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: ãƒªã‚½ãƒ¼ã‚¹å–å¾—</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">get_resources</span><span class="p">(</span><span class="nx">resource_type</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">resources</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">resources</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[</span><span class="nx">resource</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">resource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">input</span><span class="o">.</span><span class="nx">planned_values</span><span class="o">.</span><span class="nx">root_module</span><span class="o">.</span><span class="nx">resources</span><span class="p">[</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">resource</span><span class="o">.</span><span class="nx">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">resource_type</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ã®ãƒã‚§ãƒƒã‚¯</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">deny</span><span class="w"> </span><span class="kd">contains</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">resource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">get_resources</span><span class="p">(</span><span class="s2">&#34;aws_instance&#34;</span><span class="p">)[</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># å®Ÿéš›ã®å€¤ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆå¤‰æ•°å±•é–‹æ¸ˆã¿ï¼‰</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">resource</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">instance_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&#34;t2.micro&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">sprintf</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s2">&#34;EC2 instance &#39;%s&#39; must be t2.micro. Current: %s&#34;</span><span class="o">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">[</span><span class="nx">resource</span><span class="o">.</span><span class="nx">name</span><span class="o">,</span><span class="w"> </span><span class="nx">resource</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">instance_type</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="32-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼">3.2 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼<a hidden class="anchor" aria-hidden="true" href="#32-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼">#</a></h3>
<h4 id="s3-æš—å·åŒ–ã®å¿…é ˆåŒ–">S3 æš—å·åŒ–ã®å¿…é ˆåŒ–<a hidden class="anchor" aria-hidden="true" href="#s3-æš—å·åŒ–ã®å¿…é ˆåŒ–">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rego" data-lang="rego"><span class="line"><span class="cl"><span class="c"># S3 ãƒã‚±ãƒƒãƒˆã«ã¯æš—å·åŒ–ãŒå¿…é ˆ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">deny</span><span class="w"> </span><span class="kd">contains</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">bucket</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">get_resources</span><span class="p">(</span><span class="s2">&#34;aws_s3_bucket&#34;</span><span class="p">)[</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">bucket_address</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">bucket</span><span class="o">.</span><span class="nx">address</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># æš—å·åŒ–è¨­å®šã®æœ‰ç„¡ã‚’ç¢ºèª</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">not</span><span class="w"> </span><span class="nf">has_encryption</span><span class="p">(</span><span class="nx">bucket_address</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">sprintf</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s2">&#34;S3 bucket &#39;%s&#39; requires encryption configuration&#34;</span><span class="o">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">[</span><span class="nx">bucket</span><span class="o">.</span><span class="nx">name</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># æš—å·åŒ–è¨­å®šã®å­˜åœ¨ç¢ºèª</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">has_encryption</span><span class="p">(</span><span class="nx">bucket_address</span><span class="p">)</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">encryption</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">get_resources</span><span class="p">(</span><span class="s2">&#34;aws_s3_bucket_server_side_encryption_configuration&#34;</span><span class="p">)[</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">encryption</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">bucket</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">bucket_address</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h4 id="imdsv2-ã®å¿…é ˆåŒ–">IMDSv2 ã®å¿…é ˆåŒ–<a hidden class="anchor" aria-hidden="true" href="#imdsv2-ã®å¿…é ˆåŒ–">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rego" data-lang="rego"><span class="line"><span class="cl"><span class="c"># EC2 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ IMDSv2 ã‚’å¿…é ˆã¨ã™ã‚‹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">deny</span><span class="w"> </span><span class="kd">contains</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">get_resources</span><span class="p">(</span><span class="s2">&#34;aws_instance&#34;</span><span class="p">)[</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># metadata_options ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">not</span><span class="w"> </span><span class="nx">instance</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">metadata_options</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">sprintf</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s2">&#34;EC2 instance &#39;%s&#39; ã¯ IMDSv2 ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™&#34;</span><span class="o">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">[</span><span class="nx">instance</span><span class="o">.</span><span class="nx">name</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">deny</span><span class="w"> </span><span class="kd">contains</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">get_resources</span><span class="p">(</span><span class="s2">&#34;aws_instance&#34;</span><span class="p">)[</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">metadata_options</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># http_tokens ãŒ required ã§ãªã„</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">metadata_options</span><span class="p">[</span><span class="nx">_</span><span class="p">]</span><span class="o">.</span><span class="nx">http_tokens</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">&#34;required&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">sprintf</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s2">&#34;EC2 instance &#39;%s&#39; ã® IMDSv2 ãŒæœ‰åŠ¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“&#34;</span><span class="o">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">[</span><span class="nx">instance</span><span class="o">.</span><span class="nx">name</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="33-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã®å³æ ¼ãªãƒã‚§ãƒƒã‚¯">3.3 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã®å³æ ¼ãªãƒã‚§ãƒƒã‚¯<a hidden class="anchor" aria-hidden="true" href="#33-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã®å³æ ¼ãªãƒã‚§ãƒƒã‚¯">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rego" data-lang="rego"><span class="line"><span class="cl"><span class="c"># å±é™ºãªãƒãƒ¼ãƒˆã®å…¨å…¬é–‹ã‚’ç¦æ­¢</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">deny</span><span class="w"> </span><span class="kd">contains</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">get_resources</span><span class="p">(</span><span class="s2">&#34;aws_security_group&#34;</span><span class="p">)[</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">ingress</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sg</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">ingress</span><span class="p">[</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># 0.0.0.0/0 ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">cidr</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ingress</span><span class="o">.</span><span class="nx">cidr_blocks</span><span class="p">[</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">cidr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&#34;0.0.0.0/0&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># å±é™ºãªãƒãƒ¼ãƒˆ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">dangerous_ports</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">{</span><span class="mi">22</span><span class="o">,</span><span class="w"> </span><span class="mi">3389</span><span class="o">,</span><span class="w"> </span><span class="mi">3306</span><span class="o">,</span><span class="w"> </span><span class="mi">5432</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">port</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">dangerous_ports</span><span class="p">[</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">ingress</span><span class="o">.</span><span class="nx">from_port</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">port</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">ingress</span><span class="o">.</span><span class="nx">to_port</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">port</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">port_names</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="mi">22</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;SSH&#34;</span><span class="o">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="mi">3389</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;RDP&#34;</span><span class="o">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="mi">3306</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;MySQL&#34;</span><span class="o">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="mi">5432</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;PostgreSQL&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">sprintf</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s2">&#34;Security group &#39;%s&#39; exposes %s (port %d) to 0.0.0.0/0&#34;</span><span class="o">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">[</span><span class="nx">sg</span><span class="o">.</span><span class="nx">name</span><span class="o">,</span><span class="w"> </span><span class="nx">port_names</span><span class="p">[</span><span class="nx">port</span><span class="p">]</span><span class="o">,</span><span class="w"> </span><span class="nx">port</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="34-ã‚¿ã‚°ãƒãƒªã‚·ãƒ¼">3.4 ã‚¿ã‚°ãƒãƒªã‚·ãƒ¼<a hidden class="anchor" aria-hidden="true" href="#34-ã‚¿ã‚°ãƒãƒªã‚·ãƒ¼">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rego" data-lang="rego"><span class="line"><span class="cl"><span class="c"># å¿…é ˆã‚¿ã‚°ã®å®šç¾©</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">required_tags</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">{</span><span class="s2">&#34;Environment&#34;</span><span class="o">,</span><span class="w"> </span><span class="s2">&#34;Owner&#34;</span><span class="o">,</span><span class="w"> </span><span class="s2">&#34;Project&#34;</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">allowed_environments</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">{</span><span class="s2">&#34;production&#34;</span><span class="o">,</span><span class="w"> </span><span class="s2">&#34;staging&#34;</span><span class="o">,</span><span class="w"> </span><span class="s2">&#34;development&#34;</span><span class="o">,</span><span class="w"> </span><span class="s2">&#34;test&#34;</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># ã‚¿ã‚°ä»˜ã‘å¯èƒ½ãªãƒªã‚½ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">taggable_resources</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s2">&#34;aws_instance&#34;</span><span class="o">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s2">&#34;aws_s3_bucket&#34;</span><span class="o">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s2">&#34;aws_db_instance&#34;</span><span class="o">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s2">&#34;aws_vpc&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># å¿…é ˆã‚¿ã‚°ã®å­˜åœ¨ç¢ºèª</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">deny</span><span class="w"> </span><span class="kd">contains</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">resource_type</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">taggable_resources</span><span class="p">[</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">resource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">get_resources</span><span class="p">(</span><span class="nx">resource_type</span><span class="p">)[</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># ã‚¿ã‚°ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">not</span><span class="w"> </span><span class="nx">resource</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">tags</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">sprintf</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s2">&#34;%s &#39;%s&#39; has no tags set. Required tags: %v&#34;</span><span class="o">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">[</span><span class="nx">resource_type</span><span class="o">,</span><span class="w"> </span><span class="nx">resource</span><span class="o">.</span><span class="nx">name</span><span class="o">,</span><span class="w"> </span><span class="nx">required_tags</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># ç‰¹å®šã®ã‚¿ã‚°ãŒæ¬ è½ã—ã¦ã„ã‚‹å ´åˆ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">deny</span><span class="w"> </span><span class="kd">contains</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">resource_type</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">taggable_resources</span><span class="p">[</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">resource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">get_resources</span><span class="p">(</span><span class="nx">resource_type</span><span class="p">)[</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">resource</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">tags</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># å¿…é ˆã‚¿ã‚°ãŒæ¬ è½</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">required_tag</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">required_tags</span><span class="p">[</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">not</span><span class="w"> </span><span class="nx">resource</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">tags</span><span class="p">[</span><span class="nx">required_tag</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">sprintf</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s2">&#34;%s &#39;%s&#39; is missing required tag &#39;%s&#39;&#34;</span><span class="o">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">[</span><span class="nx">resource_type</span><span class="o">,</span><span class="w"> </span><span class="nx">resource</span><span class="o">.</span><span class="nx">name</span><span class="o">,</span><span class="w"> </span><span class="nx">required_tag</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># Environment ã‚¿ã‚°ã®å€¤æ¤œè¨¼</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">deny</span><span class="w"> </span><span class="kd">contains</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">resource_type</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">taggable_resources</span><span class="p">[</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">resource</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">get_resources</span><span class="p">(</span><span class="nx">resource_type</span><span class="p">)[</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">resource</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">tags</span><span class="o">.</span><span class="nx">Environment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">env</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">resource</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">tags</span><span class="o">.</span><span class="nx">Environment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">not</span><span class="w"> </span><span class="nx">allowed_environments</span><span class="p">[</span><span class="nx">env</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">sprintf</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s2">&#34;%s &#39;%s&#39; Environment tag value &#39;%s&#39; is invalid. Allowed values: %v&#34;</span><span class="o">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">[</span><span class="nx">resource_type</span><span class="o">,</span><span class="w"> </span><span class="nx">resource</span><span class="o">.</span><span class="nx">name</span><span class="o">,</span><span class="w"> </span><span class="nx">env</span><span class="o">,</span><span class="w"> </span><span class="nx">allowed_environments</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="35-ã‚³ã‚¹ãƒˆæœ€é©åŒ–ãƒãƒªã‚·ãƒ¼">3.5 ã‚³ã‚¹ãƒˆæœ€é©åŒ–ãƒãƒªã‚·ãƒ¼<a hidden class="anchor" aria-hidden="true" href="#35-ã‚³ã‚¹ãƒˆæœ€é©åŒ–ãƒãƒªã‚·ãƒ¼">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rego" data-lang="rego"><span class="line"><span class="cl"><span class="c"># è¨±å¯ã•ã‚ŒãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">allowed_instance_types</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s2">&#34;t3.micro&#34;</span><span class="o">,</span><span class="w"> </span><span class="s2">&#34;t3.small&#34;</span><span class="o">,</span><span class="w"> </span><span class="s2">&#34;t3.medium&#34;</span><span class="o">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s2">&#34;m5.large&#34;</span><span class="o">,</span><span class="w"> </span><span class="s2">&#34;m5.xlarge&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ã®åˆ¶é™</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">deny</span><span class="w"> </span><span class="kd">contains</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">get_resources</span><span class="p">(</span><span class="s2">&#34;aws_instance&#34;</span><span class="p">)[</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance_type</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">instance</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">instance_type</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">not</span><span class="w"> </span><span class="nx">allowed_instance_types</span><span class="p">[</span><span class="nx">instance_type</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">sprintf</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s2">&#34;EC2 instance &#39;%s&#39; instance type &#39;%s&#39; is not allowed. Allowed types: %v&#34;</span><span class="o">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">[</span><span class="nx">instance</span><span class="o">.</span><span class="nx">name</span><span class="o">,</span><span class="w"> </span><span class="nx">instance_type</span><span class="o">,</span><span class="w"> </span><span class="nx">allowed_instance_types</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># é–‹ç™ºç’°å¢ƒã§ Multi-AZ ã¯ä¸è¦</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">warn</span><span class="w"> </span><span class="kd">contains</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">db</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">get_resources</span><span class="p">(</span><span class="s2">&#34;aws_db_instance&#34;</span><span class="p">)[</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">db</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">tags</span><span class="o">.</span><span class="nx">Environment</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&#34;development&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">db</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">multi_az</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">sprintf</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s2">&#34;RDS instance &#39;%s&#39; has Multi-AZ enabled in development. Multi-AZ is usually unnecessary for development and wastes cost&#34;</span><span class="o">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">[</span><span class="nx">db</span><span class="o">.</span><span class="nx">name</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="36-è¤‡é›‘ãªãƒãƒªã‚·ãƒ¼ãƒªã‚½ãƒ¼ã‚¹é–“ã®é–¢ä¿‚">3.6 è¤‡é›‘ãªãƒãƒªã‚·ãƒ¼ï¼ˆãƒªã‚½ãƒ¼ã‚¹é–“ã®é–¢ä¿‚ï¼‰<a hidden class="anchor" aria-hidden="true" href="#36-è¤‡é›‘ãªãƒãƒªã‚·ãƒ¼ãƒªã‚½ãƒ¼ã‚¹é–“ã®é–¢ä¿‚">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rego" data-lang="rego"><span class="line"><span class="cl"><span class="c"># EC2 ãŒ VPC å†…ã«ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">warn</span><span class="w"> </span><span class="kd">contains</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">get_resources</span><span class="p">(</span><span class="s2">&#34;aws_instance&#34;</span><span class="p">)[</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># subnet_id ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">not</span><span class="w"> </span><span class="nx">instance</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">subnet_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">sprintf</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s2">&#34;EC2 instance &#39;%s&#39; ãŒ VPC å†…ã«é…ç½®ã•ã‚Œã¦ã„ã¾ã›ã‚“&#34;</span><span class="o">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">[</span><span class="nx">instance</span><span class="o">.</span><span class="nx">name</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="c"># æœ¬ç•ªç’°å¢ƒã®ãƒªã‚½ãƒ¼ã‚¹ã¯é©åˆ‡ãªè¨­å®šã‚’æŒã¤ã¹ã</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="n">deny</span><span class="w"> </span><span class="kd">contains</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="kd">if</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">get_resources</span><span class="p">(</span><span class="s2">&#34;aws_instance&#34;</span><span class="p">)[</span><span class="nx">_</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">instance</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">tags</span><span class="o">.</span><span class="nx">Environment</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&#34;production&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã®ãƒã‚§ãƒƒã‚¯</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">violations</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[</span><span class="nx">v</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">not</span><span class="w"> </span><span class="nx">instance</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">metadata_options</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">v</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s2">&#34;IMDSv2 ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">violations2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[</span><span class="nx">v</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">instance</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">root_block_device</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">instance</span><span class="o">.</span><span class="nx">values</span><span class="o">.</span><span class="nx">root_block_device</span><span class="p">[</span><span class="nx">_</span><span class="p">]</span><span class="o">.</span><span class="nx">encrypted</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nx">v</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s2">&#34;ãƒ«ãƒ¼ãƒˆãƒœãƒªãƒ¥ãƒ¼ãƒ ãŒæš—å·åŒ–ã•ã‚Œã¦ã„ãªã„&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">all_violations</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">array</span><span class="o">.</span><span class="nf">concat</span><span class="p">(</span><span class="nx">violations</span><span class="o">,</span><span class="w"> </span><span class="nx">violations2</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nf">count</span><span class="p">(</span><span class="nx">all_violations</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nf">sprintf</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s2">&#34;Production EC2 instance &#39;%s&#39; has issues: %v&#34;</span><span class="o">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">[</span><span class="nx">instance</span><span class="o">.</span><span class="nx">name</span><span class="o">,</span><span class="w"> </span><span class="nx">all_violations</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="37-å®Ÿè¡Œä¾‹">3.7 å®Ÿè¡Œä¾‹<a hidden class="anchor" aria-hidden="true" href="#37-å®Ÿè¡Œä¾‹">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Terraform ãƒ—ãƒ©ãƒ³ç”Ÿæˆ</span>
</span></span><span class="line"><span class="cl">$ terraform init
</span></span><span class="line"><span class="cl">$ <span class="nv">AWS_PROFILE</span><span class="o">=</span><span class="s2">&#34;&#34;</span> <span class="nv">AWS_EC2_METADATA_DISABLED</span><span class="o">=</span><span class="nb">true</span> <span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span><span class="s2">&#34;test&#34;</span> <span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span><span class="s2">&#34;test&#34;</span> <span class="nv">AWS_DEFAULT_REGION</span><span class="o">=</span><span class="s2">&#34;us-west-2&#34;</span> terraform plan -out<span class="o">=</span>tfplan
</span></span><span class="line"><span class="cl">$ terraform show -json tfplan &gt; tfplan.json
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Conftest å®Ÿè¡Œ</span>
</span></span><span class="line"><span class="cl">$ conftest <span class="nb">test</span> tfplan.json --policy policy/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">FAIL - tfplan.json - EC2 instance <span class="s1">&#39;web&#39;</span> uses t2.micro. Current: t2.micro
</span></span><span class="line"><span class="cl">FAIL - tfplan.json - S3 bucket <span class="s1">&#39;data&#39;</span> requires encryption configuration
</span></span><span class="line"><span class="cl">FAIL - tfplan.json - Security group <span class="s1">&#39;web&#39;</span> exposes SSH <span class="o">(</span>port 22<span class="o">)</span> to 0.0.0.0/0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">5</span> tests, <span class="m">2</span> passed, <span class="m">0</span> warnings, <span class="m">3</span> failures, <span class="m">0</span> exceptions
</span></span></code></pre></div><hr>
<h2 id="å‚è€ƒè³‡æ–™">å‚è€ƒè³‡æ–™<a hidden class="anchor" aria-hidden="true" href="#å‚è€ƒè³‡æ–™">#</a></h2>
<h3 id="å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ">å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ<a hidden class="anchor" aria-hidden="true" href="#å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ">#</a></h3>
<ul>
<li><a href="https://www.conftest.dev/">Conftest å…¬å¼ã‚µã‚¤ãƒˆ</a></li>
<li><a href="https://www.openpolicyagent.org/docs/latest/terraform/">Open Policy Agent ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</a></li>
<li><a href="https://developer.hashicorp.com/terraform">Terraform å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</a></li>
</ul>
<h3 id="ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚¬ã‚¤ãƒ‰">ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãƒ»ã‚¬ã‚¤ãƒ‰<a hidden class="anchor" aria-hidden="true" href="#ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚¬ã‚¤ãƒ‰">#</a></h3>
<ul>
<li><a href="https://policyascode.dev/guides/opa-terraform-policy-guide/">OPA &amp; Terraform: The Definitive Guide (2025 Edition)</a></li>
<li><a href="https://www.vroble.com/2025/11/beyond-terraform-plan-how-policy-as.html">Beyond terraform plan: Policy as Code with OPA</a></li>
<li><a href="https://dev.to/prince_of_pasta/securing-your-terraform-pipelines-with-conftest-regula-and-opa-4hkh">Securing Terraform Pipelines with Conftest and OPA</a></li>
</ul>
<hr>
<h2 id="ãŠã‚ã‚Šã«">ãŠã‚ã‚Šã«<a hidden class="anchor" aria-hidden="true" href="#ãŠã‚ã‚Šã«">#</a></h2>
<p>IaC ã‚³ãƒ¼ãƒ‰é–‹ç™ºã«å¯¾ã—ã¦ Rego ãƒãƒªã‚·ã®åˆ¶ç´„ã‚’åŠ ãˆã‚‹ã“ã¨ã§ã€ã‚ˆã‚Šå®‰å…¨ã«é–‹ç™ºãŒè¡Œãˆã‚‹äº‹ãŒåˆ†ã‹ã‚Šã¾ã—ãŸã€‚ç‰¹ã«è¤‡æ•°åã§é–‹ç™ºã‚’è¡Œã†å ´åˆã‚„ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ãŒç¤¾å†…çš„ã«ã‚ã‚‹å ´åˆã«äººã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã¯æ¼ã‚Œã‚‹æã‚ŒãŒã‚ã‚‹ã®ã§ã€æ©Ÿæ¢°çš„ã«åˆ¶ç´„ã‚’åŠ ãˆã‚‰ã‚Œã‚‹äº‹ã¯ãƒ¡ãƒªãƒƒãƒˆå¤§ãã„ã¨æ€ã£ã¦ã„ã¾ã™ã€‚</p>
<p>ã¾ãŸã€Conftest ã¨ OPA ã¯å­¦ç¿’ã‚³ã‚¹ãƒˆãŒä½ãã™ãã«å§‹ã‚ã‚‰ã‚Œã‚‹ã®ã‚‚ãƒ¡ãƒªãƒƒãƒˆãŒå¤§ãã„ã§ã™ã€‚ã€‚å°ã•ãªãƒãƒªã‚·ãƒ¼ã‹ã‚‰å§‹ã‚ã¦ã€æ®µéšçš„ã«æ‹¡å¤§ã—ã¦ã„ãã®ãŒè‰¯ã„ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚</p>


  </div>

  <footer class="post-footer">
<nav class="paginav">
  <a class="next" href="https://jedipunkz.github.io/post/discord-exporter/">
    <span class="title">Next Â»</span>
    <br>
    <span>Prometheus Exporter é–‹ç™ºã§ Discord ã‚µãƒ¼ãƒé‹å–¶ã®å¥å…¨åŒ–ã‚’å›³ã‚‹</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Conftest OPA ã§ Terraform ã‚³ãƒ¼ãƒ‰é–‹ç™ºã«åˆ¶ç´„ã‚’è¨­ã‘ã‚‹ on x"
            href="https://x.com/intent/tweet/?text=Conftest%20OPA%20%e3%81%a7%20Terraform%20%e3%82%b3%e3%83%bc%e3%83%89%e9%96%8b%e7%99%ba%e3%81%ab%e5%88%b6%e7%b4%84%e3%82%92%e8%a8%ad%e3%81%91%e3%82%8b&amp;url=https%3a%2f%2fjedipunkz.github.io%2fpost%2fconftest%2f&amp;hashtags=">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Conftest OPA ã§ Terraform ã‚³ãƒ¼ãƒ‰é–‹ç™ºã«åˆ¶ç´„ã‚’è¨­ã‘ã‚‹ on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fjedipunkz.github.io%2fpost%2fconftest%2f&amp;title=Conftest%20OPA%20%e3%81%a7%20Terraform%20%e3%82%b3%e3%83%bc%e3%83%89%e9%96%8b%e7%99%ba%e3%81%ab%e5%88%b6%e7%b4%84%e3%82%92%e8%a8%ad%e3%81%91%e3%82%8b&amp;summary=Conftest%20OPA%20%e3%81%a7%20Terraform%20%e3%82%b3%e3%83%bc%e3%83%89%e9%96%8b%e7%99%ba%e3%81%ab%e5%88%b6%e7%b4%84%e3%82%92%e8%a8%ad%e3%81%91%e3%82%8b&amp;source=https%3a%2f%2fjedipunkz.github.io%2fpost%2fconftest%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Conftest OPA ã§ Terraform ã‚³ãƒ¼ãƒ‰é–‹ç™ºã«åˆ¶ç´„ã‚’è¨­ã‘ã‚‹ on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2fjedipunkz.github.io%2fpost%2fconftest%2f&title=Conftest%20OPA%20%e3%81%a7%20Terraform%20%e3%82%b3%e3%83%bc%e3%83%89%e9%96%8b%e7%99%ba%e3%81%ab%e5%88%b6%e7%b4%84%e3%82%92%e8%a8%ad%e3%81%91%e3%82%8b">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Conftest OPA ã§ Terraform ã‚³ãƒ¼ãƒ‰é–‹ç™ºã«åˆ¶ç´„ã‚’è¨­ã‘ã‚‹ on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fjedipunkz.github.io%2fpost%2fconftest%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Conftest OPA ã§ Terraform ã‚³ãƒ¼ãƒ‰é–‹ç™ºã«åˆ¶ç´„ã‚’è¨­ã‘ã‚‹ on whatsapp"
            href="https://api.whatsapp.com/send?text=Conftest%20OPA%20%e3%81%a7%20Terraform%20%e3%82%b3%e3%83%bc%e3%83%89%e9%96%8b%e7%99%ba%e3%81%ab%e5%88%b6%e7%b4%84%e3%82%92%e8%a8%ad%e3%81%91%e3%82%8b%20-%20https%3a%2f%2fjedipunkz.github.io%2fpost%2fconftest%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Conftest OPA ã§ Terraform ã‚³ãƒ¼ãƒ‰é–‹ç™ºã«åˆ¶ç´„ã‚’è¨­ã‘ã‚‹ on telegram"
            href="https://telegram.me/share/url?text=Conftest%20OPA%20%e3%81%a7%20Terraform%20%e3%82%b3%e3%83%bc%e3%83%89%e9%96%8b%e7%99%ba%e3%81%ab%e5%88%b6%e7%b4%84%e3%82%92%e8%a8%ad%e3%81%91%e3%82%8b&amp;url=https%3a%2f%2fjedipunkz.github.io%2fpost%2fconftest%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Conftest OPA ã§ Terraform ã‚³ãƒ¼ãƒ‰é–‹ç™ºã«åˆ¶ç´„ã‚’è¨­ã‘ã‚‹ on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Conftest%20OPA%20%e3%81%a7%20Terraform%20%e3%82%b3%e3%83%bc%e3%83%89%e9%96%8b%e7%99%ba%e3%81%ab%e5%88%b6%e7%b4%84%e3%82%92%e8%a8%ad%e3%81%91%e3%82%8b&u=https%3a%2f%2fjedipunkz.github.io%2fpost%2fconftest%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://jedipunkz.github.io/">jedipunkz ğŸš€ ã®ãƒ–ãƒ­ã‚°</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
