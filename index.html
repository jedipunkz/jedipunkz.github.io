<!DOCTYPE HTML>

<html>
    <head>
        
            
                <title>ジェダイさんのブログ</title>
            
        

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="generator" content="Hugo 0.53" />
        


        
        
            
        

        <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ジェダイさんのブログ"/>
<meta name="twitter:description" content=""/>

        <meta property="og:title" content="ジェダイさんのブログ" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://jedipunkz.github.io/" />
<meta property="og:updated_time" content="2018-12-31T00:00:00&#43;00:00"/>

        
<meta itemprop="name" content="ジェダイさんのブログ">
<meta itemprop="description" content="">


        

        

        
        
            
        

        
        
            <link rel="stylesheet" href="/css/google-font.css" />
            <link rel="stylesheet" href="/css/font-awesome.min.css" />
            <link rel="stylesheet" href="/css/main.css" />
            <link rel="stylesheet" href="/css/add-on.css" />
            <link rel="stylesheet" href="/css/monokai-sublime.css">
        

        

        
        
        
            
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-30563095-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

        
    </head>
    <body>

        
        <div id="wrapper">

    
    
<header id="header">
    
        <h1><a href="/"></i></a></h1>
    

    <nav class="links">
        <ul>
            
                <li>
                    <a href="">
                        Blog
                    </a>
                </li>
            
                <li>
                    <a href="about/index.html">
                        About
                    </a>
                </li>
            
        </ul>
    </nav>
    <nav class="main">
        <ul>
            
            <li id="share-nav" class="share-menu" style="display:none;">
                <a class="fa-share-alt" href="#share-menu">Share</a>
            </li>
            
            <li class="search">
                <a class="fa-search" href="#search">Search</a>
                <form id="search" method="get" action="//google.com/search">
                    <input type="text" name="q" placeholder="Search" />
                    <input type="hidden" name="q" value="site:https://jedipunkz.github.io">
                </form>
            </li>
            <li class="menu">
                <a class="fa-bars" href="#menu">Menu</a>
            </li>
        </ul>
    </nav>
</header>


<section id="menu">

    
        <section>
            <form class="search" method="get" action="//google.com/search">
                <input type="text" name="q" placeholder="Search" />
                <input type="hidden" name="q" value="site:https://jedipunkz.github.io">
            </form>
        </section>

    
        <section>
            <ul class="links">
                
                    <li>
                        <a href="">
                            <h3>
                                
                                Blog
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="about/index.html">
                            <h3>
                                
                                About
                            </h3>
                        </a>
                    </li>
                
            </ul>
        </section>

    
        <section>
            <ul class="links">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    <li>
                        <a href="https://jedipunkz.github.io/blog/2018/12/31/istio/"><p>Istio, Helm を使って Getting Started 的なアプリをデプロイ</p></a>
                    </li>
                
                    <li>
                        <a href="https://jedipunkz.github.io/blog/2017/07/02/test-kitchen-cluster/"><p>Docker,Test-Kitchen,Ansible でクラスタを構成する</p></a>
                    </li>
                
                    <li>
                        <a href="https://jedipunkz.github.io/blog/2017/04/13/gke-lb/"><p>GCP ロードバランサと GKE クラスタを Terraform を使って構築する</p></a>
                    </li>
                
                    <li>
                        <a href="https://jedipunkz.github.io/blog/2017/02/12/serverless-fission/"><p>Serverless on Kubernetes : Fission を使ってみた</p></a>
                    </li>
                
                    <li>
                        <a href="https://jedipunkz.github.io/blog/2017/01/13/kubernetes-deployments/"><p>Kubernetes Deployments を使ってみた！</p></a>
                    </li>
                
            </ul>
        </section>

    
        
</section>

    
    <div id="main">
        
            <article class="post">
    <header>
    <div class="title">
        
            <h2><a href="https://jedipunkz.github.io/blog/2018/12/31/istio/">Istio, Helm を使って Getting Started 的なアプリをデプロイ</a></h2>
        
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2018-12-31'>
            December 31, 2018</time>
        <span class="author"></span>
        
        
    </div>
</header>


    <section id="social-share">
        <ul class="icons">
            


<li><a href="//twitter.com/share?url=https%3a%2f%2fjedipunkz.github.io%2fblog%2f2018%2f12%2f31%2fistio%2f&text=Istio%2c%20Helm%20%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%20Getting%20Started%20%e7%9a%84%e3%81%aa%e3%82%a2%e3%83%97%e3%83%aa%e3%82%92%e3%83%87%e3%83%97%e3%83%ad%e3%82%a4&via=" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
</a></li>


<li><a href="//plus.google.com/share?url=https%3a%2f%2fjedipunkz.github.io%2fblog%2f2018%2f12%2f31%2fistio%2f" target="_blank" class="share-btn google-plus">
    <i class="fa fa-google-plus"></i>
    <p>Google+</p>
</a></li>


<li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fjedipunkz.github.io%2fblog%2f2018%2f12%2f31%2fistio%2f" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
</a></li>


<li><a href="//reddit.com/submit?url=https%3a%2f%2fjedipunkz.github.io%2fblog%2f2018%2f12%2f31%2fistio%2f&title=Istio%2c%20Helm%20%e3%82%92%e4%bd%bf%e3%81%a3%e3%81%a6%20Getting%20Started%20%e7%9a%84%e3%81%aa%e3%82%a2%e3%83%97%e3%83%aa%e3%82%92%e3%83%87%e3%83%97%e3%83%ad%e3%82%a4" target="_blank" class="share-btn reddit">
    <i class="fa fa-reddit-alien"></i>
    <p>Reddit</p>
</a></li>



















        </ul>
    </section>
    

    <div id="content">
        

<p>こんにちは。<a href="https://twitter.com/jedipunkz">@jedipunkz</a> です。</p>

<p>最近は kubernetes を触ってなかったのですが Istio や Envoy 等 CNCF 関連のソフトウェアの記事をよく見かけるようになって、少し理解しておいたほうがいいかなと思い Istio と Minikube を使って Getting Started 的な事をやってみました。Istio をダウンロードすると中にサンプルアプリケーションが入っているのでそれを利用してアプリのデプロイまでを行ってみます。</p>

<p>Istio をダウンロードするとお手軽に Istio 環境を作るための yaml ファイルがあり、それを kubectl apply することで Istio 環境を整えられるのですが、ドキュメントにプロダクション環境を想定した場合は Helm Template を用いた方がいいだろう、と記載あったので今回は Helm Template を用いて Istio 環境を作ります。</p>

<h2 id="前提の環境">前提の環境</h2>

<p>下記の環境でテストを行いました。</p>

<ul>
<li>macos Mojave</li>
<li>minikube v0.32.0</li>
<li>kubectl v1.10.3</li>
<li>helm v2.12.1</li>
<li>virtualbox</li>
</ul>

<h2 id="準備">準備</h2>

<h3 id="kubectl-と-helm-のインストール">kubectl と helm のインストール</h3>

<p>kubctl と helm をインストールします。両者共に homebrew でインストールします。</p>

<pre><code class="language-bash">brew install kubernetes-cli
brew install kubernetes-helm
</code></pre>

<h3 id="minikube-のインストールと起動">minikube のインストールと起動</h3>

<p>minikube をインストールして起動します。</p>

<pre><code class="language-bash">curl -Lo minikube https://storage.googleapis.com/minikube/releases/v0.32.0/minikube-darwin-amd64 &amp;&amp; chmod +x minikube &amp;&amp; sudo cp minikube /usr/local/bin/ &amp;&amp; rm minikube
minikube start --memory 2048
</code></pre>

<h3 id="istio-のダウンロードとインストール">Istio のダウンロードとインストール</h3>

<p>Istio のダウンロードとインストールを行います。後術しますがこのディレクトリの中に Istio 環境を構築するためのファイルやサンプルアプリケーションが入っています。</p>

<pre><code class="language-bash">curl -L https://git.io/getLatestIstio | sh -
cd istio-1.0.5
sudo cp bin/istioctl /usr/local/bin/istioctl
</code></pre>

<h2 id="構築作業">構築作業</h2>

<h3 id="istio-の-custom-resource-definitions-をインストール">Istio の Custom Resource Definitions をインストール</h3>

<p>Istio の Custom Resource Definitions (以下 CRDs) をインストールします。Kubernetes の CRDs は独自のカスタムリソースを定義し追加するものです。Kubernets API Server を介して作成することで作成したリソースの CRUD の API が Kubernetes API に追加されます。</p>

<p>先程ダウンロードした Istio のディレクトリに crds.yaml があるのでそれを適用します。</p>

<pre><code class="language-bash">kubectl apply -f install/kubernetes/helm/istio/templates/crds.yaml
</code></pre>

<h3 id="helm-template-を使って-istio-の-core-components-をインストール">Helm Template を使って Istio の Core Components をインストール</h3>

<p>Helm Template の仕組みをつかって Istio の Core Components をインストールします。まず Helm Template を出力し istio-system というネームスペースを作成、その後生成した Template を用いて kubectl コマンドで適用します。</p>

<pre><code class="language-bash">helm template install/kubernetes/helm/istio --name istio --namespace istio-system &gt; ./istio.yaml
kubectl create namespace istio-system
kubectl apply -f ./istio.yaml
</code></pre>

<h3 id="状態の確認">状態の確認</h3>

<p>この状態で service と pods の状態を確認してみます。</p>

<pre><code class="language-bash">kubectl get svc -n istio-system
NAME                     TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                                                                                                                   AGE
istio-citadel            ClusterIP      10.100.143.194   &lt;none&gt;        8060/TCP,9093/TCP                                                                                                         55s
istio-egressgateway      ClusterIP      10.108.243.97    &lt;none&gt;        80/TCP,443/TCP                                                                                                            55s
istio-galley             ClusterIP      10.98.99.11      &lt;none&gt;        443/TCP,9093/TCP                                                                                                          55s
istio-ingressgateway     LoadBalancer   10.97.17.220     &lt;pending&gt;     80:31380/TCP,443:31390/TCP,31400:31400/TCP,15011:30080/TCP,8060:31309/TCP,853:31151/TCP,15030:30455/TCP,15031:30836/TCP   55s
istio-pilot              ClusterIP      10.102.75.110    &lt;none&gt;        15010/TCP,15011/TCP,8080/TCP,9093/TCP                                                                                     55s
istio-policy             ClusterIP      10.101.145.62    &lt;none&gt;        9091/TCP,15004/TCP,9093/TCP                                                                                               55s
istio-sidecar-injector   ClusterIP      10.107.131.48    &lt;none&gt;        443/TCP                                                                                                                   55s
istio-telemetry          ClusterIP      10.96.248.64     &lt;none&gt;        9091/TCP,15004/TCP,9093/TCP,42422/TCP                                                                                     55s
prometheus               ClusterIP      10.98.228.190    &lt;none&gt;        9090/TCP                                                                                                                  55s
</code></pre>

<pre><code class="language-bash">kubectl get pods -n istio-system
NAME                                     READY     STATUS              RESTARTS   AGE
istio-citadel-55cdfdd57c-64tnn           0/1       ContainerCreating   0          1m
istio-cleanup-secrets-x6dmj              0/1       Completed           0          1m
istio-egressgateway-7798845f5d-qfx2k     1/1       Running             0          1m
istio-galley-76bbb946c8-5l626            0/1       ContainerCreating   0          1m
istio-ingressgateway-78c6d8b8d7-68r2z    1/1       Running             0          1m
istio-pilot-5fcb895bff-pmg8z             0/2       Pending             0          1m
istio-policy-7b6cc95d7b-w7ndg            2/2       Running             0          1m
istio-security-post-install-jcwg5        0/1       Completed           0          1m
istio-sidecar-injector-9c6698858-8lt92   0/1       ContainerCreating   0          1m
istio-telemetry-bfc9ff784-2mzzj          2/2       Running             0          1m
prometheus-65d6f6b6c-nttwz               0/1       ContainerCreating   0          1m
</code></pre>

<h2 id="サンプルアプリケーションのデプロイ">サンプルアプリケーションのデプロイ</h2>

<p>先程ダウンロードした Istio のディレクトリにサンプルアプリケーション &lsquo;bookinfo&rsquo; がありますのでそれをデプロイしてみます。
デプロイ方法は2パターンあります。</p>

<p>方法1. istioctl を使ってアプリの yaml に対して sidecar を記すよう変換しそれを kubctl apply します。</p>

<pre><code class="language-bash">kubectl apply -f &lt;(istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml)
</code></pre>

<p>方法2. Sidecar Injection をデフォルトの動きとして設定し kubectl apply します</p>

<pre><code class="language-bash">kubectl label namespace default istio-injection=enabled
kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yam
</code></pre>

<p>最後にアプリケーションの状態を確認します</p>

<pre><code class="language-bash">kubectl get svc
NAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE
details       ClusterIP   10.111.252.7     &lt;none&gt;        9080/TCP   17s
kubernetes    ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP    6m
productpage   ClusterIP   10.108.205.216   &lt;none&gt;        9080/TCP   10s
ratings       ClusterIP   10.102.161.24    &lt;none&gt;        9080/TCP   14s
reviews       ClusterIP   10.106.18.105    &lt;none&gt;        9080/TCP   12s
</code></pre>

<pre><code class="language-bash">kubectl get pods
NAME                              READY     STATUS            RESTARTS   AGE
details-v1-5458f64c65-svrr7       0/2       PodInitializing   0          48s
productpage-v1-577c9594b7-4f49s   0/2       Init:0/1          0          43s
ratings-v1-79467df9b5-vrx4w       0/2       PodInitializing   0          47s
reviews-v1-5d46b744bd-686s9       0/2       Init:0/1          0          46s
reviews-v2-7f7d7f99f7-xsvm8       0/2       Init:0/1          0          46s
reviews-v3-7bc67f66-cmt4x         0/2       Init:0/1          0          45s
</code></pre>

<h2 id="まとめ">まとめ</h2>

<p>プロダクション環境を想定した Istio 構築と言っても Helm Template を用いて簡単に操作できることが分かりました。</p>

<p>またここで重要なのはサンプルアプリケーション &lsquo;bookinfo&rsquo; の Kubenetes Pods に Envoy プロキシを Sidecar 的に配置するための変換コマンドとして</p>

<pre><code class="language-bash">kubectl apply -f &lt;(istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml)
</code></pre>

<p>が用いられていることです。下記の操作を実行してみるとよくわかるでしょう。</p>

<pre><code class="language-bash">istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml &gt; ./bookinfo.sidecar.yaml
diff -u bookinfo.yaml bookinfo.sidecar.yaml
</code></pre>

<p>差分が長くなるためここでは省略しますが元の bookinfo.yaml には記されていなかった sidecar の文字が読み取れると思います。アプリに隣接した pods に Envoy が起動している pods が Sidecar 的に配置され下記のような構成になりました。</p>

<pre><code>              ingress          &quot;python&quot;            &quot;java&quot;            &quot;nodejs&quot;
           +-----------+    +-------------+    +-------------+    +-------------+
           | +-------+ |    |  +-------+  |    |  +-------+  |    |  +-------+  |
request -&gt; | | envoy | | -&gt; |  | envoy |  | -&gt; |  | envoy |  | -&gt; |  | envoy |  |
           | +-------+ |    |  +-------+  |    |  +-------+  |    |  +-------+  |
           +-----------+    | productpage |    |  review-v1  |    |   ratings   |
                            +-------------+    +-------------+    +-------------+
           
                                               +-------------+
                                               |  +-------+  |
                                               |  | envoy |  |
                                               |  +-------+  |
                                               |  review-v2  |
                                               +-------------+
           
                                               +-------------+
                                               |  +-------+  |
                                               |  | envoy |  |
                                               |  +-------+  |
                                               |  review-v3  |
                                               +-------------+
           
                                               +-------------+
                                               |  +-------+  |
                                               |  | envoy |  |
                                               |  +-------+  |
                                               |   details   |
                                               +-------------+
                                                    ruby
</code></pre>

<h2 id="参考-url">参考 URL</h2>

<ul>
<li><a href="https://istio.io/docs/setup/kubernetes/quick-start/">https://istio.io/docs/setup/kubernetes/quick-start/</a></li>
<li><a href="https://istio.io/docs/examples/bookinfo/">https://istio.io/docs/examples/bookinfo/</a></li>
<li><a href="https://istio.io/docs/setup/kubernetes/helm-install/">https://istio.io/docs/setup/kubernetes/helm-install/</a></li>
</ul>

    </div>

    <footer>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    
                        Category
                    
                
            </li>
        
    

    
    
        <li><a href='/categories/infrastructure'>infrastructure</a></li>
    
</ul>

    </footer>
</article>
<ul class="actions pagination">
    
        <li><a href="https://jedipunkz.github.io/blog/2017/07/02/test-kitchen-cluster/"
                class="button big previous">Docker,Test-Kitchen,Ansible でクラスタを構成する</a></li>
    

    
</ul>





        
    </div>
    
<section id="sidebar">

    
        <section id="intro">
            
            
            
            <ul class="icons">
                
                    <li><a href="https://jedipunkz.github.io/index.xml" type="application/rss+xml"
                        target="_blank" title="RSS" class="fa fa-rss"></a></li>
                
                
            </ul>
        </section>

    
        <section id="recent-posts">
            <ul class="posts">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    
                

                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://jedipunkz.github.io/blog/2018/12/31/istio/">Istio, Helm を使って Getting Started 的なアプリをデプロイ</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2018-12-31'>
                                    December 31, 2018</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://jedipunkz.github.io/blog/2017/07/02/test-kitchen-cluster/">Docker,Test-Kitchen,Ansible でクラスタを構成する</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2017-07-02'>
                                    July 2, 2017</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://jedipunkz.github.io/blog/2017/04/13/gke-lb/">GCP ロードバランサと GKE クラスタを Terraform を使って構築する</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2017-04-13'>
                                    April 13, 2017</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://jedipunkz.github.io/blog/2017/02/12/serverless-fission/">Serverless on Kubernetes : Fission を使ってみた</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2017-02-12'>
                                    February 12, 2017</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://jedipunkz.github.io/blog/2017/01/13/kubernetes-deployments/">Kubernetes Deployments を使ってみた！</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2017-01-13'>
                                    January 13, 2017</time>
                            </header>
                        </article>
                    </li>
                

                
                    <li>
                        <ul class="actions">
                            <li><a href=
                            
                                "/post/"
                            
                            class="button">View more posts</a></li>
                        </ul>
                    </li>
                
            </ul>
        </section>

    
    
    
    
        <section id="categories">
            <ul class="posts">
                <header>
                    <h3><a href="/categories/">Categories</a></h3>
                </header>

                
                    
                

                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/infrastructure/">infrastructure</a>
                                <span style="float:right;">110</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/report/">report</a>
                                <span style="float:right;">9</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/tools/">tools</a>
                                <span style="float:right;">11</span>
                            </header>
                        </article>
                    </li>
                
            </ul>
        </section>
    

    
        

    
        <section id="footer">
            <ul class="icons">
                
                    <li><a href="https://jedipunkz.github.io/index.xml" type="application/rss+xml"
                        target="_blank" title="RSS" class="fa fa-rss"></a></li>
                
                
            </ul>

            <p class="copyright">&copy; ジェダイさんのブログ. テーマデザインは <a href="//github.com/jpescador" target="_blank">Julio Pescador</a>さんによるものです。 </p>
        </section>

</section>

            </div>
        <a id="back-to-top" href="#" class="fa fa-arrow-up fa-border fa-2x"></a>
        

        
        
            
        

        
        
            <script src="/js/jquery.min.js"></script>
            <script src="/js/skel.min.js"></script>
            <script src="/js/util.js"></script>
            <script src="/js/main.js"></script>
            <script src="/js/backToTop.js"></script>
            <script src="/js/highlight.pack.js"></script>
        

        

            
            <script>hljs.initHighlightingOnLoad();</script>
            
    </body>
</html>

